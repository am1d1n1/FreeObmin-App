
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FreeObmin - Платформа обміну речами в Україні. Обмінюйтесь речами безкоштовно, знаходьте нових друзів та допомагайте іншим. Легко знаходьте речі, які вам потрібні, та діліться тим, що вам більше не потрібно.">
    <title>Обмін Речей - Безкоштовна платформа для обміну та подарунків</title>
    <link rel="icon" type="image/png" href="ico.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#93a4ff',
                        secondary: '#34d399',
                        accent: '#fbbf24',
                        dark: '#182235',
                        darker: '#0a0f1a',
                        light: '#f3f4f6'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Light theme styles */
        body.light {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .bg-dark {
            background-color: #f3f4f6;
        }
        
        body.light .bg-darker {
            background-color: #e5e7eb;
        }
        
        body.light .text-white {
            color: #111827;
        }
        
        body.light .text-gray-300 {
            color: #4b5563;
        }
        
        body.light .text-gray-400 {
            color: #6b7280;
        }
        
        body.light .text-gray-500 {
            color: #9ca3af;
        }
        
        body.light .item-card {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .item-card:hover {
            background-color: #f3f4f6;
        }
        
        body.light .category-card {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .category-card:hover {
            background-color: #4338ca;
            color: white;
        }
        
        body.light .how-it-works-card {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .rules-card {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .chat-user {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light .chat-user:hover {
            background-color: #e5e7eb;
        }
        
        body.light .message-bubble {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        body.light .message-bubble.current-user {
            background-color: #3b82f6;
            color: white;
        }
        
        body.light .modal-content {
            background-color: #ffffff;
            color: #111827;
        }
        
        body.light input, 
        body.light select, 
        body.light textarea {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #111827;
        }
        
        body.light input:focus, 
        body.light select:focus, 
        body.light textarea:focus {
            border-color: #93a4ff;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
        }
        
        body.light .search-input {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #111827;
        }
        body.light .btn-primary {
            background: linear-gradient(135deg, #fceb00 0%, #ff0000 100%);
        }
        
        body.light .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        body.light .share-button {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        
        body.light .chat-messages {
            background-color: #e5e7eb;
        }
        
        body.light .filter-panel {
            background-color: #ffffff;
        }
        
        body.light .pagination button {
            background-color: #d1d5db;
            color: #111827;
        }
        
        body.light .pagination button.active {
            background-color: #6366f1;
            color: white;
        }
        
        body.light .user-menu-dropdown {
            background: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        body.light .toast {
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #111827;
        }
        
        body.light .toast-title {
            color: #111827;
        }
        
        body.light .toast-message {
            color: #4b5563;
        }
        
        body.light .toast-close {
            color: #6b7280;
        }
        
        body.light .toast-close:hover {
            background: #e5e7eb;
            color: #4b5563;
        }
        
        body.light .settings-section {
            border-bottom: 1px solid #d1d5db;
        }
        
        body.light .toggle-switch .slider {
            background-color: #9ca3af;
        }
        
        body.light input:checked + .slider {
            background-color: #6366f1;
        }
        
        body.light .profile-overlay {
            background: rgba(255, 255, 255, 0.5);
        }
        
        body.light .emoji-picker {
            background: #ffffff;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body.light .emoji-item:hover {
            background-color: #e5e7eb;
        }
        
        body.light .chat-sidebar {
            background-color: #ffffff;
        }
        
        body.light .chat-main {
            background-color: #ffffff;
        }

        
        body.light header {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body.light footer {
            background-color: #e5e7eb;
        }
        
        /* Dark theme styles (default) */
        body.dark, body {
            background-color: #182235;
            color: #d1d5db;
        }
        
        body.dark .bg-dark, body .bg-dark {
            background-color: #111827;
        }
        
        body.dark .bg-darker, body .bg-darker {
            background-color: #182235;
        }
        
        body.dark .item-card, body .item-card {
            background-color: #111827;
        }
        
        body.dark .item-card:hover, body .item-card:hover {
            background-color: #3c4a63;
        }
        
        body.dark .category-card, body .category-card {
            background-color: #111827;
        }
        
        body.dark .category-card:hover, body .category-card:hover {
            background-color: #4338ca;
            color: white;
        }
        
        body.dark .how-it-works-card, body .how-it-works-card {
            background-color: #111827;
        }
        
        body.dark .rules-card, body .rules-card {
            background-color: #111827;
        }
        
        body.dark .chat-user, body .chat-user {
            background-color: #182235;
        }
        
        body.dark .chat-user:hover, body .chat-user:hover {
            background-color: #111827;
        }
        
        body.dark .message-bubble, body .message-bubble {
            background-color: #3c4a63;
        }
        
        body.dark .message-bubble.current-user, body .message-bubble.current-user {
            background-color: #4338ca;
        }
        
        body.dark .modal-content, body .modal-content {
            background-color: #111827;
        }
        
        body.dark input, body.dark select, body.dark textarea, 
        body input, body select, body textarea {
            background-color: #3c4a63;
            border-color: #5b6b82;
            color: #d1d5db;
        }
        
        body.dark input:focus, body.dark select:focus, body.dark textarea:focus, 
        body input:focus, body select:focus, body textarea:focus {
            border-color: #93a4ff;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
        }
        
        body.dark .search-input, body .search-input {
            background-color: #3c4a63;
            border-color: #5b6b82;
            color: #d1d5db;
        }
        body.dark .btn-primary {
            background: linear-gradient(135deg, #ae00ff 0%, #680663 100%);
        }
        
        body.dark .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        body.dark .chat-messages, body .chat-messages {
            background-color: #111827;
        }
        
        body.dark .filter-panel, body .filter-panel {
            background-color: #111827;
        }
        
        body.dark .pagination button, body .pagination button {
            background-color: #3c4a63;
            color: #d1d5db;
        }
        
        body.dark .user-menu-dropdown, body .user-menu-dropdown {
            background: #111827;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        body.dark .toast, body .toast {
            background: #111827;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        body.dark .toast-title, body .toast-title {
            color: #d1d5db;
        }
        
        body.dark .toast-message, body .toast-message {
            color: #6b7280;
        }
        
        body.dark .toast-close, body .toast-close {
            color: #4b5563;
        }
        
        body.dark .toast-close:hover, body .toast-close:hover {
            background: #3c4a63;
            color: #6b7280;
        }
        
        body.dark .settings-section, body .settings-section {
            border-bottom: 1px solid #3c4a63;
        }
        
        body.dark .toggle-switch .slider, body .toggle-switch .slider {
            background-color: #5b6b82;
        }
        
        body.dark input:checked + .slider, body input:checked + .slider {
            background-color: #6366f1;
        }
        
        body.dark .emoji-picker, body .emoji-picker {
            background: #111827;
            border: 1px solid #3c4a63;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        body.dark .emoji-item:hover, body .emoji-item:hover {
            background-color: #3c4a63;
        }
        
        body.dark .chat-sidebar, body .chat-sidebar {
            background-color: #182235;
        }
        
        body.dark .chat-main, body .chat-main {
            background-color: #111827;
        }
        
        body.dark header, body header {
            background-color: #111827;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        body.dark footer, body footer {
            background-color: #0a0f1a;
        }
        
        /* Common styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .item-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        .category-card {
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }
        
        .btn-secondary {
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        }
        
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 4px solid rgba(30, 41, 59, 0.3);
            border-radius: 50%;
            border-top: 4px solid #93a4ff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-preview {
            position: relative;
            display: inline-block;
        }
        
        .remove-image {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .thumbnail-active {
            border: 2px solid #93a4ff;
        }
        
        .user-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            border-radius: 0.5rem;
            width: 200px;
            z-index: 1000;
            display: none;
        }
        
        .user-menu-dropdown.show {
            display: block;
        }
        
        .status-active {
            background-color: #10b981;
        }
        
        .status-inactive {
            background-color: #ef4444;
        }
        
        .status-exchanged {
            background-color: #f59e0b;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .chat-user.active {
            background-color: #4338ca;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        
        .pagination button.active {
            background-color: #6366f1;
            color: white;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Custom Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            border-left: 4px solid #93a4ff;
            border-radius: 8px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            transform-origin: top right;
        }
        
        .toast.success {
            border-left-color: #34d399;
        }
        
        .toast.error {
            border-left-color: #f87171;
        }
        
        .toast.warning {
            border-left-color: #fbbf24;
        }
        
        .toast.info {
            border-left-color: #60a5fa;
        }
        
        .toast-content {
            flex: 1;
            padding: 0 12px;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .toast.success .toast-icon {
            background: #065f46;
            color: #34d399;
        }
        
        .toast.error .toast-icon {
            background: #7f1d1d;
            color: #f87171;
        }
        
        .toast.warning .toast-icon {
            background: #78350f;
            color: #fbbf24;
        }
        
        .toast.info .toast-icon {
            background: #1e3a8a;
            color: #60a5fa;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
        }
        
        .toast.closing {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        /* Profile Image Upload */
        .profile-image-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .profile-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .profile-image-upload:hover .profile-overlay {
            opacity: 1;
        }
        
        .profile-overlay i {
            font-size: 24px;
        }
        
        /* Settings Modal */
        .settings-section {
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Filter Panel */
        .filter-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            opacity: 0;
        }
        
        .filter-panel.open {
            max-height: 500px;
            opacity: 1;
        }
        
        /* Edit Item Image Preview */
        .edit-image-preview {
            position: relative;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .edit-remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Share Button */
        .share-button {
            transition: all 0.3s ease;
        }
        
        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }
        
        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .emoji-picker.show {
            display: block;
        }
        
        .emoji-item {
            display: inline-block;
            padding: 0.25rem;
            cursor: pointer;
            font-size: 1.25rem;
            border-radius: 0.25rem;
        }
        
        /* Chat Modal Fixed Size */
        .chat-modal-content {
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-sidebar {
            height: 100%;
            overflow-y: auto;
        }
        
        .chat-main {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Phone number styles */
        .phone-number {
            color: #3b82f6;
            font-weight: 500;
        }
        
        .hidden-phone {
            color: #6b7280;
            font-style: italic;
        }
        
        /* Virtual Assistant Styles */
        #virtual-assistant-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
        }

        #virtual-assistant {
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        #virtual-assistant.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .assistant-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .assistant-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        #close-assistant {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        #close-assistant:hover {
            background: rgba(255,255,255,0.2);
        }

        .assistant-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .assistant-welcome {
            text-align: center;
            margin-bottom: 20px;
        }

        .assistant-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .assistant-greeting {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 10px;
        }

        .assistant-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .faq-list {
            list-style: none;
        }

        .faq-item {
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .faq-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .faq-question {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: #333;
        }

        .faq-question:hover {
            color: #ff6b6b;
        }

        .faq-icon {
            transition: transform 0.3s ease;
        }

        .faq-item.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            color: #666;
            line-height: 1.6;
        }

        .faq-item.active .faq-answer {
            padding: 0 20px 20px;
            max-height: 400px;
        }

        .assistant-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            text-align: center;
            border-top: 1px solid #eee;
        }

        .contact-link {
            color: #ff6b6b;
            text-decoration: none;
            font-weight: 500;
        }

        .contact-link:hover {
            text-decoration: underline;
        }

        /* Animated Stork Styles */
        .stork-container {
            position: relative;
            width: 70px;
            height: 70px;
            cursor: pointer;
        }

        .stork-body {
            position: absolute;
            width: 50px;
            height: 25px;
            background: white;
            border-radius: 50%;
            top: 25px;
            left: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stork-head {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 22px;
            left: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stork-beak {
            position: absolute;
            width: 15px;
            height: 5px;
            background: #ff9966;
            border-radius: 50%;
            top: 28px;
            left: 0;
            transform: rotate(-10deg);
        }

        .stork-eye {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #333;
            border-radius: 50%;
            top: 25px;
            left: 10px;
        }

        .stork-leg {
            position: absolute;
            width: 3px;
            height: 20px;
            background: #ff9966;
            top: 45px;
        }

        .stork-leg.left {
            left: 25px;
        }

        .stork-leg.right {
            left: 35px;
        }

        .stork-wing {
            position: absolute;
            width: 30px;
            height: 15px;
            background: white;
            border-radius: 50%;
            top: 22px;
            right: 15px;
            transform-origin: left center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stork-wing.left {
            transform: rotate(-20deg);
            animation: flapLeft 1.5s ease-in-out infinite;
        }

        .stork-wing.right {
            transform: rotate(20deg);
            animation: flapRight 1.5s ease-in-out infinite;
        }

        @keyframes flapLeft {
            0%, 100% { transform: rotate(-20deg); }
            50% { transform: rotate(0deg); }
        }

        @keyframes flapRight {
            0%, 100% { transform: rotate(20deg); }
            50% { transform: rotate(0deg); }
        }

        @keyframes fly {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .stork-container {
            animation: fly 3s ease-in-out infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #virtual-assistant {
                width: 350px;
                height: 450px;
            }
        }

        @media (max-width: 480px) {
            #virtual-assistant {
                width: 300px;
                height: 400px;
            }
            
            .stork-container {
                width: 60px;
                height: 60px;
            }
            
            .stork-body {
                width: 40px;
                height: 20px;
                top: 20px;
                left: 8px;
            }
            
            .stork-head {
                width: 16px;
                height: 16px;
                top: 18px;
                left: 4px;
            }
            
            .stork-beak {
                width: 12px;
                height: 4px;
                top: 22px;
            }
            
            .stork-eye {
                width: 3px;
                height: 3px;
                top: 20px;
                left: 8px;
            }
            
            .stork-leg {
                width: 2px;
                height: 15px;
                top: 35px;
            }
            
            .stork-leg.left {
                left: 20px;
            }
            
            .stork-leg.right {
                left: 28px;
            }
            
            .stork-wing {
                width: 25px;
                height: 12px;
                top: 18px;
                right: 12px;
            }
        }
        
        /* Fix for chat message text color */
        .message-sender-name {
            color: white !important;
            font-weight: bold;
        }
        
        .message-text {
            color: white !important;
        }
        
        .message-time {
            color: #cbd5e1 !important;
            font-size: 0.75rem;
        }
        
        /* Notification badge for push notifications */
        .push-notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Push notification modal */
        .push-notification-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: #111827;
            border-left: 4px solid #93a4ff;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            transform-origin: top right;
        }
        
        .push-notification-content {
            display: flex;
            align-items: flex-start;
        }
        
        .push-notification-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #1e3a8a;
            color: #60a5fa;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .push-notification-text {
            flex: 1;
        }
        
        .push-notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #d1d5db;
        }
        
        .push-notification-message {
            font-size: 14px;
            line-height: 1.4;
            color: #9ca3af;
        }
        
        .push-notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #4b5563;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            margin-left: 12px;
            flex-shrink: 0;
        }
        
        .push-notification-close:hover {
            background: #3c4a63;
            color: #6b7280;
        }
        
        /* Push notification settings */
        .push-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 12px;
            background: #1f2937;
            border-radius: 8px;
        }
        
        .push-setting-item:last-child {
            margin-bottom: 0;
        }
        
        .push-setting-info {
            flex: 1;
        }
        
        .push-setting-title {
            font-weight: 600;
            color: #d1d5db;
            margin-bottom: 4px;
        }
        
        .push-setting-description {
            font-size: 14px;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-darker light">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header -->
    <header class="bg-dark shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <div class="bg-primary w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exchange-alt text-white text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Обмін<span class="text-primary">Речей</span></h1>
                </div>
                
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-6">
                    <a href="#" class="text-gray-300 hover:text-primary font-medium">Головна</a>
                    <a href="#categories" class="text-gray-300 hover:text-primary font-medium">Категорії</a>
                    <a href="#items" class="text-gray-300 hover:text-primary font-medium">Речі</a>
                    <a href="#rules" class="text-gray-300 hover:text-primary font-medium">Правила</a>
                </nav>
                
                <div class="flex items-center space-x-3">
                    <button id="theme-toggle" class="theme-toggle">
                        <i class="fas fa-sun text-gray-400"></i>
                    </button>
                    
                    <div id="auth-buttons">
                        <button id="login-btn" class="bg-dark border border-primary text-primary px-4 py-2 rounded-lg font-medium hover:bg-primary hover:text-white transition">Вхід</button>
                        <button id="signup-btn" class="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-500 transition hidden md:inline-block">Реєстрація</button>
                    </div>
                    
                    <div id="user-menu" class="hidden relative">
                        <div class="flex items-center space-x-2 cursor-pointer" id="user-menu-toggle">
                            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white">
                                <i class="fas fa-user"></i>
                            </div>
                            <span id="user-name" class="font-medium hidden md:block text-white"></span>
                            <i class="fas fa-caret-down text-gray-400"></i>
                        </div>
                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="py-2">
                                <a href="#" id="chat-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700 relative">
                                    <i class="fas fa-comments mr-2"></i> Чати
                                    <span id="chat-notification-badge" class="notification-badge hidden">0</span>
                                </a>
                                <a href="#" id="my-items-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">
                                    <i class="fas fa-list mr-2"></i> Мої оголошення
                                </a>
                                <a href="#" id="moderation-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700 hidden relative">
                                    <i class="fas fa-shield-alt mr-2"></i> Модерація
                                    <span id="moderation-badge" class="notification-badge hidden">0</span>
                                </a>
                                <a href="#" id="favorites-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">
                                    <i class="fas fa-heart mr-2"></i> Обране
                                </a>
                                <a href="#" id="profile-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">
                                    <i class="fas fa-user mr-2"></i> Профіль
                                </a>
                                <a href="#" id="settings-menu-btn" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">
                                    <i class="fas fa-cog mr-2"></i> Налаштування
                                </a>
                                <hr class="my-2 border-gray-700">
                                <a href="#" id="logout-menu-btn" class="block px-4 py-2 text-red-400 hover:bg-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Вийти
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
        <!-- Hero Section -->
        <section class="bg-blue-900 py-16">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Обмінюйся. Ділись. Знаходь нові речі!</h1>
                <p class="text-xl mb-8 max-w-2xl mx-auto">Безкоштовна платформа для обміну речами та подарунків. Знайди щось нове для себе та віддай непотрібне іншим!</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="add-item-hero-btn" class="btn-primary px-8 py-3 rounded-lg font-bold text-lg">Додати оголошення</button>
                    <button class="btn-secondary px-8 py-3 rounded-lg font-bold text-lg">Переглянути речі</button>
                </div>
            </div>
        </section>

        <!-- Search and Filter Section -->
        <section class="py-8 bg-dark">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="relative flex-1">
                            <input type="text" placeholder="Пошук..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent search-input" id="search-input">
                            <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                        </div>
                        <button id="filter-toggle-btn" class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-500 transition flex items-center">
                            <i class="fas fa-filter mr-2"></i> Фільтри
                        </button>
                        <button id="search-btn" class="bg-secondary text-white px-6 py-3 rounded-lg font-medium hover:bg-green-500 transition flex items-center">
                            <i class="fas fa-search mr-2"></i> Шукати
                        </button>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div id="filter-panel" class="filter-panel bg-gray-800 rounded-lg shadow-md p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-gray-300 mb-2">Категорія</label>
                                <select id="category-filter-modal" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">Всі категорії</option>
                                    <option value="одяг">Одяг</option>
                                    <option value="електроніка">Електроніка</option>
                                    <option value="дім">Дім</option>
                                    <option value="книги">Книги</option>
                                    <option value="спорт">Спорт</option>
                                    <option value="транспорт">Транспорт</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Область</label>
                                <select id="region-filter" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">Оберіть область</option>
                                    <!-- Options will be populated dynamically from locations.json -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Місто/Район</label>
                                <select id="city-district-filter" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">Оберіть місто/район</option>
                                    <!-- Options will be populated dynamically based on selected region -->
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-gray-300 mb-2">Сортування</label>
                            <select id="sort-order" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="desc">Спочатку нові</option>
                                <option value="asc">Спочатку старі</option>
                            </select>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button id="apply-filters-btn" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-500 transition">
                                Застосувати фільтри
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="py-16 bg-dark">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">Популярні категорії</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="одяг">
                        <div class="w-16 h-16 bg-indigo-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-tshirt text-primary text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Одяг</h3>
                    </div>
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="електроніка">
                        <div class="w-16 h-16 bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-laptop text-secondary text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Електроніка</h3>
                    </div>
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="дім">
                        <div class="w-16 h-16 bg-yellow-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-home text-accent text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Дім</h3>
                    </div>
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="книги">
                        <div class="w-16 h-16 bg-purple-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-book text-purple-400 text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Книги</h3>
                    </div>
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="спорт">
                        <div class="w-16 h-16 bg-pink-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-dumbbell text-pink-400 text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Спорт</h3>
                    </div>
                    <div class="category-card p-6 rounded-xl shadow-md text-center cursor-pointer" data-category="транспорт">
                        <div class="w-16 h-16 bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-car text-blue-400 text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg text-white">Транспорт</h3>
                    </div>
                </div>
            </div>
        </section>

        <!-- Items Section -->
        <section id="items" class="py-16 bg-darker">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-white mb-8" id="items-title">Останні оголошення</h2>
                
                <div id="items-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Items will be loaded here dynamically -->
                    <div id="loading-items" class="col-span-full text-center py-12">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-gray-400">Завантаження оголошень...</p>
                    </div>
                </div>
                
                <div id="pagination-container" class="pagination">
                    <!-- Pagination will be loaded here dynamically -->
                </div>
            </div>
        </section>

        <!-- How It Works -->
        <section class="py-16 bg-dark">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">Як це працює?</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="how-it-works-card p-8 rounded-xl shadow-md text-center">
                        <div class="w-20 h-20 bg-indigo-900 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-plus text-primary text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-white">1. Додай річ</h3>
                        <p class="text-gray-400 mt-1">Зареєструйся та додай оголошення про річ, якою хочеш поділитися або обмінятися.</p>
                    </div>
                    <div class="how-it-works-card p-8 rounded-xl shadow-md text-center">
                        <div class="w-20 h-20 bg-green-900 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-search text-secondary text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-white">2. Знайди потрібне</h3>
                        <p class="text-gray-400 mt-1">Шукай речі, які тобі потрібні, за категоріями, містом або ключовими словами.</p>
                    </div>
                    <div class="how-it-works-card p-8 rounded-xl shadow-md text-center">
                        <div class="w-20 h-20 bg-yellow-900 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-hands-helping text-accent text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-white">3. Обміняйся</h3>
                        <p class="text-gray-400 mt-1">Зв'яжись з власником, домовся про зустріч та обміняйся речами!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Rules Section -->
        <section id="rules" class="py-16 bg-darker">
            <div class="container mx-auto px-4 max-w-4xl">
                <h2 class="text-3xl font-bold text-center mb-12 text-white">Правила користування</h2>
                <div class="rules-card rounded-xl shadow-md p-8">
                    <ul class="space-y-6">
                        <li class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-4">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Додавайте лише речі, якими хочете поділитися</h3>
                                <p class="text-gray-400 mt-1">Платформа призначена для безкоштовного обміну та подарунків. Не розміщуйте товари для продажу.</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-4">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Описуйте речі чесно</h3>
                                <p class="text-gray-400 mt-1">Вказуйте реальний стан речей, щоб уникнути недорозумінь при зустрічі.</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-4">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Поважайте інших користувачів</h3>
                                <p class="text-gray-400 mt-1">Спілкуйтеся ввічливо, дотримуйтесь домовленостей та зустрічайтеся в безпечних місцях.</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-4">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Не залишайте оголошення без відповідей надовго</h3>
                                <p class="text-gray-400 mt-1">Якщо річ вже обміняно або віддано, видаляйте оголошення.</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-darker text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="bg-primary w-8 h-8 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-white"></i>
                        </div>
                        <h2 class="text-xl font-bold">Обмін<span class="text-primary">Речей</span></h2>
                    </div>
                    <p class="text-gray-400">Безкоштовна платформа для обміну речами та подарунків.</p>
                    <div class="flex space-x-4 mt-4">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Навігація</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white">Головна</a></li>
                        <li><a href="#categories" class="text-gray-400 hover:text-white">Категорії</a></li>
                        <li><a href="#items" class="text-gray-400 hover:text-white">Речі</a></li>
                        <li><a href="#rules" class="text-gray-400 hover:text-white">Правила</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Корисні посилання</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white">Допомога</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Контакти</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Політика конфіденційності</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Умови використання</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Підписка</h3>
                    <p class="text-gray-400 mb-4">Підпишись на новини та отримуй оновлення</p>
                    <div class="flex">
                        <input type="email" placeholder="Ваш email" class="px-4 py-2 rounded-l-lg w-full text-dark focus:outline-none bg-gray-700 text-white">
                        <button class="bg-primary px-4 py-2 rounded-r-lg font-medium">OK</button>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500">
                <p>&copy; 2023 ОбмінРечей. Всі права захищені.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-md p-8 relative">
            <button id="close-login-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Вхід до акаунту</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="login-email">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2" for="login-password">Пароль</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Увійти</button>
                <div class="text-center mt-4">
                    <a href="#" class="text-primary hover:underline">Забули пароль?</a>
                </div>
            </form>
            <div class="mt-6 text-center">
                <p class="text-gray-400">Немає акаунту? <button id="show-signup" class="text-primary font-bold hover:underline">Зареєструватися</button></p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-md p-8 relative">
            <button id="close-signup-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Реєстрація</h2>
            <form id="signup-form">
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="signup-name">Ім'я</label>
                    <input type="text" id="signup-name" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="signup-email">Email</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="signup-phone">Номер телефону</label>
                    <input type="tel" id="signup-phone" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="+380XXXXXXXXX" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="signup-password">Пароль</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2" for="signup-confirm-password">Підтвердження пароля</label>
                    <input type="password" id="signup-confirm-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Зареєструватися</button>
            </form>
            <div class="mt-6 text-center">
                <p class="text-gray-400">Вже маєте акаунт? <button id="show-login" class="text-primary font-bold hover:underline">Увійти</button></p>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-2xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-add-item-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Додати нове оголошення</h2>
            <form id="add-item-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-300 mb-2" for="item-name">Назва речі</label>
                        <input type="text" id="item-name" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="item-category">Категорія</label>
                        <select id="item-category" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Оберіть категорію</option>
                            <option value="одяг">Одяг</option>
                            <option value="електроніка">Електроніка</option>
                            <option value="дім">Дім</option>
                            <option value="книги">Книги</option>
                            <option value="спорт">Спорт</option>
                            <option value="транспорт">Транспорт</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2" for="item-description">Опис</label>
                    <textarea id="item-description" rows="4" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Детально опишіть річ, її стан, розмір тощо" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-300 mb-2" for="item-region">Область</label>
                        <select id="item-region" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Оберіть область</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="item-city-district">Місто/Район</label>
                        <select id="item-city-district" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Оберіть місто/район</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="item-type">Тип</label>
                        <select id="item-type" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="обмін">Обмін</option>
                            <option value="подарунок">Подарунок</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Фото</label>
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition" id="main-image-upload">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-2"></i>
                        <p class="text-gray-400">Завантажити головне фото</p>
                        <input type="file" id="main-image" class="hidden" accept="image/*" required>
                    </div>
                    <div id="main-image-preview" class="mt-2 hidden">
                        <div class="image-preview">
                            <img id="main-image-preview-img" src="" alt="Main" class="w-full h-32 object-cover rounded">
                            <div class="remove-image" data-input="main-image">×</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Додаткові фото (до 3)</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition additional-image-upload" data-index="1">
                            <i class="fas fa-plus text-2xl text-gray-500 mb-1"></i>
                            <p class="text-gray-400 text-sm">Фото 1</p>
                            <input type="file" class="hidden additional-image-input" accept="image/*" data-index="1">
                        </div>
                        <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition additional-image-upload" data-index="2">
                            <i class="fas fa-plus text-2xl text-gray-500 mb-1"></i>
                            <p class="text-gray-400 text-sm">Фото 2</p>
                            <input type="file" class="hidden additional-image-input" accept="image/*" data-index="2">
                        </div>
                        <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition additional-image-upload" data-index="3">
                            <i class="fas fa-plus text-2xl text-gray-500 mb-1"></i>
                            <p class="text-gray-400 text-sm">Фото 3</p>
                            <input type="file" class="hidden additional-image-input" accept="image/*" data-index="3">
                        </div>
                    </div>
                    <div id="additional-images-preview" class="grid grid-cols-3 gap-4 mt-2"></div>
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Додати оголошення</button>
            </form>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-2xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-edit-item-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Редагувати оголошення</h2>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-300 mb-2" for="edit-item-name">Назва речі</label>
                        <input type="text" id="edit-item-name" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="edit-item-category">Категорія</label>
                        <select id="edit-item-category" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="одяг">Одяг</option>
                            <option value="електроніка">Електроніка</option>
                            <option value="дім">Дім</option>
                            <option value="книги">Книги</option>
                            <option value="спорт">Спорт</option>
                            <option value="транспорт">Транспорт</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2" for="edit-item-description">Опис</label>
                    <textarea id="edit-item-description" rows="4" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Детально опишіть річ, її стан, розмір тощо" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-300 mb-2" for="edit-item-region">Область</label>
                        <select id="edit-item-region" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Оберіть область</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="edit-item-city-district">Місто/Район</label>
                        <select id="edit-item-city-district" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Оберіть місто/район</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2" for="edit-item-type">Тип</label>
                        <select id="edit-item-type" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="обмін">Обмін</option>
                            <option value="подарунок">Подарунок</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2" for="edit-item-status">Статус</label>
                    <select id="edit-item-status" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        <option value="active">Активне</option>
                        <option value="inactive">Неактивне</option>
                        <option value="exchanged">Обмінене</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Фото</label>
                    <div id="edit-images-container" class="flex flex-wrap mb-4">
                        <!-- Existing images will be loaded here -->
                    </div>
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition" id="edit-add-image">
                        <i class="fas fa-plus text-3xl text-gray-500 mb-2"></i>
                        <p class="text-gray-400">Додати нове фото</p>
                        <input type="file" id="edit-new-image" class="hidden" accept="image/*" multiple>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Зберегти зміни</button>
            </form>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div id="item-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-4xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-item-detail-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div id="item-detail-content">
                <!-- Item details will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- My Items Modal -->
    <div id="my-items-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-4xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-my-items-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Мої оголошення</h2>
            <div id="my-items-container">
                <!-- My items will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-4xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-favorites-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Обрані оголошення</h2>
            <div id="favorites-container">
                <!-- Favorite items will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Moderation Modal -->
    <div id="moderation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-5xl p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-moderation-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Модерація оголошень</h2>
            <div id="moderation-container">
                <!-- Moderation items will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-4xl p-4 relative chat-modal-content">
            <div class="flex h-full">
                <div class="w-1/3 border-r border-gray-700 pr-2 flex flex-col chat-sidebar">
                    <h2 class="text-lg font-bold mb-2 text-white">Чати</h2>
                    <div id="chats-list" class="flex-1 overflow-y-auto">
                        <!-- Chats will be loaded here dynamically -->
                    </div>
                </div>
                <div class="w-2/3 pl-2 flex flex-col chat-main">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-white" id="current-chat-user">Чат</h2>
                        <button id="close-chat-modal" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 chat-messages bg-gray-800 rounded-lg p-3 mb-2">
                        <div id="chat-messages-container">
                            <!-- Messages will be loaded here dynamically -->
                        </div>
                    </div>
                    <div class="flex relative">
                        <button id="emoji-btn" class="bg-gray-700 text-gray-300 px-3 rounded-l-lg font-bold hover:bg-gray-600 transition">
                            <i class="far fa-smile"></i>
                        </button>
                        <div id="emoji-picker" class="emoji-picker">
                            <div class="emoji-item">😀</div>
                            <div class="emoji-item">😂</div>
                            <div class="emoji-item">😍</div>
                            <div class="emoji-item">🥰</div>
                            <div class="emoji-item">😎</div>
                            <div class="emoji-item">🤩</div>
                            <div class="emoji-item">🥳</div>
                            <div class="emoji-item">😭</div>
                            <div class="emoji-item">😡</div>
                            <div class="emoji-item">👍</div>
                            <div class="emoji-item">👎</div>
                            <div class="emoji-item">❤️</div>
                            <div class="emoji-item">🔥</div>
                            <div class="emoji-item">💯</div>
                            <div class="emoji-item">✨</div>
                            <div class="emoji-item">🎉</div>
                        </div>
                        <input type="text" id="chat-message-input" placeholder="Напишіть повідомлення..." class="flex-1 border border-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-gray-800 text-white">
                        <button id="send-chat-message" class="bg-primary text-white px-4 rounded-r-lg font-bold hover:bg-indigo-500 transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-md p-8 relative">
            <button id="close-profile-edit-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Редагувати профіль</h2>
            <form id="profile-edit-form">
                <div class="mb-6 text-center">
                    <div class="profile-image-upload mx-auto">
                        <div class="w-24 h-24 rounded-full bg-primary flex items-center justify-center mx-auto mb-4 relative overflow-hidden">
                            <img id="profile-image-preview" src="" alt="Profile" class="w-full h-full object-cover">
                            <div class="profile-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <input type="file" id="profile-image" class="hidden" accept="image/*">
                        <p class="text-gray-400 text-sm">Натисніть для зміни фото</p>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="profile-name">Ім'я</label>
                    <input type="text" id="profile-name" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="profile-email">Email</label>
                    <input type="email" id="profile-email" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="profile-phone">Номер телефону</label>
                    <input type="tel" id="profile-phone" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="+380XXXXXXXXX" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition mb-4">Зберегти зміни</button>
            </form>
            <div class="border-t border-gray-700 pt-4">
                <h3 class="text-lg font-bold mb-4 text-white">Зміна пароля</h3>
                <form id="change-password-form">
                    <div class="mb-4">
                        <label class="block text-gray-300 mb-2" for="current-password">Поточний пароль</label>
                        <input type="password" id="current-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-300 mb-2" for="new-password">Новий пароль</label>
                        <input type="password" id="new-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-300 mb-2" for="confirm-new-password">Підтвердження нового пароля</label>
                        <input type="password" id="confirm-new-password" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <button type="submit" class="w-full bg-secondary text-white py-3 rounded-lg font-bold hover:bg-green-500 transition">Змінити пароль</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-md p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Налаштування</h2>
            
            <div class="settings-section">
                <h3 class="text-lg font-bold mb-4 text-white">Зовнішній вигляд</h3>
                <div class="setting-item">
                    <span class="text-gray-300">Темна тема</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-theme-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="text-lg font-bold mb-4 text-white">Сповіщення</h3>
                <div class="push-setting-item">
                    <div class="push-setting-info">
                        <div class="push-setting-title">Push-сповіщення</div>
                        <div class="push-setting-description">Отримувати сповіщення в браузері</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="push-notifications-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="text-gray-300">Сповіщення про нові повідомлення</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="message-notifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="text-gray-300">Сповіщення про нові оголошення</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="item-notifications">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="text-gray-300">Сповіщення про обрані</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="favorite-notifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="text-lg font-bold mb-4 text-white">Приватність</h3>
                <div class="setting-item">
                    <span class="text-gray-300">Показувати мій профіль іншим</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="profile-visibility" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="text-gray-300">Дозволити повідомлення від незнайомців</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="stranger-messages" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="text-lg font-bold mb-4 text-white">Мова</h3>
                <div class="setting-item">
                    <span class="text-gray-300">Мова інтерфейсу</span>
                    <select id="language-select" class="border border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary bg-gray-800 text-white">
                        <option value="uk">Українська</option>
                    </select>
                </div>
            </div>
            
            <div class="pt-4">
                <button id="save-settings-btn" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Зберегти налаштування</button>
            </div>
        </div>
    </div>

    <!-- Virtual Assistant Container -->
    <div id="virtual-assistant-container">
        <div class="stork-container" id="assistant-toggle">
            <div class="stork-body"></div>
            <div class="stork-head"></div>
            <div class="stork-beak"></div>
            <div class="stork-eye"></div>
            <div class="stork-leg left"></div>
            <div class="stork-leg right"></div>
            <div class="stork-wing left"></div>
            <div class="stork-wing right"></div>
        </div>
        <div id="virtual-assistant">
            <div class="assistant-header">
                <div class="assistant-title">Віртуальна Лелека</div>
                <button id="close-assistant">×</button>
            </div>
            
            <div class="assistant-content">
                <div class="assistant-welcome">
                    <div class="assistant-avatar">
                        <i class="fas fa-dove"></i>
                    </div>
                    <h3 class="assistant-greeting">Привіт! Я Лелека!</h3>
                    <p class="assistant-subtitle">Допоможу вам з найпоширенішими питаннями</p>
                </div>
                
                <ul class="faq-list">
                    <li class="faq-item">
                        <div class="faq-question">
                            <span>Як зареєструватися на платформі?</span>
                            <i class="fas fa-chevron-down faq-icon"></i>
                        </div>
                        <div class="faq-answer">
                            <p>Для реєстрації натисніть кнопку "Реєстрація" у верхньому правому куті. Введіть своє ім'я, email, номер телефону та створіть пароль. Після підтвердження email ви зможете користуватися всіма функціями платформи.</p>
                        </div>
                    </li>
                    
                    <li class="faq-item">
                        <div class="faq-question">
                            <span>Як додати оголошення?</span>
                            <i class="fas fa-chevron-down faq-icon"></i>
                        </div>
                        <div class="faq-answer">
                            <p>Після входу в акаунт натисніть кнопку "Додати оголошення". Заповніть форму: вкажіть назву речі, оберіть категорію, додайте опис та фото. Не забудьте вказати місце знаходження та тип (обмін або подарунок).</p>
                        </div>
                    </li>
                    
                    <li class="faq-item">
                        <div class="faq-question">
                            <span>Як зв'язатися з власником речі?</span>
                            <i class="fas fa-chevron-down faq-icon"></i>
                        </div>
                        <div class="faq-answer">
                            <p>Відкрийте оголошення, яке вас цікавить, та натисніть кнопку "Зв'язатися з власником". Це відкриє чат, де ви зможете обговорити деталі обміну або передачі речі.</p>
                        </div>
                    </li>
                    
                    <li class="faq-item">
                        <div class="faq-question">
                            <span>Чи безпечно обмінюватися речами?</span>
                            <i class="fas fa-chevron-down faq-icon"></i>
                        </div>
                        <div class="faq-answer">
                            <p>Так, але дотримуйтесь правил безпеки: зустрічайтеся в людних місцях, перевіряйте стан речей перед обміном, довіряйте інтуїції. Наша платформа має систему рейтингу користувачів для додаткової безпеки.</p>
                        </div>
                    </li>
                    
                    <li class="faq-item">
                        <div class="faq-question">
                            <span>Що робити, якщо річ вже обміняно?</span>
                            <i class="fas fa-chevron-down faq-icon"></i>
                        </div>
                        <div class="faq-answer">
                            <p>У своєму кабінеті перейдіть до "Мої оголошення" та змініть статус оголошення на "Обмінено". Це допоможе іншим користувачам знати, що річ більше не доступна.</p>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="assistant-footer">
                <p>Не знайшли відповідь? <a href="#" class="contact-link">Зв'яжіться з нами</a></p>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        
        // Check for saved theme preference or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.classList.add(savedTheme);
        
        // Update theme toggle button icon
        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('light')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }
        
        // Initialize theme icon
        updateThemeIcon();
        
        // Theme toggle event listener
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('light');
            body.classList.toggle('dark');
            
            // Save preference to localStorage
            const currentTheme = body.classList.contains('light') ? 'light' : 'dark';
            localStorage.setItem('theme', currentTheme);
            
            // Update icon
            updateThemeIcon();
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFfTBwF-HXWATxcknSaxguozhsxzNLYJA",
            authDomain: "swap-e9630.firebaseapp.com",
            projectId: "swap-e9630",
            storageBucket: "swap-e9630.appspot.com",
            messagingSenderId: "654932840054",
            appId: "1:654932840054:web:d26424cbc61de08d89d957"
        };

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'dgjrkh7oj';
        const CLOUDINARY_UPLOAD_PRESET = 'obmin_rechey';

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const messaging = firebase.messaging();

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const userMenu = document.getElementById('user-menu');
        const authButtons = document.getElementById('auth-buttons');
        const userName = document.getElementById('user-name');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const addItemModal = document.getElementById('add-item-modal');
        const editItemModal = document.getElementById('edit-item-modal');
        const itemDetailModal = document.getElementById('item-detail-modal');
        const myItemsModal = document.getElementById('my-items-modal');
        const favoritesModal = document.getElementById('favorites-modal');
        const moderationModal = document.getElementById('moderation-modal');
        const chatModal = document.getElementById('chat-modal');
        const profileEditModal = document.getElementById('profile-edit-modal');
        const settingsModal = document.getElementById('settings-modal');
        const closeLoginModal = document.getElementById('close-login-modal');
        const closeSignupModal = document.getElementById('close-signup-modal');
        const closeAddItemModal = document.getElementById('close-add-item-modal');
        const closeEditItemModal = document.getElementById('close-edit-item-modal');
        const closeItemDetailModal = document.getElementById('close-item-detail-modal');
        const closeMyItemsModal = document.getElementById('close-my-items-modal');
        const closeFavoritesModal = document.getElementById('close-favorites-modal');
        const closeModerationModal = document.getElementById('close-moderation-modal');
        const closeChatModal = document.getElementById('close-chat-modal');
        const closeProfileEditModal = document.getElementById('close-profile-edit-modal');
        const closeSettingsModal = document.getElementById('close-settings-modal');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const addItemForm = document.getElementById('add-item-form');
        const editItemForm = document.getElementById('edit-item-form');
        const profileEditForm = document.getElementById('profile-edit-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const addItemHeroBtn = document.getElementById('add-item-hero-btn');
        const itemsContainer = document.getElementById('items-container');
        const loadingItems = document.getElementById('loading-items');
        const itemsTitle = document.getElementById('items-title');
        const userMenuToggle = document.getElementById('user-menu-toggle');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const chatMenuBtn = document.getElementById('chat-menu-btn');
        const myItemsMenuBtn = document.getElementById('my-items-menu-btn');
        const moderationMenuBtn = document.getElementById('moderation-menu-btn');
        const favoritesMenuBtn = document.getElementById('favorites-menu-btn');
        const profileMenuBtn = document.getElementById('profile-menu-btn');
        const settingsMenuBtn = document.getElementById('settings-menu-btn');
        const logoutMenuBtn = document.getElementById('logout-menu-btn');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendChatMessage = document.getElementById('send-chat-message');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatNotificationBadge = document.getElementById('chat-notification-badge');
        const chatsList = document.getElementById('chats-list');
        const paginationContainer = document.getElementById('pagination-container');
        const toastContainer = document.getElementById('toast-container');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const moderationContainer = document.getElementById('moderation-container');
        const moderationBadge = document.getElementById('moderation-badge');

        // Filter elements
        const filterToggleBtn = document.getElementById('filter-toggle-btn');
        const filterPanel = document.getElementById('filter-panel');
        const regionFilter = document.getElementById('region-filter');
        const cityDistrictFilter = document.getElementById('city-district-filter');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const categoryFilterModal = document.getElementById('category-filter-modal');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const sortOrderSelect = document.getElementById('sort-order');

        // Add item form elements
        const itemRegion = document.getElementById('item-region');
        const itemCityDistrict = document.getElementById('item-city-district');

        // Edit item form elements
        const editItemRegion = document.getElementById('edit-item-region');
        const editItemCityDistrict = document.getElementById('edit-item-city-district');
        const editImagesContainer = document.getElementById('edit-images-container');
        const editAddImage = document.getElementById('edit-add-image');
        const editNewImage = document.getElementById('edit-new-image');

        // Profile elements
        const profileImagePreview = document.getElementById('profile-image-preview');
        const profileImage = document.getElementById('profile-image');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profilePhone = document.getElementById('profile-phone');
        const currentPassword = document.getElementById('current-password');
        const newPassword = document.getElementById('new-password');
        const confirmNewPassword = document.getElementById('confirm-new-password');

        // Settings elements
        const darkThemeToggle = document.getElementById('dark-theme-toggle');
        const pushNotificationsToggle = document.getElementById('push-notifications-toggle');
        const messageNotifications = document.getElementById('message-notifications');
        const itemNotifications = document.getElementById('item-notifications');
        const favoriteNotifications = document.getElementById('favorite-notifications');
        const profileVisibility = document.getElementById('profile-visibility');
        const strangerMessages = document.getElementById('stranger-messages');
        const languageSelect = document.getElementById('language-select');

        // State variables
        let currentUser = null;
        let items = [];
        let filteredItems = [];
        let currentItemId = null;
        let currentChatUserId = null;
        let currentChatUserName = null;
        let itemsPerPage = 6;
        let currentPage = 1;
        let currentCategory = '';
        let uploadedImages = {
            main: null,
            additional: []
        };
        let chatUsers = [];
        let unreadMessages = {};
        let chatListeners = {};
        let favoriteItems = [];
        let profileImageUrl = null;
        let locationsData = {};
        let shareTimeout = null;
        let userPhoneNumber = ''; // Для зберігання номера телефону користувача
        let isAdmin = false;
        let moderationUnsubscribe = null;
        let sortOrder = 'desc';
        let isSubmittingItem = false;

        function normalizeItem(raw) {
            const safe = raw || {};
            const name = safe.name ?? safe.title ?? '';
            const description = safe.description ?? safe.desc ?? '';
            const location = safe.location ?? safe.city ?? safe.region ?? '';
            const imageUrls = Array.isArray(safe.imageUrls)
                ? safe.imageUrls
                : (Array.isArray(safe.photoUrls)
                    ? safe.photoUrls
                    : (Array.isArray(safe.images) ? safe.images : []));
            const userName = safe.userName ?? safe.ownerName ?? safe.ownerDisplayName ?? '';
            const userId = safe.userId ?? safe.ownerId ?? safe.uid ?? '';
            const category = safe.category ?? '';
            const rawType = safe.type ?? safe.itemType ?? safe.price ?? '';
            let type = rawType;
            if (rawType === 'exchange' || rawType === 'swap') {
                type = 'обмін';
            } else if (rawType === 'gift' || rawType === 'free') {
                type = 'подарунок';
            }
            const status = safe.status ?? safe.state ?? 'active';
            const region = safe.region ?? safe.area ?? '';
            const cityDistrict = safe.cityDistrict ?? safe.city ?? safe.district ?? '';
            const ownerEmail = safe.ownerEmail ?? safe.userEmail ?? safe.email ?? '';
            const ownerAvatar = safe.ownerAvatar ?? safe.userAvatar ?? safe.avatar ?? '';

            return {
                ...safe,
                name,
                description,
                location,
                imageUrls,
                userName,
                userId,
                category,
                type,
                status,
                region,
                cityDistrict,
                ownerEmail,
                ownerAvatar
            };
        }

        function getCreatedAtDate(value) {
            if (!value) return new Date(0);
            if (typeof value === 'string') {
                const parsed = Date.parse(value);
                return Number.isNaN(parsed) ? new Date(0) : new Date(parsed);
            }
            if (typeof value.toDate === 'function') return value.toDate();
            if (typeof value.seconds === 'number') return new Date(value.seconds * 1000);
            return new Date(value);
        }

        function applySort(list) {
            const itemsCopy = [...list];
            itemsCopy.sort((a, b) => {
                const aDate = getCreatedAtDate(a.createdAt);
                const bDate = getCreatedAtDate(b.createdAt);
                return sortOrder === 'asc'
                    ? aDate.getTime() - bDate.getTime()
                    : bDate.getTime() - aDate.getTime();
            });
            return itemsCopy;
        }

        function isPublicStatus(status) {
            if (!status) return true;
            return !['pending', 'rejected', 'blocked'].includes(status);
        }

        function slugify(value) {
            const map = {
                'а': 'a',
                'б': 'b',
                'в': 'v',
                'г': 'h',
                'ґ': 'g',
                'д': 'd',
                'е': 'e',
                'є': 'ye',
                'ж': 'zh',
                'з': 'z',
                'и': 'y',
                'і': 'i',
                'ї': 'yi',
                'й': 'y',
                'к': 'k',
                'л': 'l',
                'м': 'm',
                'н': 'n',
                'о': 'o',
                'п': 'p',
                'р': 'r',
                'с': 's',
                'т': 't',
                'у': 'u',
                'ф': 'f',
                'х': 'kh',
                'ц': 'ts',
                'ч': 'ch',
                'ш': 'sh',
                'щ': 'shch',
                'ь': '',
                'ы': 'y',
                'ъ': '',
                'э': 'e',
                'ю': 'yu',
                'я': 'ya'
            };

            const input = String(value || '').toLowerCase();
            let result = '';
            for (const char of input) {
                if (Object.prototype.hasOwnProperty.call(map, char)) {
                    result += map[char];
                } else if (/[a-z0-9]/.test(char)) {
                    result += char;
                } else {
                    result += '-';
                }
            }

            result = result.replace(/-{2,}/g, '-').replace(/^-+|-+$/g, '');
            return result || 'item';
        }

        function getShortCodeFromPath() {
            const path = window.location.pathname.replace(/\/+$/, '');
            if (!path || path === '/') return null;
            const last = path.split('/').pop();
            if (last.includes('_')) {
                const tail = last.split('_').pop();
                if (/^[a-z0-9]{5,10}$/.test(tail)) return tail;
            }
            return null;
        }

        async function resolveShortCode(code) {
            try {
                const doc = await db.collection('short_links').doc(code).get();
                if (!doc.exists) return null;
                const data = doc.data();
                return data && data.itemId ? data.itemId : null;
            } catch (error) {
                console.error('Error resolving short code:', error);
                return null;
            }
        }

        async function createShortCodeForItem(item) {
            try {
                const existing = await db.collection('short_links')
                    .where('itemId', '==', item.id)
                    .limit(1)
                    .get();
                if (!existing.empty) {
                    return existing.docs[0].id;
                }
            } catch (error) {
                console.error('Error checking short link:', error);
            }

            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            for (let attempt = 0; attempt < 5; attempt += 1) {
                let code = '';
                for (let i = 0; i < 6; i += 1) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                const ref = db.collection('short_links').doc(code);
                const doc = await ref.get();
                if (doc.exists) {
                    continue;
                }
                await ref.set({
                    itemId: item.id,
                    slug: slugify(item.name || item.title || 'item'),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return code;
            }
            return item.id;
        }

        // Push notification state
        let pushNotificationsEnabled = true;
        let pushNotificationPermission = 'default';

        // Edit item state
        let editItemImages = []; // Масив URL зображень для редагування
        let newEditImages = []; // Масив нових зображень для додавання

        // Toast Notification System
        class ToastManager {
            constructor() {
                this.container = toastContainer;
                this.toasts = [];
            }

            show(message, options = {}) {
                const {
                    type = 'info',
                    title = '',
                    duration = 4000,
                    closable = true
                } = options;

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const iconMap = {
                    success: 'fa-check',
                    error: 'fa-exclamation-triangle',
                    warning: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                };

                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${iconMap[type] || iconMap.info}"></i>
                    </div>
                    <div class="toast-content">
                        ${title ? `<div class="toast-title">${title}</div>` : ''}
                        <div class="toast-message">${message}</div>
                    </div>
                    ${closable ? '<button class="toast-close">&times;</button>' : ''}
                `;

                this.container.appendChild(toast);

                // Add close functionality
                if (closable) {
                    const closeButton = toast.querySelector('.toast-close');
                    closeButton.addEventListener('click', () => {
                        this.removeToast(toast);
                    });
                }

                // Auto remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        this.removeToast(toast);
                    }, duration);
                }

                // Store reference
                this.toasts.push(toast);

                return toast;
            }

            removeToast(toast) {
                toast.classList.add('closing');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                    this.toasts = this.toasts.filter(t => t !== toast);
                }, 300);
            }

            success(message, options = {}) {
                return this.show(message, { ...options, type: 'success' });
            }

            error(message, options = {}) {
                return this.show(message, { ...options, type: 'error' });
            }

            warning(message, options = {}) {
                return this.show(message, { ...options, type: 'warning' });
            }

            info(message, options = {}) {
                return this.show(message, { ...options, type: 'info' });
            }
        }

        const toast = new ToastManager();

        // Push Notification System
        class PushNotificationManager {
            constructor() {
                this.container = document.body;
                this.notifications = [];
                this.maxNotifications = 5;
            }

            async requestPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    pushNotificationPermission = permission;
                    return permission;
                }
                return 'denied';
            }

            async show(title, message, options = {}) {
                const {
                    icon = 'https://placehold.co/64x64?text=🔔',
                    tag = 'push-notification',
                    requireInteraction = false,
                    data = {}
                } = options;

                // Check if push notifications are enabled
                if (!pushNotificationsEnabled) {
                    return;
                }

                // Try to show browser notification
                if ('Notification' in window && pushNotificationPermission === 'granted') {
                    try {
                        const notification = new Notification(title, {
                            body: message,
                            icon: icon,
                            tag: tag,
                            requireInteraction: requireInteraction,
                            data: data
                        });

                        notification.onclick = function(event) {
                            event.preventDefault();
                            window.focus();
                            if (data.action) {
                                data.action();
                            }
                            notification.close();
                        };

                        // Auto close after 5 seconds
                        setTimeout(() => {
                            notification.close();
                        }, 5000);

                        return notification;
                    } catch (error) {
                        console.warn('Browser notification failed:', error);
                    }
                }

                // Fallback to custom notification
                this.showCustomNotification(title, message, options);
            }

            showCustomNotification(title, message, options = {}) {
                const {
                    icon = '🔔',
                    duration = 5000,
                    action = null
                } = options;

                // Remove oldest notification if we have too many
                if (this.notifications.length >= this.maxNotifications) {
                    const oldest = this.notifications.shift();
                    if (oldest && oldest.parentNode) {
                        oldest.parentNode.removeChild(oldest);
                    }
                }

                const notification = document.createElement('div');
                notification.className = 'push-notification-modal';
                notification.innerHTML = `
                    <div class="push-notification-content">
                        <div class="push-notification-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="push-notification-text">
                            <div class="push-notification-title">${title}</div>
                            <div class="push-notification-message">${message}</div>
                        </div>
                        <button class="push-notification-close">&times;</button>
                    </div>
                `;

                this.container.appendChild(notification);
                this.notifications.push(notification);

                // Add close functionality
                const closeButton = notification.querySelector('.push-notification-close');
                closeButton.addEventListener('click', () => {
                    this.removeNotification(notification);
                });

                // Auto remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        this.removeNotification(notification);
                    }, duration);
                }

                // Add click action if provided
                if (action) {
                    notification.addEventListener('click', action);
                }

                return notification;
            }

            removeNotification(notification) {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    this.notifications = this.notifications.filter(n => n !== notification);
                }, 300);
            }

            // Send push notification to user
            async sendToUser(userId, title, message, data = {}) {
                if (!userId) return;

                try {
                    // Save notification to Firestore
                    await db.collection('notifications').add({
                        userId: userId,
                        title: title,
                        message: message,
                        data: data,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Show notification if user is online
                    if (currentUser && currentUser.uid === userId) {
                        this.show(title, message, { data: data });
                    }
                } catch (error) {
                    console.error('Error sending push notification:', error);
                }
            }
        }

        const pushNotifications = new PushNotificationManager();

        // Filter panel toggle
        filterToggleBtn.addEventListener('click', () => {
            filterPanel.classList.toggle('open');
        });

        // Emoji picker
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
        });

        // Add emoji to input
        document.querySelectorAll('.emoji-item').forEach(emoji => {
            emoji.addEventListener('click', () => {
                chatMessageInput.value += emoji.textContent;
                chatMessageInput.focus();
                emojiPicker.classList.remove('show');
            });
        });

        // Load locations data from locations.json
        async function loadLocationsData() {
            try {
                const response = await fetch('locations.json');
                if (!response.ok) {
                    throw new Error('Failed to load locations data');
                }
                locationsData = await response.json();
                populateRegionFilter();
                populateItemRegionFilter(); // Populate region filter for add item form
                populateEditItemRegionFilter(); // Populate region filter for edit item form
            } catch (error) {
                console.error('Error loading locations data:', error);
                toast.error('Помилка завантаження даних про локації', { title: 'Помилка' });
            }
        }

        // Populate region filter
        function populateRegionFilter() {
            regionFilter.innerHTML = '<option value="">Оберіть область</option>';
            
            Object.keys(locationsData).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });
        }

        // Populate region filter for add item form
        function populateItemRegionFilter() {
            itemRegion.innerHTML = '<option value="">Оберіть область</option>';
            
            Object.keys(locationsData).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                itemRegion.appendChild(option);
            });
        }

        // Populate region filter for edit item form
        function populateEditItemRegionFilter() {
            editItemRegion.innerHTML = '<option value="">Оберіть область</option>';
            
            Object.keys(locationsData).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                editItemRegion.appendChild(option);
            });
        }

        // Populate city/district filter based on selected region
        regionFilter.addEventListener('change', function() {
            const selectedRegion = this.value;
            cityDistrictFilter.innerHTML = '<option value="">Оберіть місто/район</option>';
            
            if (selectedRegion && locationsData[selectedRegion]) {
                const regions = locationsData[selectedRegion];
                
                // Add districts
                Object.keys(regions).forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    option.dataset.type = 'district';
                    cityDistrictFilter.appendChild(option);
                });
                
                // Add cities
                Object.values(regions).forEach(districtData => {
                    districtData.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.name;
                        option.textContent = city.name;
                        option.dataset.type = 'city';
                        cityDistrictFilter.appendChild(option);
                        
                        // Add districts for cities if they exist
                        if (city.districts && city.districts.length > 0) {
                            city.districts.forEach(districtName => {
                                const districtOption = document.createElement('option');
                                districtOption.value = `${city.name} - ${districtName}`;
                                districtOption.textContent = `${city.name} - ${districtName}`;
                                districtOption.dataset.type = 'city-district';
                                cityDistrictFilter.appendChild(districtOption);
                            });
                        }
                    });
                });
            }
        });

        // Populate city/district filter for add item form
        itemRegion.addEventListener('change', function() {
            const selectedRegion = this.value;
            itemCityDistrict.innerHTML = '<option value="">Оберіть місто/район</option>';
            
            if (selectedRegion && locationsData[selectedRegion]) {
                const regions = locationsData[selectedRegion];
                
                // Add districts
                Object.keys(regions).forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    option.dataset.type = 'district';
                    itemCityDistrict.appendChild(option);
                });
                
                // Add cities
                Object.values(regions).forEach(districtData => {
                    districtData.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.name;
                        option.textContent = city.name;
                        option.dataset.type = 'city';
                        itemCityDistrict.appendChild(option);
                        
                        // Add districts for cities if they exist
                        if (city.districts && city.districts.length > 0) {
                            city.districts.forEach(districtName => {
                                const districtOption = document.createElement('option');
                                districtOption.value = `${city.name} - ${districtName}`;
                                districtOption.textContent = `${city.name} - ${districtName}`;
                                districtOption.dataset.type = 'city-district';
                                itemCityDistrict.appendChild(districtOption);
                            });
                        }
                    });
                });
            }
        });

        // Populate city/district filter for edit item form
        editItemRegion.addEventListener('change', function() {
            const selectedRegion = this.value;
            editItemCityDistrict.innerHTML = '<option value="">Оберіть місто/район</option>';
            
            if (selectedRegion && locationsData[selectedRegion]) {
                const regions = locationsData[selectedRegion];
                
                // Add districts
                Object.keys(regions).forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    option.dataset.type = 'district';
                    editItemCityDistrict.appendChild(option);
                });
                
                // Add cities
                Object.values(regions).forEach(districtData => {
                    districtData.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.name;
                        option.textContent = city.name;
                        option.dataset.type = 'city';
                        editItemCityDistrict.appendChild(option);
                        
                        // Add districts for cities if they exist
                        if (city.districts && city.districts.length > 0) {
                            city.districts.forEach(districtName => {
                                const districtOption = document.createElement('option');
                                districtOption.value = `${city.name} - ${districtName}`;
                                districtOption.textContent = `${city.name} - ${districtName}`;
                                districtOption.dataset.type = 'city-district';
                                editItemCityDistrict.appendChild(districtOption);
                            });
                        }
                    });
                });
            }
        });

        // Apply filters
        applyFiltersBtn.addEventListener('click', () => {
            const selectedCategory = categoryFilterModal.value;
            const selectedRegion = regionFilter.value;
            const selectedCityDistrict = cityDistrictFilter.value;
            const searchText = searchInput.value.toLowerCase();
            
            // Filter items based on all criteria
            filteredItems = items.filter(item => {
                // Category filter
                const categoryMatch = !selectedCategory || item.category === selectedCategory;
                
                // Location filter
                let locationMatch = true;
                if (selectedCityDistrict) {
                    locationMatch = item.cityDistrict === selectedCityDistrict;
                } else if (selectedRegion) {
                    locationMatch = item.region === selectedRegion;
                }
                
                // Search text filter
                const searchMatch = !searchText || 
                    (item.name && item.name.toLowerCase().includes(searchText)) || 
                    (item.description && item.description.toLowerCase().includes(searchText));
                
                return categoryMatch && locationMatch && searchMatch;
            });
            
            // Update title
            if (selectedCategory) {
                const categoryNames = {
                    'одяг': 'Одяг',
                    'електроніка': 'Електроніка',
                    'дім': 'Дім',
                    'книги': 'Книги',
                    'спорт': 'Спорт',
                    'транспорт': 'Транспорт'
                };
                itemsTitle.textContent = `Оголошення в категорії: ${categoryNames[selectedCategory]}`;
            } else {
                itemsTitle.textContent = 'Останні оголошення';
            }
            
            currentPage = 1;
            filteredItems = applySort(filteredItems);
            displayItems();
            generatePagination();
            
            // Close the filter panel
            filterPanel.classList.remove('open');
            
            toast.success('Фільтри застосовано', { title: 'Успіх' });
        });

        // Search button handler
        searchBtn.addEventListener('click', () => {
            const searchText = searchInput.value.toLowerCase();
            
            // Filter items based on search text only
            filteredItems = items.filter(item => {
                return !searchText || 
                    (item.name && item.name.toLowerCase().includes(searchText)) || 
                    (item.description && item.description.toLowerCase().includes(searchText));
            });
            
            // Update title
            if (searchText) {
                itemsTitle.textContent = `Результати пошуку: "${searchText}"`;
            } else {
                itemsTitle.textContent = 'Останні оголошення';
            }
            
            currentPage = 1;
            filteredItems = applySort(filteredItems);
            displayItems();
            generatePagination();
        });

        if (sortOrderSelect) {
            sortOrderSelect.addEventListener('change', () => {
                sortOrder = sortOrderSelect.value;
                filteredItems = applySort(filteredItems);
                currentPage = 1;
                displayItems();
                generatePagination();
            });
        }

        // Modals
        function openModal(modal) {
            modal.classList.remove('hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
        }

        // Event Listeners for Modals
        loginBtn.addEventListener('click', () => openModal(loginModal));
        signupBtn.addEventListener('click', () => openModal(signupModal));
        closeLoginModal.addEventListener('click', () => closeModal(loginModal));
        closeSignupModal.addEventListener('click', () => closeModal(signupModal));
        closeAddItemModal.addEventListener('click', () => {
            closeModal(addItemModal);
            resetImageUploads();
        });
        closeEditItemModal.addEventListener('click', () => {
            closeModal(editItemModal);
            resetEditImageUploads();
        });
        closeItemDetailModal.addEventListener('click', () => closeModal(itemDetailModal));
        closeMyItemsModal.addEventListener('click', () => closeModal(myItemsModal));
        closeFavoritesModal.addEventListener('click', () => closeModal(favoritesModal));
        closeModerationModal.addEventListener('click', () => closeModal(moderationModal));
        closeChatModal.addEventListener('click', () => {
            closeModal(chatModal);
            currentChatUserId = null;
            currentChatUserName = null;
            // Stop listening to chat messages when closing modal
            Object.values(chatListeners).forEach(unsubscribe => unsubscribe());
            chatListeners = {};
        });
        closeProfileEditModal.addEventListener('click', () => closeModal(profileEditModal));
        closeSettingsModal.addEventListener('click', () => closeModal(settingsModal));

        showSignup.addEventListener('click', () => {
            closeModal(loginModal);
            openModal(signupModal);
        });

        showLogin.addEventListener('click', () => {
            closeModal(signupModal);
            openModal(loginModal);
        });

        // User menu dropdown
        userMenuToggle.addEventListener('click', (e) => {
            userMenuDropdown.classList.toggle('show');
            e.stopPropagation();
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userMenuToggle.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                userMenuDropdown.classList.remove('show');
            }
        });

        // Menu buttons - check if user is logged in
        function checkAuthAndOpenModal(modalOpener) {
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для доступу до цієї функції', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return false;
            }
            return true;
        }

        // Chat menu button
        chatMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            if (!checkAuthAndOpenModal(openModal)) return;
            openModal(chatModal);
            loadChats();
        });

        // My items menu button
        myItemsMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            if (!checkAuthAndOpenModal(openModal)) return;
            openModal(myItemsModal);
            loadMyItems();
        });

        // Favorites menu button
        favoritesMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            if (!checkAuthAndOpenModal(openModal)) return;
            openModal(favoritesModal);
            loadFavoriteItems();
        });

        // Moderation menu button
        moderationMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            if (!isAdmin) return;
            openModal(moderationModal);
            loadModerationItems();
        });

        // Profile menu button
        profileMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            openProfileEditModal();
        });

        // Settings menu button
        settingsMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            openSettingsModal();
        });

        // Open settings modal
        function openSettingsModal() {
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для доступу до налаштувань', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return;
            }
            
            // Load current settings
            darkThemeToggle.checked = body.classList.contains('dark');
            pushNotificationsToggle.checked = pushNotificationsEnabled;
            openModal(settingsModal);
        }

        // Save settings
        saveSettingsBtn.addEventListener('click', () => {
            // Apply theme setting
            if (darkThemeToggle.checked && !body.classList.contains('dark')) {
                body.classList.remove('light');
                body.classList.add('dark');
                const icon = themeToggle.querySelector('i');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'dark');
            } else if (!darkThemeToggle.checked && !body.classList.contains('light')) {
                body.classList.remove('dark');
                body.classList.add('light');
                const icon = themeToggle.querySelector('i');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'light');
            }
            
            // Apply push notifications setting
            pushNotificationsEnabled = pushNotificationsToggle.checked;
            
            toast.success('Налаштування успішно збережено', { title: 'Успіх' });
            closeModal(settingsModal);
        });

        // Logout menu button
        logoutMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.remove('show');
            auth.signOut()
                .then(() => {
                    toast.success('Ви успішно вийшли з акаунту', { title: 'Вихід' });
                })
                .catch(error => {
                    console.error('Sign out error:', error);
                    toast.error('Помилка виходу: ' + error.message, { title: 'Помилка' });
                });
        });

        // Auth State Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                userName.textContent = user.displayName || user.email.split('@')[0];
                updateChatNotificationBadge();
                // Hide/show menu items based on auth state
                document.getElementById('my-items-menu-btn').parentElement.style.display = 'block';
                document.getElementById('favorites-menu-btn').parentElement.style.display = 'block';
                
                // Load profile data including phone number
                loadProfileData();
                
                // Request push notification permission
                requestPushNotificationPermission();
                
                // Listen for notifications
                listenForNotifications();
            } else {
                currentUser = null;
                isAdmin = false;
                updateAdminUI();
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
                chatNotificationBadge.classList.add('hidden');
                // Hide menu items for non-authenticated users
                document.getElementById('my-items-menu-btn').parentElement.style.display = 'none';
                document.getElementById('favorites-menu-btn').parentElement.style.display = 'none';
            }
        });

        // Request push notification permission
        async function requestPushNotificationPermission() {
            if ('Notification' in window) {
                const permission = await pushNotifications.requestPermission();
                console.log('Push notification permission:', permission);
                
                if (permission === 'granted') {
                    // Try to get FCM token
                    try {
                        const token = await messaging.getToken({ vapidKey: 'BB1VotaVm81Sm8R9nwVnQAXI344Q4w87n9x_pRIdkqPfQjIBD9ssa4BOP9o-XnIRonH9J1s1SAoBFS_ENRaL8RQ' });
                        console.log('FCM token:', token);
                        
                        // Save token to user's document
                        if (currentUser) {
                            await db.collection('users').doc(currentUser.uid).set({
                                fcmToken: token
                            }, { merge: true });
                        }
                    } catch (error) {
                        console.error('Error getting FCM token:', error);
                    }
                }
            }
        }

        // Listen for notifications
        function listenForNotifications() {
            if (!currentUser) return;
            
            // Listen for new notifications in Firestore
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const notification = change.doc.data();
                            pushNotifications.show(notification.title, notification.message, {
                                data: notification.data
                            });
                            
                            // Mark as read after showing
                            setTimeout(async () => {
                                try {
                                    await db.collection('notifications').doc(change.doc.id).update({
                                        read: true
                                    });
                                } catch (error) {
                                    console.error('Error marking notification as read:', error);
                                }
                            }, 1000);
                        }
                    });
                });
        }

        // Load profile data including phone number
        async function loadProfileData() {
            if (!currentUser) return;
            
            try {
                profileName.value = currentUser.displayName || '';
                profileEmail.value = currentUser.email || '';
                
                // Load phone number from Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    profilePhone.value = userData.phoneNumber || '';
                    userPhoneNumber = userData.phoneNumber || '';
                    isAdmin = userData.role === 'admin' || userData.isModerator === true;
                    updateAdminUI();
                }
                
                // Set profile image
                if (currentUser.photoURL) {
                    profileImagePreview.src = currentUser.photoURL;
                } else {
                    profileImagePreview.src = 'https://placehold.co/200x200?text=Фото';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        function updateAdminUI() {
            if (isAdmin) {
                moderationMenuBtn.classList.remove('hidden');
                startModerationListener();
            } else {
                moderationMenuBtn.classList.add('hidden');
                moderationBadge.classList.add('hidden');
                if (moderationUnsubscribe) {
                    moderationUnsubscribe();
                    moderationUnsubscribe = null;
                }
            }
        }

        function startModerationListener() {
            if (!isAdmin) return;
            if (moderationUnsubscribe) {
                moderationUnsubscribe();
            }
            moderationUnsubscribe = db.collection('items')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    const pendingCount = snapshot.size;
                    if (pendingCount > 0) {
                        moderationBadge.textContent = pendingCount;
                        moderationBadge.classList.remove('hidden');
                    } else {
                        moderationBadge.classList.add('hidden');
                    }
                });
        }

        async function loadModerationItems() {
            if (!isAdmin) return;
            moderationContainer.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-gray-400">Завантаження оголошень...</p></div>';

            try {
                const snapshot = await db.collection('items')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    moderationContainer.innerHTML = '<div class="text-center py-8 text-gray-400">Немає оголошень на модерації</div>';
                    return;
                }

                let html = '<div class="space-y-4">';
                snapshot.forEach(doc => {
                    const rawItem = { id: doc.id, ...doc.data() };
                    const item = normalizeItem(rawItem);
                    const imageUrl = (item.imageUrls && item.imageUrls.length > 0)
                        ? item.imageUrls[0]
                        : 'https://placehold.co/200x150?text=Немає+зображення';
                    const createdAt = formatDate(item.createdAt);

                    html += `
                        <div class="border border-gray-700 rounded-lg p-4">
                            <div class="flex gap-4">
                                <img src="${imageUrl}" alt="${item.name}" class="w-24 h-24 object-cover rounded">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-bold text-white">${item.name || 'Без назви'}</h3>
                                            <div class="text-gray-400 text-sm">${item.location || 'Не вказано'}</div>
                                            <div class="text-gray-500 text-xs mt-1">${createdAt}</div>
                                            <div class="text-gray-400 text-xs mt-1">Автор: ${item.userName || 'Користувач'}</div>
                                        </div>
                                        <div class="text-xs text-gray-400">${item.category || ''}</div>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-2">${item.description || ''}</p>
                                    <div class="mt-3">
                                        <textarea class="w-full px-3 py-2 border border-gray-700 rounded-lg bg-gray-800 text-white text-sm moderation-comment" placeholder="Коментар для відмови (необов'язково)"></textarea>
                                    </div>
                                    <div class="mt-3 flex gap-2 justify-end">
                                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm approve-btn" data-id="${item.id}">Схвалити</button>
                                        <button class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm reject-btn" data-id="${item.id}">Відхилити</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                moderationContainer.innerHTML = html;

                moderationContainer.querySelectorAll('.approve-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        await moderateItem(itemId, 'approved', '');
                    });
                });
                moderationContainer.querySelectorAll('.reject-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        const comment = e.currentTarget
                            .closest('.border')
                            .querySelector('.moderation-comment').value.trim();
                        await moderateItem(itemId, 'rejected', comment);
                    });
                });
            } catch (error) {
                console.error('Error loading moderation items:', error);
                moderationContainer.innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження оголошень</div>';
            }
        }

        async function moderateItem(itemId, status, comment) {
            if (!isAdmin) return;
            try {
                await db.collection('items').doc(itemId).update({
                    status: status,
                    moderationComment: comment || null,
                    updatedAt: new Date().toISOString()
                });

                const itemDoc = await db.collection('items').doc(itemId).get();
                if (itemDoc.exists) {
                    const itemData = itemDoc.data();
                    const decisionText = status === 'approved'
                        ? 'Ваше оголошення схвалено'
                        : 'Ваше оголошення відхилено';
                    const body = comment ? `${decisionText}: ${comment}` : decisionText;
                    await db.collection('notifications').add({
                        toUserId: itemData.ownerId || '',
                        fromUserId: currentUser.uid,
                        fromName: currentUser.displayName || 'Модерація',
                        chatId: '',
                        itemId: itemId,
                        action: status === 'approved' ? 'moderation_approved' : 'moderation_rejected',
                        comment: comment || null,
                        title: 'Модерація',
                        body: body,
                        status: 'sent',
                        read: false,
                        createdAt: new Date().toISOString()
                    });
                }

                toast.success('Статус оголошення оновлено', { title: 'Модерація' });
                loadModerationItems();
                loadItems();
            } catch (error) {
                console.error('Error moderating item:', error);
                toast.error('Помилка модерації: ' + error.message, { title: 'Помилка' });
            }
        }

        // Open profile edit modal
        function openProfileEditModal() {
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для доступу до профілю', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return;
            }
            
            loadProfileData();
            openModal(profileEditModal);
        }

        // Profile image upload
        document.querySelector('.profile-image-upload').addEventListener('click', () => {
            profileImage.click();
        });

        profileImage.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Upload to Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const imageData = await response.json();
                profileImageUrl = imageData.secure_url;
                profileImagePreview.src = profileImageUrl;
                
                toast.success('Фото профілю оновлено', { title: 'Успіх' });
            } catch (error) {
                console.error('Error uploading profile image:', error);
                toast.error('Помилка завантаження фото: ' + error.message, { title: 'Помилка' });
            }
        });

        // Profile edit form with phone number
        profileEditForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            try {
                const updates = {
                    displayName: profileName.value
                };
                
                if (profileImageUrl) {
                    updates.photoURL = profileImageUrl;
                }
                
                await currentUser.updateProfile(updates);
                
                // Update email if changed
                if (profileEmail.value !== currentUser.email) {
                    await currentUser.updateEmail(profileEmail.value);
                    toast.info('На вашу нову пошту надіслано лист для підтвердження', { title: 'Зміна email' });
                }
                
                // Update phone number in Firestore
                await db.collection('users').doc(currentUser.uid).set({
                    phoneNumber: profilePhone.value
                }, { merge: true });
                
                toast.success('Профіль успішно оновлено', { title: 'Успіх' });
                closeModal(profileEditModal);
            } catch (error) {
                console.error('Error updating profile:', error);
                toast.error('Помилка оновлення профілю: ' + error.message, { title: 'Помилка' });
            }
        });

        // Change password form
        changePasswordForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            if (newPassword.value !== confirmNewPassword.value) {
                toast.warning('Нові паролі не співпадають', { title: 'Помилка' });
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword.value
                );
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPassword.value);
                
                toast.success('Пароль успішно змінено. На вашу пошту надіслано підтвердження', { title: 'Успіх' });
                changePasswordForm.reset();
                closeModal(profileEditModal);
            } catch (error) {
                console.error('Error changing password:', error);
                toast.error('Помилка зміни пароля: ' + error.message, { title: 'Помилка' });
            }
        });

        // Login Form
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    toast.success('Ви успішно увійшли в акаунт', { title: 'Успішний вхід' });
                    closeModal(loginModal);
                    loginForm.reset();
                })
                .catch(error => {
                    console.error('Login error:', error.message);
                    toast.error('Помилка входу: ' + error.message, { title: 'Помилка' });
                });
        });

        // Signup Form with phone number
        signupForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            if (password !== confirmPassword) {
                toast.warning('Паролі не співпадають', { title: 'Помилка реєстрації' });
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Update user profile
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(async (userCredential) => {
                    // Save phone number to Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        phoneNumber: phone
                    });
                    toast.success('Ви успішно зареєструвались', { title: 'Успішна реєстрація' });
                    closeModal(signupModal);
                    signupForm.reset();
                })
                .catch(error => {
                    console.error('Signup error:', error.message);
                    toast.error('Помилка реєстрації: ' + error.message, { title: 'Помилка' });
                });
        });

        // Image Upload Handlers
        document.getElementById('main-image-upload').addEventListener('click', () => {
            document.getElementById('main-image').click();
        });

        document.getElementById('main-image').addEventListener('change', function(e) {
            handleImageUpload(e, 'main');
        });

        // Additional image uploads
        document.querySelectorAll('.additional-image-upload').forEach(uploadDiv => {
            uploadDiv.addEventListener('click', () => {
                const index = uploadDiv.dataset.index;
                document.querySelector(`.additional-image-input[data-index="${index}"]`).click();
            });
        });

        document.querySelectorAll('.additional-image-input').forEach(input => {
            input.addEventListener('change', function(e) {
                const index = this.dataset.index;
                handleAdditionalImageUpload(e, index);
            });
        });

        // Handle main image upload
        function handleImageUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                if (type === 'main') {
                    document.getElementById('main-image-preview-img').src = event.target.result;
                    document.getElementById('main-image-preview').classList.remove('hidden');
                    uploadedImages.main = file;
                }
            };
            reader.readAsDataURL(file);
        }

        // Handle additional image upload
        function handleAdditionalImageUpload(e, index) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                // Remove existing preview for this index if exists
                const existingPreview = document.querySelector(`.additional-preview[data-index="${index}"]`);
                if (existingPreview) {
                    existingPreview.remove();
                }

                // Create new preview
                const previewContainer = document.createElement('div');
                previewContainer.className = 'image-preview additional-preview';
                previewContainer.dataset.index = index;
                previewContainer.innerHTML = `
                    <img src="${event.target.result}" alt="Additional ${index}" class="w-full h-32 object-cover rounded">
                    <div class="remove-image" data-index="${index}">×</div>
                `;
                
                document.getElementById('additional-images-preview').appendChild(previewContainer);
                
                // Store the file
                uploadedImages.additional[index] = file;
                
                // Add event listener to remove button
                previewContainer.querySelector('.remove-image').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const idx = this.dataset.index;
                    delete uploadedImages.additional[idx];
                    previewContainer.remove();
                    // Reset the input
                    document.querySelector(`.additional-image-input[data-index="${idx}"]`).value = '';
                });
            };
            reader.readAsDataURL(file);
        }

        // Remove main image
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-image') && e.target.dataset.input === 'main-image') {
                document.getElementById('main-image').value = '';
                document.getElementById('main-image-preview').classList.add('hidden');
                uploadedImages.main = null;
            }
        });

        // Reset image uploads
        function resetImageUploads() {
            document.getElementById('main-image').value = '';
            document.getElementById('main-image-preview').classList.add('hidden');
            document.getElementById('additional-images-preview').innerHTML = '';
            document.querySelectorAll('.additional-image-input').forEach(input => input.value = '');
            uploadedImages = {
                main: null,
                additional: []
            };
        }

        // Reset edit image uploads
        function resetEditImageUploads() {
            editImagesContainer.innerHTML = '';
            editItemImages = [];
            newEditImages = [];
            document.getElementById('edit-new-image').value = '';
        }

        // Add Item Form
        addItemForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для додавання оголошення', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return;
            }
            
            const name = document.getElementById('item-name').value;
            const category = document.getElementById('item-category').value;
            const description = document.getElementById('item-description').value;
            const region = document.getElementById('item-region').value;
            const cityDistrict = document.getElementById('item-city-district').value;
            const type = document.getElementById('item-type').value;
            const ownerName = currentUser.displayName || currentUser.email.split('@')[0];
            const ownerEmail = currentUser.email || '';
            const normalizedType = type === 'обмін' ? 'exchange' : 'gift';
            
            if (!uploadedImages.main) {
                toast.warning('Будь ласка, завантажте головне фото', { title: 'Помилка' });
                return;
            }

            if (isSubmittingItem) return;
            isSubmittingItem = true;
            const submitButton = addItemForm.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Відправляємо...';
            }
            
            // Create location string
            const location = cityDistrict || region || 'Не вказано';
            const city = cityDistrict || region || '';
            
            try {
                // Upload images to Cloudinary
                const imageUrls = [];
                
                // Upload main image
                const mainImageUrl = await uploadImageToCloudinary(uploadedImages.main);
                imageUrls.push(mainImageUrl);
                
                // Upload additional images
                for (let i = 1; i <= 3; i++) {
                    if (uploadedImages.additional[i]) {
                        const additionalImageUrl = await uploadImageToCloudinary(uploadedImages.additional[i]);
                        imageUrls.push(additionalImageUrl);
                    }
                }
                
                // Save item to Firestore
                const itemData = {
                    name,
                    title: name,
                    category,
                    description,
                    desc: description,
                    location,
                    city,
                    region,
                    cityDistrict,
                    type: normalizedType,
                    typeLabel: type,
                    price: type === 'обмін' ? 'Обмін' : 'Подарунок',
                    imageUrls,
                    images: imageUrls,
                    photoUrls: imageUrls,
                    localImagePaths: [],
                    photoPaths: [],
                    mainImageIndex: 0,
                    userId: currentUser.uid,
                    userName: ownerName,
                    ownerId: currentUser.uid,
                    ownerName: ownerName,
                    ownerEmail: ownerEmail,
                    ownerAvatar: currentUser.photoURL || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    likes: 0,
                    views: 0
                };
                
                const itemRef = await db.collection('items').add(itemData);
                
                // Send push notification only for approved items
                if (itemNotifications.checked && itemData.status === 'approved') {
                    sendNewItemNotification(itemData, itemRef.id);
                }
                
                toast.success('Оголошення відправлено на модерацію', { title: 'Успіх' });
                closeModal(addItemModal);
                addItemForm.reset();
                resetImageUploads();
                loadItems();
            } catch (error) {
                console.error('Error adding item:', error);
                toast.error('Помилка додавання оголошення: ' + error.message, { title: 'Помилка' });
            } finally {
                isSubmittingItem = false;
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Додати оголошення';
                }
            }
        });

        // Send new item notification
        async function sendNewItemNotification(itemData, itemId) {
            const title = 'Нове оголошення';
            const message = `Нове оголошення: ${itemData.name} (${itemData.category})`;
            const data = {
                action: () => {
                    showItemDetail(itemId);
                }
            };
            
            // Send to all users (in a real app, you might want to filter by location/category)
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                pushNotifications.sendToUser(doc.id, title, message, data);
            });
        }

        // Edit Item Form - Updated version
        editItemForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для редагування оголошення', { title: 'Потрібна авторизація' });
                return;
            }
            
            const itemId = document.getElementById('edit-item-id').value;
            const name = document.getElementById('edit-item-name').value;
            const category = document.getElementById('edit-item-category').value;
            const description = document.getElementById('edit-item-description').value;
            const region = document.getElementById('edit-item-region').value;
            const cityDistrict = document.getElementById('edit-item-city-district').value;
            const type = document.getElementById('edit-item-type').value;
            const status = document.getElementById('edit-item-status').value;
            
            // Create location string
            const location = cityDistrict || region || 'Не вказано';
            
            try {
                // Prepare update data
                const updateData = {
                    name,
                    category,
                    description,
                    location,
                    region,
                    cityDistrict,
                    type,
                    status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Handle image updates
                let imageUrls = [...editItemImages]; // Start with existing images
                
                // Remove images marked for deletion
                const imagesToRemove = Array.from(editImagesContainer.querySelectorAll('.edit-image-preview.marked-for-removal'))
                    .map(img => img.dataset.url);
                
                imageUrls = imageUrls.filter(url => !imagesToRemove.includes(url));
                
                // Upload new images
                for (const file of newEditImages) {
                    const newImageUrl = await uploadImageToCloudinary(file);
                    imageUrls.push(newImageUrl);
                }
                
                // Update imageUrls if there are changes
                if (imageUrls.length !== editItemImages.length || 
                    imageUrls.some((url, i) => url !== editItemImages[i]) ||
                    newEditImages.length > 0) {
                    updateData.imageUrls = imageUrls;
                }
                
                // Update item in Firestore
                await db.collection('items').doc(itemId).update(updateData);
                
                toast.success('Оголошення успішно оновлено!', { title: 'Успіх' });
                closeModal(editItemModal);
                loadItems();
                loadMyItems();
            } catch (error) {
                console.error('Error updating item:', error);
                toast.error('Помилка оновлення оголошення: ' + error.message, { title: 'Помилка' });
            }
        });

        // Upload image to Cloudinary
        async function uploadImageToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });
            
            const imageData = await response.json();
            return imageData.secure_url;
        }

        // Add Item Button (Hero Section)
        addItemHeroBtn.addEventListener('click', () => {
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для додавання оголошення', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return;
            }
            openModal(addItemModal);
        });

        // Category card click handler
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', function() {
                const category = this.dataset.category;
                currentCategory = category;
                filterItemsByCategory(category);
            });
        });

        // Filter items by category
        function filterItemsByCategory(category) {
            const categoryNames = {
                'одяг': 'Одяг',
                'електроніка': 'Електроніка',
                'дім': 'Дім',
                'книги': 'Книги',
                'спорт': 'Спорт',
                'транспорт': 'Транспорт'
            };
            
            itemsTitle.textContent = `Оголошення в категорії: ${categoryNames[category]}`;
            categoryFilterModal.value = category;
            
            filteredItems = items.filter(item => item.category === category);
            currentPage = 1;
            displayItems();
            generatePagination();
            
            // Scroll to items section
            document.getElementById('items').scrollIntoView({ behavior: 'smooth' });
        }

        // Load Items from Firestore
        async function loadItems() {
            try {
                loadingItems.classList.remove('hidden');
                const snapshot = await db.collection('items')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                items = [];
                snapshot.forEach(doc => {
                    items.push(normalizeItem({ id: doc.id, ...doc.data() }));
                });
                items = items.filter(item => isPublicStatus(item.status));
                
                // If we have a current category, filter by it
                if (currentCategory) {
                    filteredItems = items.filter(item => item.category === currentCategory);
                } else {
                    filteredItems = [...items];
                }
                filteredItems = applySort(filteredItems);
                
                displayItems();
                generatePagination();
            } catch (error) {
                console.error('Error loading items:', error);
                loadingItems.innerHTML = '<p class="text-red-400 text-center">Помилка завантаження оголошень</p>';
                toast.error('Помилка завантаження оголошень', { title: 'Помилка' });
            }
        }

        // Display Items
        function displayItems() {
            loadingItems.classList.add('hidden');
            
            if (filteredItems.length === 0) {
                itemsContainer.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-400">Оголошень не знайдено</p></div>';
                return;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
            const itemsToShow = filteredItems.slice(startIndex, endIndex);
            
            itemsContainer.innerHTML = '';
            
            itemsToShow.forEach(item => {
                const itemElement = createItemCard(item);
                itemsContainer.appendChild(itemElement);
            });
        }

        // Generate Pagination
        function generatePagination() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `<button class="prev-page" data-page="${currentPage - 1}">&laquo;</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHtml += `<button class="active" data-page="${i}">${i}</button>`;
                } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `<button data-page="${i}">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += `<span>...</span>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `<button class="next-page" data-page="${currentPage + 1}">&raquo;</button>`;
            }
            
            paginationContainer.innerHTML = paginationHtml;
            
            // Add event listeners to pagination buttons
            document.querySelectorAll('#pagination-container button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const page = parseInt(e.target.dataset.page);
                    if (page) {
                        currentPage = page;
                        displayItems();
                        generatePagination();
                        // Scroll to top of items section
                        document.getElementById('items').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        // Create Item Card
        function createItemCard(item) {
            const normalized = normalizeItem(item);
            // Check if item has imageUrls and at least one image
            const imageUrl = (normalized.imageUrls && normalized.imageUrls.length > 0) 
                ? normalized.imageUrls[0] 
                : 'https://placehold.co/400x300?text=Немає+зображення';
            
            const card = document.createElement('div');
            card.className = 'item-card rounded-xl shadow-md overflow-hidden cursor-pointer';
            card.innerHTML = `
                <div class="h-48 bg-gray-800 relative">
                    <img src="${imageUrl}" alt="${normalized.name}" class="w-full h-full object-cover">
                    <div class="absolute top-3 right-3 bg-${normalized.type === 'обмін' ? 'secondary' : 'accent'} text-white px-3 py-1 rounded-full text-sm font-bold">
                        ${normalized.type === 'обмін' ? 'Обмін' : 'Подарунок'}
                    </div>
                    ${normalized.status === 'exchanged' ? '<div class="absolute top-3 left-3 bg-gray-700 text-white px-2 py-1 rounded-full text-xs">Обмінено</div>' : ''}
                    <button class="favorite-btn absolute top-3 left-3 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center" data-item-id="${item.id}">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="share-btn absolute top-3 left-12 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center" data-item-id="${item.id}">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-white">${normalized.name || 'Без назви'}</h3>
                        <div class="text-accent font-bold">${normalized.location || ''}</div>
                    </div>
                    <p class="text-gray-400 mt-2">${normalized.description ? normalized.description.substring(0, 100) + (normalized.description.length > 100 ? '...' : '') : 'Немає опису'}</p>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-gray-500 text-sm">
                            <i class="far fa-clock mr-1"></i> ${formatDate(normalized.createdAt)}
                        </div>
                        <div class="flex items-center">
                            <i class="far fa-heart text-gray-500 mr-1"></i>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => showItemDetail(normalized.id));
            
            // Add favorite button functionality
            const favoriteBtn = card.querySelector('.favorite-btn');
            favoriteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(normalized.id);
            });
            
            // Add share button functionality
            const shareBtn = card.querySelector('.share-btn');
            shareBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                shareItem(normalized);
            });
            
            return card;
        }

        // Toggle favorite item
        async function toggleFavorite(itemId) {
            if (!currentUser) {
                toast.warning('Будь ласка, увійдіть для додавання до обраних', { title: 'Потрібна авторизація' });
                openModal(loginModal);
                return;
            }
            
            try {
                const favoriteRef = db.collection('favorites').doc(`${currentUser.uid}_${itemId}`);
                const favoriteDoc = await favoriteRef.get();
                
                if (favoriteDoc.exists) {
                    // Remove from favorites
                    await favoriteRef.delete();
                    toast.success('Оголошення видалено з обраних', { title: 'Обране' });
                } else {
                    // Add to favorites
                    await favoriteRef.set({
                        userId: currentUser.uid,
                        itemId: itemId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    toast.success('Оголошення додано до обраних', { title: 'Обране' });
                    
                    // Send notification to item owner
                    if (favoriteNotifications.checked) {
                        const itemDoc = await db.collection('items').doc(itemId).get();
                        if (itemDoc.exists && itemDoc.data().userId !== currentUser.uid) {
                            const title = 'Нове обране';
                            const message = `${currentUser.displayName || 'Користувач'} додав ваше оголошення до обраних`;
                            pushNotifications.sendToUser(itemDoc.data().userId, title, message);
                        }
                    }
                }
                
                // Оновлення UI
                if (!favoritesModal.classList.contains('hidden')) {
                    loadFavoriteItems();
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                toast.error('Помилка додавання до обраних: ' + error.message, { title: 'Помилка' });
            }
        }

        // Share item with improved functionality
        async function shareItem(item) {
            // Create share text based on item type and status
            let shareText = '';
            const title = item.name || item.title || 'Оголошення';
            const description = item.description || item.desc || '';
            const location = item.location || item.city || '';

            if (item.type === 'обмін') {
                shareText = `Цікава річ для обміну: ${title}\n\n${description}\n\n`;
            } else {
                shareText = `Цікавий подарунок: ${title}\n\n${description}\n\n`;
            }
            
            // Add location information
            if (location) {
                shareText += `📍 ${location}\n\n`;
            }
            
            // Add link to item with correct format
            const shortCode = await createShortCodeForItem(item);
            const slug = slugify(title) || 'item';
            const itemUrl = `${window.location.origin}/${slug}_${shortCode}`;
            shareText += `🔗 Детальніше: ${itemUrl}`;
            
            // Clear any existing timeout
            if (shareTimeout) {
                clearTimeout(shareTimeout);
            }
            
            // Try to use Web Share API first
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: shareText,
                    url: itemUrl
                }).catch(error => {
                    console.log('Error sharing:', error);
                    // Fallback to clipboard
                    copyToClipboard(shareText, item);
                });
            } else {
                // Fallback to clipboard
                copyToClipboard(shareText, item);
            }
            
            // Set timeout to prevent multiple clicks
            shareTimeout = setTimeout(() => {
                shareTimeout = null;
            }, 2000);
        }

        // Copy to clipboard with improved message
        function copyToClipboard(text, item) {
            navigator.clipboard.writeText(text).then(() => {
                const title = item.name || item.title || 'Оголошення';
                toast.success(`Посилання на оголошення "${title}" скопійовано до буфера обміну`, { title: 'Успіх' });
            }).catch(err => {
                toast.error('Помилка копіювання посилання', { title: 'Помилка' });
                console.error('Failed to copy: ', err);
            });
        }

        // Load Favorite Items
        async function loadFavoriteItems() {
            if (!currentUser) return;
            
            try {
                const favoritesContainer = document.getElementById('favorites-container');
                favoritesContainer.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-gray-400">Завантаження обраних оголошень...</p></div>';
                
                // Get favorite item IDs
                const favoritesSnapshot = await db.collection('favorites')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                if (favoritesSnapshot.empty) {
                    favoritesContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-heart text-3xl text-gray-500 mb-2"></i>
                            <p class="text-gray-400">У вас ще немає обраних оголошень</p>
                        </div>
                    `;
                    return;
                }
                
                const favoriteIds = favoritesSnapshot.docs.map(doc => doc.data().itemId);
                
                // Get favorite items
                const favoriteItems = [];
                for (const itemId of favoriteIds) {
                    const itemDoc = await db.collection('items').doc(itemId).get();
                    if (itemDoc.exists) {
                        favoriteItems.push(normalizeItem({ id: itemDoc.id, ...itemDoc.data() }));
                    }
                }
                
                if (favoriteItems.length === 0) {
                    favoritesContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-heart text-3xl text-gray-500 mb-2"></i>
                            <p class="text-gray-400">У вас ще немає обраних оголошень</p>
                        </div>
                    `;
                    return;
                }
                
                let favoritesHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                favoriteItems.forEach(item => {
                    const imageUrl = (item.imageUrls && item.imageUrls.length > 0) 
                        ? item.imageUrls[0] 
                        : 'https://placehold.co/200x150?text=Немає+зображення';
                    
                    favoritesHtml += `
                        <div class="border border-gray-700 rounded-lg p-4 flex">
                            <img src="${imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4">
                            <div class="flex-1">
                                <h3 class="font-bold text-white">${item.name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="inline-block w-3 h-3 rounded-full mr-2 status-${item.status}"></span>
                                    <span class="text-sm text-gray-400">${getStatusText(item.status)}</span>
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    <button class="view-item-btn text-blue-400 hover:text-blue-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-eye"></i> Переглянути
                                    </button>
                                    <button class="remove-favorite-btn text-red-400 hover:text-red-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-trash"></i> Видалити
                                    </button>
                                    <button class="share-favorite-btn text-green-400 hover:text-green-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-share-alt"></i> Поділитися
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                favoritesHtml += '</div>';
                favoritesContainer.innerHTML = favoritesHtml;
                
                // Add event listeners
                document.querySelectorAll('.view-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        showItemDetail(itemId);
                        closeModal(favoritesModal);
                    });
                });
                
                document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        try {
                            await db.collection('favorites').doc(`${currentUser.uid}_${itemId}`).delete();
                            toast.success('Оголошення видалено з обраних', { title: 'Обране' });
                            loadFavoriteItems();
                        } catch (error) {
                            console.error('Error removing favorite:', error);
                            toast.error('Помилка видалення з обраних: ' + error.message, { title: 'Помилка' });
                        }
                    });
                });
                
                // Add share button event listeners
                document.querySelectorAll('.share-favorite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        const item = favoriteItems.find(i => i.id === itemId);
                        if (item) {
                            shareItem(item);
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error loading favorite items:', error);
                document.getElementById('favorites-container').innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження обраних оголошень</div>';
                toast.error('Помилка завантаження обраних оголошень', { title: 'Помилка' });
            }
        }

        // Format Date
        function formatDate(timestamp) {
            if (!timestamp) return 'Невідомо';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) return 'Сьогодні';
                if (diffDays === 2) return 'Вчора';
                if (diffDays <= 7) return `${diffDays - 1} днів тому`;
                return date.toLocaleDateString('uk-UA');
            } catch (e) {
                return 'Невідомо';
            }
        }

        // Show Item Detail with phone number visibility
        async function showItemDetail(itemId) {
            try {
                const doc = await db.collection('items').doc(itemId).get();
                if (!doc.exists) {
                    toast.error('Оголошення не знайдено', { title: 'Помилка' });
                    return;
                }
                
                const item = normalizeItem({ id: doc.id, ...doc.data() });
                currentItemId = item.id;
                
                // Get owner's phone number if current user is logged in
                let phoneHtml = '';
                if (currentUser) {
                    try {
                    const ownerDoc = await db.collection('users').doc(item.userId).get();
                        if (ownerDoc.exists) {
                            const ownerData = ownerDoc.data();
                            if (ownerData.phoneNumber) {
                                phoneHtml = `<div class="mt-2"><span class="text-gray-500">📞</span> <span class="phone-number">${ownerData.phoneNumber}</span></div>`;
                            }
                        }
                    } catch (error) {
                        console.error('Error getting owner phone:', error);
                    }
                } else {
                    phoneHtml = `<div class="mt-2"><span class="hidden-phone">📞 Увійдіть для перегляду номера телефону</span></div>`;
                }
                
                const itemDetailContent = document.getElementById('item-detail-content');
                let imagesHtml = '';
                
                // Check if item has imageUrls
                if (item.imageUrls && item.imageUrls.length > 0) {
                    imagesHtml = `
                        <div class="h-80 bg-gray-800 rounded-xl overflow-hidden mb-4">
                            <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-full object-cover" id="main-detail-image">
                        </div>
                    `;
                    
                    if (item.imageUrls.length > 1) {
                        imagesHtml += '<div class="flex justify-center mt-4 space-x-2">';
                        item.imageUrls.forEach((url, index) => {
                            imagesHtml += `
                                <div class="w-16 h-16 bg-gray-800 rounded-lg overflow-hidden cursor-pointer thumbnail ${index === 0 ? 'thumbnail-active' : ''}" data-index="${index}">
                                    <img src="${url}" alt="Thumbnail ${index}" class="w-full h-full object-cover">
                                </div>
                            `;
                        });
                        imagesHtml += '</div>';
                    }
                } else {
                    imagesHtml = `
                        <div class="h-80 bg-gray-800 rounded-xl overflow-hidden mb-4 flex items-center justify-center">
                            <span class="text-gray-500">Немає зображень</span>
                        </div>
                    `;
                }
                
                itemDetailContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            ${imagesHtml}
                        </div>
                        <div>
                            <div class="flex justify-between items-start">
                                <h2 class="text-2xl font-bold text-white">${item.name || 'Без назви'}</h2>
                                <div class="bg-${item.type === 'обмін' ? 'secondary' : 'accent'} text-white px-3 py-1 rounded-full text-sm font-bold">
                                    ${item.type === 'обмін' ? 'Обмін' : 'Подарунок'}
                                </div>
                            </div>
                            <div class="flex items-center mt-2 text-accent font-bold">
                                <i class="fas fa-map-marker-alt mr-2"></i> ${item.location || 'Не вказано'}
                            </div>
                            ${item.status === 'exchanged' ? '<div class="mt-2 bg-gray-700 text-white px-2 py-1 rounded-full text-xs inline-block">Обмінено</div>' : ''}
                            <div class="mt-4">
                                <h3 class="text-lg font-bold text-white">Опис</h3>
                                <p class="text-gray-400 mt-2">${item.description || 'Немає опису'}</p>
                                ${phoneHtml}
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-bold text-white">Контакти власника</h3>
                                <div class="flex items-center mt-4">
                                    <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white mr-4">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-white">${item.userName || 'Користувач'}</div>
                                        <div class="text-gray-400">Зареєстрований користувач</div>
                                    </div>
                                </div>
                                <div class="mt-4 flex space-x-3">
                                    <button id="contact-owner-btn" class="flex-1 bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">
                                        <i class="fas fa-envelope mr-2"></i> Зв'язатися з власником
                                    </button>
                                    <button id="favorite-item-btn" class="bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-bold hover:bg-gray-600 transition">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <button id="share-item-btn" class="share-button text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-500 transition">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add thumbnail click handlers if thumbnails exist
                const thumbnails = document.querySelectorAll('.thumbnail');
                if (thumbnails.length > 0) {
                    thumbnails.forEach(thumb => {
                        thumb.addEventListener('click', function() {
                            const index = this.dataset.index;
                            document.getElementById('main-detail-image').src = item.imageUrls[index];
                            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('thumbnail-active'));
                            this.classList.add('thumbnail-active');
                        });
                    });
                }
                
                document.getElementById('contact-owner-btn').addEventListener('click', () => {
                    if (!currentUser) {
                        toast.warning('Будь ласка, увійдіть для зв\'язку з власником', { title: 'Потрібна авторизація' });
                        openModal(loginModal);
                        return;
                    }
                    
                    // Prevent sending messages to yourself
                    if (item.userId === currentUser.uid) {
                        toast.warning('Ви не можете надсилати повідомлення самому собі', { title: 'Помилка' });
                        return;
                    }
                    
                    openModal(chatModal);
                    currentChatUserId = item.userId;
                    currentChatUserName = item.userName || 'Користувач';
                    document.getElementById('current-chat-user').textContent = `Чат з ${currentChatUserName}`;
                    loadChatMessages(currentChatUserId, currentChatUserName);
                });
                
                document.getElementById('favorite-item-btn').addEventListener('click', () => {
                    toggleFavorite(itemId);
                });
                
                // Add share button functionality
                document.getElementById('share-item-btn').addEventListener('click', () => {
                    shareItem(item);
                });
                
                openModal(itemDetailModal);
            } catch (error) {
                console.error('Error loading item detail:', error);
                toast.error('Помилка завантаження оголошення', { title: 'Помилка' });
            }
        }

        // Load My Items
        async function loadMyItems() {
            if (!currentUser) return;
            
            try {
                const myItemsContainer = document.getElementById('my-items-container');
                myItemsContainer.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-gray-400">Завантаження ваших оголошень...</p></div>';
                
                const snapshot = await db.collection('items')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    myItemsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-list text-3xl text-gray-500 mb-2"></i>
                            <p class="text-gray-400">У вас ще немає оголошень</p>
                            <button id="add-first-item-btn" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-500 transition">Додати перше оголошення</button>
                        </div>
                    `;
                    document.getElementById('add-first-item-btn').addEventListener('click', () => {
                        closeModal(myItemsModal);
                        openModal(addItemModal);
                    });
                    return;
                }
                
                let myItemsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                snapshot.forEach(doc => {
                    const item = normalizeItem({ id: doc.id, ...doc.data() });
                    const imageUrl = (item.imageUrls && item.imageUrls.length > 0) 
                        ? item.imageUrls[0] 
                        : 'https://placehold.co/200x150?text=Немає+зображення';
                    
                    myItemsHtml += `
                        <div class="border border-gray-700 rounded-lg p-4 flex">
                            <img src="${imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4">
                            <div class="flex-1">
                                <h3 class="font-bold text-white">${item.name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="inline-block w-3 h-3 rounded-full mr-2 status-${item.status}"></span>
                                    <span class="text-sm text-gray-400">${getStatusText(item.status)}</span>
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    <button class="edit-item-btn text-blue-400 hover:text-blue-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-edit"></i> Редагувати
                                    </button>
                                    <button class="delete-item-btn text-red-400 hover:text-red-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-trash"></i> Видалити
                                    </button>
                                    <button class="share-my-item-btn text-green-400 hover:text-green-300 text-sm" data-id="${item.id}">
                                        <i class="fas fa-share-alt"></i> Поділитися
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                myItemsHtml += '</div>';
                myItemsContainer.innerHTML = myItemsHtml;
                
                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        editItem(itemId);
                    });
                });
                
                document.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        deleteItem(itemId);
                    });
                });
                
                // Add share button event listeners
                document.querySelectorAll('.share-my-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        const item = items.find(i => i.id === itemId);
                        if (item) {
                            shareItem(item);
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error loading my items:', error);
                document.getElementById('my-items-container').innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження ваших оголошень</div>';
                toast.error('Помилка завантаження ваших оголошень', { title: 'Помилка' });
            }
        }

        // Get status text
        function getStatusText(status) {
            switch (status) {
                case 'active': return 'Активне';
                case 'approved': return 'Активне';
                case 'pending': return 'На модерації';
                case 'rejected': return 'Відхилено';
                case 'inactive': return 'Неактивне';
                case 'exchanged': return 'Обмінене';
                default: return 'Невідомо';
            }
        }

        // Edit Item - Updated version
        async function editItem(itemId) {
            try {
                const doc = await db.collection('items').doc(itemId).get();
                if (!doc.exists) {
                    toast.error('Оголошення не знайдено', { title: 'Помилка' });
                    return;
                }
                
                const item = normalizeItem({ id: doc.id, ...doc.data() });
                
                // Fill form with item data
                document.getElementById('edit-item-id').value = item.id;
                document.getElementById('edit-item-name').value = item.name || '';
                document.getElementById('edit-item-category').value = item.category || '';
                document.getElementById('edit-item-description').value = item.description || '';
                document.getElementById('edit-item-region').value = item.region || '';
                document.getElementById('edit-item-city-district').value = item.cityDistrict || '';
                document.getElementById('edit-item-type').value = item.type || 'обмін';
                document.getElementById('edit-item-status').value = item.status || 'active';
                
                // Initialize edit images
                editItemImages = item.imageUrls || [];
                newEditImages = [];
                
                // Display existing images
                displayEditImages();
                
                closeModal(myItemsModal);
                openModal(editItemModal);
            } catch (error) {
                console.error('Error loading item for edit:', error);
                toast.error('Помилка завантаження оголошення для редагування', { title: 'Помилка' });
            }
        }

        // Display existing images in edit form
        function displayEditImages() {
            editImagesContainer.innerHTML = '';
            
            editItemImages.forEach((url, index) => {
                const imagePreview = document.createElement('div');
                imagePreview.className = 'edit-image-preview relative inline-block mr-2 mb-2';
                imagePreview.dataset.url = url;
                imagePreview.innerHTML = `
                    <img src="${url}" alt="Existing ${index}" class="w-24 h-24 object-cover rounded">
                    <div class="edit-remove-image absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer">
                        ×
                    </div>
                `;
                
                editImagesContainer.appendChild(imagePreview);
                
                // Add event listener to remove button
                imagePreview.querySelector('.edit-remove-image').addEventListener('click', function() {
                    // Mark image for removal
                    imagePreview.classList.add('marked-for-removal');
                    imagePreview.style.opacity = '0.5';
                    imagePreview.querySelector('.edit-remove-image').textContent = '↺';
                    imagePreview.querySelector('.edit-remove-image').classList.add('undo-remove');
                    
                    // Add undo functionality
                    imagePreview.querySelector('.edit-remove-image').addEventListener('click', function() {
                        imagePreview.classList.remove('marked-for-removal');
                        imagePreview.style.opacity = '1';
                        imagePreview.querySelector('.edit-remove-image').textContent = '×';
                        imagePreview.querySelector('.edit-remove-image').classList.remove('undo-remove');
                    });
                });
            });
        }

        // Add new image to edit form
        editAddImage.addEventListener('click', () => {
            editNewImage.click();
        });

        editNewImage.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                // Add to new images array
                newEditImages.push(file);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'edit-image-preview relative inline-block mr-2 mb-2';
                    imagePreview.innerHTML = `
                        <img src="${event.target.result}" alt="New image" class="w-24 h-24 object-cover rounded">
                        <div class="edit-remove-image absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer">
                            ×
                        </div>
                    `;
                    
                    editImagesContainer.appendChild(imagePreview);
                    
                    // Add event listener to remove button
                    imagePreview.querySelector('.edit-remove-image').addEventListener('click', function() {
                        // Remove from new images array
                        const index = newEditImages.indexOf(file);
                        if (index > -1) {
                            newEditImages.splice(index, 1);
                        }
                        imagePreview.remove();
                    });
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input
            e.target.value = '';
        });

        // Delete Item
        async function deleteItem(itemId) {
            if (!confirm('Ви впевнені, що хочете видалити це оголошення?')) {
                return;
            }
            
            try {
                await db.collection('items').doc(itemId).delete();
                toast.success('Оголошення успішно видалено!', { title: 'Успіх' });
                loadMyItems();
                loadItems();
            } catch (error) {
                console.error('Error deleting item:', error);
                toast.error('Помилка видалення оголошення: ' + error.message, { title: 'Помилка' });
            }
        }

        // Load Chats from Firestore with real-time updates
        async function loadChats() {
            if (!currentUser) return;
            
            try {
                chatsList.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-gray-400">Завантаження чатів...</p></div>';
                
                // Listen for chat rooms where current user is a participant
                const unsubscribe = db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .onSnapshot(snapshot => {
                        chatUsers = [];
                        
                        // Process chat rooms
                        snapshot.forEach(doc => {
                            const chatData = doc.data();
                            const otherUserId = chatData.participants.find(id => id !== currentUser.uid);
                            
                            if (otherUserId) {
                                // Get the other user's data
                                db.collection('users').doc(otherUserId).get().then(userDoc => {
                                    const userData = userDoc.exists ? userDoc.data() : { displayName: 'Невідомий користувач' };
                                    
                                    // Get the last message
                                    db.collection('chats')
                                        .doc(doc.id)
                                        .collection('messages')
                                        .orderBy('timestamp', 'desc')
                                        .limit(1)
                                        .get()
                                        .then(lastMessageSnapshot => {
                                            let lastMessage = 'Немає повідомлень';
                                            let lastMessageTime = '';
                                            
                                            if (!lastMessageSnapshot.empty) {
                                                const lastMsg = lastMessageSnapshot.docs[0].data();
                                                lastMessage = lastMsg.text;
                                                lastMessageTime = formatDate(lastMsg.timestamp);
                                            }
                                            
                                            chatUsers.push({
                                                id: otherUserId,
                                                chatId: doc.id,
                                                name: userData.displayName || 'Користувач',
                                                lastMessage: lastMessage,
                                                time: lastMessageTime
                                            });
                                            
                                            // Sort and display chats
                                            chatUsers.sort((a, b) => {
                                                return b.time.localeCompare(a.time);
                                            });
                                            displayChats();
                                        });
                                });
                            }
                        });
                    }, error => {
                        console.error('Error listening to chats:', error);
                        chatsList.innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження чатів</div>';
                        toast.error('Помилка завантаження чатів', { title: 'Помилка' });
                    });
                
                // Store the unsubscribe function to stop listening later
                chatListeners['chats'] = unsubscribe;
                
                // Select first chat if available
                if (chatUsers.length > 0 && !currentChatUserId) {
                    const firstChat = chatUsers[0];
                    currentChatUserId = firstChat.id;
                    currentChatUserName = firstChat.name;
                    document.getElementById('current-chat-user').textContent = `Чат з ${firstChat.name}`;
                    loadChatMessages(firstChat.id, firstChat.name);
                }
                
            } catch (error) {
                console.error('Error loading chats:', error);
                chatsList.innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження чатів</div>';
                toast.error('Помилка завантаження чатів', { title: 'Помилка' });
            }
        }

        // Display chats in the sidebar
        function displayChats() {
            let chatsHtml = '';
            
            if (chatUsers.length === 0) {
                chatsHtml = '<div class="text-center py-8 text-gray-500"><p>У вас ще немає чатів</p></div>';
            } else {
                chatUsers.forEach(user => {
                    chatsHtml += `
                        <div class="chat-user p-2 rounded-lg cursor-pointer hover:bg-gray-800 mb-1 flex justify-between items-center" data-user-id="${user.id}" data-chat-id="${user.chatId}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white mr-2">
                                    <i class="fas fa-user text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-white">${user.name}</div>
                                    <div class="text-gray-400 text-xs truncate max-w-[120px]">${user.lastMessage}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-gray-500 text-xs">${user.time}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            chatsList.innerHTML = chatsHtml;
            
            // Add click handlers for chat users
            document.querySelectorAll('.chat-user').forEach(userDiv => {
                userDiv.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    const chatId = this.dataset.chatId;
                    const user = chatUsers.find(u => u.id === userId);
                    
                    if (user) {
                        currentChatUserId = userId;
                        currentChatUserName = user.name;
                        document.getElementById('current-chat-user').textContent = `Чат з ${user.name}`;
                        
                        // Remove active class from all users and add to current
                        document.querySelectorAll('.chat-user').forEach(u => u.classList.remove('active'));
                        this.classList.add('active');
                        
                        loadChatMessages(userId, user.name, chatId);
                    }
                });
            });
        }

        // Load Chat Messages from Firestore with real-time updates
        async function loadChatMessages(userId, userName, chatId) {
            if (!currentUser) return;
            
            // Prevent sending messages to yourself
            if (userId === currentUser.uid) {
                toast.warning('Ви не можете надсилати повідомлення самому собі', { title: 'Помилка' });
                closeModal(chatModal);
                return;
            }
            
            // Stop listening to previous chat if any
            Object.values(chatListeners).forEach(unsubscribe => unsubscribe());
            chatListeners = {};
            
            // Clear chat messages container
            chatMessagesContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Завантаження повідомлень...</div>';
            
            try {
                let chatRoomId = chatId;
                
                // If chatId is not provided, find or create chat room
                if (!chatRoomId) {
                    chatRoomId = await getOrCreateChatRoom(currentUser.uid, userId);
                }
                
                // Listen for new messages in real-time with full document updates
                const unsubscribe = db.collection('chats')
                    .doc(chatRoomId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snapshot => {
                        // Handle added messages
                        snapshot.docChanges().forEach(change => {
                            if (change.type === "added") {
                                const message = change.doc.data();
                                const isCurrentUser = message.senderId === currentUser.uid;
                                
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `flex mb-3 ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
                                messageDiv.innerHTML = `
                                    <div class="${isCurrentUser ? 'bg-primary text-white rounded-lg rounded-tr-none' : 'bg-gray-700 rounded-lg rounded-tl-none'} p-3 max-w-xs">
                                        <div class="font-bold text-sm message-sender-name">${isCurrentUser ? 'Ви' : userName}</div>
                                        <div class="mt-1 text-sm message-text">${message.text}</div>
                                        <div class="text-xs message-time mt-1">${formatMessageTime(message.timestamp)}</div>
                                    </div>
                                    ${!isCurrentUser ? `
                                        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white ml-2 flex-shrink-0">
                                            <i class="fas fa-user text-xs"></i>
                                        </div>
                                    ` : ''}
                                `;
                                
                                chatMessagesContainer.appendChild(messageDiv);
                                
                                // Scroll to bottom
                                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                                
                                // Mark message as read if not from current user
                                if (!isCurrentUser && !message.read) {
                                    markMessageAsRead(change.doc.id, message.senderId);
                                }
                                
                                // Send push notification if message is not from current user
                                if (!isCurrentUser && messageNotifications.checked) {
                                    const title = `Нове повідомлення від ${userName}`;
                                    const messageText = message.text.length > 50 ? message.text.substring(0, 50) + '...' : message.text;
                                    pushNotifications.sendToUser(currentUser.uid, title, messageText);
                                }
                            }
                            
                            // Handle modified messages (real-time status updates)
                            if (change.type === "modified") {
                                const message = change.doc.data();
                                const isCurrentUser = message.senderId === currentUser.uid;
                                
                                // Update message display if needed
                                const messageElements = chatMessagesContainer.querySelectorAll('.message-element');
                                messageElements.forEach(el => {
                                    if (el.dataset.messageId === change.doc.id) {
                                        // Update read status or other properties
                                        if (message.read) {
                                            el.classList.add('read');
                                        }
                                    }
                                });
                            }
                        });
                    }, error => {
                        console.error('Error listening to messages:', error);
                        chatMessagesContainer.innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження повідомлень</div>';
                        toast.error('Помилка завантаження повідомлень', { title: 'Помилка' });
                    });
                
                // Store the unsubscribe function to stop listening later
                chatListeners[chatRoomId] = unsubscribe;
                
                // Enable message sending
                sendChatMessage.disabled = false;
                chatMessageInput.disabled = false;
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
                chatMessagesContainer.innerHTML = '<div class="text-center py-4 text-red-400">Помилка завантаження повідомлень</div>';
                toast.error('Помилка завантаження повідомлень', { title: 'Помилка' });
            }
        }

        // Mark message as read with security check
        async function markMessageAsRead(messageId, senderId) {
            if (!currentUser) return;
            
            try {
                // Find chat between users
                const chatQuery = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                let chatDoc = null;
                chatQuery.forEach(doc => {
                    const data = doc.data();
                    if (data.participants.includes(senderId)) {
                        chatDoc = doc;
                    }
                });
                
                if (chatDoc) {
                    // Security check: ensure current user is a participant
                    const chatData = chatDoc.data();
                    if (chatData.participants.includes(currentUser.uid)) {
                        // Update message status
                        await db.collection('chats')
                            .doc(chatDoc.id)
                            .collection('messages')
                            .doc(messageId)
                            .update({ 
                                read: true,
                                readAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    }
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
            }
        }

        // Format message time
        function formatMessageTime(timestamp) {
            if (!timestamp) return 'Щойно';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffMinutes < 1) return 'Щойно';
                if (diffMinutes < 60) return `${diffMinutes} хв тому`;
                
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) return `${diffHours} год тому`;
                
                return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return 'Щойно';
            }
        }

        // Get or create chat room
        async function getOrCreateChatRoom(userId1, userId2) {
            // Try to find existing chat room
            const chatQuery = await db.collection('chats')
                .where('participants', 'in', [[userId1, userId2], [userId2, userId1]])
                .get();
            
            if (!chatQuery.empty) {
                return chatQuery.docs[0].id;
            }
            
            // Create new chat room
            const newChatRef = await db.collection('chats').add({
                participants: [userId1, userId2],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            return newChatRef.id;
        }

        // Send Chat Message with security check
        sendChatMessage.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = chatMessageInput.value.trim();
            if (!message || !currentUser || !currentChatUserId) return;
            
            // Prevent sending messages to yourself
            if (currentChatUserId === currentUser.uid) {
                toast.warning('Ви не можете надсилати повідомлення самому собі', { title: 'Помилка' });
                return;
            }
            
            try {
                // Get or create chat room
                const chatRoomId = await getOrCreateChatRoom(currentUser.uid, currentChatUserId);
                
                // Security check: ensure current user is a participant
                const chatDoc = await db.collection('chats').doc(chatRoomId).get();
                if (!chatDoc.exists) {
                    throw new Error('Chat room not found');
                }
                
                const chatData = chatDoc.data();
                if (!chatData.participants.includes(currentUser.uid)) {
                    throw new Error('Unauthorized access to chat room');
                }
                
                // Add message to Firestore
                await db.collection('chats').doc(chatRoomId).collection('messages').add({
                    text: message,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });
                
                // Clear input
                chatMessageInput.value = '';
                
                // Update last message in chat list
                const chatUser = chatUsers.find(u => u.id === currentChatUserId);
                if (chatUser) {
                    chatUser.lastMessage = message;
                    chatUser.time = 'Щойно';
                    displayChats();
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                toast.error('Помилка надсилання повідомлення: ' + error.message, { title: 'Помилка' });
            }
        }

        // Update chat notification badge
        function updateChatNotificationBadge() {
            const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
            if (totalUnread > 0) {
                chatNotificationBadge.textContent = totalUnread;
                chatNotificationBadge.classList.remove('hidden');
            } else {
                chatNotificationBadge.classList.add('hidden');
            }
        }

        // Filter Items
        function filterItems() {
            const category = categoryFilterModal.value;
            const region = regionFilter.value;
            
            // Update current category
            currentCategory = category;
            
            // Update title
            if (category) {
                const categoryNames = {
                    'одяг': 'Одяг',
                    'електроніка': 'Електроніка',
                    'дім': 'Дім',
                    'книги': 'Книги',
                    'спорт': 'Спорт',
                    'транспорт': 'Транспорт'
                };
                itemsTitle.textContent = `Оголошення в категорії: ${categoryNames[category]}`;
            } else {
                itemsTitle.textContent = 'Останні оголошення';
            }
            
            filteredItems = items.filter(item => {
                const categoryMatch = !category || item.category === category;
                const regionMatch = !region || item.region === region;
                return categoryMatch && regionMatch;
            });
            
            currentPage = 1;
            displayItems();
            generatePagination();
        }

        // Event Listeners for Filters
        categoryFilterModal.addEventListener('change', filterItems);
        regionFilter.addEventListener('change', filterItems);

        // Virtual Assistant Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const assistantToggle = document.getElementById('assistant-toggle');
            const virtualAssistant = document.getElementById('virtual-assistant');
            const closeAssistant = document.getElementById('close-assistant');
            const faqItems = document.querySelectorAll('.faq-item');
            
            // Toggle assistant visibility
            assistantToggle.addEventListener('click', function() {
                if (virtualAssistant.classList.contains('visible')) {
                    virtualAssistant.classList.remove('visible');
                    setTimeout(() => {
                        virtualAssistant.style.display = 'none';
                    }, 300);
                } else {
                    virtualAssistant.style.display = 'flex';
                    setTimeout(() => {
                        virtualAssistant.classList.add('visible');
                    }, 10);
                }
            });
            
            // Close assistant
            closeAssistant.addEventListener('click', function() {
                virtualAssistant.classList.remove('visible');
                setTimeout(() => {
                    virtualAssistant.style.display = 'none';
                }, 300);
            });
            
            // FAQ accordion functionality
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                question.addEventListener('click', () => {
                    item.classList.toggle('active');
                });
            });
            
            // Initial setup
            virtualAssistant.style.display = 'none';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
            loadLocationsData();
            
            // Check if there's an item ID in the URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item') || urlParams.get('id');
            if (itemId) {
                showItemDetail(itemId);
                return;
            }
            const shortCode = getShortCodeFromPath();
            if (shortCode) {
                resolveShortCode(shortCode).then(resolvedId => {
                    if (resolvedId) {
                        showItemDetail(resolvedId);
                    }
                });
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', e => {
            if (e.target === loginModal) closeModal(loginModal);
            if (e.target === signupModal) closeModal(signupModal);
            if (e.target === addItemModal) closeModal(addItemModal);
            if (e.target === editItemModal) closeModal(editItemModal);
            if (e.target === itemDetailModal) closeModal(itemDetailModal);
            if (e.target === myItemsModal) closeModal(myItemsModal);
            if (e.target === favoritesModal) closeModal(favoritesModal);
            if (e.target === chatModal) closeModal(chatModal);
            if (e.target === profileEditModal) closeModal(profileEditModal);
            if (e.target === settingsModal) closeModal(settingsModal);
        });
    </script>

    <!-- Password Reset Modal -->
    <div id="password-reset-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="modal-content rounded-xl w-full max-w-md p-8 relative">
            <button id="close-password-reset-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6 text-white">Відновлення пароля</h2>
            <form id="password-reset-form">
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2" for="reset-email">Email</label>
                    <input type="email" id="reset-email" class="w-full px-4 py-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-500 transition">Надіслати лист</button>
            </form>
        </div>
    </div>

</body>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const forgotLink = document.querySelector('#login-form a.text-primary');
    const resetModal = document.getElementById('password-reset-modal');
    const closeResetModal = document.getElementById('close-password-reset-modal');
    const resetForm = document.getElementById('password-reset-form');
    const resetEmail = document.getElementById('reset-email');

    function showToast(type, title, message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div class="toast-icon"></div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close">&times;</button>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('closing'), 3800);
        setTimeout(() => toast.remove(), 4200);
    }

    if (forgotLink) {
        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetModal.classList.remove('hidden');
        });
    }

    if (closeResetModal) {
        closeResetModal.addEventListener('click', () => {
            resetModal.classList.add('hidden');
        });
    }

    resetModal.addEventListener('click', (e) => {
        if (e.target === resetModal) resetModal.classList.add('hidden');
    });

    if (resetForm) {
        resetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = resetEmail.value.trim();
            if (!email) return;
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    showToast('success', 'Успіх', 'Лист для відновлення надіслано.');
                    resetModal.classList.add('hidden');
                })
                .catch(err => {
                    showToast('error', 'Помилка', err.message);
                });
        });
    }
});
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(reg => console.log("✅ Service Worker зарегистрирован:", reg))
    .catch(err => console.error("❌ Ошибка регистрации SW:", err));
}
</script>

</html>
