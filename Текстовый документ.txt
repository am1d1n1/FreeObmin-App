import 'dart:async';
import 'dart:convert';
import 'dart:io';
import 'dart:math';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:image_picker/image_picker.dart';
import 'package:dotted_border/dotted_border.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:share_plus/share_plus.dart';
import 'package:app_links/app_links.dart';

// Firebase imports
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:onesignal_flutter/onesignal_flutter.dart';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
    FlutterLocalNotificationsPlugin();

const String _oneSignalAppId = 'b70a149b-e101-4140-8868-7301d0a5d4fc';
const String _pushServerUrl =
    'https://freeobmin-push-server.onrender.com/notify';
const String _cloudinaryCloudName = 'dgjrkh7oj';
const String _cloudinaryUploadPreset = 'obmin_rechey';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
  SystemChrome.setEnabledSystemUIMode(SystemUiMode.edgeToEdge);
  SystemChrome.setSystemUIOverlayStyle(const SystemUiOverlayStyle(
    systemNavigationBarColor: Colors.transparent,
    systemNavigationBarDividerColor: Colors.transparent,
    systemNavigationBarIconBrightness: Brightness.light,
    statusBarColor: Colors.transparent,
    statusBarIconBrightness: Brightness.light,
  ));

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
  await FirebaseService.initialize();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  await _initNotifications();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OneSignal
  await _initOneSignal();

  runApp(const NeoObminApp());
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
Future<void> _initNotifications() async {
  const AndroidInitializationSettings initializationSettingsAndroid =
      AndroidInitializationSettings('@mipmap/ic_launcher');

  const InitializationSettings initializationSettings = InitializationSettings(
    android: initializationSettingsAndroid,
  );

  await flutterLocalNotificationsPlugin.initialize(initializationSettings);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OneSignal
Future<void> _initOneSignal() async {
  OneSignal.initialize(_oneSignalAppId);
  await OneSignal.Notifications.requestPermission(true);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
Future<void> _showTestNotification() async {
  const AndroidNotificationDetails androidPlatformChannelSpecifics =
      AndroidNotificationDetails(
    'neoobmin_channel',
    'NeoObmin Notifications',
    channelDescription: '–ö–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π NeoObmin',
    importance: Importance.max,
    priority: Priority.high,
    ticker: 'ticker',
  );

  const NotificationDetails platformChannelSpecifics = NotificationDetails(
    android: androidPlatformChannelSpecifics,
  );

  await flutterLocalNotificationsPlugin.show(
    0,
    'NeoObmin',
    '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! üéâ',
    platformChannelSpecifics,
  );
}

/* ============================================================
   FIREBASE SERVICE
============================================================ */

enum ConnectionState { connecting, connected, disconnected }

class FirebaseService {
  static ConnectionState connectionState = ConnectionState.connecting;

  static FirebaseAuth? auth;
  static FirebaseFirestore? firestore;
  // Cloudinary is used for image uploads.

  static Future<void> initialize() async {
    try {
      connectionState = ConnectionState.connecting;
      print('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...');

      if (Firebase.apps.isEmpty) {
        try {
          await Firebase.initializeApp(
            options: const FirebaseOptions(
              apiKey: "AIzaSyAevP47EVaXhBnax9v110pjToNTR4XuQa0",
              appId: "1:654932840054:android:8981cc54a7875a5b89d957",
              messagingSenderId: "654932840054",
              projectId: "swap-e9630",
              storageBucket: "swap-e9630.appspot.com",
            ),
          );
        } on FirebaseException catch (e) {
          if (e.code != 'duplicate-app') rethrow;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
      auth = FirebaseAuth.instance;
      firestore = FirebaseFirestore.instance;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      print('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore...');
      try {
        await firestore!
            .collection('test_connection')
            .limit(1)
            .get()
            .timeout(const Duration(seconds: 10));

        connectionState = ConnectionState.connected;
        print('‚úÖ Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } on TimeoutException {
        print('‚è∞ –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore');
        connectionState = ConnectionState.disconnected;
      } catch (e) {
        print('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: $e');
        connectionState = ConnectionState.connected;
      }
    } catch (e) {
      print('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: $e');
      connectionState = ConnectionState.disconnected;
    }
  }
}

/* ============================================================
   NEOOBMIN ‚Ä¢ –£–õ–¨–¢–†–ê-–°–û–í–†–ï–ú–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù
============================================================ */

class NeoObminApp extends StatelessWidget {
  const NeoObminApp({super.key});

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: neoStore,
      builder: (_, __) {
        return MaterialApp(
          debugShowCheckedModeBanner: false,
          title: 'NeoObmin',
          navigatorKey: _rootNavKey,
          themeMode: neoStore.themeMode,
          theme: _buildLightTheme(),
          darkTheme: _buildDarkTheme(),
          home: const NeoRoot(),
        );
      },
    );
  }

  ThemeData _buildLightTheme() {
    final color = NeoThemes.currentColor;
    const surface = Color(0xFFFFFFFF);
    const background = Color(0xFFF1F4F6);
    const onSurface = Color(0xFF12161C);

    final baseScheme = ColorScheme.fromSeed(
      seedColor: color,
      brightness: Brightness.light,
    ).copyWith(
      surface: surface,
      surfaceContainerHighest: const Color(0xFFE8EDF1),
      surfaceContainer: const Color(0xFFF2F5F7),
      onSurface: onSurface,
      outline: const Color(0xFFD7DEE6),
      outlineVariant: const Color(0xFFE3E9EF),
    );

    final textTheme = GoogleFonts.manropeTextTheme().copyWith(
      displayLarge: const TextStyle(
        fontSize: 34,
        fontWeight: FontWeight.w800,
        height: 1.1,
        letterSpacing: -0.6,
      ),
      displayMedium: const TextStyle(
        fontSize: 28,
        fontWeight: FontWeight.w700,
        height: 1.15,
        letterSpacing: -0.4,
      ),
      titleLarge: const TextStyle(
        fontSize: 20,
        fontWeight: FontWeight.w700,
        height: 1.3,
      ),
      titleMedium: const TextStyle(
        fontSize: 17,
        fontWeight: FontWeight.w600,
        height: 1.35,
      ),
      bodyLarge: const TextStyle(
        fontSize: 16,
        fontWeight: FontWeight.w500,
        height: 1.5,
      ),
      bodyMedium: const TextStyle(
        fontSize: 14,
        fontWeight: FontWeight.w500,
        height: 1.5,
      ),
      labelLarge: const TextStyle(
        fontSize: 13,
        fontWeight: FontWeight.w600,
        letterSpacing: 0.2,
      ),
    ).apply(
      bodyColor: onSurface,
      displayColor: onSurface,
    );

    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      colorScheme: baseScheme,
      scaffoldBackgroundColor: background,
      textTheme: textTheme,
      appBarTheme: AppBarTheme(
        backgroundColor: surface,
        elevation: 0,
        centerTitle: false,
        surfaceTintColor: Colors.transparent,
        foregroundColor: onSurface,
        iconTheme: const IconThemeData(color: onSurface),
        titleTextStyle: textTheme.titleLarge?.copyWith(
          fontWeight: FontWeight.w700,
        ),
      ),
      cardTheme: CardThemeData(
        elevation: 0,
        color: surface,
        margin: EdgeInsets.zero,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
          side: const BorderSide(color: Color(0xFFE2E8EF)),
        ),
        surfaceTintColor: Colors.transparent,
      ),
      dialogTheme: DialogThemeData(
        backgroundColor: surface,
        surfaceTintColor: Colors.transparent,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: baseScheme.surfaceContainerHighest,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(
            color: color.withAlpha(140),
            width: 2,
          ),
        ),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 18, vertical: 14),
        floatingLabelBehavior: FloatingLabelBehavior.never,
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          textStyle: textTheme.labelLarge?.copyWith(
            fontWeight: FontWeight.w700,
            letterSpacing: 0.2,
          ),
          elevation: 0,
          shadowColor: Colors.transparent,
          surfaceTintColor: Colors.transparent,
        ),
      ),
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: OutlinedButton.styleFrom(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          side: BorderSide(color: color.withAlpha(100)),
          textStyle: textTheme.labelLarge,
          backgroundColor: Colors.transparent,
        ),
      ),
      textButtonTheme: TextButtonThemeData(
        style: TextButton.styleFrom(
          foregroundColor: color,
          textStyle: textTheme.labelLarge,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
          ),
        ),
      ),
      iconTheme: const IconThemeData(size: 22, color: onSurface),
      dividerTheme: const DividerThemeData(
        color: Color(0xFFE4EAF0),
        thickness: 1,
        space: 0,
      ),
      chipTheme: ChipThemeData(
        backgroundColor: color.withAlpha(20),
        deleteIconColor: color,
        selectedColor: color.withAlpha(50),
        secondarySelectedColor: color.withAlpha(80),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 5),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10),
          side: BorderSide(color: color.withAlpha(80)),
        ),
        labelStyle: textTheme.labelLarge?.copyWith(color: color),
        secondaryLabelStyle: textTheme.labelLarge?.copyWith(color: Colors.white),
        brightness: Brightness.light,
      ),
      listTileTheme: ListTileThemeData(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(14),
        ),
        tileColor: baseScheme.surface,
      ),
      bottomNavigationBarTheme: BottomNavigationBarThemeData(
        backgroundColor: baseScheme.surface,
        selectedItemColor: color,
        unselectedItemColor: onSurface.withAlpha(140),
        elevation: 0,
      ),
      tabBarTheme: TabBarThemeData(
        labelColor: color,
        unselectedLabelColor: onSurface.withAlpha(140),
        indicator: BoxDecoration(
          borderRadius: BorderRadius.circular(10),
          color: color.withAlpha(24),
        ),
      ),
      floatingActionButtonTheme: FloatingActionButtonThemeData(
        backgroundColor: color,
        foregroundColor: Colors.white,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
      ),
    );
  }

  ThemeData _buildDarkTheme() {
    final color = NeoThemes.currentColor;
    const surface = Color(0xFF151A21);
    const background = Color(0xFF0E1116);
    const onSurface = Color(0xFFE6ECF2);

    final baseScheme = ColorScheme.fromSeed(
      seedColor: color,
      brightness: Brightness.dark,
    ).copyWith(
      surface: surface,
      surfaceContainerHighest: const Color(0xFF1C2430),
      surfaceContainer: const Color(0xFF191F2A),
      onSurface: onSurface,
      outline: const Color(0xFF2A3442),
      outlineVariant: const Color(0xFF202834),
    );

    final textTheme = GoogleFonts.manropeTextTheme().copyWith(
      displayLarge: const TextStyle(
        fontSize: 34,
        fontWeight: FontWeight.w800,
        height: 1.1,
        letterSpacing: -0.6,
      ),
      displayMedium: const TextStyle(
        fontSize: 28,
        fontWeight: FontWeight.w700,
        height: 1.15,
        letterSpacing: -0.4,
      ),
      titleLarge: const TextStyle(
        fontSize: 20,
        fontWeight: FontWeight.w700,
        height: 1.3,
      ),
      titleMedium: const TextStyle(
        fontSize: 17,
        fontWeight: FontWeight.w600,
        height: 1.35,
      ),
      bodyLarge: const TextStyle(
        fontSize: 16,
        fontWeight: FontWeight.w500,
        height: 1.5,
      ),
      bodyMedium: const TextStyle(
        fontSize: 14,
        fontWeight: FontWeight.w500,
        height: 1.5,
      ),
      labelLarge: const TextStyle(
        fontSize: 13,
        fontWeight: FontWeight.w600,
        letterSpacing: 0.2,
      ),
    ).apply(
      bodyColor: onSurface,
      displayColor: onSurface,
    );

    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      colorScheme: baseScheme,
      scaffoldBackgroundColor: background,
      textTheme: textTheme,
      appBarTheme: AppBarTheme(
        backgroundColor: surface,
        elevation: 0,
        centerTitle: false,
        surfaceTintColor: Colors.transparent,
        foregroundColor: onSurface,
        iconTheme: const IconThemeData(color: onSurface),
        titleTextStyle: textTheme.titleLarge?.copyWith(
          fontWeight: FontWeight.w700,
        ),
      ),
      cardTheme: CardThemeData(
        elevation: 0,
        color: surface,
        margin: EdgeInsets.zero,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
          side: const BorderSide(color: Color(0xFF273141)),
        ),
        surfaceTintColor: Colors.transparent,
      ),
      dialogTheme: DialogThemeData(
        backgroundColor: surface,
        surfaceTintColor: Colors.transparent,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: baseScheme.surfaceContainerHighest,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(
            color: color.withAlpha(140),
            width: 2,
          ),
        ),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 18, vertical: 14),
        floatingLabelBehavior: FloatingLabelBehavior.never,
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          textStyle: textTheme.labelLarge?.copyWith(
            fontWeight: FontWeight.w700,
            letterSpacing: 0.2,
          ),
          elevation: 0,
          shadowColor: Colors.transparent,
          surfaceTintColor: Colors.transparent,
        ),
      ),
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: OutlinedButton.styleFrom(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          side: BorderSide(color: color.withAlpha(100)),
          textStyle: textTheme.labelLarge,
          backgroundColor: Colors.transparent,
        ),
      ),
      textButtonTheme: TextButtonThemeData(
        style: TextButton.styleFrom(
          foregroundColor: color,
          textStyle: textTheme.labelLarge,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
          ),
        ),
      ),
      iconTheme: const IconThemeData(size: 22, color: onSurface),
      dividerTheme: const DividerThemeData(
        color: Color(0xFF232C37),
        thickness: 1,
        space: 0,
      ),
      chipTheme: ChipThemeData(
        backgroundColor: color.withAlpha(34),
        deleteIconColor: color,
        selectedColor: color.withAlpha(70),
        secondarySelectedColor: color.withAlpha(100),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 5),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10),
          side: BorderSide(color: color.withAlpha(80)),
        ),
        labelStyle: textTheme.labelLarge?.copyWith(color: color),
        secondaryLabelStyle: textTheme.labelLarge?.copyWith(color: Colors.white),
        brightness: Brightness.dark,
      ),
      listTileTheme: ListTileThemeData(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(14),
        ),
        tileColor: baseScheme.surface,
      ),
      bottomNavigationBarTheme: BottomNavigationBarThemeData(
        backgroundColor: baseScheme.surface,
        selectedItemColor: color,
        unselectedItemColor: onSurface.withAlpha(140),
        elevation: 0,
      ),
      tabBarTheme: TabBarThemeData(
        labelColor: color,
        unselectedLabelColor: onSurface.withAlpha(140),
        indicator: BoxDecoration(
          borderRadius: BorderRadius.circular(10),
          color: color.withAlpha(24),
        ),
      ),
      floatingActionButtonTheme: FloatingActionButtonThemeData(
        backgroundColor: color,
        foregroundColor: Colors.white,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
      ),
    );
  }
}

/* ===========================
        NEO THEMES
=========================== */

class NeoThemes {
  static final List<Color> themeColors = [
    const Color(0xFF18A957), // Avito green
    const Color(0xFF2A6DF4), // Avito blue
    const Color(0xFF23B7A8), // Teal
    const Color(0xFF8BC34A), // Lime
    const Color(0xFF00A3FF), // Sky
    const Color(0xFFF5A524), // Amber
    const Color(0xFFE53935), // Red
    const Color(0xFF7E57C2), // Violet
  ];

  static final List<Color> neonColors = [
    const Color(0xFF2ECC71), // Brighter green
    const Color(0xFF5C8DFF), // Brighter blue
    const Color(0xFF44CFC1), // Brighter teal
    const Color(0xFFA7D971), // Brighter lime
    const Color(0xFF4CC3FF), // Brighter sky
    const Color(0xFFFFC55A), // Brighter amber
    const Color(0xFFFF6F6B), // Brighter red
    const Color(0xFFA184FF), // Brighter violet
  ];

  static final List<String> themeNames = [
    '–ò–Ω–¥–∏–≥–æ',
    '–§–∏–æ–ª–µ—Ç',
    '–†–æ–∑–æ–≤—ã–π',
    '–ò–∑—É–º—Ä—É–¥',
    '–õ–∞–∑—É—Ä—å',
    '–Ø–Ω—Ç–∞—Ä—å',
    '–ö—Ä–∞—Å–Ω—ã–π',
    '–¶–∏–∞–Ω'
  ];

  static Color get currentColor => themeColors[neoStore.selectedThemeIndex];
  static Color get currentNeon => neonColors[neoStore.selectedThemeIndex];

  static Gradient getPrimaryGradient(Color color) {
    return LinearGradient(
      colors: [
        color.withAlpha(220),
        color.withAlpha(140),
      ],
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      stops: const [0.0, 1.0],
    );
  }

  static Gradient getCardGradient(bool isDark) {
    return LinearGradient(
      colors: isDark
          ? [
              const Color(0xFF18202B),
              const Color(0xFF141A22),
            ]
          : [
              const Color(0xFFFFFFFF),
              const Color(0xFFF2F5F7),
            ],
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
    );
  }

  static Gradient getBlurGradient(bool isDark) {
    return LinearGradient(
      colors: isDark
          ? [
              Colors.black.withAlpha(77),
              Colors.black.withAlpha(26),
            ]
          : [
              Colors.white.withAlpha(204),
              Colors.white.withAlpha(77),
            ],
      begin: Alignment.topCenter,
      end: Alignment.bottomCenter,
    );
  }

  static BoxDecoration getAppBackground(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final color = currentColor;

    return BoxDecoration(
      gradient: LinearGradient(
        colors: isDark
            ? [
                const Color(0xFF0E1116),
                const Color(0xFF141A22),
                color.withAlpha(28),
              ]
            : [
                const Color(0xFFF1F4F6),
                const Color(0xFFF7F9FB),
                color.withAlpha(20),
              ],
        begin: Alignment.topLeft,
        end: Alignment.bottomRight,
      ),
    );
  }

  static BoxDecoration getCardDecoration(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cs = Theme.of(context).colorScheme;

    return BoxDecoration(
      color: cs.surface,
      borderRadius: BorderRadius.circular(20),
      border: Border.all(
        color: cs.outline.withAlpha(isDark ? 128 : 160),
        width: 1,
      ),
      boxShadow: [
        BoxShadow(
          color: Colors.black.withAlpha(isDark ? 80 : 20),
          blurRadius: 18,
          offset: const Offset(0, 6),
        ),
      ],
    );
  }

  static BoxDecoration getBlurDecoration(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return BoxDecoration(
      gradient: getBlurGradient(isDark),
      borderRadius: BorderRadius.circular(20),
    );
  }

  static BoxDecoration getNeonDecoration(Color color) {
    return BoxDecoration(
      gradient: LinearGradient(
        colors: [
          color.withAlpha(170),
          color.withAlpha(90),
        ],
        begin: Alignment.topLeft,
        end: Alignment.bottomRight,
      ),
      borderRadius: BorderRadius.circular(12),
      boxShadow: [
        BoxShadow(
          color: color.withAlpha(110),
          blurRadius: 18,
          spreadRadius: 1,
          offset: const Offset(0, 4),
        ),
      ],
    );
  }

  static BoxDecoration getGlassDecoration(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return BoxDecoration(
      color: isDark
          ? const Color(0xFF151A21).withAlpha(210)
          : const Color(0xFFFFFFFF).withAlpha(230),
      borderRadius: BorderRadius.circular(20),
      border: Border.all(
        color: isDark ? Colors.white.withAlpha(40) : Colors.black.withAlpha(15),
        width: 1,
      ),
      boxShadow: [
        BoxShadow(
          color: Colors.black.withAlpha(isDark ? 70 : 18),
          blurRadius: 14,
          offset: const Offset(0, 5),
        ),
      ],
    );
  }
}

/* ===========================
        MODELS
=========================== */

enum ItemType { exchange, gift }

extension ItemTypeX on ItemType {
  String get label => this == ItemType.exchange ? '–û–±–º–µ–Ω' : '–ü–æ–¥–∞—Ä–æ–∫';
  IconData get icon => this == ItemType.exchange
      ? Icons.swap_horiz_rounded
      : Icons.card_giftcard_rounded;
  Color get accent => this == ItemType.exchange
      ? const Color(0xFF10B981)
      : const Color(0xFF8B5CF6);
}

enum ItemStatus { pending, approved, rejected }

extension ItemStatusX on ItemStatus {
  String get label {
    switch (this) {
      case ItemStatus.pending:
        return '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏';
      case ItemStatus.approved:
        return '–û–¥–æ–±—Ä–µ–Ω–æ';
      case ItemStatus.rejected:
        return '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
    }
  }

  Color get color {
    switch (this) {
      case ItemStatus.pending:
        return const Color(0xFFF59E0B);
      case ItemStatus.approved:
        return const Color(0xFF10B981);
      case ItemStatus.rejected:
        return const Color(0xFFEF4444);
    }
  }

  IconData get icon {
    switch (this) {
      case ItemStatus.pending:
        return Icons.pending_rounded;
      case ItemStatus.approved:
        return Icons.check_circle_rounded;
      case ItemStatus.rejected:
        return Icons.cancel_rounded;
    }
  }
}

String _slugifyTitle(String input) {
  const map = {
    '–∞': 'a',
    '–±': 'b',
    '–≤': 'v',
    '–≥': 'h',
    '“ë': 'g',
    '–¥': 'd',
    '–µ': 'e',
    '—î': 'ye',
    '–∂': 'zh',
    '–∑': 'z',
    '–∏': 'y',
    '—ñ': 'i',
    '—ó': 'yi',
    '–π': 'y',
    '–∫': 'k',
    '–ª': 'l',
    '–º': 'm',
    '–Ω': 'n',
    '–æ': 'o',
    '–ø': 'p',
    '—Ä': 'r',
    '—Å': 's',
    '—Ç': 't',
    '—É': 'u',
    '—Ñ': 'f',
    '—Ö': 'kh',
    '—Ü': 'ts',
    '—á': 'ch',
    '—à': 'sh',
    '—â': 'shch',
    '—å': '',
    '—ã': 'y',
    '—ä': '',
    '—ç': 'e',
    '—é': 'yu',
    '—è': 'ya',
  };

  final buffer = StringBuffer();
  for (final rune in input.toLowerCase().runes) {
    final char = String.fromCharCode(rune);
    if (map.containsKey(char)) {
      buffer.write(map[char]);
    } else if (RegExp(r'[a-z0-9]').hasMatch(char)) {
      buffer.write(char);
    } else {
      buffer.write('-');
    }
  }

  final slug = buffer
      .toString()
      .replaceAll(RegExp(r'-{2,}'), '-')
      .replaceAll(RegExp(r'^-+|-+$'), '');
  return slug.isEmpty ? 'item' : slug;
}

String? _extractItemIdFromUri(Uri uri) {
  final queryId = uri.queryParameters['id'];
  if (queryId != null && queryId.isNotEmpty) return queryId;
  final queryItem = uri.queryParameters['item'];
  if (queryItem != null && queryItem.isNotEmpty) return queryItem;

  final path = uri.pathSegments.isNotEmpty ? uri.pathSegments.last : '';
  if (path.isEmpty) return null;

  final match = RegExp(r'i_([A-Za-z0-9]+)').firstMatch(path);
  if (match != null) return match.group(1);

  final idPattern = RegExp(r'^[A-Za-z0-9]{8,}$');
  if (path.contains('-')) {
    final tail = path.split('-').last;
    if (idPattern.hasMatch(tail)) return tail;
  }

  if (idPattern.hasMatch(path)) return path;
  return null;
}

String? _extractShortCodeFromUri(Uri uri) {
  final queryCode = uri.queryParameters['code'];
  if (queryCode != null && queryCode.isNotEmpty) return queryCode;
  final path = uri.pathSegments.isNotEmpty ? uri.pathSegments.last : '';
  if (path.isEmpty) return null;
  if (path.contains('_')) {
    final tail = path.split('_').last;
    if (RegExp(r'^[a-z0-9]{5,10}$').hasMatch(tail)) return tail;
  }
  return null;
}

class Item {
  final String id;
  final String title;
  final String desc;
  final String city;
  final String category;
  final ItemType type;
  final ItemStatus status;
  int likes;
  int views;
  final String ownerId;
  final String ownerName;
  final String ownerEmail;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final List<String> photoPaths;
  final List<String> photoUrls;
  final List<String> localImagePaths;
  final int mainImageIndex;
  final String? moderationComment;

  Item({
    required this.id,
    required this.title,
    required this.desc,
    required this.city,
    required this.category,
    required this.type,
    this.status = ItemStatus.pending,
    required this.likes,
    required this.views,
    required this.ownerId,
    required this.ownerName,
    required this.ownerEmail,
    required this.createdAt,
    this.updatedAt,
    required this.photoPaths,
    required this.photoUrls,
    this.localImagePaths = const [],
    this.mainImageIndex = 0,
    this.moderationComment,
  });

  List<String> get allPhotos {
    final networkPhotos = photoUrls
        .where((url) => url.startsWith('http') || url.startsWith('https'))
        .toList();
    final localPhotos = localImagePaths;
    return [...networkPhotos, ...localPhotos];
  }

  String _thumbUrl(String url) {
    if (!url.startsWith('http')) return url;
    const marker = '/upload/';
    if (!url.contains(marker)) return url;
    return url.replaceFirst(marker, '${marker}w_600,q_auto,f_auto/');
  }

  String get mainPhoto {
    final allPhotos = this.allPhotos;
    if (allPhotos.isEmpty) return '';
    if (mainImageIndex < allPhotos.length) {
      return allPhotos[mainImageIndex];
    }
    return allPhotos.first;
  }

  Item copyWith({
    String? id,
    String? title,
    String? desc,
    String? city,
    String? category,
    ItemType? type,
    ItemStatus? status,
    int? likes,
    int? views,
    String? ownerId,
    String? ownerName,
    String? ownerEmail,
    DateTime? createdAt,
    DateTime? updatedAt,
    List<String>? photoPaths,
    List<String>? photoUrls,
    List<String>? localImagePaths,
    int? mainImageIndex,
    String? moderationComment,
  }) {
    return Item(
      id: id ?? this.id,
      title: title ?? this.title,
      desc: desc ?? this.desc,
      city: city ?? this.city,
      category: category ?? this.category,
      type: type ?? this.type,
      status: status ?? this.status,
      likes: likes ?? this.likes,
      views: views ?? this.views,
      ownerId: ownerId ?? this.ownerId,
      ownerName: ownerName ?? this.ownerName,
      ownerEmail: ownerEmail ?? this.ownerEmail,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? DateTime.now(),
      photoPaths: photoPaths ?? this.photoPaths,
      photoUrls: photoUrls ?? this.photoUrls,
      localImagePaths: localImagePaths ?? this.localImagePaths,
      mainImageIndex: mainImageIndex ?? this.mainImageIndex,
      moderationComment: moderationComment ?? this.moderationComment,
    );
  }

  Map<String, dynamic> toJson() => {
        'id': id,
        'title': title,
        'desc': desc,
        'city': city,
        'category': category,
        'type': type == ItemType.exchange ? 'exchange' : 'gift',
        'status': status == ItemStatus.pending
            ? 'pending'
            : status == ItemStatus.approved
                ? 'approved'
                : 'rejected',
        'likes': likes,
        'views': views,
        'ownerId': ownerId,
        'ownerName': ownerName,
        'ownerEmail': ownerEmail,
        'createdAt': createdAt.toIso8601String(),
        'updatedAt': updatedAt?.toIso8601String(),
        'photoPaths': photoPaths,
        'photoUrls': photoUrls,
        'images': photoUrls,
        'localImagePaths': localImagePaths,
        'mainImageIndex': mainImageIndex,
        'moderationComment': moderationComment,
      };

  static Item fromJson(Map<String, dynamic> json) {
    String strValue(String key, String fallback) {
      final value = json[key];
      if (value == null) return fallback;
      final text = value.toString().trim();
      return text.isEmpty ? fallback : text;
    }

    List<String> listValue(String key) {
      final raw = json[key] as List?;
      if (raw == null) return const [];
      return raw
          .map((e) => e?.toString().trim() ?? '')
          .where((e) => e.isNotEmpty)
          .toList();
    }

    DateTime parseDate(dynamic value) {
      if (value == null) return DateTime.now();
      if (value is Timestamp) return value.toDate();
      if (value is DateTime) return value;
      return DateTime.tryParse(value.toString()) ?? DateTime.now();
    }

    DateTime? parseNullableDate(dynamic value) {
      if (value == null) return null;
      if (value is Timestamp) return value.toDate();
      if (value is DateTime) return value;
      return DateTime.tryParse(value.toString());
    }

    final parsedPhotoUrls = listValue('photoUrls');
    final resolvedPhotoUrls =
        parsedPhotoUrls.isEmpty ? listValue('images') : parsedPhotoUrls;

    return Item(
      id: strValue('id', 'unknown'),
      title: strValue('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
      desc: strValue('desc', ''),
      city: strValue('city', ''),
      category: strValue('category', ''),
      type: (json['type'] as String? ?? 'exchange') == 'exchange'
          ? ItemType.exchange
          : ItemType.gift,
      status: (json['status'] as String? ?? 'pending') == 'pending'
          ? ItemStatus.pending
          : (json['status'] == 'approved'
              ? ItemStatus.approved
              : ItemStatus.rejected),
      likes: (json['likes'] ?? 0) as int,
      views: (json['views'] ?? 0) as int,
      ownerId: strValue('ownerId', 'u_unknown'),
      ownerName: strValue('ownerName', 'User'),
      ownerEmail: strValue('ownerEmail', 'user@example.com'),
      createdAt: parseDate(json['createdAt']),
      updatedAt: parseNullableDate(json['updatedAt']),
      photoPaths: listValue('photoPaths'),
      photoUrls: resolvedPhotoUrls,
      localImagePaths: listValue('localImagePaths'),
      mainImageIndex: (json['mainImageIndex'] ?? 0) as int,
      moderationComment: json['moderationComment']?.toString(),
    );
  }

  Widget getImageWidget(BuildContext context,
      {double iconSize = 40, BoxFit fit = BoxFit.cover}) {
    final cs = Theme.of(context).colorScheme;
    final displayUrl = _thumbUrl(mainPhoto);

    if (mainPhoto.isEmpty) {
      return Container(
        color: cs.surfaceContainer,
        child: Center(
          child: Icon(
            type.icon,
            color: cs.onSurface.withAlpha(77),
            size: iconSize,
          ),
        ),
      );
    }

    if (displayUrl.startsWith('http') || displayUrl.startsWith('https')) {
      return CachedNetworkImage(
        imageUrl: displayUrl,
        fit: fit,
        placeholder: (context, url) => Center(
          child: CircularProgressIndicator(
            strokeWidth: 2,
            color: NeoThemes.currentColor,
          ),
        ),
        errorWidget: (context, url, error) {
          return Container(
            color: cs.surfaceContainer,
            child: Center(
              child: Icon(
                type.icon,
                color: cs.onSurface.withAlpha(77),
                size: iconSize,
              ),
            ),
          );
        },
      );
    } else {
      try {
        final uri = Uri.tryParse(mainPhoto);
        final filePath = uri?.scheme == 'file' ? uri!.toFilePath() : mainPhoto;
        return Image.file(
          File(filePath),
          fit: fit,
          errorBuilder: (context, error, stackTrace) {
            return Container(
              color: cs.surfaceContainer,
              child: Center(
                child: Icon(
                  type.icon,
                  color: cs.onSurface.withAlpha(77),
                  size: iconSize,
                ),
              ),
            );
          },
        );
      } catch (e) {
        return Container(
          color: cs.surfaceContainer,
          child: Center(
            child: Icon(
              type.icon,
              color: cs.onSurface.withAlpha(77),
              size: iconSize,
            ),
          ),
        );
      }
    }
  }

  Widget getImageAtIndex(BuildContext context, int index,
      {double iconSize = 40, BoxFit fit = BoxFit.cover}) {
    final cs = Theme.of(context).colorScheme;
    final photos = allPhotos;

    if (index >= photos.length || photos.isEmpty) {
      return Container(
        color: cs.surfaceContainer,
        child: Center(
          child: Icon(
            type.icon,
            color: cs.onSurface.withAlpha(77),
            size: iconSize,
          ),
        ),
      );
    }

    final photo = photos[index];

    if (photo.startsWith('http') || photo.startsWith('https')) {
      return CachedNetworkImage(
        imageUrl: photo,
        fit: fit,
        placeholder: (context, url) => Center(
          child: CircularProgressIndicator(
            strokeWidth: 2,
            color: NeoThemes.currentColor,
          ),
        ),
        errorWidget: (context, url, error) {
          return Container(
            color: cs.surfaceContainer,
            child: Center(
              child: Icon(
                type.icon,
                color: cs.onSurface.withAlpha(77),
                size: iconSize,
              ),
            ),
          );
        },
      );
    } else {
      try {
        final uri = Uri.tryParse(photo);
        final filePath = uri?.scheme == 'file' ? uri!.toFilePath() : photo;
        return Image.file(
          File(filePath),
          fit: fit,
          errorBuilder: (context, error, stackTrace) {
            return Container(
              color: cs.surfaceContainer,
              child: Center(
                child: Icon(
                  type.icon,
                  color: cs.onSurface.withAlpha(77),
                  size: iconSize,
                ),
              ),
            );
          },
        );
      } catch (e) {
        return Container(
          color: cs.surfaceContainer,
          child: Center(
            child: Icon(
              type.icon,
              color: cs.onSurface.withAlpha(77),
              size: iconSize,
            ),
          ),
        );
      }
    }
  }
}

enum MessageType { text, image }

class ChatMessage {
  final String id;
  final String text;
  final bool fromMe;
  final DateTime at;
  final MessageType type;
  final String? imagePath;
  final String? imageUrl;
  final String? itemId;
  final String? itemTitle;

  const ChatMessage({
    required this.id,
    required this.text,
    required this.fromMe,
    required this.at,
    this.type = MessageType.text,
    this.imagePath,
    this.imageUrl,
    this.itemId,
    this.itemTitle,
  });

  Map<String, dynamic> toJson() => {
        'id': id,
        'text': text,
        'fromMe': fromMe,
        'at': at.toIso8601String(),
        'type': type == MessageType.text ? 'text' : 'image',
        'imagePath': imagePath,
        'imageUrl': imageUrl,
        'itemId': itemId,
        'itemTitle': itemTitle,
      };

  static ChatMessage fromJson(Map<String, dynamic> json) => ChatMessage(
        id: json['id'],
        text: json['text'],
        fromMe: json['fromMe'] == true,
        at: DateTime.tryParse(json['at'] ?? '') ?? DateTime.now(),
        type: (json['type'] as String? ?? 'text') == 'text'
            ? MessageType.text
            : MessageType.image,
        imagePath: json['imagePath'],
        imageUrl: json['imageUrl'],
        itemId: json['itemId'],
        itemTitle: json['itemTitle'],
      );
}

class ChatThread {
  final String id;
  final String peerId;
  final String peerName;
  final String peerEmail;
  final List<ChatMessage> messages;
  int unread;
  final String? relatedItemId;

  ChatThread({
    required this.id,
    required this.peerId,
    required this.peerName,
    required this.peerEmail,
    required this.messages,
    this.unread = 0,
    this.relatedItemId,
  });

  ChatMessage get last => messages.isNotEmpty
      ? messages.last
      : ChatMessage(
          id: 'm0', text: '–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥', fromMe: false, at: DateTime.now());

  Map<String, dynamic> toJson() => {
        'id': id,
        'peerId': peerId,
        'peerName': peerName,
        'peerEmail': peerEmail,
        'unread': unread,
        'relatedItemId': relatedItemId,
        'messages': messages.map((m) => m.toJson()).toList(),
      };

  static ChatThread fromJson(Map<String, dynamic> json) => ChatThread(
        id: json['id'],
        peerId: json['peerId'],
        peerName: json['peerName'],
        peerEmail: json['peerEmail'] ?? 'user@example.com',
        unread: (json['unread'] ?? 0) as int,
        relatedItemId: json['relatedItemId'],
        messages: (json['messages'] as List? ?? const [])
            .map((e) => ChatMessage.fromJson(Map<String, dynamic>.from(e)))
            .toList(),
      );
}

class AppNotification {
  final String id;
  final String toUserId;
  final String fromUserId;
  final String fromName;
  final String chatId;
  final String itemId;
  final String action;
  final String? comment;
  final String title;
  final String body;
  final String status; // sent, failed, pending
  final bool read;
  final DateTime createdAt;

  const AppNotification({
    required this.id,
    required this.toUserId,
    required this.fromUserId,
    required this.fromName,
    required this.chatId,
    required this.itemId,
    required this.action,
    this.comment,
    required this.title,
    required this.body,
    required this.status,
    required this.read,
    required this.createdAt,
  });

  AppNotification copyWith(
      {String? status, bool? read, String? action, String? comment}) {
    return AppNotification(
      id: id,
      toUserId: toUserId,
      fromUserId: fromUserId,
      fromName: fromName,
      chatId: chatId,
      itemId: itemId,
      action: action ?? this.action,
      comment: comment ?? this.comment,
      title: title,
      body: body,
      status: status ?? this.status,
      read: read ?? this.read,
      createdAt: createdAt,
    );
  }

  static AppNotification fromJson(String id, Map<String, dynamic> json) {
    DateTime parseDate(dynamic value) {
      if (value == null) return DateTime.now();
      if (value is Timestamp) return value.toDate();
      if (value is DateTime) return value;
      return DateTime.tryParse(value.toString()) ?? DateTime.now();
    }

    return AppNotification(
      id: id,
      toUserId: (json['toUserId'] ?? '').toString(),
      fromUserId: (json['fromUserId'] ?? '').toString(),
      fromName: (json['fromName'] ?? 'User').toString(),
      chatId: (json['chatId'] ?? '').toString(),
      itemId: (json['itemId'] ?? '').toString(),
      action: (json['action'] ?? '').toString(),
      comment: json['comment']?.toString(),
      title: (json['title'] ?? '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ').toString(),
      body: (json['body'] ?? '').toString(),
      status: (json['status'] ?? 'pending').toString(),
      read: json['read'] == true,
      createdAt: parseDate(json['createdAt']),
    );
  }
}

class LocationCity {
  final String name;
  final String type;
  final List<String> districts;

  const LocationCity({
    required this.name,
    required this.type,
    required this.districts,
  });

  factory LocationCity.fromJson(Map<String, dynamic> json) {
    return LocationCity(
      name: (json['name'] ?? '').toString(),
      type: (json['type'] ?? '').toString(),
      districts: (json['districts'] as List? ?? const [])
          .map((e) => e.toString())
          .toList(),
    );
  }
}

class LocationSelection {
  final String region;
  final String district;
  final LocationCity city;

  const LocationSelection({
    required this.region,
    required this.district,
    required this.city,
  });
}

class LocationData {
  final Map<String, Map<String, List<LocationCity>>> data;

  const LocationData(this.data);

  List<String> get regions {
    final list = data.keys.toList()..sort();
    return list;
  }

  List<String> districtsFor(String region) {
    final districts = data[region]?.keys.toList() ?? const [];
    districts.sort();
    return districts;
  }

  List<LocationCity> citiesFor(String region, String district) {
    return data[region]?[district] ?? const [];
  }

  LocationSelection? findCity(String cityName) {
    final needle = cityName.trim().toLowerCase();
    if (needle.isEmpty) return null;

    for (final entry in data.entries) {
      final region = entry.key;
      for (final districtEntry in entry.value.entries) {
        final district = districtEntry.key;
        for (final city in districtEntry.value) {
          if (city.name.toLowerCase() == needle) {
            return LocationSelection(
              region: region,
              district: district,
              city: city,
            );
          }
        }
      }
    }
    return null;
  }

  static Future<LocationData> load() async {
    final raw = await rootBundle.loadString('lib/locations.json');
    final decoded = jsonDecode(raw) as Map<String, dynamic>;
    final Map<String, Map<String, List<LocationCity>>> data = {};

    decoded.forEach((regionName, districtsRaw) {
      final districtMap = <String, List<LocationCity>>{};
      final districts = districtsRaw as Map<String, dynamic>;
      districts.forEach((districtName, citiesRaw) {
        final list = (citiesRaw as List)
            .map((e) => LocationCity.fromJson(
                e as Map<String, dynamic>? ?? const {}))
            .where((city) => city.name.isNotEmpty)
            .toList();
        list.sort((a, b) =>
            a.name.toLowerCase().compareTo(b.name.toLowerCase()));
        districtMap[districtName] = list;
      });
      data[regionName] = districtMap;
    });

    return LocationData(data);
  }
}

enum UserRole { user, moderator, admin }

class Achievement {
  final String id;
  final String title;
  final String description;
  final IconData icon;
  final Color color;
  final int progress;
  final int target;
  final bool unlocked;

  const Achievement({
    required this.id,
    required this.title,
    required this.description,
    required this.icon,
    required this.color,
    required this.progress,
    required this.target,
    required this.unlocked,
  });
}

class SessionUser {
  final String uid;
  String name;
  final String email;
  String city;
  final UserRole role;
  int likes;
  int level;
  int itemsPosted;
  int itemsApproved;
  int exchangesCompleted;
  DateTime? lastAchievementUpdate;
  String? currentPassword;
  String? profileImagePath;
  String? profileImageUrl; // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è URL –∏–∑ Firebase Storage

  SessionUser({
    required this.uid,
    required this.name,
    required this.email,
    required this.city,
    required this.role,
    required this.likes,
    required this.level,
    this.itemsPosted = 0,
    this.itemsApproved = 0,
    this.exchangesCompleted = 0,
    this.lastAchievementUpdate,
    this.currentPassword,
    this.profileImagePath,
    this.profileImageUrl,
  });

  bool get isModerator => role == UserRole.moderator || role == UserRole.admin;
  bool get isAdmin => role == UserRole.admin;

  Map<String, dynamic> toJson() => {
        'uid': uid,
        'name': name,
        'email': email,
        'city': city,
        'role': role == UserRole.user
            ? 'user'
            : role == UserRole.moderator
                ? 'moderator'
                : 'admin',
        'likes': likes,
        'level': level,
        'itemsPosted': itemsPosted,
        'itemsApproved': itemsApproved,
        'exchangesCompleted': exchangesCompleted,
        'lastAchievementUpdate': lastAchievementUpdate?.toIso8601String(),
        'profileImagePath': profileImagePath,
        'profileImageUrl': profileImageUrl,
      };

  static SessionUser fromJson(Map<String, dynamic> json) {
    final roleStr = json['role'] as String? ?? 'user';
    return SessionUser(
      uid: json['uid'],
      name: json['name'],
      email: json['email'],
      city: json['city'],
      role: roleStr == 'moderator'
          ? UserRole.moderator
          : roleStr == 'admin'
              ? UserRole.admin
              : UserRole.user,
      likes: (json['likes'] ?? 0) as int,
      level: (json['level'] ?? 1) as int,
      itemsPosted: (json['itemsPosted'] ?? 0) as int,
      itemsApproved: (json['itemsApproved'] ?? 0) as int,
      exchangesCompleted: (json['exchangesCompleted'] ?? 0) as int,
      lastAchievementUpdate: json['lastAchievementUpdate'] != null
          ? DateTime.tryParse(json['lastAchievementUpdate'])
          : null,
      profileImagePath: json['profileImagePath'],
      profileImageUrl: json['profileImageUrl'],
    );
  }

  SessionUser copyWith({
    String? name,
    String? city,
    String? profileImagePath,
    String? profileImageUrl,
  }) {
    return SessionUser(
      uid: uid,
      name: name ?? this.name,
      email: email,
      city: city ?? this.city,
      role: role,
      likes: likes,
      level: level,
      itemsPosted: itemsPosted,
      itemsApproved: itemsApproved,
      exchangesCompleted: exchangesCompleted,
      lastAchievementUpdate: lastAchievementUpdate,
      profileImagePath: profileImagePath ?? this.profileImagePath,
      profileImageUrl: profileImageUrl ?? this.profileImageUrl,
    );
  }
}

/* ===========================
        NEO STORE
=========================== */

final NeoStore neoStore = NeoStore();
final GlobalKey<NavigatorState> _rootNavKey = GlobalKey<NavigatorState>();

class NeoStore extends ChangeNotifier {
  SessionUser? _user;
  SessionUser? get user => _user;

  bool ready = false;

  int selectedThemeIndex = 0;
  int selectedThemeMode = 0;
  ThemeMode get themeMode {
    switch (selectedThemeMode) {
      case 0:
        return ThemeMode.light;
      case 1:
        return ThemeMode.dark;
      case 2:
        return ThemeMode.system;
      default:
        return ThemeMode.system;
    }
  }

  bool get isDark => themeMode == ThemeMode.dark;

  final List<Item> _items = [];
  List<Item> get items => List.from(_items); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞

  final List<ChatThread> _chats = [];
  List<ChatThread> get chats => List.from(_chats); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞

  final List<AppNotification> _notifications = [];
  List<AppNotification> get notifications => List.from(_notifications);

  final Map<String, String?> _profileImageCache = {};

  final Set<String> favorites = {};

  Future<LocationData>? _locationsFuture;

  bool sNotifs = true;
  bool sHaptics = true;
  bool sAutoPlay = true;
  bool sUseNeon = true;
  bool sAutoSync = true;
  bool sSaveHistory = true;
  bool sShowOnlineStatus = true;

  bool _isUserChanging = false;

  // Firebase listeners
  StreamSubscription? _itemsSubscription;
  StreamSubscription? _chatsSubscription;
  StreamSubscription? _authSubscription;
  StreamSubscription? _notificationsSubscription;

  // –§–∏–ª—å—Ç—Ä—ã
  String _selectedCategory = '–í—Å–µ';
  String _selectedCity = '–í—Å–µ';
  ItemType? _selectedType;
  String _sortBy = 'newest';
  String _searchQuery = '';

  String get selectedCategory => _selectedCategory;
  String get selectedCity => _selectedCity;
  ItemType? get selectedType => _selectedType;
  String get sortBy => _sortBy;
  String get searchQuery => _searchQuery;

  Future<LocationData> get locations async {
    _locationsFuture ??= LocationData.load();
    return _locationsFuture!;
  }

  // Cache –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  List<Item> _cachedFilteredItems = [];
  DateTime _lastFilterUpdate = DateTime.now();
  final int _feedPageSize = 20;
  int _visibleFeedCount = 20;
  bool _isLoadingMoreFeed = false;

  List<Item> get filteredItems {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    final now = DateTime.now();
    if (_cachedFilteredItems.isNotEmpty &&
        now.difference(_lastFilterUpdate).inSeconds < 2) {
      return _cachedFilteredItems;
    }

    List<Item> result = getApprovedItems();

    if (_selectedCategory != '–í—Å–µ') {
      result =
          result.where((item) => item.category == _selectedCategory).toList();
    }

    if (_selectedCity != '–í—Å–µ') {
      result = result.where((item) => item.city == _selectedCity).toList();
    }

    if (_selectedType != null) {
      result = result.where((item) => item.type == _selectedType).toList();
    }

    if (_searchQuery.trim().isNotEmpty) {
      final query = _searchQuery.trim().toLowerCase();
      result = result.where((item) {
        return item.title.toLowerCase().contains(query) ||
            item.desc.toLowerCase().contains(query) ||
            item.city.toLowerCase().contains(query) ||
            item.category.toLowerCase().contains(query);
      }).toList();
    }

    if (_sortBy == 'newest') {
      result.sort((a, b) => b.createdAt.compareTo(a.createdAt));
    } else {
      result.sort((a, b) => a.createdAt.compareTo(b.createdAt));
    }

    _cachedFilteredItems = result;
    _lastFilterUpdate = now;
    return result;
  }

  List<Item> get visibleFilteredItems {
    final items = filteredItems;
    if (items.length <= _visibleFeedCount) return items;
    return items.sublist(0, _visibleFeedCount);
  }

  bool get canLoadMoreFeed => filteredItems.length > _visibleFeedCount;

  void resetFeedPagination() {
    _visibleFeedCount = _feedPageSize;
  }

  void loadMoreFeed() {
    if (_isLoadingMoreFeed || !canLoadMoreFeed) return;
    _isLoadingMoreFeed = true;
    _visibleFeedCount += _feedPageSize;
    _isLoadingMoreFeed = false;
    notifyListeners();
  }

  void setSearchQuery(String value) {
    if (_searchQuery == value) return;
    _searchQuery = value;
    _cachedFilteredItems = [];
    resetFeedPagination();
    notifyListeners();
  }

  List<String> get availableCategories {
    final categories = _items.map((item) => item.category).toSet().toList();
    categories.insert(0, '–í—Å–µ');
    return categories;
  }

  List<String> get availableCities {
    final cities = _items.map((item) => item.city).toSet().toList();
    cities.insert(0, '–í—Å–µ');
    return cities;
  }

  void setFilters({
    String? category,
    String? city,
    ItemType? type,
    String? sort,
  }) {
    bool changed = false;

    if (category != null && category != _selectedCategory) {
      _selectedCategory = category;
      changed = true;
    }

    if (city != null && city != _selectedCity) {
      _selectedCity = city;
      changed = true;
    }

    if (type != _selectedType) {
      _selectedType = type;
      changed = true;
    }

    if (sort != null && sort != _sortBy) {
      _sortBy = sort;
      changed = true;
    }

    if (changed) {
      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
      _cachedFilteredItems = [];
      resetFeedPagination();
      notifyListeners();
    }
  }

  void clearFilters() {
    bool changed = false;

    if (_selectedCategory != '–í—Å–µ') {
      _selectedCategory = '–í—Å–µ';
      changed = true;
    }

    if (_selectedCity != '–í—Å–µ') {
      _selectedCity = '–í—Å–µ';
      changed = true;
    }

    if (_selectedType != null) {
      _selectedType = null;
      changed = true;
    }

    if (_sortBy != 'newest') {
      _sortBy = 'newest';
      changed = true;
    }

    if (changed) {
      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
      _cachedFilteredItems = [];
      resetFeedPagination();
      notifyListeners();
    }
  }

  Future<void> init() async {
    try {
      final sp = await SharedPreferences.getInstance();
      selectedThemeIndex = sp.getInt('neo_theme') ?? 0;
      selectedThemeMode = sp.getInt('neo_theme_mode') ?? 0;
      sNotifs = sp.getBool('neo_notifs') ?? true;
      sHaptics = sp.getBool('neo_haptics') ?? true;
      sAutoPlay = sp.getBool('neo_autoplay') ?? true;
      sUseNeon = sp.getBool('neo_neon') ?? true;
      sAutoSync = sp.getBool('neo_auto_sync') ?? true;
      sSaveHistory = sp.getBool('neo_save_history') ?? true;
      sShowOnlineStatus = sp.getBool('neo_show_online') ?? true;

      final fRaw = sp.getString('neo_favs_guest');
      if (fRaw != null) {
        try {
          favorites
            ..clear()
            ..addAll((jsonDecode(fRaw) as List).map((e) => e.toString()));
        } catch (_) {}
      }
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Å—Ç–µ–≤–æ–π –∫—ç—à —á–∞—Ç–æ–≤ (–µ—Å–ª–∏ –±—ã–ª)
      await _loadChatsCacheForCurrentUser();

      print('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –¥–∞–Ω–Ω—ã—Ö...');
      await _initFirebaseListeners();
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ store: $e');
    } finally {
      ready = true;
      notifyListeners();
    }
  }

  Future<void> _initFirebaseListeners() async {
    try {
      _authSubscription = FirebaseService.auth
          ?.authStateChanges()
          .listen((User? firebaseUser) async {
        if (_isUserChanging) return;
        _isUserChanging = true;

        try {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —á–∞—Ç—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          await _chatsSubscription?.cancel();
          _chatsSubscription = null;

          // –í—Å–µ–≥–¥–∞ —á–∏—Å—Ç–∏–º —á–∞—Ç—ã –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "—á—É–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ
          _chats.clear();

          if (firebaseUser != null) {
            // 1) –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await _loadUserFromFirebase(firebaseUser.uid);
            OneSignal.login(firebaseUser.uid);
            await _syncOneSignalPlayerId();
            if (sShowOnlineStatus) {
              await setOnlineStatus(true);
            }

            // 2) –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ/–∫—ç—à —á–∞—Ç–æ–≤ –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–≥–æ uid
            await _loadFavsForCurrentUser();
            await _loadChatsCacheForCurrentUser();

            // 3) –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —á–∞—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            _setupChatsSubscription(firebaseUser.uid);
            _setupNotificationsSubscription(firebaseUser.uid);
          } else {
            // –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º
            if (sShowOnlineStatus) {
              await setOnlineStatus(false);
            }
            _user = null;
            OneSignal.logout();
            await _saveUser();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Å—Ç–µ–≤–æ–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–µ—Å–ª–∏ –±—ã–ª–æ) –∏ –≥–æ—Å—Ç–µ–≤–æ–π –∫—ç—à —á–∞—Ç–æ–≤
            await _loadFavsForCurrentUser();
            await _loadChatsCacheForCurrentUser();
            _notificationsSubscription?.cancel();
            _notifications.clear();
          }
        } catch (e) {
          print('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ authStateChanges: $e');
        } finally {
          _isUserChanging = false;
          notifyListeners();
        }
      });

      _itemsSubscription = FirebaseService.firestore
          ?.collection('items')
          .orderBy('createdAt', descending: true)
          .snapshots()
          .listen((snapshot) {
        _updateItemsFromSnapshot(snapshot);
      });

      if (_user != null) {
        _chatsSubscription = FirebaseService.firestore
            ?.collection('chats')
            .where('participants', arrayContains: _user!.uid)
            .orderBy('lastMessageAt', descending: true)
            .snapshots()
            .listen((snapshot) {
          _updateChatsFromSnapshot(snapshot);
        });
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase listeners: $e');
      rethrow;
    }
  }

  void _updateItemsFromSnapshot(QuerySnapshot snapshot) {
    final List<Item> newItems = [];

    for (var doc in snapshot.docs) {
      try {
        final data = doc.data() as Map<String, dynamic>;
        data['id'] = doc.id;
        final item = Item.fromJson(data);
        newItems.add(item);
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ item: $e');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
    _items.clear();
    _items.addAll(newItems);

    // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
    _cachedFilteredItems = [];
    resetFeedPagination();

    // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    _saveItems();
    notifyListeners();
  }

  void _updateChatsFromSnapshot(QuerySnapshot snapshot) {
    final List<ChatThread> newChats = [];

    for (var doc in snapshot.docs) {
      try {
        final data = doc.data() as Map<String, dynamic>;
        final chat = _chatFromFirebase(data, doc.id);
        newChats.add(chat);
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–∞—Ç–∞: $e');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
    _chats.clear();
    _chats.addAll(newChats);

    // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    _saveChats();
    notifyListeners();
  }

  void _setupNotificationsSubscription(String uid) {
    _notificationsSubscription?.cancel();
    _notificationsSubscription = FirebaseService.firestore
        ?.collection('notifications')
        .where('toUserId', isEqualTo: uid)
        .snapshots()
        .listen((snapshot) {
      final List<AppNotification> list = [];
      for (var doc in snapshot.docs) {
        final data = doc.data() as Map<String, dynamic>? ?? {};
        list.add(AppNotification.fromJson(doc.id, data));
      }
      list.sort((a, b) => b.createdAt.compareTo(a.createdAt));
      _notifications
        ..clear()
        ..addAll(list);
      notifyListeners();
    });
  }

  Future<String?> _createNotification({
    required String toUserId,
    required String fromUserId,
    required String fromName,
    required String chatId,
    String itemId = '',
    String action = '',
    String? comment,
    required String title,
    required String body,
  }) async {
    try {
      final doc = FirebaseService.firestore!.collection('notifications').doc();
      await doc.set({
        'toUserId': toUserId,
        'fromUserId': fromUserId,
        'fromName': fromName,
        'chatId': chatId,
        'itemId': itemId,
        'action': action,
        'comment': comment,
        'title': title,
        'body': body,
        'status': 'pending',
        'read': false,
        'createdAt': DateTime.now().toIso8601String(),
      });
      return doc.id;
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $e');
      return null;
    }
  }

  Future<void> _updateNotificationStatus(String id, String status) async {
    try {
      await FirebaseService.firestore!
          .collection('notifications')
          .doc(id)
          .update({'status': status});
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $e');
    }
  }

  Future<void> markNotificationRead(String id) async {
    try {
      await FirebaseService.firestore!
          .collection('notifications')
          .doc(id)
          .update({'read': true});
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º: $e');
    }
  }

  Future<void> _loadUserFromFirebase(String uid) async {
    try {
      final doc =
          await FirebaseService.firestore!.collection('users').doc(uid).get();

      if (doc.exists) {
        final data = doc.data()!;
        _user = SessionUser(
          uid: uid,
          name: data['name'] ?? 'User',
          email: data['email'] ?? 'user@example.com',
          city: data['city'] ?? '–ö–∏–µ–≤',
          role: data['role'] == 'moderator'
              ? UserRole.moderator
              : data['role'] == 'admin'
                  ? UserRole.admin
                  : UserRole.user,
          likes: data['likes'] ?? 0,
          level: data['level'] ?? 1,
          itemsPosted: data['itemsPosted'] ?? 0,
          itemsApproved: data['itemsApproved'] ?? 0,
          exchangesCompleted: data['exchangesCompleted'] ?? 0,
          lastAchievementUpdate: data['lastAchievementUpdate'] != null
              ? DateTime.parse(data['lastAchievementUpdate'])
              : null,
          profileImagePath: data['profileImagePath'],
          profileImageUrl: data['profileImageUrl'],
        );
        _profileImageCache[uid] = _user!.profileImageUrl;
        await _saveUser();
        notifyListeners();
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firebase: $e');
    }
  }

  Future<String?> fetchUserProfileImageUrl(String uid) async {
    if (uid.isEmpty) return null;
    if (_profileImageCache.containsKey(uid)) {
      final cached = _profileImageCache[uid];
      if (cached?.isNotEmpty == true) return cached;
    }

    try {
      final doc =
          await FirebaseService.firestore!.collection('users').doc(uid).get();
      if (doc.exists) {
        final data = doc.data() ?? {};
        final url = data['profileImageUrl'] as String?;
        if (url?.isNotEmpty == true) {
          _profileImageCache[uid] = url;
        } else {
          _profileImageCache.remove(uid);
        }
        return url;
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è: $e');
    }

    _profileImageCache.remove(uid);
    return null;
  }

  Future<void> _syncOneSignalPlayerId() async {
    final user = _user;
    if (user == null) return;

    try {
      final playerId = OneSignal.User.pushSubscription.id;
      if (playerId == null || playerId.isEmpty) return;

      await FirebaseService.firestore!
          .collection('users')
          .doc(user.uid)
          .set({'oneSignalId': playerId}, SetOptions(merge: true));
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è OneSignal ID: $e');
    }
  }

  Future<void> setOnlineStatus(bool isOnline) async {
    final user = _user;
    if (user == null) return;
    try {
      await FirebaseService.firestore!.collection('users').doc(user.uid).set({
        'online': isOnline,
        'lastSeen': DateTime.now().toIso8601String(),
      }, SetOptions(merge: true));
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞: $e');
    }
  }

  Future<bool> _sendPushToUser({
    required String userId,
    required String title,
    required String body,
  }) async {
    if (_pushServerUrl.isEmpty) return false;

    try {
      final doc = await FirebaseService.firestore!
          .collection('users')
          .doc(userId)
          .get();
      final data = doc.data() ?? {};
      final oneSignalId = data['oneSignalId'] as String?;
      if (oneSignalId == null || oneSignalId.isEmpty) return false;

      final client = HttpClient();
      try {
        final request = await client.postUrl(Uri.parse(_pushServerUrl));
        request.headers.contentType = ContentType.json;
        request.write(jsonEncode({
          'to': oneSignalId,
          'title': title,
          'body': body,
        }));
        final response = await request.close();
        final responseBody = await response.transform(utf8.decoder).join();
        if (response.statusCode < 200 || response.statusCode >= 300) {
          print('? –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à–∞: ${response.statusCode}');
          return false;
        }
        if (responseBody.isNotEmpty) {
          try {
            final payload = jsonDecode(responseBody);
            if (payload is Map && payload['ok'] == true) {
              final raw = payload['response'];
              if (raw is String) {
                try {
                  final inner = jsonDecode(raw);
                  if (inner is Map && inner['errors'] != null) return false;
                } catch (_) {
                  if (raw.contains('errors')) return false;
                }
              } else if (raw is Map && raw['errors'] != null) {
                return false;
              }
            }
          } catch (_) {}
        }
        return true;
      } finally {
        client.close();
      }
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à–∞: $e');
      return false;
    }
    return false;
  }

  ChatThread _chatFromFirebase(Map<String, dynamic> data, String id) {
    final participants = List<String>.from(data['participants'] ?? []);
    final currentUserId = _user?.uid ?? '';
    final peerId = participants.firstWhere((p) => p != currentUserId);

    DateTime parseMessageTime(dynamic value) {
      if (value == null) return DateTime.now();
      if (value is Timestamp) return value.toDate();
      if (value is DateTime) return value;
      return DateTime.tryParse(value.toString()) ?? DateTime.now();
    }

    return ChatThread(
      id: id,
      peerId: peerId,
      peerName: _peerNameFromChat(data, peerId),
      peerEmail: _peerEmailFromChat(data, peerId),
      messages: (data['messages'] as List? ?? []).map((msg) {
        return ChatMessage(
          id: msg['id'] ?? '',
          text: msg['text'] ?? '',
          fromMe: msg['from'] == currentUserId,
          at: parseMessageTime(msg['at']),
          type: msg['type'] == 'image' ? MessageType.image : MessageType.text,
          imageUrl: msg['imageUrl'],
          itemId: msg['itemId'],
          itemTitle: msg['itemTitle'],
        );
      }).toList(),
      unread: data['unread']?[currentUserId] ?? 0,
      relatedItemId: data['relatedItemId'],
    );
  }

  String _peerNameFromChat(Map<String, dynamic> data, String peerId) {
    final info = Map<String, dynamic>.from(data['participantsInfo'] ?? {});
    final peer = Map<String, dynamic>.from(info[peerId] ?? {});
    return (peer['name'] as String?) ?? (data['peerName'] as String?) ?? 'User';
  }

  String _peerEmailFromChat(Map<String, dynamic> data, String peerId) {
    final info = Map<String, dynamic>.from(data['participantsInfo'] ?? {});
    final peer = Map<String, dynamic>.from(info[peerId] ?? {});
    return (peer['email'] as String?) ??
        (data['peerEmail'] as String?) ??
        'user@example.com';
  }

  Future<void> _saveUser() async {
    final sp = await SharedPreferences.getInstance();
    if (_user == null) {
      await sp.remove('neo_user');
      return;
    }
    await sp.setString('neo_user', jsonEncode(_user!.toJson()));
  }

  Future<void> _saveItems() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(
        'neo_items', jsonEncode(_items.map((e) => e.toJson()).toList()));
  }

  Future<void> _saveChats() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(
        _kChats(), jsonEncode(_chats.map((e) => e.toJson()).toList()));
  }

  Future<void> _saveTheme() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setInt('neo_theme', selectedThemeIndex);
    await sp.setInt('neo_theme_mode', selectedThemeMode);
  }

  String _uidOrGuest() => _user?.uid.isNotEmpty == true ? _user!.uid : 'guest';

  String _kFavs() => 'neo_favs_${_uidOrGuest()}';
  String _kChats() => 'neo_chats_${_uidOrGuest()}';

  Future<void> _loadFavsForCurrentUser() async {
    final sp = await SharedPreferences.getInstance();
    final raw = sp.getString(_kFavs());
    favorites.clear();
    if (raw == null) return;
    try {
      favorites.addAll((jsonDecode(raw) as List).map((e) => e.toString()));
    } catch (_) {}
  }

  Future<void> _loadChatsCacheForCurrentUser() async {
    final sp = await SharedPreferences.getInstance();
    final raw = sp.getString(_kChats());
    _chats.clear();
    if (raw == null) return;
    try {
      final list = (jsonDecode(raw) as List)
          .map((e) => ChatThread.fromJson(e as Map<String, dynamic>))
          .toList();
      _chats.addAll(list);
    } catch (_) {}
  }

  void _setupChatsSubscription(String uid) {
    _chatsSubscription?.cancel();
    _chatsSubscription = FirebaseService.firestore
        ?.collection('chats')
        .where('participants', arrayContains: uid)
        .orderBy('lastMessageAt', descending: true)
        .snapshots()
        .listen((snapshot) {
      _updateChatsFromSnapshot(snapshot);
    });
  }

  Future<void> _saveFavs() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kFavs(), jsonEncode(favorites.toList()));
  }

  Future<void> _saveSettings() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool('neo_notifs', sNotifs);
    await sp.setBool('neo_haptics', sHaptics);
    await sp.setBool('neo_autoplay', sAutoPlay);
    await sp.setBool('neo_neon', sUseNeon);
    await sp.setBool('neo_auto_sync', sAutoSync);
    await sp.setBool('neo_save_history', sSaveHistory);
    await sp.setBool('neo_show_online', sShowOnlineStatus);
  }

  void changeTheme(int index) async {
    selectedThemeIndex = index % NeoThemes.themeColors.length;
    await _saveTheme();
    notifyListeners();
  }

  void changeThemeMode(int mode) async {
    selectedThemeMode = mode.clamp(0, 2);
    await _saveTheme();
    notifyListeners();
  }

  bool isFav(String itemId) => favorites.contains(itemId);

  Future<void> toggleFav(String itemId) async {
    final wasFav = favorites.contains(itemId);
    if (wasFav) {
      favorites.remove(itemId);
    } else {
      favorites.add(itemId);
    }
    await _saveFavs();
    notifyListeners();
    await _updateItemLikes(itemId, wasFav ? -1 : 1);
  }

  Future<void> login({
    required String email,
    required String password,
  }) async {
    try {
      print('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Firebase...');

      final credential = await FirebaseService.auth!.signInWithEmailAndPassword(
        email: email,
        password: password,
      );

      final user = credential.user;
      if (user == null) {
        throw Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.');
      }
      print('? Firebase –≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω: ${user.uid}');
      await _loadUserFromFirebase(user.uid);
    } on FirebaseAuthException catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ Firebase Auth: ${e.code} - ${e.message}');

      String errorMessage;
      switch (e.code) {
        case 'wrong-password':
          errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.';
          break;
        case 'user-not-found':
          errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.';
          break;
        case 'user-disabled':
          errorMessage = '–ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω.';
          break;
        case 'invalid-email':
          errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.';
          break;
        case 'too-many-requests':
          errorMessage = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
          break;
        default:
          errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${e.message}';
      }

      throw Exception(errorMessage);
    } catch (e) {
      rethrow;
    }
  }

  Future<void> signup({
    required String name,
    required String email,
    required String password,
    required String city,
  }) async {
    try {
      print('üîÑ –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Firebase...');

      final credential =
          await FirebaseService.auth!.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      final user = credential.user;
      if (user == null) {
        throw Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
      }
      print('? Firebase —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ${user.uid}');

      await FirebaseService.firestore!.collection('users').doc(user.uid).set({
        'uid': user.uid,
        'name': name,
        'email': email,
        'city': city,
        'role': 'user',
        'likes': 0,
        'level': 1,
        'itemsPosted': 0,
        'itemsApproved': 0,
        'exchangesCompleted': 0,
        'createdAt': DateTime.now().toIso8601String(),
      });

      await _loadUserFromFirebase(user.uid);
    } on FirebaseAuthException catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ Firebase Auth –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${e.code}');

      String errorMessage;
      switch (e.code) {
        case 'email-already-in-use':
          errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
          break;
        case 'weak-password':
          errorMessage =
              '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.';
          break;
        case 'invalid-email':
          errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.';
          break;
        case 'operation-not-allowed':
          errorMessage = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ email –æ—Ç–∫–ª—é—á–µ–Ω–∞.';
          break;
        default:
          errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${e.message}';
      }

      throw Exception(errorMessage);
    } catch (e) {
      rethrow;
    }
  }

  Future<void> logout() async {
    if (_isUserChanging) return;
    _isUserChanging = true;

    try {
      if (sShowOnlineStatus) {
        await setOnlineStatus(false);
      }
      await FirebaseService.auth!.signOut();
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ Firebase: $e');
    }

    _user = null;
    await _saveUser();

    _isUserChanging = false;
    notifyListeners();
  }

  Future<bool> changePassword(
      String currentPassword, String newPassword) async {
    if (_user == null) return false;

    try {
      final user = FirebaseService.auth!.currentUser;
      final credential = EmailAuthProvider.credential(
        email: _user!.email,
        password: currentPassword,
      );

      await user!.reauthenticateWithCredential(credential);
      await user.updatePassword(newPassword);

      return true;
    } on FirebaseAuthException catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è: ${e.code}');
      return false;
    }
  }

  Future<String?> _uploadProfileImage(String localPath) async {
    return _uploadToCloudinary(
      localPath,
      folder: 'profile_images',
    );
  }

  Future<List<String>> uploadItemImages(
    List<String> imagePaths, {
    ValueChanged<double>? onProgress,
  }) async {
    if (imagePaths.isEmpty) return const [];

    final total = imagePaths.length;
    var completed = 0;
    final uploaded = <String>[];

    for (final path in imagePaths) {
      if (path.startsWith('http')) {
        uploaded.add(path);
        completed += 1;
        if (onProgress != null) {
          onProgress(completed / total);
        }
        continue;
      }

      final url = await _uploadToCloudinary(
        path,
        folder: 'item_images',
        onProgress: onProgress == null
            ? null
            : (value) {
                onProgress((completed + value) / total);
              },
      );
      if (url != null && url.isNotEmpty) {
        uploaded.add(url);
      }
      completed += 1;
      if (onProgress != null) {
        onProgress(completed / total);
      }
    }

    return uploaded;
  }

  Future<void> updateProfile(
      {String? name, String? city, String? profileImagePath}) async {
    if (_user == null) return;

    String? profileImageUrl = _user!.profileImageUrl;

    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –≤ Firebase Storage
    if (profileImagePath != null) {
      profileImageUrl = await _uploadProfileImage(profileImagePath);
    }

    _user = _user!.copyWith(
      name: name ?? _user!.name,
      city: city ?? _user!.city,
      profileImagePath: profileImagePath ?? _user!.profileImagePath,
      profileImageUrl: profileImageUrl ?? _user!.profileImageUrl,
    );

    _profileImageCache[_user!.uid] = _user!.profileImageUrl;

    try {
      final updateData = <String, dynamic>{};
      if (name != null) updateData['name'] = name;
      if (city != null) updateData['city'] = city;
      if (profileImageUrl != null) {
        updateData['profileImageUrl'] = profileImageUrl;
      }
      if (profileImagePath != null) {
        updateData['profileImagePath'] = profileImagePath;
      }

      await FirebaseService.firestore!
          .collection('users')
          .doc(_user!.uid)
          .update(updateData);
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤ Firebase: $e');
    }

    await _saveUser();
    notifyListeners();
  }

  Future<void> addItem(Item item) async {
    Item? newItem; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∑–¥–µ—Å—å

    try {
      final itemData = item.toJson();
      itemData.remove('id');

      final docRef =
          await FirebaseService.firestore!.collection('items').add(itemData);

      newItem = item.copyWith(id: docRef.id); // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ

      // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      _items.insert(0, newItem);

      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
      _cachedFilteredItems = [];

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      notifyListeners();

      if (_user != null && item.ownerId == _user!.uid) {
        _user!.itemsPosted++;
        if (item.status == ItemStatus.approved) {
          _user!.itemsApproved++;
        }
        await FirebaseService.firestore!
            .collection('users')
            .doc(_user!.uid)
            .update({
          'itemsPosted': _user!.itemsPosted,
          'itemsApproved': _user!.itemsApproved,
        });
        await _saveUser();
        notifyListeners(); // –ï—â–µ —Ä–∞–∑ —É–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      }

      await _saveItems();
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ Firebase: $e');
      // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
      if (newItem != null) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ newItem –Ω–µ null
        _items.removeWhere((element) => element.id == newItem!.id);
      }
      _cachedFilteredItems = [];
      notifyListeners();
      rethrow;
    }
  }

  Future<void> updateItem(Item updatedItem) async {
    final index = _items.indexWhere((e) => e.id == updatedItem.id);
    if (index != -1) {
      final oldItem = _items[index];

      // –ï—Å–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–Ω–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º),
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é
      if (_user != null &&
          _user!.uid == updatedItem.ownerId &&
          !_user!.isModerator) {
        updatedItem = updatedItem.copyWith(
          status: ItemStatus.pending,
          moderationComment: null,
          updatedAt: DateTime.now(),
        );
      }

      _items[index] = updatedItem;

      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
      _cachedFilteredItems = [];

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      notifyListeners();

      try {
        await FirebaseService.firestore!
            .collection('items')
            .doc(updatedItem.id)
            .update(updatedItem.toJson());
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ Firebase: $e');
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        _items[index] = oldItem;
        _cachedFilteredItems = [];
        notifyListeners();
        rethrow;
      }

      await _saveItems();
    }
  }

  Future<void> moderateItem(String itemId, ItemStatus status,
      {String? comment}) async {
    final index = _items.indexWhere((e) => e.id == itemId);
    if (index != -1) {
      final oldItem = _items[index];
      _items[index] = oldItem.copyWith(
        status: status,
        moderationComment: status == ItemStatus.rejected ? comment : null,
      );

      // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
      _cachedFilteredItems = [];

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      notifyListeners();

      if (status == ItemStatus.approved && _user != null) {
        final item = _items[index];
        if (item.ownerId == _user!.uid) {
          _user!.itemsApproved++;
          await _saveUser();
          notifyListeners(); // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        }
      }

      try {
        await FirebaseService.firestore!
            .collection('items')
            .doc(itemId)
            .update({
          'status': status == ItemStatus.approved ? 'approved' : 'rejected',
          'moderationComment': status == ItemStatus.rejected ? comment : null,
          'updatedAt': DateTime.now().toIso8601String(),
        });

        final item = _items[index];
        final decisionText = status == ItemStatus.approved
            ? '–í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ'
            : '–í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ';
        final body = comment?.isNotEmpty == true
            ? '$decisionText: $comment'
            : decisionText;
        final notificationId = await _createNotification(
          toUserId: item.ownerId,
          fromUserId: _user?.uid ?? 'system',
          fromName: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è',
          chatId: '',
          itemId: item.id,
          action: status == ItemStatus.approved
              ? 'moderation_approved'
              : 'moderation_rejected',
          comment: comment,
          title: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è',
          body: body,
        );
        final sent = await _sendPushToUser(
          userId: item.ownerId,
          title: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è',
          body: body,
        );
        if (notificationId != null) {
          await _updateNotificationStatus(
              notificationId, sent ? 'sent' : 'failed');
        }
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ Firebase: $e');
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        _items[index] = oldItem;
        _cachedFilteredItems = [];
        notifyListeners();
        rethrow;
      }

      await _saveItems();
    }
  }

  Future<void> deleteItem(String itemId) async {
    final item = _items.firstWhere((e) => e.id == itemId);
    _items.removeWhere((e) => e.id == itemId);
    favorites.remove(itemId);

    // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
    _cachedFilteredItems = [];

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    notifyListeners();

    try {
      await FirebaseService.firestore!.collection('items').doc(itemId).delete();
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ Firebase: $e');
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
      _items.add(item);
      _cachedFilteredItems = [];
      notifyListeners();
      rethrow;
    }

    await _saveItems();
    await _saveFavs();
  }

  List<Item> getApprovedItems() {
    return _items.where((item) => item.status == ItemStatus.approved).toList();
  }

  List<Item> getPendingItems() {
    return _items.where((item) => item.status == ItemStatus.pending).toList();
  }

  List<Item> myItems() {
    final me = _user;
    if (me == null) return [];
    final list = _items.where((e) => e.ownerId == me.uid).toList();
    list.sort((a, b) => b.createdAt.compareTo(a.createdAt));
    return list;
  }

  List<Item> itemsByOwner(String ownerId) {
    final list = _items.where((e) => e.ownerId == ownerId).toList();
    list.sort((a, b) => b.createdAt.compareTo(a.createdAt));
    return list;
  }

  List<Item> getSimilarItems(Item item, {int limit = 3}) {
    final query = item.title.toLowerCase();
    return getApprovedItems()
        .where((e) =>
            e.id != item.id &&
            (e.category == item.category ||
                e.city == item.city ||
                e.title.toLowerCase().contains(query) ||
                query.contains(e.title.toLowerCase())))
        .take(limit)
        .toList();
  }

  Future<String> buildShareUrl(Item item) async {
    final slug = _slugifyTitle(item.title);
    final code = await _getOrCreateShortCode(item);
    return 'https://freeobmin.pp.ua/${slug}_$code';
  }

  Future<String> _getOrCreateShortCode(Item item) async {
    final firestore = FirebaseService.firestore;
    if (firestore == null) return item.id;

    try {
      final existing = await firestore
          .collection('short_links')
          .where('itemId', isEqualTo: item.id)
          .limit(1)
          .get();
      if (existing.docs.isNotEmpty) {
        return existing.docs.first.id;
      }
    } catch (e) {
      print('? Short link lookup failed: $e');
    }

    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    final random = Random();
    for (var attempt = 0; attempt < 5; attempt++) {
      final code = List.generate(
        6,
        (_) => chars[random.nextInt(chars.length)],
      ).join();
      final docRef = firestore.collection('short_links').doc(code);
      final doc = await docRef.get();
      if (doc.exists) {
        continue;
      }
      await docRef.set({
        'itemId': item.id,
        'slug': _slugifyTitle(item.title),
        'createdAt': FieldValue.serverTimestamp(),
      });
      return code;
    }

    return item.id;
  }

  Future<String?> resolveShortCode(String code) async {
    final firestore = FirebaseService.firestore;
    if (firestore == null) return null;
    try {
      final doc = await firestore.collection('short_links').doc(code).get();
      if (!doc.exists) return null;
      final data = doc.data();
      return data?['itemId'] as String?;
    } catch (e) {
      print('? Short link resolve failed: $e');
      return null;
    }
  }

  Future<Item?> fetchItemById(String itemId) async {
    try {
      final existing = _items.firstWhere(
        (e) => e.id == itemId,
        orElse: () => Item(
          id: '',
          title: '',
          desc: '',
          city: '',
          category: '',
          type: ItemType.exchange,
          likes: 0,
          views: 0,
          ownerId: '',
          ownerName: '',
          ownerEmail: '',
          createdAt: DateTime.now(),
          photoPaths: const [],
          photoUrls: const [],
        ),
      );
      if (existing.id.isNotEmpty) {
        return existing;
      }
      final doc = await FirebaseService.firestore
          ?.collection('items')
          .doc(itemId)
          .get();
      if (doc == null || !doc.exists) return null;
      final data = doc.data() as Map<String, dynamic>;
      data['id'] = doc.id;
      return Item.fromJson(data);
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ item $itemId: $e');
      return null;
    }
  }

  Future<void> incrementViews(String itemId) async {
    final index = _items.indexWhere((e) => e.id == itemId);
    if (index == -1) return;

    final oldItem = _items[index];
    final meId = _user?.uid;
    final sp = await SharedPreferences.getInstance();
    final viewedKey = 'neo_viewed_items_${meId ?? 'guest'}';
    final raw = sp.getString(viewedKey);
    final viewed = raw != null
        ? (jsonDecode(raw) as List).map((e) => e.toString()).toSet()
        : <String>{};

    if (viewed.contains(itemId)) return;
    viewed.add(itemId);
    await sp.setString(viewedKey, jsonEncode(viewed.toList()));

    bool didIncrement = false;

    try {
      if (meId != null) {
        final docRef =
            FirebaseService.firestore!.collection('items').doc(itemId);
        didIncrement =
            await FirebaseService.firestore!.runTransaction<bool>((tx) async {
          final snap = await tx.get(docRef);
          final data = snap.data() ?? {};
          final viewedBy = List<String>.from(data['viewedBy'] ?? []);
          if (viewedBy.contains(meId)) return false;
          final currentViews = (data['views'] ?? oldItem.views) as int;
          tx.update(docRef, {
            'views': currentViews + 1,
            'viewedBy': FieldValue.arrayUnion([meId]),
          });
          return true;
        });
      } else {
        await FirebaseService.firestore!
            .collection('items')
            .doc(itemId)
            .update({'views': FieldValue.increment(1)});
        didIncrement = true;
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: $e');
    }

    if (!didIncrement) return;

    final newItem = oldItem.copyWith(views: oldItem.views + 1);
    _items[index] = newItem;
    _cachedFilteredItems = [];
    notifyListeners();
    _saveItems();
  }

  Future<void> setActiveViewer(String itemId, bool active) async {
    final uid = _user?.uid;
    if (uid == null) return;

    try {
      final docRef = FirebaseService.firestore!.collection('items').doc(itemId);
      if (active) {
        await docRef.update({
          'activeViewers': FieldValue.arrayUnion([uid]),
          'activeViewersUpdatedAt': DateTime.now().toIso8601String(),
        });
      } else {
        await docRef.update({
          'activeViewers': FieldValue.arrayRemove([uid]),
        });
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: $e');
    }
  }

  Future<void> incrementLikes(String itemId) async {
    await _updateItemLikes(itemId, 1);
  }

  Future<void> _updateItemLikes(String itemId, int delta) async {
    final index = _items.indexWhere((e) => e.id == itemId);
    if (index == -1) return;

    final oldItem = _items[index];
    final newLikes = max(0, oldItem.likes + delta);
    final newItem = oldItem.copyWith(likes: newLikes);
    _items[index] = newItem;

    _cachedFilteredItems = [];
    notifyListeners();

    try {
      await FirebaseService.firestore!
          .collection('items')
          .doc(itemId)
          .update({'likes': newItem.likes});
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∞–π–∫–æ–≤: $e');
      _items[index] = oldItem;
      _cachedFilteredItems = [];
      notifyListeners();
    }

    _saveItems();
  }

  int get totalUnread => _chats.fold<int>(0, (a, b) => a + max(0, b.unread));
  int get totalUnreadNotifications =>
      _notifications.where((n) => !n.read).length;

  Future<void> markChatRead(String chatId) async {
    final index = _chats.indexWhere((e) => e.id == chatId);
    if (index != -1) {
      final oldChat = _chats[index];
      final newChat = ChatThread(
        id: oldChat.id,
        peerId: oldChat.peerId,
        peerName: oldChat.peerName,
        peerEmail: oldChat.peerEmail,
        messages: oldChat.messages,
        unread: 0,
        relatedItemId: oldChat.relatedItemId,
      );

      _chats[index] = newChat;

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      notifyListeners();

      try {
        await FirebaseService.firestore!
            .collection('chats')
            .doc(chatId)
            .update({
          'unread.${_user!.uid}': 0,
        });
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —á–∞—Ç–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º –≤ Firebase: $e');
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        _chats[index] = oldChat;
        notifyListeners();
        rethrow;
      }

      await _saveChats();
    }
  }

  String _threadId(String meId, String peerId) {
    final a = meId.compareTo(peerId) <= 0 ? meId : peerId;
    final b = meId.compareTo(peerId) <= 0 ? peerId : meId;
    return 't_${a}_$b';
  }

  Future<String> ensureChatWith({
    required String peerId,
    required String peerName,
    required String peerEmail,
    String? itemId,
    String? itemTitle,
  }) async {
    final me = _user;
    if (me == null) throw StateError('Not logged in');

    // IMPORTANT:
    // Firestore –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'array-contains' (–∏/–∏–ª–∏ array-contains-any) –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
    // –†–∞–Ω–µ–µ –∑–¥–µ—Å—å –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞ —á–µ—Ä–µ–∑ query –ø–æ participants, —á—Ç–æ —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    // –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø–∞–¥–µ–Ω–∏—é —Å:
    // "!hasArrayContains: You cannot use 'array-contains' filters more than once."
    //
    // –†–µ—à–µ–Ω–∏–µ: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π id —á–∞—Ç–∞ –¥–ª—è –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    // –¢–æ–≥–¥–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ .doc(id).get(), –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ array-contains —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    final threadId = _threadId(me.uid, peerId);

    try {
      final docRef =
          FirebaseService.firestore!.collection('chats').doc(threadId);
      final snap = await docRef.get();

      if (snap.exists) {
        // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω—è–µ–º participantsInfo, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å peerName/peerEmail —É –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω.
        final data = snap.data() ?? {};
        final participantsInfo =
            Map<String, dynamic>.from(data['participantsInfo'] ?? {});
        final shouldPatch = !(participantsInfo.containsKey(me.uid) &&
            participantsInfo.containsKey(peerId));

        if (shouldPatch) {
          await docRef.set({
            'participants': [me.uid, peerId],
            'participantsInfo': {
              me.uid: {'name': me.name, 'email': me.email},
              peerId: {'name': peerName, 'email': peerEmail},
            },
            'updatedAt': DateTime.now().toIso8601String(),
          }, SetOptions(merge: true));
        }
        return threadId;
      }

      // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π (—Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º id).
      final createdAt = DateTime.now();
      final firstMessageId = 'm_${createdAt.millisecondsSinceEpoch}';

      final chatData = <String, dynamic>{
        'participants': [me.uid, peerId],
        'participantsInfo': {
          me.uid: {'name': me.name, 'email': me.email},
          peerId: {'name': peerName, 'email': peerEmail},
        },
        // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –ø–∞—Ä—Å–µ—Ä–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback).
        'peerName': peerName,
        'peerEmail': peerEmail,
        'messages': [
          {
            'id': firstMessageId,
            'text': '–ü—Ä–∏–≤–µ—Ç! –ü–∏—à—É –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é.',
            'from': me.uid,
            'at': createdAt.toIso8601String(),
            'type': 'text',
            'itemId': itemId,
            'itemTitle': itemTitle,
          }
        ],
        'createdAt': createdAt.toIso8601String(),
        'lastMessageAt': createdAt.toIso8601String(),
        'lastMessage': '–ü—Ä–∏–≤–µ—Ç! –ü–∏—à—É –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é.',
        // unread ‚Äî —Å–ª–æ–≤–∞—Ä—å —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ uid
        'unread': {me.uid: 0, peerId: 1},
        'relatedItemId': itemId,
      };

      await docRef.set(chatData);

      final newChat = ChatThread(
        id: threadId,
        peerId: peerId,
        peerName: peerName,
        peerEmail: peerEmail,
        messages: [
          ChatMessage(
            id: firstMessageId,
            text: '–ü—Ä–∏–≤–µ—Ç! –ü–∏—à—É –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é.',
            fromMe: true,
            at: createdAt,
            itemId: itemId,
            itemTitle: itemTitle,
          ),
        ],
        unread: 0,
        relatedItemId: itemId,
      );

      _chats.insert(0, newChat);
      await _saveChats();
      notifyListeners();

      return threadId;
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ –≤ Firebase: $e');
      rethrow;
    }
  }

  Future<void> sendMessage(String chatId, String text,
      {String? itemId, String? itemTitle}) async {
    final index = _chats.indexWhere((e) => e.id == chatId);
    if (index != -1) {
      final me = _user;
      if (me == null) return;

      final newMessage = ChatMessage(
        id: 'm_${DateTime.now().millisecondsSinceEpoch}',
        text: text.trim(),
        fromMe: true,
        at: DateTime.now(),
        itemId: itemId,
        itemTitle: itemTitle,
      );

      final oldChat = _chats[index];
      final updatedMessages = List<ChatMessage>.from(oldChat.messages)
        ..add(newMessage);

      final updatedChat = ChatThread(
        id: oldChat.id,
        peerId: oldChat.peerId,
        peerName: oldChat.peerName,
        peerEmail: oldChat.peerEmail,
        messages: updatedMessages,
        unread: oldChat.unread,
        relatedItemId: oldChat.relatedItemId,
      );

      _chats.removeAt(index);
      _chats.insert(0, updatedChat);

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
      notifyListeners();

      try {
        await FirebaseService.firestore!
            .collection('chats')
            .doc(chatId)
            .update({
          'messages': FieldValue.arrayUnion([
            {
              'id': newMessage.id,
              'text': newMessage.text,
              'from': me.uid,
              'at': newMessage.at.toIso8601String(),
              'type': 'text',
              'itemId': itemId,
              'itemTitle': itemTitle,
            }
          ]),
          'lastMessageAt': newMessage.at.toIso8601String(),
          'lastMessage': text,
          'unread.${oldChat.peerId}': FieldValue.increment(1),
        });

        await _saveChats();
        final notificationId = await _createNotification(
          toUserId: oldChat.peerId,
          fromUserId: me.uid,
          fromName: me.name,
          chatId: chatId,
          title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
          body: text,
        );
        final sent = await _sendPushToUser(
          userId: oldChat.peerId,
          title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
          body: text,
        );
        if (notificationId != null) {
          await _updateNotificationStatus(
              notificationId, sent ? 'sent' : 'failed');
        }
      } catch (e) {
        print('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Firebase: $e');
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        _chats.removeWhere((c) => c.id == chatId);
        _chats.add(oldChat);
        _chats.sort((a, b) => b.last.at.compareTo(a.last.at));
        await _saveChats();
        notifyListeners();
        rethrow;
      }
    }
  }

  Future<String?> _uploadChatImage(String localPath, String chatId,
      {ValueChanged<double>? onProgress}) async {
    return _uploadToCloudinary(
      localPath,
      folder: 'chat_images',
      onProgress: onProgress,
    );
  }

  String _cloudinaryContentType(String path) {
    final lower = path.toLowerCase();
    if (lower.endsWith('.png')) return 'image/png';
    if (lower.endsWith('.webp')) return 'image/webp';
    return 'image/jpeg';
  }

  Future<String?> _uploadToCloudinary(
    String localPath, {
    String? folder,
    ValueChanged<double>? onProgress,
  }) async {
    if (_cloudinaryCloudName.isEmpty || _cloudinaryUploadPreset.isEmpty) {
      print('? Cloudinary –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã');
      return null;
    }

    try {
      final file = File(localPath);
      if (!await file.exists()) return null;
      final totalBytes = await file.length();

      final uri = Uri.parse(
          'https://api.cloudinary.com/v1_1/$_cloudinaryCloudName/image/upload');
      final boundary = '----freeobmin_${DateTime.now().millisecondsSinceEpoch}';
      final request = await HttpClient().postUrl(uri);
      request.headers.set(
        HttpHeaders.contentTypeHeader,
        'multipart/form-data; boundary=$boundary',
      );

      void writeField(String name, String value) {
        request.add(utf8.encode('--$boundary\r\n'));
        request.add(utf8
            .encode('Content-Disposition: form-data; name="$name"\r\n\r\n'));
        request.add(utf8.encode('$value\r\n'));
      }

      writeField('upload_preset', _cloudinaryUploadPreset);
      if (folder != null && folder.isNotEmpty) {
        writeField('folder', folder);
      }

      final fileName = localPath.split(Platform.pathSeparator).last;
      request.add(utf8.encode('--$boundary\r\n'));
      request.add(utf8.encode(
          'Content-Disposition: form-data; name="file"; filename="$fileName"\r\n'));
      request.add(utf8.encode(
          'Content-Type: ${_cloudinaryContentType(localPath)}\r\n\r\n'));

      int sent = 0;
      await for (final chunk in file.openRead()) {
        request.add(chunk);
        sent += chunk.length;
        if (onProgress != null && totalBytes > 0) {
          onProgress((sent / totalBytes).clamp(0.0, 1.0));
        }
      }
      request.add(utf8.encode('\r\n--$boundary--\r\n'));

      final response = await request.close();
      final body = await response.transform(utf8.decoder).join();
      if (response.statusCode < 200 || response.statusCode >= 300) {
        print('? Cloudinary upload failed: ${response.statusCode} $body');
        return null;
      }
      final payload = jsonDecode(body) as Map<String, dynamic>;
      return (payload['secure_url'] ?? payload['url'])?.toString();
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Cloudinary: $e');
      return null;
    }
  }

  Future<void> sendImageMessage(String chatId, String imagePath,
      {String? itemId,
      String? itemTitle,
      ValueChanged<double>? onProgress}) async {
    final index = _chats.indexWhere((e) => e.id == chatId);
    if (index == -1) return;

    final me = _user;
    if (me == null) return;

    final imageUrl =
        await _uploadChatImage(imagePath, chatId, onProgress: onProgress);
    if (imageUrl == null) {
      throw Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
    }

    final newMessage = ChatMessage(
      id: 'm_${DateTime.now().millisecondsSinceEpoch}',
      text: '',
      fromMe: true,
      at: DateTime.now(),
      type: MessageType.image,
      imageUrl: imageUrl,
      itemId: itemId,
      itemTitle: itemTitle,
    );

    final oldChat = _chats[index];
    final updatedMessages = List<ChatMessage>.from(oldChat.messages)
      ..add(newMessage);

    final updatedChat = ChatThread(
      id: oldChat.id,
      peerId: oldChat.peerId,
      peerName: oldChat.peerName,
      peerEmail: oldChat.peerEmail,
      messages: updatedMessages,
      unread: oldChat.unread,
      relatedItemId: oldChat.relatedItemId,
    );

    _chats.removeAt(index);
    _chats.insert(0, updatedChat);
    notifyListeners();

    try {
      await FirebaseService.firestore!.collection('chats').doc(chatId).update({
        'messages': FieldValue.arrayUnion([
          {
            'id': newMessage.id,
            'text': '',
            'from': me.uid,
            'at': newMessage.at.toIso8601String(),
            'type': 'image',
            'imageUrl': imageUrl,
            'itemId': itemId,
            'itemTitle': itemTitle,
          }
        ]),
        'lastMessageAt': newMessage.at.toIso8601String(),
        'lastMessage': '–§–æ—Ç–æ',
        'unread.${oldChat.peerId}': FieldValue.increment(1),
      });

      await _saveChats();
      final notificationId = await _createNotification(
        toUserId: oldChat.peerId,
        fromUserId: me.uid,
        fromName: me.name,
        chatId: chatId,
        title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
        body: '–§–æ—Ç–æ',
      );
      final sent = await _sendPushToUser(
        userId: oldChat.peerId,
        title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
        body: '–§–æ—Ç–æ',
      );
      if (notificationId != null) {
        await _updateNotificationStatus(
            notificationId, sent ? 'sent' : 'failed');
      }
    } catch (e) {
      print('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –≤ —á–∞—Ç: $e');
      _chats.removeWhere((c) => c.id == chatId);
      _chats.add(oldChat);
      _chats.sort((a, b) => b.last.at.compareTo(a.last.at));
      await _saveChats();
      notifyListeners();
      rethrow;
    }
  }

  Future<void> setSettings({
    bool? notifs,
    bool? haptics,
    bool? autoplay,
    bool? neon,
    bool? autoSync,
    bool? saveHistory,
    bool? showOnlineStatus,
  }) async {
    if (notifs != null) sNotifs = notifs;
    if (haptics != null) sHaptics = haptics;
    if (autoplay != null) sAutoPlay = autoplay;
    if (neon != null) sUseNeon = neon;
    if (autoSync != null) sAutoSync = autoSync;
    if (saveHistory != null) sSaveHistory = saveHistory;
    if (showOnlineStatus != null) sShowOnlineStatus = showOnlineStatus;
    await _saveSettings();
    notifyListeners();
  }

  Future<void> resetData() async {
    final sp = await SharedPreferences.getInstance();
    await sp.remove('neo_items');
    await sp.remove('neo_chats_guest');
    await sp.remove('neo_favs_guest');
    // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
    await sp.remove(_kChats());
    await sp.remove(_kFavs());
    _items.clear();
    _chats.clear();
    favorites.clear();

    // –û—á–∏—â–∞–µ–º –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
    _cachedFilteredItems = [];

    await _saveItems();
    await _saveChats();
    await _saveFavs();
    notifyListeners();
  }

  List<Achievement> getUserAchievements() {
    if (_user == null) return [];

    final achievements = [
      Achievement(
        id: 'novice',
        title: '–ù–æ–≤–∏—á–æ–∫ –æ–±–º–µ–Ω–∞',
        description: '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',
        icon: Icons.star_outline_rounded,
        color: Colors.blue,
        progress: _user!.itemsPosted,
        target: 1,
        unlocked: _user!.itemsPosted >= 1,
      ),
      Achievement(
        id: 'collector',
        title: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',
        description: '–°–æ–∑–¥–∞–π—Ç–µ 5 –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
        icon: Icons.collections_rounded,
        color: Colors.purple,
        progress: _user!.itemsPosted,
        target: 5,
        unlocked: _user!.itemsPosted >= 5,
      ),
      Achievement(
        id: 'popular',
        title: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π',
        description: '–ü–æ–ª—É—á–∏—Ç–µ 10 –ª–∞–π–∫–æ–≤ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö',
        icon: Icons.favorite_rounded,
        color: Colors.red,
        progress: _user!.likes,
        target: 10,
        unlocked: _user!.likes >= 10,
      ),
      Achievement(
        id: 'approved_master',
        title: '–ú–∞—Å—Ç–µ—Ä –æ–¥–æ–±—Ä–µ–Ω–∏–π',
        description: '–ü–æ–ª—É—á–∏—Ç–µ 3 –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        icon: Icons.check_circle_rounded,
        color: Colors.green,
        progress: _user!.itemsApproved,
        target: 3,
        unlocked: _user!.itemsApproved >= 3,
      ),
      Achievement(
        id: 'trader',
        title: '–¢—Ä–µ–π–¥–µ—Ä',
        description: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ 1 –æ–±–º–µ–Ω',
        icon: Icons.swap_horiz_rounded,
        color: Colors.orange,
        progress: _user!.exchangesCompleted,
        target: 1,
        unlocked: _user!.exchangesCompleted >= 1,
      ),
      Achievement(
        id: 'expert',
        title: '–≠–∫—Å–ø–µ—Ä—Ç –æ–±–º–µ–Ω–∞',
        description: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ 5 –æ–±–º–µ–Ω–æ–≤',
        icon: Icons.verified_rounded,
        color: Colors.deepPurple,
        progress: _user!.exchangesCompleted,
        target: 5,
        unlocked: _user!.exchangesCompleted >= 5,
      ),
      Achievement(
        id: 'socializer',
        title: '–û–±—â–∏—Ç–µ–ª—å–Ω—ã–π',
        description: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–∞—Ö',
        icon: Icons.chat_rounded,
        color: Colors.teal,
        progress: _user!.exchangesCompleted * 10,
        target: 50,
        unlocked: _user!.exchangesCompleted >= 5,
      ),
    ];

    return achievements;
  }

  int get unlockedAchievementsCount {
    return getUserAchievements().where((a) => a.unlocked).length;
  }

  @override
  void dispose() {
    _itemsSubscription?.cancel();
    _chatsSubscription?.cancel();
    _authSubscription?.cancel();
    super.dispose();
  }
}

/* ===========================
        WIDGETS
=========================== */

class NeoRoot extends StatefulWidget {
  const NeoRoot({super.key});

  @override
  State<NeoRoot> createState() => _NeoRootState();
}

class _NeoRootState extends State<NeoRoot>
    with SingleTickerProviderStateMixin, WidgetsBindingObserver {
  late AnimationController _controller;
  late Animation<double> _animation;
  final AppLinks _appLinks = AppLinks();
  StreamSubscription<Uri>? _linkSub;
  String? _pendingItemId;
  String? _pendingShortCode;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _initDeepLinks();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 1000),
      vsync: this,
    );
    _animation = CurvedAnimation(
      parent: _controller,
      curve: Curves.easeOutCubic,
    );

    WidgetsBinding.instance.addPostFrameCallback((_) async {
      await neoStore.init();
      if (mounted) {
        _controller.forward();
        final pending = _pendingItemId;
        if (pending != null) {
          _pendingItemId = null;
          _openItemFromLink(pending);
        }
        final pendingCode = _pendingShortCode;
        if (pendingCode != null) {
          _pendingShortCode = null;
          _openItemFromShortCode(pendingCode);
        }
        setState(() {});
      }
    });
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _linkSub?.cancel();
    _controller.dispose();
    super.dispose();
  }

  Future<void> _initDeepLinks() async {
    try {
      final initial = await _appLinks.getInitialLink();
      if (initial != null) {
        _handleIncomingLink(initial);
      }
    } catch (e) {
      print('? –û—à–∏–±–∫–∞ initial deep link: $e');
    }

    _linkSub = _appLinks.uriLinkStream.listen(
      _handleIncomingLink,
      onError: (error) => print('? –û—à–∏–±–∫–∞ deep link: $error'),
    );
  }

  void _handleIncomingLink(Uri uri) {
    final itemId = _extractItemIdFromUri(uri);
    if (itemId != null) {
      if (!neoStore.ready) {
        _pendingItemId = itemId;
        return;
      }
      _openItemFromLink(itemId);
      return;
    }

    final shortCode = _extractShortCodeFromUri(uri);
    if (shortCode == null) return;
    if (!neoStore.ready) {
      _pendingShortCode = shortCode;
      return;
    }
    _openItemFromShortCode(shortCode);
  }

  void _openItemFromLink(String itemId) {
    final nav = _rootNavKey.currentState;
    if (nav == null) return;
    nav.push(
      MaterialPageRoute(
        builder: (context) => NeoItemDetailPage(
          itemId: itemId,
        ),
      ),
    );
  }

  Future<void> _openItemFromShortCode(String code) async {
    final nav = _rootNavKey.currentState;
    if (nav == null) return;
    final itemId = await neoStore.resolveShortCode(code);
    if (itemId == null || itemId.isEmpty) {
      print('? Short link not found: $code');
      return;
    }
    nav.push(
      MaterialPageRoute(
        builder: (context) => NeoItemDetailPage(
          itemId: itemId,
        ),
      ),
    );
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    final showOnline = neoStore.sShowOnlineStatus;
    if (!showOnline) return;

    if (state == AppLifecycleState.resumed) {
      neoStore.setOnlineStatus(true);
    } else if (state == AppLifecycleState.paused ||
        state == AppLifecycleState.inactive ||
        state == AppLifecycleState.detached) {
      neoStore.setOnlineStatus(false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [
              Theme.of(context).colorScheme.surface.withAlpha(77),
              Theme.of(context).colorScheme.surfaceContainer.withAlpha(26),
            ],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: Stack(
          children: [
            FadeTransition(
              opacity: _animation,
              child: ScaleTransition(
                scale: _animation,
                child: Builder(
                  builder: (context) {
                    if (!neoStore.ready) {
                      return const _NeoSplash();
                    }
                    return const NeoShell();
                  },
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _NeoSplash extends StatelessWidget {
  const _NeoSplash();

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0.0, end: 1.0),
      duration: const Duration(milliseconds: 900),
      curve: Curves.easeOutCubic,
      builder: (context, value, child) {
        return Container(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                cs.surface,
                cs.surfaceContainer.withAlpha(204),
              ],
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
            ),
          ),
          child: Opacity(
            opacity: value,
            child: Transform.scale(
              scale: 0.9 + (0.1 * value),
              child: child,
            ),
          ),
        );
      },
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              width: 96,
              height: 96,
              decoration: NeoThemes.getNeonDecoration(NeoThemes.currentColor),
              child: Center(
                child: Image.asset(
                  'assets/images/logo.png',
                  width: 48,
                  height: 48,
                  fit: BoxFit.contain,
                ),
              ),
            ),
            const SizedBox(height: 24),
            ShaderMask(
              shaderCallback: (bounds) {
                return LinearGradient(
                  colors: [
                    NeoThemes.currentColor,
                    NeoThemes.currentNeon,
                  ],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ).createShader(bounds);
              },
              child: Text(
                'NeoObmin',
                style: Theme.of(context).textTheme.displayLarge?.copyWith(
                      color: Colors.white,
                    ),
              ),
            ),
            const SizedBox(height: 16),
            Text(
              '–ó–∞–≥—Ä—É–∑–∫–∞...',
              style: TextStyle(
                color: cs.onSurface.withAlpha(153),
                fontSize: 14,
              ),
            ),
          ],
        ),
      ),
    );
  }

}

class NeoShell extends StatefulWidget {
  const NeoShell({super.key});

  @override
  State<NeoShell> createState() => _NeoShellState();
}

class _NeoShellState extends State<NeoShell> {
  int _selectedIndex = 0;

  @override
  void initState() {
    super.initState();
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    neoStore.addListener(_handleUserChange);
  }

  @override
  void dispose() {
    neoStore.removeListener(_handleUserChange);
    super.dispose();
  }

  void _handleUserChange() {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å (–≥–¥–µ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞)
    if (neoStore.user == null && _selectedIndex != 3) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted) {
          setState(() {
            _selectedIndex = 3; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ—Ñ–∏–ª—è
          });
        }
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBody: true,
      body: Stack(
        children: [
          Positioned.fill(
            child: Container(
              decoration: NeoThemes.getAppBackground(context),
            ),
          ),
          _getPage(),
          Positioned(
            bottom: 12,
            left: 16,
            right: 16,
            child: SafeArea(
              top: false,
              minimum: const EdgeInsets.only(bottom: 6),
              child: _NeoNavBar(
                index: _selectedIndex,
                onTap: (index) => setState(() => _selectedIndex = index),
              ),
            ),
          ),
        ],
      ),
      floatingActionButton: _NeoFAB(
        onTap: () => _handleCreate(),
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
    );
  }

  Widget _getPage() {
    switch (_selectedIndex) {
      case 0:
        return const NeoFeed();
      case 1:
        return const NeoChats();
      case 2:
        return const NeoFavorites();
      case 3:
        return const NeoProfile();
      default:
        return const NeoFeed();
    }
  }

  void _handleCreate() {
    if (neoStore.user == null) {
      Navigator.push(
        context,
        MaterialPageRoute(builder: (context) => const NeoLoginPage()),
      );
    } else {
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => const NeoCreateItemPage(),
          fullscreenDialog: true,
        ),
      );
    }
  }
}

class _NeoNavBar extends StatelessWidget {
  final int index;
  final ValueChanged<int> onTap;

  const _NeoNavBar({
    required this.index,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: neoStore,
      builder: (context, _) {
        final cs = Theme.of(context).colorScheme;
        final isDark = Theme.of(context).brightness == Brightness.dark;

        return ClipRRect(
          borderRadius: BorderRadius.circular(22),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 12, sigmaY: 12),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
              decoration: BoxDecoration(
                color: cs.surface.withAlpha(isDark ? 220 : 235),
                borderRadius: BorderRadius.circular(22),
                border: Border.all(
                  color: cs.outline.withAlpha(90),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withAlpha(isDark ? 80 : 18),
                    blurRadius: 18,
                    offset: const Offset(0, 8),
                  ),
                ],
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Expanded(
                    child: Center(
                      child: _NavItem(
                        icon: Icons.home_rounded,
                        label: '–õ–µ–Ω—Ç–∞',
                        active: index == 0,
                        onTap: () => onTap(0),
                      ),
                    ),
                  ),
                  Expanded(
                    child: Center(
                      child: _NavItem(
                        icon: Icons.chat_rounded,
                        label: '–ß–∞—Ç—ã',
                        active: index == 1,
                        badgeCount: neoStore.totalUnread,
                        onTap: () => onTap(1),
                      ),
                    ),
                  ),
                  const SizedBox(width: 72),
                  Expanded(
                    child: Center(
                      child: _NavItem(
                        icon: Icons.favorite_rounded,
                        label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
                        active: index == 2,
                        onTap: () => onTap(2),
                      ),
                    ),
                  ),
                  Expanded(
                    child: Center(
                      child: _NavItem(
                        icon: Icons.person_rounded,
                        label: '–ü—Ä–æ—Ñ–∏–ª—å',
                        active: index == 3,
                        onTap: () => onTap(3),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

class _NavItem extends StatefulWidget {
  final IconData icon;
  final String label;
  final bool active;
  final VoidCallback onTap;
  final int badgeCount;

  const _NavItem({
    required this.icon,
    required this.label,
    required this.active,
    required this.onTap,
    this.badgeCount = 0,
  });

  @override
  State<_NavItem> createState() => _NavItemState();
}

class _NavItemState extends State<_NavItem>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );
    _scale = Tween<double>(begin: 1.0, end: 1.2).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _handleHover(bool hover) {
    if (hover) {
      _controller.forward();
    } else {
      _controller.reverse();
    }
  }

  @override
  Widget build(BuildContext context) {
    final color = NeoThemes.currentColor;
    final cs = Theme.of(context).colorScheme;

    return MouseRegion(
      onEnter: (_) => _handleHover(true),
      onExit: (_) => _handleHover(false),
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedBuilder(
          animation: _controller,
          builder: (context, child) {
            return Transform.scale(
              scale: _scale.value,
              child: child,
            );
          },
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 200),
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
            decoration: BoxDecoration(
              color:
                  widget.active ? color.withAlpha(28) : Colors.transparent,
              borderRadius: BorderRadius.circular(14),
              border: Border.all(
                color: widget.active
                    ? color.withAlpha(120)
                    : Colors.transparent,
              ),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Stack(
                  clipBehavior: Clip.none,
                  children: [
                    Icon(
                      widget.icon,
                      color:
                          widget.active ? color : cs.onSurface.withAlpha(150),
                      size: 22,
                    ),
                    if (widget.badgeCount > 0)
                      Positioned(
                        top: -6,
                        right: -10,
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: const Color(0xFFE53935),
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(
                              color: Theme.of(context).colorScheme.surface,
                              width: 1.5,
                            ),
                          ),
                          child: Text(
                            '${widget.badgeCount}',
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 9,
                              fontWeight: FontWeight.w700,
                            ),
                          ),
                        ),
                      ),
                  ],
                ),
                const SizedBox(height: 6),
                Text(
                  widget.label,
                  style: TextStyle(
                    fontSize: 10,
                    color: widget.active ? color : cs.onSurface.withAlpha(150),
                    fontWeight: FontWeight.w600,
                    letterSpacing: 0.3,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _NeoFAB extends StatefulWidget {
  final VoidCallback onTap;

  const _NeoFAB({required this.onTap});

  @override
  State<_NeoFAB> createState() => _NeoFABState();
}

class _NeoFABState extends State<_NeoFAB> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _scale = Tween<double>(begin: 1.0, end: 1.1).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _handleHover(bool hover) {
    if (hover) {
      _controller.forward();
    } else {
      _controller.reverse();
    }
  }

  @override
  Widget build(BuildContext context) {
    final accent = NeoThemes.currentColor;
    return MouseRegion(
      onEnter: (_) => _handleHover(true),
      onExit: (_) => _handleHover(false),
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedBuilder(
          animation: _controller,
          builder: (context, child) {
            return Transform.scale(
              scale: _scale.value,
              child: child,
            );
          },
          child: Container(
            width: 60,
            height: 60,
            decoration: BoxDecoration(
              color: accent,
              borderRadius: BorderRadius.circular(18),
              boxShadow: [
                BoxShadow(
                  color: accent.withAlpha(120),
                  blurRadius: 16,
                  offset: const Offset(0, 6),
                ),
              ],
            ),
            child: const Center(
              child: Icon(
                Icons.add_rounded,
                size: 28,
                color: Colors.white,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

/* ===========================
        NEO FEED
=========================== */

class NeoFeed extends StatefulWidget {
  const NeoFeed({super.key});

  @override
  State<NeoFeed> createState() => _NeoFeedState();
}

class _NeoFeedState extends State<NeoFeed> {
  final _searchController = TextEditingController();
  final _searchFocus = FocusNode();
  final _scrollController = ScrollController();
  List<String> _searchHistory = [];
  bool _showSearchHistory = false;
  String _historyKey = '';

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_handleScroll);
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ neoStore
    neoStore.addListener(_refresh);
    _historyKey = _buildHistoryKey();
    _loadSearchHistory();
    _searchFocus.addListener(() {
      setState(() {
        _showSearchHistory = _searchFocus.hasFocus;
      });
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _searchFocus.dispose();
    _scrollController.dispose();
    // –ù–µ –∑–∞–±—ã–≤–∞–µ–º —É–¥–∞–ª–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–∏ dispose
    neoStore.removeListener(_refresh);
    super.dispose();
  }

  void _handleScroll() {
    if (!_scrollController.hasClients) return;
    final position = _scrollController.position;
    if (position.pixels >= position.maxScrollExtent - 400) {
      neoStore.loadMoreFeed();
    }
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  void _refresh() {
    if (mounted) {
      final nextKey = _buildHistoryKey();
      if (nextKey != _historyKey) {
        _historyKey = nextKey;
        _loadSearchHistory();
      }
      setState(() {});
    }
  }

  String _buildHistoryKey() {
    final uid = neoStore.user?.uid;
    return uid?.isNotEmpty == true
        ? 'neo_search_history_$uid'
        : 'neo_search_history_guest';
  }

  Future<void> _loadSearchHistory() async {
    final sp = await SharedPreferences.getInstance();
    final raw = sp.getString(_historyKey);
    if (raw == null) {
      _searchHistory = [];
    } else {
      try {
        _searchHistory =
            (jsonDecode(raw) as List).map((e) => e.toString()).toList();
      } catch (_) {
        _searchHistory = [];
      }
    }
    if (mounted) setState(() {});
  }

  Future<void> _saveSearchHistory() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_historyKey, jsonEncode(_searchHistory));
  }

  Future<void> _addSearchHistory(String query) async {
    final value = query.trim();
    if (value.isEmpty) return;
    _searchHistory.removeWhere((q) => q.toLowerCase() == value.toLowerCase());
    _searchHistory.insert(0, value);
    if (_searchHistory.length > 12) {
      _searchHistory = _searchHistory.take(12).toList();
    }
    await _saveSearchHistory();
    if (mounted) setState(() {});
  }

  Future<void> _clearSearchHistory() async {
    _searchHistory = [];
    await _saveSearchHistory();
    if (mounted) setState(() {});
  }

  Widget _buildSearchHistory(ColorScheme cs) {
    if (!_showSearchHistory || _searchHistory.isEmpty) {
      return const SizedBox();
    }

    return Container(
      margin: const EdgeInsets.only(top: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: cs.surfaceContainerHighest,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: cs.outline.withAlpha(51)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withAlpha(15),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            children: [
              Text(
                '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞',
                style: Theme.of(context).textTheme.titleSmall,
              ),
              const Spacer(),
              TextButton(
                onPressed: _clearSearchHistory,
                child: const Text('–û—á–∏—Å—Ç–∏—Ç—å'),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Column(
            children: _searchHistory.map((query) {
              return Padding(
                padding: const EdgeInsets.only(bottom: 8),
                child: InkWell(
                  borderRadius: BorderRadius.circular(12),
                  onTap: () {
                    _searchController.text = query;
                    _searchController.selection = TextSelection.fromPosition(
                      TextPosition(offset: query.length),
                    );
                    neoStore.setSearchQuery(query);
                    setState(() {
                      _showSearchHistory = false;
                    });
                    _searchFocus.unfocus();
                  },
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                        horizontal: 12, vertical: 10),
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(12),
                      color: cs.surfaceContainer,
                      border: Border.all(
                        color: NeoThemes.currentColor.withAlpha(51),
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.history_rounded,
                          size: 18,
                          color: cs.onSurface.withAlpha(128),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: Text(
                            query,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                            style: TextStyle(
                              color: cs.onSurface,
                            ),
                          ),
                        ),
                        Icon(
                          Icons.arrow_outward_rounded,
                          size: 16,
                          color: cs.onSurface.withAlpha(128),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final screenWidth = MediaQuery.of(context).size.width;
    final horizontalPadding = screenWidth < 360 ? 16.0 : 20.0;

    return CustomScrollView(
      controller: _scrollController,
      physics: const BouncingScrollPhysics(),
      slivers: [
        SliverToBoxAdapter(
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  cs.surface.withAlpha(230),
                  cs.surface.withAlpha(153),
                ],
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
              ),
            ),
            child: SafeArea(
              bottom: false,
              child: Padding(
                padding: EdgeInsets.fromLTRB(
                  horizontalPadding,
                  12,
                  horizontalPadding,
                  16,
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Container(
                          width: 44,
                          height: 44,
                          decoration: const BoxDecoration(
                            color: Colors.transparent,
                            shape: BoxShape.circle,
                          ),
                          child: Center(
                            child: Image.asset(
                              'assets/images/logo.png',
                              width: 30,
                              height: 30,
                              fit: BoxFit.contain,
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Text(
                          'NeoObmin',
                          style: Theme.of(context).textTheme.titleLarge,
                        ),
                        const Spacer(),
                        // –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–Ω–∞
                        IconButton(
                          onPressed: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) => const NotificationsPage(),
                              ),
                            );
                          },
                          icon: Badge(
                            isLabelVisible:
                                neoStore.totalUnreadNotifications > 0,
                            label: Text(
                              '${neoStore.totalUnreadNotifications}',
                            ),
                            child: const Icon(Icons.notifications_rounded),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    Container(
                      decoration: BoxDecoration(
                        color: cs.surface,
                        borderRadius: BorderRadius.circular(18),
                        border: Border.all(color: cs.outline.withAlpha(120)),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withAlpha(
                                Theme.of(context).brightness == Brightness.dark
                                    ? 70
                                    : 18),
                            blurRadius: 18,
                            offset: const Offset(0, 6),
                          ),
                        ],
                      ),
                      child: TextField(
                        controller: _searchController,
                        focusNode: _searchFocus,
                        decoration: InputDecoration(
                          hintText: '–ß—Ç–æ –∏—â–µ—Ç–µ —Å–µ–≥–æ–¥–Ω—è?',
                          prefixIcon: Icon(
                            Icons.search_rounded,
                            color: cs.onSurface.withAlpha(140),
                          ),
                          filled: true,
                          fillColor: cs.surface,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(18),
                            borderSide: BorderSide.none,
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                              horizontal: 20, vertical: 16),
                        ),
                        onChanged: (value) {
                          neoStore.setSearchQuery(value);
                        },
                        onSubmitted: (value) {
                          _addSearchHistory(value);
                          neoStore.setSearchQuery(value);
                        },
                      ),
                    ),
                    _buildSearchHistory(cs),
                    const SizedBox(height: 16),
                    // –î–æ–±–∞–≤–ª—è–µ–º Key –∫ –≤–∏–¥–∂–µ—Ç—É, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–ª—Å—è
                    _FilterChipsBar(
                        key: ValueKey(neoStore.filteredItems.length)),
                  ],
                ),
              ),
            ),
          ),
        ),
        SliverPadding(
          padding: const EdgeInsets.all(20),
          sliver: SliverGrid(
            gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 2,
              crossAxisSpacing: 16,
              mainAxisSpacing: 16,
              childAspectRatio: 0.75,
            ),
            delegate: SliverChildBuilderDelegate(
              (context, index) {
                final items = neoStore.visibleFilteredItems;
                final canLoadMore = neoStore.canLoadMoreFeed;
                if (index < items.length) {
                  final item = items[index];
                  return GestureDetector(
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => NeoItemDetailPage(
                            itemId: item.id,
                            initialItem: item,
                          ),
                        ),
                      );
                    },
                    child: _NeoItemCard(item: item),
                  );
                }
                if (canLoadMore && index == items.length) {
                  return Center(
                    child: Padding(
                      padding: const EdgeInsets.all(8),
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        color: NeoThemes.currentColor,
                      ),
                    ),
                  );
                }
                return const SizedBox();
              },
              childCount: neoStore.canLoadMoreFeed
                  ? neoStore.visibleFilteredItems.length + 1
                  : neoStore.visibleFilteredItems.length,
            ),
          ),
        ),
        const SliverToBoxAdapter(
          child: SizedBox(height: 100),
        ),
      ],
    );
  }
}

class _FilterChipsBar extends StatefulWidget {
  const _FilterChipsBar({super.key});

  @override
  State<_FilterChipsBar> createState() => __FilterChipsBarState();
}

class __FilterChipsBarState extends State<_FilterChipsBar> {
  @override
  void initState() {
    super.initState();
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ neoStore
    neoStore.addListener(_refresh);
  }

  @override
  void dispose() {
    neoStore.removeListener(_refresh);
    super.dispose();
  }

  void _refresh() {
    if (mounted) {
      setState(() {});
    }
  }

  @override
  Widget build(BuildContext context) {
    final activeFilters = [
      if (neoStore.selectedCategory != '–í—Å–µ') neoStore.selectedCategory,
      if (neoStore.selectedCity != '–í—Å–µ') neoStore.selectedCity,
      if (neoStore.selectedType != null) neoStore.selectedType!.label,
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Expanded(
              child: SingleChildScrollView(
                scrollDirection: Axis.horizontal,
                child: Row(
                  children: [
                    _FilterChip(
                      label: '–í—Å–µ',
                      active: neoStore.selectedCategory == '–í—Å–µ' &&
                          neoStore.selectedCity == '–í—Å–µ' &&
                          neoStore.selectedType == null,
                      onTap: () => neoStore.clearFilters(),
                    ),
                    const SizedBox(width: 8),
                    _FilterChip(
                      label: '–§–∏–ª—å—Ç—Ä—ã',
                      active: activeFilters.isNotEmpty,
                      icon: Icons.filter_alt_rounded,
                      onTap: () {
                        showModalBottomSheet(
                          context: context,
                          backgroundColor: Colors.transparent,
                          isScrollControlled: true,
                          builder: (context) => const _FilterSheet(),
                        );
                      },
                    ),
                    const SizedBox(width: 8),
                    _FilterChip(
                      label: neoStore.sortBy == 'newest'
                          ? '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ'
                          : '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ',
                      active: true,
                      icon: neoStore.sortBy == 'newest'
                          ? Icons.arrow_downward_rounded
                          : Icons.arrow_upward_rounded,
                      onTap: () {
                        neoStore.setFilters(
                          sort:
                              neoStore.sortBy == 'newest' ? 'oldest' : 'newest',
                        );
                      },
                    ),
                  ],
                ),
              ),
            ),
            IconButton(
              onPressed: () {
                showModalBottomSheet(
                  context: context,
                  backgroundColor: Colors.transparent,
                  isScrollControlled: true,
                  builder: (context) => const _FilterSheet(),
                );
              },
              icon: Icon(
                Icons.tune_rounded,
                color: NeoThemes.currentColor,
              ),
            ),
          ],
        ),
        if (activeFilters.isNotEmpty) ...[
          const SizedBox(height: 8),
          Wrap(
            spacing: 8,
            runSpacing: 4,
            children: activeFilters.map((filter) {
              return GestureDetector(
                onTap: () {
                  _openEditFilterDialog(context, filter);
                },
                child: Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: NeoThemes.currentColor.withAlpha(26),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: NeoThemes.currentColor.withAlpha(77),
                    ),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        filter,
                        style: TextStyle(
                          color: NeoThemes.currentColor,
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                      const SizedBox(width: 4),
                      GestureDetector(
                        onTap: () {
                          if (filter == neoStore.selectedCategory &&
                              filter != '–í—Å–µ') {
                            neoStore.setFilters(category: '–í—Å–µ');
                          } else if (filter == neoStore.selectedCity &&
                              filter != '–í—Å–µ') {
                            neoStore.setFilters(city: '–í—Å–µ');
                          } else if (neoStore.selectedType?.label == filter) {
                            neoStore.setFilters(type: null);
                          }
                        },
                        child: Icon(
                          Icons.close_rounded,
                          size: 14,
                          color: NeoThemes.currentColor,
                        ),
                      ),
                    ],
                  ),
                ),
              );
            }).toList(),
          ),
        ],
      ],
    );
  }

  void _openEditFilterDialog(BuildContext context, String filter) {
    showDialog(
      context: context,
      builder: (context) {
        return FilterEditDialog(
          currentFilter: filter,
          filterType: _getFilterType(filter),
        );
      },
    );
  }

  String _getFilterType(String filter) {
    if (neoStore.selectedCategory == filter) return 'category';
    if (neoStore.selectedCity == filter) return 'city';
    if (neoStore.selectedType?.label == filter) return 'type';
    return 'unknown';
  }
}

class FilterEditDialog extends StatefulWidget {
  final String currentFilter;
  final String filterType;

  const FilterEditDialog({
    super.key,
    required this.currentFilter,
    required this.filterType,
  });

  @override
  State<FilterEditDialog> createState() => _FilterEditDialogState();
}

class _FilterEditDialogState extends State<FilterEditDialog> {
  late String _selectedCategory;
  late String _selectedCity;
  late ItemType? _selectedType;
  late String _selectedSort;
  final _cityController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _selectedCategory = neoStore.selectedCategory;
    _selectedCity = neoStore.selectedCity;
    _selectedType = neoStore.selectedType;
    _selectedSort = neoStore.sortBy;
    _cityController.text = _selectedCity;
  }

  @override
  void dispose() {
    _cityController.dispose();
    super.dispose();
  }

  Future<void> _pickCity() async {
    final city = await showLocationPicker(
      context,
      initialCity: _selectedCity,
      allowAll: true,
    );
    if (city != null) {
      setState(() {
        _selectedCity = city;
        _cityController.text = city;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(20),
      child: Container(
        decoration: BoxDecoration(
          color: cs.surface,
          borderRadius: BorderRadius.circular(28),
        ),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Text(
                    '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä',
                    style: Theme.of(context).textTheme.titleLarge,
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close_rounded),
                  ),
                ],
              ),
              const SizedBox(height: 20),
              Text(
                '–¢–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä: ${widget.currentFilter}',
                style: TextStyle(
                  color: cs.onSurface.withAlpha(179),
                ),
              ),
              const SizedBox(height: 20),
              if (widget.filterType == 'category') ...[
                Text(
                  '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é',
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: neoStore.availableCategories.map((category) {
                    return _FilterOptionChip(
                      label: category,
                      selected: _selectedCategory == category,
                      onTap: () => setState(() => _selectedCategory = category),
                    );
                  }).toList(),
                ),
              ] else if (widget.filterType == 'city') ...[
                Text(
                  '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥',
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 12),
                NeoInput(
                  controller: _cityController,
                  hint: '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥',
                  prefixIcon: Icons.location_on_rounded,
                  suffixIcon: Icons.keyboard_arrow_down_rounded,
                  readOnly: true,
                  onTap: _pickCity,
                ),
              ] else if (widget.filterType == 'type') ...[
                Text(
                  '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø',
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: [
                    _FilterOptionChip(
                      label: '–í—Å–µ',
                      selected: _selectedType == null,
                      onTap: () => setState(() => _selectedType = null),
                    ),
                    _FilterOptionChip(
                      label: '–û–±–º–µ–Ω',
                      selected: _selectedType == ItemType.exchange,
                      onTap: () =>
                          setState(() => _selectedType = ItemType.exchange),
                    ),
                    _FilterOptionChip(
                      label: '–ü–æ–¥–∞—Ä–æ–∫',
                      selected: _selectedType == ItemType.gift,
                      onTap: () =>
                          setState(() => _selectedType = ItemType.gift),
                    ),
                  ],
                ),
              ],
              const SizedBox(height: 24),
              Text(
                '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',
                style: Theme.of(context).textTheme.titleMedium,
              ),
              const SizedBox(height: 12),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: [
                  _FilterOptionChip(
                    label: '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ',
                    icon: Icons.arrow_downward_rounded,
                    selected: _selectedSort == 'newest',
                    onTap: () => setState(() => _selectedSort = 'newest'),
                  ),
                  _FilterOptionChip(
                    label: '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ',
                    icon: Icons.arrow_upward_rounded,
                    selected: _selectedSort == 'oldest',
                    onTap: () => setState(() => _selectedSort = 'oldest'),
                  ),
                ],
              ),
              const SizedBox(height: 32),
              Row(
                children: [
                  Expanded(
                    child: NeoButton(
                      text: '–û—Ç–º–µ–Ω–∞',
                      onPressed: () => Navigator.pop(context),
                      color: Colors.grey,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: NeoButton(
                      text: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                      onPressed: () {
                        neoStore.setFilters(
                          category: widget.filterType == 'category'
                              ? _selectedCategory
                              : null,
                          city: widget.filterType == 'city'
                              ? _selectedCity
                              : null,
                          type: widget.filterType == 'type'
                              ? _selectedType
                              : null,
                          sort: _selectedSort,
                        );
                        Navigator.pop(context);
                      },
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              NeoTextButton(
                text: '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã',
                onPressed: () {
                  neoStore.clearFilters();
                  Navigator.pop(context);
                },
                color: Colors.red,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FilterSheet extends StatefulWidget {
  const _FilterSheet();

  @override
  State<_FilterSheet> createState() => __FilterSheetState();
}

class __FilterSheetState extends State<_FilterSheet> {
  late String _tempCategory;
  late String _tempCity;
  late ItemType? _tempType;
  late String _tempSort;
  final _cityController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _tempCategory = neoStore.selectedCategory;
    _tempCity = neoStore.selectedCity;
    _tempType = neoStore.selectedType;
    _tempSort = neoStore.sortBy;
    _cityController.text = _tempCity;
  }

  @override
  void dispose() {
    _cityController.dispose();
    super.dispose();
  }

  Future<void> _pickFilterCity() async {
    final city = await showLocationPicker(
      context,
      initialCity: _tempCity,
      allowAll: true,
    );
    if (city != null) {
      setState(() {
        _tempCity = city;
        _cityController.text = city;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      margin: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: cs.surface,
        borderRadius: BorderRadius.circular(28),
      ),
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Text(
                  '–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',
                  style: Theme.of(context).textTheme.titleLarge,
                ),
                const Spacer(),
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.close_rounded),
                ),
              ],
            ),
            const SizedBox(height: 24),
            Text(
              '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: neoStore.availableCategories.map((category) {
                return _FilterOptionChip(
                  label: category,
                  selected: _tempCategory == category,
                  onTap: () => setState(() => _tempCategory = category),
                );
              }).toList(),
            ),
            const SizedBox(height: 24),
            Text(
              '–ì–æ—Ä–æ–¥',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            NeoInput(
              controller: _cityController,
              hint: '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥',
              prefixIcon: Icons.location_on_rounded,
              suffixIcon: Icons.keyboard_arrow_down_rounded,
              readOnly: true,
              onTap: _pickFilterCity,
            ),
            const SizedBox(height: 24),
            Text(
              '–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: [
                _FilterOptionChip(
                  label: '–í—Å–µ',
                  selected: _tempType == null,
                  onTap: () => setState(() => _tempType = null),
                ),
                _FilterOptionChip(
                  label: '–û–±–º–µ–Ω',
                  selected: _tempType == ItemType.exchange,
                  onTap: () => setState(() => _tempType = ItemType.exchange),
                ),
                _FilterOptionChip(
                  label: '–ü–æ–¥–∞—Ä–æ–∫',
                  selected: _tempType == ItemType.gift,
                  onTap: () => setState(() => _tempType = ItemType.gift),
                ),
              ],
            ),
            const SizedBox(height: 24),
            Text(
              '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: [
                _FilterOptionChip(
                  label: '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ',
                  icon: Icons.arrow_downward_rounded,
                  selected: _tempSort == 'newest',
                  onTap: () => setState(() => _tempSort = 'newest'),
                ),
                _FilterOptionChip(
                  label: '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ',
                  icon: Icons.arrow_upward_rounded,
                  selected: _tempSort == 'oldest',
                  onTap: () => setState(() => _tempSort = 'oldest'),
                ),
              ],
            ),
            const SizedBox(height: 32),
            Row(
              children: [
                Expanded(
                  child: NeoButton(
                    text: '–°–±—Ä–æ—Å–∏—Ç—å',
                    onPressed: () {
                      setState(() {
                        _tempCategory = '–í—Å–µ';
                        _tempCity = '–í—Å–µ';
                        _tempType = null;
                        _tempSort = 'newest';
                      });
                    },
                    color: Colors.grey,
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: NeoButton(
                    text: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                    onPressed: () {
                      neoStore.setFilters(
                        category: _tempCategory,
                        city: _tempCity,
                        type: _tempType,
                        sort: _tempSort,
                      );
                      Navigator.pop(context); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
                    },
                  ),
                ),
              ],
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }
}

class _FilterOptionChip extends StatelessWidget {
  final String label;
  final IconData? icon;
  final bool selected;
  final VoidCallback onTap;

  const _FilterOptionChip({
    required this.label,
    this.icon,
    required this.selected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final color = NeoThemes.currentColor;

    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
          color: selected ? color.withAlpha(38) : Colors.transparent,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: selected ? color.withAlpha(77) : Colors.grey.withAlpha(77),
            width: 1.5,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (icon != null) ...[
              Icon(
                icon,
                size: 16,
                color: selected ? color : Colors.grey,
              ),
              const SizedBox(width: 6),
            ],
            Text(
              label,
              style: TextStyle(
                color: selected ? color : Colors.grey,
                fontWeight: FontWeight.w600,
                fontSize: 13,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _FilterChip extends StatefulWidget {
  final String label;
  final IconData? icon;
  final bool active;
  final VoidCallback onTap;

  const _FilterChip({
    required this.label,
    this.icon,
    required this.active,
    required this.onTap,
  });

  @override
  State<_FilterChip> createState() => __FilterChipState();
}

class __FilterChipState extends State<_FilterChip>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );
    _scale = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _handleHover(bool hover) {
    if (hover) {
      _controller.forward();
    } else {
      _controller.reverse();
    }
  }

  @override
  Widget build(BuildContext context) {
    final color = NeoThemes.currentColor;
    final cs = Theme.of(context).colorScheme;

    return MouseRegion(
      onEnter: (_) => _handleHover(true),
      onExit: (_) => _handleHover(false),
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedBuilder(
          animation: _controller,
          builder: (context, child) {
            return Transform.scale(
              scale: _scale.value,
              child: child,
            );
          },
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
            decoration: BoxDecoration(
              color: widget.active
                  ? color.withAlpha(38)
                  : cs.surfaceContainerHighest,
              borderRadius: BorderRadius.circular(20),
              border: Border.all(
                color: widget.active
                    ? color.withAlpha(77)
                    : cs.outline.withAlpha(51),
                width: 1.5,
              ),
              boxShadow: widget.active
                  ? [
                      BoxShadow(
                        color: color.withAlpha(51),
                        blurRadius: 10,
                        offset: const Offset(0, 2),
                      ),
                    ]
                  : null,
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                if (widget.icon != null) ...[
                  Icon(
                    widget.icon,
                    size: 16,
                    color: widget.active ? color : cs.onSurface.withAlpha(204),
                  ),
                  const SizedBox(width: 6),
                ],
                Text(
                  widget.label,
                  style: TextStyle(
                    color: widget.active ? color : cs.onSurface.withAlpha(204),
                    fontWeight: FontWeight.w600,
                    fontSize: 13,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _NeoItemCard extends StatefulWidget {
  final Item item;

  const _NeoItemCard({required this.item});

  @override
  State<_NeoItemCard> createState() => __NeoItemCardState();
}

class __NeoItemCardState extends State<_NeoItemCard> {
  bool _isFavorite = false;
  bool _isProcessing = false;

  @override
  void initState() {
    super.initState();
    _isFavorite = neoStore.isFav(widget.item.id);
  }

  void _toggleFavorite() async {
    if (_isProcessing) return;

    setState(() {
      _isProcessing = true;
    });

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - —Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    setState(() {
      _isFavorite = !_isFavorite;
    });

    try {
      await neoStore.toggleFav(widget.item.id);
    } catch (e) {
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setState(() {
        _isFavorite = !_isFavorite;
      });
      print('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ: $e');
    } finally {
      setState(() {
        _isProcessing = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final accent = NeoThemes.currentColor;
    final typeColor = widget.item.type.accent;

    return Container(
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          AspectRatio(
            aspectRatio: 4 / 3,
            child: Stack(
              children: [
                Positioned.fill(
                  child: ClipRRect(
                    borderRadius: const BorderRadius.vertical(
                      top: Radius.circular(20),
                    ),
                    child: widget.item.getImageWidget(
                      context,
                      fit: BoxFit.cover,
                    ),
                  ),
                ),
                Positioned(
                  top: 12,
                  left: 12,
                  child: Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                    decoration: BoxDecoration(
                      color: typeColor.withAlpha(190),
                      borderRadius: BorderRadius.circular(10),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withAlpha(60),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Text(
                      widget.item.type.label,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 10,
                        fontWeight: FontWeight.w700,
                        letterSpacing: 0.4,
                      ),
                    ),
                  ),
                ),
                Positioned(
                  top: 10,
                  right: 10,
                  child: GestureDetector(
                    onTap: _toggleFavorite,
                    child: Container(
                      width: 34,
                      height: 34,
                      decoration: BoxDecoration(
                        color: Colors.black.withAlpha(170),
                        borderRadius: BorderRadius.circular(10),
                        border: Border.all(
                          color: Colors.white.withAlpha(50),
                        ),
                      ),
                      child: Center(
                        child: _isProcessing
                            ? const SizedBox(
                                width: 16,
                                height: 16,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  color: Colors.white,
                                ),
                              )
                            : Icon(
                                _isFavorite
                                    ? Icons.favorite_rounded
                                    : Icons.favorite_border_rounded,
                                size: 18,
                                color: _isFavorite ? Colors.redAccent : Colors.white,
                              ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
          Padding(
            padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.item.title,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.w700,
                      ),
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 6),
                Text(
                  widget.item.desc,
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: cs.onSurface.withAlpha(160),
                        height: 1.4,
                      ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Icon(
                      Icons.location_on_rounded,
                      size: 14,
                      color: accent.withAlpha(160),
                    ),
                    const SizedBox(width: 6),
                    Expanded(
                      child: Text(
                        widget.item.city,
                        style: Theme.of(context).textTheme.labelMedium?.copyWith(
                              color: cs.onSurface.withAlpha(170),
                            ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 6),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        ITEM DETAIL PAGE
=========================== */

class NeoItemDetailPage extends StatefulWidget {
  final String itemId;
  final Item? initialItem;

  const NeoItemDetailPage({
    super.key,
    required this.itemId,
    this.initialItem,
  });

  @override
  State<NeoItemDetailPage> createState() => _NeoItemDetailPageState();
}

class _NeoItemDetailPageState extends State<NeoItemDetailPage> {
  Item? _item;
  int _currentImageIndex = 0;
  bool _isFavorite = false;
  bool _viewerRegistered = false;
  bool _loadingItem = true;

  @override
  void initState() {
    super.initState();
    _item = widget.initialItem;
    if (_item != null) {
      _isFavorite = neoStore.isFav(_item!.id);
      _currentImageIndex = _item!.mainImageIndex;
    }
    _loadItem();

    WidgetsBinding.instance.addPostFrameCallback((_) {
      neoStore.incrementViews(widget.itemId);
      if (!_viewerRegistered) {
        neoStore.setActiveViewer(widget.itemId, true);
        _viewerRegistered = true;
      }
    });
  }

  Future<void> _loadItem() async {
    final fetched = await neoStore.fetchItemById(widget.itemId);
    if (!mounted) return;
    if (fetched != null) {
      setState(() {
        _item = fetched;
        _isFavorite = neoStore.isFav(fetched.id);
        _currentImageIndex = fetched.mainImageIndex;
        _loadingItem = false;
      });
    } else {
      setState(() {
        _loadingItem = false;
      });
    }
  }

  @override
  void dispose() {
    if (_viewerRegistered) {
      neoStore.setActiveViewer(widget.itemId, false);
    }
    super.dispose();
  }

  void _toggleFavorite() {
    setState(() {
      _isFavorite = !_isFavorite;
    });
    neoStore.toggleFav(widget.itemId);
  }

  void _openImageFullScreen(int index) {
    final item = _item;
    if (item == null) return;
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => NeoImageFullScreen(
          images: item.allPhotos,
          initialIndex: index,
        ),
      ),
    );
  }

  void _viewSellerProfile() {
    final item = _item;
    if (item == null) return;
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => SellerProfilePage(
          sellerId: item.ownerId,
        ),
      ),
    );
  }

  Future<void> _shareItem(Item item) async {
    final url = await neoStore.buildShareUrl(item);
    await Share.share(url, subject: item.title);
  }

  Widget _buildProfileImage(String userId, String name) {
    return FutureBuilder<String?>(
      future: neoStore.fetchUserProfileImageUrl(userId),
      builder: (context, snapshot) {
        final url = snapshot.data;
        if (url?.isNotEmpty == true) {
          return ClipRRect(
            borderRadius: BorderRadius.circular(25),
            child: CachedNetworkImage(
              imageUrl: url!,
              width: 50,
              height: 50,
              fit: BoxFit.cover,
              placeholder: (context, value) => Center(
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  color: NeoThemes.currentColor,
                ),
              ),
              errorWidget: (context, value, error) {
                return _buildDefaultProfileAvatar(name);
              },
            ),
          );
        }
        return _buildDefaultProfileAvatar(name);
      },
    );
  }

  Widget _buildDefaultProfileAvatar(String name) {
    return Container(
      width: 50,
      height: 50,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            NeoThemes.currentColor,
            NeoThemes.currentNeon,
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        shape: BoxShape.circle,
      ),
      child: Center(
        child: Text(
          name.substring(0, 1),
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.w700,
            fontSize: 20,
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final item = _item;
    if (item == null) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ'),
        ),
        body: Center(
          child: _loadingItem
              ? const CircularProgressIndicator()
              : const Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'),
        ),
      );
    }
    final images = item.allPhotos;
    final similarItems = neoStore.getSimilarItems(item);

    return Scaffold(
      body: CustomScrollView(
        physics: const BouncingScrollPhysics(),
        slivers: [
          SliverAppBar(
            expandedHeight: 300,
            floating: false,
            pinned: true,
            automaticallyImplyLeading: false,
            backgroundColor: Colors.transparent,
            surfaceTintColor: Colors.transparent,
            flexibleSpace: FlexibleSpaceBar(
              background: Stack(
                children: [
                  if (images.isNotEmpty)
                    PageView.builder(
                      itemCount: images.length,
                      onPageChanged: (index) {
                        setState(() => _currentImageIndex = index);
                      },
                      itemBuilder: (context, index) {
                        return GestureDetector(
                          onTap: () => _openImageFullScreen(index),
                          child: item.getImageAtIndex(context, index,
                              fit: BoxFit.cover, iconSize: 60),
                        );
                      },
                    )
                  else
                    Container(
                      color: cs.surfaceContainer,
                      child: Center(
                        child: Icon(
                          item.type.icon,
                          color: cs.onSurface.withAlpha(77),
                          size: 60,
                        ),
                      ),
                    ),
                  if (images.length > 1)
                    Positioned(
                      bottom: 16,
                      left: 0,
                      right: 0,
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: List.generate(images.length, (index) {
                          return Container(
                            width: 8,
                            height: 8,
                            margin: const EdgeInsets.symmetric(horizontal: 4),
                            decoration: BoxDecoration(
                              shape: BoxShape.circle,
                              color: _currentImageIndex == index
                                  ? Colors.white
                                  : Colors.white.withAlpha(128),
                            ),
                          );
                        }),
                      ),
                    ),
                  Positioned(
                    top: MediaQuery.of(context).padding.top + 16,
                    left: 16,
                    child: Container(
                      width: 40,
                      height: 40,
                      decoration: BoxDecoration(
                        color: Colors.black.withAlpha(128),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: IconButton(
                        icon: const Icon(Icons.arrow_back_rounded,
                            color: Colors.white, size: 20),
                        onPressed: () => Navigator.pop(context),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
          SliverPadding(
            padding: const EdgeInsets.all(20),
            sliver: SliverList(
              delegate: SliverChildListDelegate([
                Row(
                  children: [
                    Expanded(
                      child: SelectableText(
                        item.title,
                        style: Theme.of(context).textTheme.displaySmall,
                      ),
                    ),
                    IconButton(
                      onPressed: () => _shareItem(item),
                      icon: const Icon(Icons.share_rounded),
                    ),
                    IconButton(
                      onPressed: _toggleFavorite,
                      icon: Icon(
                        _isFavorite
                            ? Icons.favorite_rounded
                            : Icons.favorite_outline_rounded,
                        color: _isFavorite ? Colors.red : cs.onSurface,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: item.type.accent.withAlpha(26),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: item.type.accent.withAlpha(77),
                          width: 1.5,
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(
                            item.type.icon,
                            size: 16,
                            color: item.type.accent,
                          ),
                          const SizedBox(width: 6),
                          Text(
                            item.type.label,
                            style: TextStyle(
                              color: item.type.accent,
                              fontWeight: FontWeight.w600,
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(width: 12),
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: item.status.color.withAlpha(26),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: item.status.color.withAlpha(77),
                          width: 1.5,
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(
                            item.status.icon,
                            size: 16,
                            color: item.status.color,
                          ),
                          const SizedBox(width: 6),
                          Text(
                            item.status.label,
                            style: TextStyle(
                              color: item.status.color,
                              fontWeight: FontWeight.w600,
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Icon(
                      Icons.location_on_rounded,
                      size: 16,
                      color: cs.onSurface.withAlpha(128),
                    ),
                    const SizedBox(width: 4),
                    Text(
                      item.city,
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(128),
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: NeoThemes.getCardDecoration(context),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '–û–ø–∏—Å–∞–Ω–∏–µ',
                        style: Theme.of(context).textTheme.titleMedium,
                      ),
                      const SizedBox(height: 12),
                      SelectableText(
                        item.desc,
                        style: TextStyle(
                          color: cs.onSurface.withAlpha(204),
                          fontSize: 16,
                          height: 1.5,
                        ),
                      ),
                    ],
                  ),
                ),
                if (neoStore.user?.uid == item.ownerId)
                  StreamBuilder<DocumentSnapshot>(
                    stream: FirebaseService.firestore!
                        .collection('items')
                        .doc(item.id)
                        .snapshots(),
                    builder: (context, snapshot) {
                      final data =
                          snapshot.data?.data() as Map<String, dynamic>? ?? {};
                      final viewers =
                          List<String>.from(data['activeViewers'] ?? []);
                      final meId = neoStore.user?.uid;
                      var activeCount = viewers.length;
                      if (meId != null && viewers.contains(meId)) {
                        activeCount -= 1;
                      }
                      if (activeCount <= 0) return const SizedBox();
                      return Container(
                        margin: const EdgeInsets.only(top: 16),
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: NeoThemes.currentColor.withAlpha(20),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: NeoThemes.currentColor.withAlpha(77),
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.visibility_rounded,
                              color: NeoThemes.currentColor,
                              size: 18,
                            ),
                            const SizedBox(width: 8),
                            Text(
                              '–°–µ–π—á–∞—Å –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç: $activeCount',
                              style: TextStyle(
                                color: NeoThemes.currentColor,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: NeoThemes.getCardDecoration(context),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥–∞–≤—Ü–µ',
                        style: Theme.of(context).textTheme.titleMedium,
                      ),
                      const SizedBox(height: 16),
                      GestureDetector(
                        onTap: _viewSellerProfile,
                        child: Row(
                          children: [
                            _buildProfileImage(item.ownerId, item.ownerName),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    item.ownerName,
                                    style:
                                        Theme.of(context).textTheme.titleMedium,
                                  ),
                                  const SizedBox(height: 4),
                                  Text(
                                    '–ì–æ—Ä–æ–¥: ${item.city}',
                                    style: TextStyle(
                                      color: cs.onSurface.withAlpha(153),
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            Icon(
                              Icons.chevron_right_rounded,
                              color: cs.onSurface.withAlpha(77),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 16),
                      NeoButton(
                        text: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞',
                        onPressed: _viewSellerProfile,
                        fullWidth: true,
                        icon: Icons.person_rounded,
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: NeoThemes.getCardDecoration(context),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                        style: Theme.of(context).textTheme.titleMedium,
                      ),
                      const SizedBox(height: 16),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
                                style: TextStyle(
                                  color: cs.onSurface.withAlpha(128),
                                  fontSize: 12,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                item.category,
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
                                style: TextStyle(
                                  color: cs.onSurface.withAlpha(128),
                                  fontSize: 12,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Row(
                                children: [
                                  Icon(
                                    Icons.remove_red_eye_rounded,
                                    size: 16,
                                    color: cs.onSurface.withAlpha(179),
                                  ),
                                  const SizedBox(width: 6),
                                  Text(
                                    '${item.views}',
                                    style:
                                        Theme.of(context).textTheme.bodyLarge,
                                  ),
                                ],
                              ),
                            ],
                          ),
                          if (item.ownerId == neoStore.user?.uid)
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  '–õ–∞–π–∫–∏',
                                  style: TextStyle(
                                    color: cs.onSurface.withAlpha(128),
                                    fontSize: 12,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Row(
                                  children: [
                                    const Icon(
                                      Icons.favorite_rounded,
                                      size: 16,
                                      color: Colors.red,
                                    ),
                                    const SizedBox(width: 6),
                                    Text(
                                      '${item.likes}',
                                      style:
                                          Theme.of(context).textTheme.bodyLarge,
                                    ),
                                  ],
                                ),
                              ],
                            ),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                '–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
                                style: TextStyle(
                                  color: cs.onSurface.withAlpha(128),
                                  fontSize: 12,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                '${item.createdAt.day.toString().padLeft(2, '0')}.${item.createdAt.month.toString().padLeft(2, '0')}.${item.createdAt.year}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                '–í—Ä–µ–º—è',
                                style: TextStyle(
                                  color: cs.onSurface.withAlpha(128),
                                  fontSize: 12,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                '${item.createdAt.hour.toString().padLeft(2, '0')}:${item.createdAt.minute.toString().padLeft(2, '0')}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                          const SizedBox(width: 60),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Row(
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
                                style: TextStyle(
                                  color: cs.onSurface.withAlpha(128),
                                  fontSize: 12,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                item.id,
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
                // –í NeoItemDetailPage –≤ –º–µ—Ç–æ–¥–µ build, –∏—â–µ–º –±–ª–æ–∫ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π:
                if (similarItems.isNotEmpty) ...[
                  const SizedBox(height: 20),
                  Text(
                    '–ü–æ—Ö–æ–∂–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
                    style: Theme.of(context).textTheme.titleLarge,
                  ),
                  const SizedBox(height: 12),
                  SizedBox(
                    height: 200, // –£–≤–µ–ª–∏—á–∏–º –≤—ã—Å–æ—Ç—É –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    child: ListView.builder(
                      scrollDirection: Axis.horizontal,
                      itemCount: similarItems.length,
                      itemBuilder: (context, index) {
                        final similarItem = similarItems[index];
                        return GestureDetector(
                          onTap: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) => NeoItemDetailPage(
                                  itemId: similarItem.id,
                                  initialItem: similarItem,
                                ),
                              ),
                            );
                          },
                          child: Container(
                            width: 180, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞
                            margin: EdgeInsets.only(
                                right:
                                    index < similarItems.length - 1 ? 12 : 0),
                            decoration: NeoThemes.getCardDecoration(context),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                // –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                Expanded(
                                  child: ClipRRect(
                                    borderRadius: const BorderRadius.vertical(
                                      top: Radius.circular(24),
                                    ),
                                    child: Container(
                                      width: double.infinity,
                                      color: cs.surfaceContainer,
                                      child: similarItem.getImageAtIndex(
                                          context, 0,
                                          fit: BoxFit.cover, iconSize: 40),
                                    ),
                                  ),
                                ),
                                Padding(
                                  padding: const EdgeInsets.all(12),
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        similarItem.title,
                                        style: Theme.of(context)
                                            .textTheme
                                            .labelLarge,
                                        maxLines: 2,
                                        overflow: TextOverflow.ellipsis,
                                      ),
                                      const SizedBox(height: 4),
                                      Row(
                                        children: [
                                          Icon(
                                            Icons.location_on_rounded,
                                            size: 12,
                                            color: cs.onSurface.withAlpha(128),
                                          ),
                                          const SizedBox(width: 4),
                                          Text(
                                            similarItem.city,
                                            style: TextStyle(
                                              fontSize: 11,
                                              color:
                                                  cs.onSurface.withAlpha(153),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                        );
                      },
                    ),
                  ),
                ],
                const SizedBox(height: 20),
                if (neoStore.user != null && neoStore.user!.uid != item.ownerId)
                  NeoButton(
                    text: '–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É',
                    onPressed: () async {
                      try {
                        final chatId = await neoStore.ensureChatWith(
                          peerId: item.ownerId,
                          peerName: item.ownerName,
                          peerEmail: item.ownerEmail,
                          itemId: item.id,
                          itemTitle: item.title,
                        );
                        if (!mounted) return;
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) =>
                                ChatDetailPage(chatId: chatId),
                          ),
                        );
                      } catch (e) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text('–û—à–∏–±–∫–∞: $e'),
                          ),
                        );
                      }
                    },
                    fullWidth: true,
                    icon: Icons.chat_rounded,
                  ),
                const SizedBox(height: 40),
              ]),
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        SELLER PROFILE PAGE
=========================== */

class SellerProfilePage extends StatefulWidget {
  final String sellerId;

  const SellerProfilePage({
    super.key,
    required this.sellerId,
  });

  @override
  State<SellerProfilePage> createState() => _SellerProfilePageState();
}

class _SellerProfilePageState extends State<SellerProfilePage> {
  late SessionUser? _seller;
  late List<Item> _sellerItems;
  late List<Item> _approvedItems;

  @override
  void initState() {
    super.initState();
    _loadSellerData();
  }

  Future<void> _loadSellerData() async {
    final allItems = neoStore.itemsByOwner(widget.sellerId);
    _sellerItems = allItems;
    _approvedItems =
        allItems.where((item) => item.status == ItemStatus.approved).toList();

    if (_sellerItems.isNotEmpty) {
      final firstItem = _sellerItems.first;
      _seller = SessionUser(
        uid: widget.sellerId,
        name: firstItem.ownerName,
        email: firstItem.ownerEmail,
        city: firstItem.city,
        role: UserRole.user,
        likes: _sellerItems.fold(0, (sum, item) => sum + item.likes),
        level: (_sellerItems.length ~/ 3) + 1,
        itemsPosted: _sellerItems.length,
        itemsApproved: _approvedItems.length,
        exchangesCompleted: _sellerItems.length ~/ 2,
        profileImageUrl: null,
      );
    } else {
      _seller = null;
    }

    final profileImageUrl =
        await neoStore.fetchUserProfileImageUrl(widget.sellerId);
    if (_seller != null && profileImageUrl?.isNotEmpty == true) {
      _seller = _seller!.copyWith(profileImageUrl: profileImageUrl);
    }

    if (mounted) {
      setState(() {});
    }
  }

  Widget _buildProfileImage() {
    if (_seller?.profileImageUrl?.isNotEmpty == true) {
      return ClipRRect(
        borderRadius: BorderRadius.circular(50),
        child: CachedNetworkImage(
          imageUrl: _seller!.profileImageUrl!,
          width: 100,
          height: 100,
          fit: BoxFit.cover,
          placeholder: (context, url) => Center(
            child: CircularProgressIndicator(
              strokeWidth: 2,
              color: NeoThemes.currentColor,
            ),
          ),
          errorWidget: (context, url, error) {
            return _buildDefaultAvatar();
          },
        ),
      );
    } else {
      return _buildDefaultAvatar();
    }
  }

  Widget _buildDefaultAvatar() {
    return Container(
      width: 100,
      height: 100,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            NeoThemes.currentColor,
            NeoThemes.currentNeon,
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        shape: BoxShape.circle,
        boxShadow: [
          BoxShadow(
            color: NeoThemes.currentColor.withAlpha(77),
            blurRadius: 20,
            spreadRadius: 5,
          ),
        ],
      ),
      child: Center(
        child: Text(
          _seller?.name.substring(0, 1) ?? 'U',
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.w700,
            fontSize: 40,
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    if (_seller == null) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞'),
        ),
        body: const Center(
          child: Text('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'),
        ),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text('–ü—Ä–æ—Ñ–∏–ª—å ${_seller!.name}'),
      ),
      body: CustomScrollView(
        physics: const BouncingScrollPhysics(),
        slivers: [
          SliverToBoxAdapter(
            child: Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    NeoThemes.currentColor.withAlpha(77),
                    cs.surface.withAlpha(153),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                ),
              ),
              child: Column(
                children: [
                  _buildProfileImage(),
                  const SizedBox(height: 16),
                  Text(
                    _seller!.name,
                    style: Theme.of(context).textTheme.displaySmall,
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '–ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–∫—Ä—ã—Ç—ã',
                    style: TextStyle(
                      color: cs.onSurface.withAlpha(153),
                      fontSize: 14,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                  Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                    decoration: BoxDecoration(
                      color: NeoThemes.currentColor.withAlpha(26),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: NeoThemes.currentColor.withAlpha(77),
                      ),
                    ),
                    child: Text(
                      '–ü—Ä–æ–¥–∞–≤–µ—Ü',
                      style: TextStyle(
                        color: NeoThemes.currentColor,
                        fontWeight: FontWeight.w600,
                        fontSize: 12,
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: NeoThemes.getCardDecoration(context),
                    child: Column(
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceAround,
                          children: [
                            _StatItem(
                              value: '${_seller!.itemsPosted}',
                              label: '–í—Å–µ–≥–æ',
                              icon: Icons.list_alt_rounded,
                            ),
                            _StatItem(
                              value: '${_seller!.itemsApproved}',
                              label: '–ê–∫—Ç–∏–≤–Ω—ã–µ',
                              icon: Icons.check_circle_rounded,
                            ),
                            _StatItem(
                              value: '${_seller!.likes}',
                              label: '–õ–∞–π–∫–∏',
                              icon: Icons.favorite_rounded,
                            ),
                          ],
                        ),
                        const SizedBox(height: 16),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceAround,
                          children: [
                            _StatItem(
                              value: '${_seller!.exchangesCompleted}',
                              label: '–û–±–º–µ–Ω—ã',
                              icon: Icons.swap_horiz_rounded,
                            ),
                            _StatItem(
                              value: '${_seller!.level}',
                              label: '–£—Ä–æ–≤–µ–Ω—å',
                              icon: Icons.star_rounded,
                            ),
                            _StatItem(
                              value: _seller!.city,
                              label: '–ì–æ—Ä–æ–¥',
                              icon: Icons.location_on_rounded,
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
          SliverPadding(
            padding: const EdgeInsets.all(20),
            sliver: SliverToBoxAdapter(
              child: Text(
                '–û–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞ (${_approvedItems.length})',
                style: Theme.of(context).textTheme.titleLarge,
              ),
            ),
          ),
          if (_approvedItems.isEmpty)
            SliverToBoxAdapter(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Container(
                  padding: const EdgeInsets.all(40),
                  decoration: NeoThemes.getCardDecoration(context),
                  child: Column(
                    children: [
                      Icon(
                        Icons.list_alt_rounded,
                        size: 60,
                        color: cs.onSurface.withAlpha(128),
                      ),
                      const SizedBox(height: 16),
                      Text(
                        '–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                        style: Theme.of(context).textTheme.titleMedium,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        '–£ —ç—Ç–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                        style: TextStyle(
                          color: cs.onSurface.withAlpha(128),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            )
          else
            SliverPadding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              sliver: SliverGrid(
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 2,
                  crossAxisSpacing: 16,
                  mainAxisSpacing: 16,
                  childAspectRatio: 0.75,
                ),
                delegate: SliverChildBuilderDelegate(
                  (context, index) {
                    final item = _approvedItems[index];
                    return GestureDetector(
                      onTap: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) => NeoItemDetailPage(
                              itemId: item.id,
                              initialItem: item,
                            ),
                          ),
                        );
                      },
                      child: _NeoItemCard(item: item),
                    );
                  },
                  childCount: _approvedItems.length,
                ),
              ),
            ),
          const SliverToBoxAdapter(
            child: SizedBox(height: 100),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        IMAGE FULL SCREEN
=========================== */

class NeoImageFullScreen extends StatefulWidget {
  final List<String> images;
  final int initialIndex;

  const NeoImageFullScreen({
    super.key,
    required this.images,
    this.initialIndex = 0,
  });

  @override
  State<NeoImageFullScreen> createState() => _NeoImageFullScreenState();
}

class _NeoImageFullScreenState extends State<NeoImageFullScreen> {
  late PageController _pageController;
  int _currentIndex = 0;
  final TransformationController _transformController =
      TransformationController();
  TapDownDetails? _doubleTapDetails;
  static const double _maxZoom = 4.0;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _transformController.dispose();
    _pageController.dispose();
    super.dispose();
  }

  Widget _buildFullScreenImage(String imagePath) {
    final uri = Uri.tryParse(imagePath);
    final isHttp =
        imagePath.startsWith('http') || imagePath.startsWith('https');
    final isFile = uri?.scheme == 'file';

    if (isHttp) {
      return CachedNetworkImage(
        imageUrl: imagePath,
        fit: BoxFit.contain,
        placeholder: (context, url) => const Center(
          child: CircularProgressIndicator(),
        ),
        errorWidget: (context, url, error) {
          return Center(
            child: Icon(
              Icons.broken_image_rounded,
              color: Colors.white.withAlpha(128),
              size: 60,
            ),
          );
        },
      );
    } else {
      final filePath = isFile ? uri!.toFilePath() : imagePath;
      return Image.file(
        File(filePath),
        fit: BoxFit.contain,
        errorBuilder: (context, error, stackTrace) {
          return Center(
            child: Icon(
              Icons.broken_image_rounded,
              color: Colors.white.withAlpha(128),
              size: 60,
            ),
          );
        },
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          PageView.builder(
            controller: _pageController,
            itemCount: widget.images.length,
            onPageChanged: (index) {
              setState(() => _currentIndex = index);
              _transformController.value = Matrix4.identity();
            },
            itemBuilder: (context, index) {
              return GestureDetector(
                onDoubleTapDown: (details) => _doubleTapDetails = details,
                onDoubleTap: () {
                  final position = _doubleTapDetails?.localPosition;
                  if (position == null) return;
                  final currentScale =
                      _transformController.value.getMaxScaleOnAxis();
                  if (currentScale > 1.0) {
                    _transformController.value = Matrix4.identity();
                  } else {
                    final zoomed = Matrix4.identity()
                      ..translate(-position.dx * (_maxZoom - 1),
                          -position.dy * (_maxZoom - 1))
                      ..scale(_maxZoom);
                    _transformController.value = zoomed;
                  }
                },
                child: InteractiveViewer(
                  transformationController: _transformController,
                  maxScale: _maxZoom,
                  minScale: 0.8,
                  child: Center(
                    child: _buildFullScreenImage(widget.images[index]),
                  ),
                ),
              );
            },
          ),
          Positioned(
            top: MediaQuery.of(context).padding.top + 16,
            left: 16,
            child: Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: Colors.black.withAlpha(128),
                borderRadius: BorderRadius.circular(20),
              ),
              child: IconButton(
                icon: const Icon(Icons.close_rounded,
                    color: Colors.white, size: 20),
                onPressed: () => Navigator.pop(context),
              ),
            ),
          ),
          if (widget.images.length > 1)
            Positioned(
              top: MediaQuery.of(context).padding.top + 16,
              right: 16,
              child: Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(
                  color: Colors.black.withAlpha(128),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  '${_currentIndex + 1}/${widget.images.length}',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }
}

/* ===========================
        CHAT DETAIL PAGE
=========================== */

class ChatDetailPage extends StatefulWidget {
  final String chatId;

  const ChatDetailPage({super.key, required this.chatId});

  @override
  State<ChatDetailPage> createState() => _ChatDetailPageState();
}

class _ChatDetailPageState extends State<ChatDetailPage> {
  final TextEditingController _messageController = TextEditingController();
  late ChatThread _chat;
  late VoidCallback _chatListener;
  final ScrollController _scrollController = ScrollController();
  final ImagePicker _picker = ImagePicker();
  bool _isUploadingImage = false;
  double _uploadProgress = 0.0;

  @override
  void initState() {
    super.initState();
    final chat = neoStore.chats.firstWhere(
      (c) => c.id == widget.chatId,
      orElse: () => ChatThread(
        id: widget.chatId,
        peerId: 'unknown',
        peerName: 'Unknown',
        peerEmail: '',
        messages: [],
      ),
    );
    _chat = chat;
    _chatListener = () {
      final updated = neoStore.chats.firstWhere(
        (c) => c.id == widget.chatId,
        orElse: () => _chat,
      );
      if (updated != _chat) {
        setState(() => _chat = updated);
      }
    };
    neoStore.addListener(_chatListener);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      neoStore.markChatRead(widget.chatId);
      _showSafetyReminderIfNeeded();
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          _scrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  @override
  void dispose() {
    _messageController.dispose();
    _scrollController.dispose();
    neoStore.removeListener(_chatListener);
    super.dispose();
  }

  Future<void> _showSafetyReminderIfNeeded() async {
    final sp = await SharedPreferences.getInstance();
    final uid = neoStore.user?.uid ?? 'guest';
    final key = 'neo_chat_safety_shown_$uid';
    if (sp.getBool(key) == true) return;
    if (!mounted) return;

    await showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ —á–∞—Ç–∞—Ö'),
        content: const Text(
          '–ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º —Å—Å—ã–ª–∫–∞–º, –Ω–µ —Å–æ–æ–±—â–∞–π—Ç–µ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –∑–∞—Ä–∞–Ω–µ–µ.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('–û–ö'),
          ),
        ],
      ),
    );

    await sp.setBool(key, true);
  }

  Widget _buildProfileImage(String peerId, String peerName) {
    return FutureBuilder<String?>(
      future: neoStore.fetchUserProfileImageUrl(peerId),
      builder: (context, snapshot) {
        final url = snapshot.data;
        if (url?.isNotEmpty == true) {
          return ClipRRect(
            borderRadius: BorderRadius.circular(18),
            child: CachedNetworkImage(
              imageUrl: url!,
              width: 36,
              height: 36,
              fit: BoxFit.cover,
              placeholder: (context, value) => Center(
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  color: NeoThemes.currentColor,
                ),
              ),
              errorWidget: (context, value, error) {
                return _buildDefaultPeerAvatar(peerName);
              },
            ),
          );
        }
        return _buildDefaultPeerAvatar(peerName);
      },
    );
  }

  Widget _buildDefaultPeerAvatar(String peerName) {
    return Container(
      width: 36,
      height: 36,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            NeoThemes.currentColor,
            NeoThemes.currentNeon,
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        shape: BoxShape.circle,
      ),
      child: Center(
        child: Text(
          peerName.substring(0, 1),
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.w700,
          ),
        ),
      ),
    );
  }

  Widget _buildOnlineStatus(ColorScheme cs) {
    if (!neoStore.sShowOnlineStatus) return const SizedBox();
    return StreamBuilder<DocumentSnapshot>(
      stream: FirebaseService.firestore!
          .collection('users')
          .doc(_chat.peerId)
          .snapshots(),
      builder: (context, snapshot) {
        final data = snapshot.data?.data() as Map<String, dynamic>? ?? {};
        final isOnline = data['online'] == true;
        final lastSeenRaw = data['lastSeen'] as String?;
        DateTime? lastSeen;
        if (lastSeenRaw != null && lastSeenRaw.isNotEmpty) {
          lastSeen = DateTime.tryParse(lastSeenRaw)?.toLocal();
        }

        String label;
        if (isOnline) {
          label = '–í —Å–µ—Ç–∏';
        } else if (lastSeen != null) {
          final hh = lastSeen.hour.toString().padLeft(2, '0');
          final mm = lastSeen.minute.toString().padLeft(2, '0');
          label = '–ë—ã–ª(–∞) $hh:$mm';
        } else {
          label = '–ù–µ –≤ —Å–µ—Ç–∏';
        }

        return Row(
          children: [
            Container(
              width: 6,
              height: 6,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: isOnline ? Colors.green : cs.onSurface.withAlpha(128),
              ),
            ),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(
                fontSize: 10,
                color: isOnline ? Colors.green : cs.onSurface.withAlpha(128),
              ),
            ),
          ],
        );
      },
    );
  }

  String _filePathFromImage(String? value) {
    if (value == null || value.isEmpty) return '';
    final uri = Uri.tryParse(value);
    if (uri?.scheme == 'file') {
      return uri!.toFilePath();
    }
    return value;
  }

  void _sendMessage() {
    final text = _messageController.text.trim();
    if (text.isNotEmpty) {
      neoStore.sendMessage(widget.chatId, text, itemId: _chat.relatedItemId);
      _messageController.clear();
      setState(() {
        _chat = neoStore.chats.firstWhere((c) => c.id == widget.chatId);
      });
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (_scrollController.hasClients) {
          _scrollController.animateTo(
            _scrollController.position.maxScrollExtent,
            duration: const Duration(milliseconds: 300),
            curve: Curves.easeOut,
          );
        }
      });
    }
  }

  Future<void> _pickChatImage() async {
    try {
      final XFile? image = await _picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 1600,
        maxHeight: 1600,
        imageQuality: 90,
      );

      if (image == null) return;
      setState(() {
        _isUploadingImage = true;
        _uploadProgress = 0.0;
      });
      await neoStore.sendImageMessage(
        widget.chatId,
        image.path,
        itemId: _chat.relatedItemId,
        onProgress: (progress) {
          if (!mounted) return;
          setState(() => _uploadProgress = progress);
        },
      );
      if (!mounted) return;
      setState(() {
        _chat = neoStore.chats.firstWhere((c) => c.id == widget.chatId);
        _isUploadingImage = false;
        _uploadProgress = 0.0;
      });
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (_scrollController.hasClients) {
          _scrollController.animateTo(
            _scrollController.position.maxScrollExtent,
            duration: const Duration(milliseconds: 300),
            curve: Curves.easeOut,
          );
        }
      });
    } catch (e) {
      if (!mounted) return;
      setState(() {
        _isUploadingImage = false;
        _uploadProgress = 0.0;
      });
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–æ—Ç–æ: $e')),
      );
    }
  }

  void _viewSellerProfile() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => SellerProfilePage(
          sellerId: _chat.peerId,
        ),
      ),
    );
  }

  Widget _buildItemPreview() {
    if (_chat.relatedItemId == null) return const SizedBox();

    final item =
        neoStore.items.firstWhere((item) => item.id == _chat.relatedItemId,
            orElse: () => Item(
                  id: '',
                  title: '–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ',
                  desc: '',
                  city: '',
                  category: '',
                  type: ItemType.exchange,
                  status: ItemStatus.pending,
                  likes: 0,
                  views: 0,
                  ownerId: '',
                  ownerName: '',
                  ownerEmail: '',
                  createdAt: DateTime.now(),
                  photoPaths: const [],
                  photoUrls: const [],
                ));

    final mainPhoto = item.mainPhoto;
    ImageProvider? previewImage;
    if (mainPhoto.isNotEmpty) {
      final uri = Uri.tryParse(mainPhoto);
      if (mainPhoto.startsWith('http') || mainPhoto.startsWith('https')) {
        previewImage = NetworkImage(mainPhoto);
      } else if (uri?.scheme == 'file') {
        previewImage = FileImage(File(uri!.toFilePath()));
      } else {
        previewImage = FileImage(File(mainPhoto));
      }
    }

    return GestureDetector(
      onTap: () {
        if (item.id.isNotEmpty) {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => NeoItemDetailPage(
                itemId: item.id,
                initialItem: item,
              ),
            ),
          );
        }
      },
      child: Container(
        margin: const EdgeInsets.symmetric(vertical: 12, horizontal: 20),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).colorScheme.surfaceContainer,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: Theme.of(context).colorScheme.outline.withAlpha(51),
          ),
        ),
        child: Row(
          children: [
            Container(
              width: 50,
              height: 50,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(12),
                image: previewImage != null
                    ? DecorationImage(
                        image: previewImage,
                        fit: BoxFit.cover,
                      )
                    : null,
                color: Theme.of(context).colorScheme.surfaceContainerHighest,
              ),
              child: item.mainPhoto.isEmpty
                  ? Center(
                      child: Icon(
                        item.type.icon,
                        color: Theme.of(context)
                            .colorScheme
                            .onSurface
                            .withAlpha(128),
                      ),
                    )
                  : null,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    '–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é',
                    style: TextStyle(
                      fontSize: 12,
                      color: Theme.of(context)
                          .colorScheme
                          .onSurface
                          .withAlpha(153),
                    ),
                  ),
                  Text(
                    item.title,
                    style: Theme.of(context).textTheme.labelLarge,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            const Icon(
              Icons.chevron_right_rounded,
              color: Colors.grey,
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Scaffold(
      appBar: AppBar(
        title: GestureDetector(
          onTap: _viewSellerProfile,
          child: Row(
            children: [
              _buildProfileImage(_chat.peerId, _chat.peerName),
              const SizedBox(width: 12),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    _chat.peerName,
                    style: Theme.of(context).textTheme.titleMedium,
                  ),
                  if (neoStore.sShowOnlineStatus)
                    _buildOnlineStatus(cs)
                  else
                    Text(
                      '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è',
                      style: TextStyle(
                        fontSize: 10,
                        color: cs.onSurface.withAlpha(128),
                      ),
                    ),
                ],
              ),
            ],
          ),
        ),
      ),
      body: Column(
        children: [
          _buildItemPreview(),
          Expanded(
            child: ListView.builder(
              controller: _scrollController,
              padding: const EdgeInsets.all(20),
              itemCount: _chat.messages.length,
              itemBuilder: (context, index) {
                final message = _chat.messages[index];
                return Align(
                  alignment: message.fromMe
                      ? Alignment.centerRight
                      : Alignment.centerLeft,
                  child: Container(
                    constraints: BoxConstraints(
                      maxWidth: MediaQuery.of(context).size.width * 0.7,
                    ),
                    margin: const EdgeInsets.only(bottom: 12),
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 12,
                    ),
                    decoration: BoxDecoration(
                      color: message.fromMe
                          ? NeoThemes.currentColor
                          : cs.surfaceContainerHighest,
                      borderRadius: BorderRadius.circular(20),
                      border: Border.all(
                        color: message.fromMe
                            ? Colors.transparent
                            : cs.outline.withAlpha(51),
                      ),
                    ),
                    child: Column(
                      crossAxisAlignment: message.fromMe
                          ? CrossAxisAlignment.end
                          : CrossAxisAlignment.start,
                      children: [
                        if (message.itemTitle != null && index == 0)
                          Container(
                            padding: const EdgeInsets.all(8),
                            margin: const EdgeInsets.only(bottom: 8),
                            decoration: BoxDecoration(
                              color: NeoThemes.currentColor.withAlpha(26),
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: NeoThemes.currentColor.withAlpha(77),
                              ),
                            ),
                            child: Row(
                              children: [
                                Icon(
                                  Icons.shopping_bag_rounded,
                                  size: 16,
                                  color: NeoThemes.currentColor,
                                ),
                                const SizedBox(width: 6),
                                Expanded(
                                  child: Text(
                                    message.itemTitle!,
                                    style: TextStyle(
                                      color: NeoThemes.currentColor,
                                      fontSize: 12,
                                      fontWeight: FontWeight.w600,
                                    ),
                                    maxLines: 1,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        if (message.type == MessageType.image &&
                            (message.imageUrl?.isNotEmpty == true ||
                                message.imagePath?.isNotEmpty == true))
                          GestureDetector(
                            onTap: () {
                              final image =
                                  message.imageUrl ?? message.imagePath ?? '';
                              if (image.isEmpty) return;
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (context) => NeoImageFullScreen(
                                    images: [image],
                                    initialIndex: 0,
                                  ),
                                ),
                              );
                            },
                            child: ClipRRect(
                              borderRadius: BorderRadius.circular(16),
                              child: (message.imageUrl?.isNotEmpty == true &&
                                      (message.imageUrl!.startsWith('http') ||
                                          message.imageUrl!
                                              .startsWith('https')))
                                  ? CachedNetworkImage(
                                      imageUrl: message.imageUrl!,
                                      width: 220,
                                      height: 220,
                                      fit: BoxFit.cover,
                                      placeholder: (context, url) => Center(
                                        child: CircularProgressIndicator(
                                          strokeWidth: 2,
                                          color: NeoThemes.currentColor,
                                        ),
                                      ),
                                      errorWidget: (context, url, error) =>
                                          const Icon(Icons.broken_image_rounded),
                                    )
                                  : Image.file(
                                      File(
                                        _filePathFromImage(
                                          message.imageUrl ?? message.imagePath,
                                        ),
                                      ),
                                      width: 220,
                                      height: 220,
                                      fit: BoxFit.cover,
                                    ),
                            ),
                          )
                        else
                          SelectableText(
                            message.text,
                            style: TextStyle(
                              color:
                                  message.fromMe ? Colors.white : cs.onSurface,
                              fontSize: 15,
                            ),
                          ),
                        const SizedBox(height: 4),
                        Text(
                          '${message.at.hour.toString().padLeft(2, '0')}:${message.at.minute.toString().padLeft(2, '0')}',
                          style: TextStyle(
                            fontSize: 11,
                            color: message.fromMe
                                ? Colors.white.withAlpha(179)
                                : cs.onSurface.withAlpha(128),
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
          ),
          if (_isUploadingImage)
            Padding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 8),
              child: LinearProgressIndicator(
                value: _uploadProgress > 0 ? _uploadProgress : null,
                minHeight: 6,
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          SafeArea(
            top: false,
            child: Container(
              padding: const EdgeInsets.fromLTRB(12, 12, 12, 12),
              decoration: BoxDecoration(
                color: cs.surface,
                border: Border(
                  top: BorderSide(
                    color: cs.outline.withAlpha(51),
                  ),
                ),
              ),
              child: Row(
                children: [
                  Container(
                    width: 44,
                    height: 44,
                    decoration: BoxDecoration(
                      color: cs.surfaceContainerHighest,
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: IconButton(
                      onPressed: _pickChatImage,
                      icon: Icon(
                        Icons.photo_rounded,
                        color: cs.onSurface.withAlpha(179),
                        size: 20,
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Container(
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(24),
                        color: cs.surfaceContainerHighest,
                      ),
                      child: TextField(
                        controller: _messageController,
                        decoration: InputDecoration(
                          hintText: '–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(24),
                            borderSide: BorderSide.none,
                          ),
                          contentPadding:
                              const EdgeInsets.symmetric(horizontal: 20),
                        ),
                        onSubmitted: (_) => _sendMessage(),
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Container(
                    width: 48,
                    height: 48,
                    decoration:
                        NeoThemes.getNeonDecoration(NeoThemes.currentColor),
                    child: IconButton(
                      onPressed: _sendMessage,
                      icon: const Icon(
                        Icons.send_rounded,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        LOGIN PAGE
=========================== */

class NeoLoginPage extends StatefulWidget {
  const NeoLoginPage({super.key});

  @override
  State<NeoLoginPage> createState() => _NeoLoginPageState();
}

class _NeoLoginPageState extends State<NeoLoginPage> {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _loading = false;
  bool _isSignup = false;

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _handleLogin() async {
    if (_emailController.text.isEmpty || _passwordController.text.isEmpty) {
      _showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    setState(() => _loading = true);

    try {
      await neoStore.login(
        email: _emailController.text,
        password: _passwordController.text,
      );

      if (!mounted) return;

      _showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
      Navigator.pop(context);
    } catch (e) {
      _showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: $e');
    } finally {
      setState(() => _loading = false);
    }
  }

  void _showToast(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        duration: const Duration(seconds: 2),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Scaffold(
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [
              cs.surface.withAlpha(230),
              cs.surfaceContainer.withAlpha(153),
            ],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: SafeArea(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.arrow_back_rounded),
                ),
                const SizedBox(height: 40),
                Center(
                  child: Container(
                    width: 80,
                    height: 80,
                    decoration:
                        NeoThemes.getNeonDecoration(NeoThemes.currentColor),
                    child: const Center(
                      child: Icon(
                        Icons.person_rounded,
                        size: 40,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 32),
                Text(
                  _isSignup ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç',
                  style: Theme.of(context).textTheme.displaySmall,
                ),
                const SizedBox(height: 8),
                Text(
                  _isSignup
                      ? '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'
                      : '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º',
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(153),
                    fontSize: 16,
                  ),
                ),
                const SizedBox(height: 32),
                NeoInput(
                  controller: _emailController,
                  hint: 'Email',
                  prefixIcon: Icons.email_rounded,
                  keyboardType: TextInputType.emailAddress,
                ),
                const SizedBox(height: 16),
                NeoInput(
                  controller: _passwordController,
                  hint: '–ü–∞—Ä–æ–ª—å',
                  prefixIcon: Icons.lock_rounded,
                  obscure: true,
                ),
                const SizedBox(height: 32),
                NeoButton(
                  text: _isSignup ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏',
                  onPressed: _handleLogin,
                  loading: _loading,
                  fullWidth: true,
                ),
                const SizedBox(height: 24),
                Center(
                  child: NeoTextButton(
                    text: _isSignup
                        ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏'
                        : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
                    onPressed: () {
                      setState(() => _isSignup = !_isSignup);
                    },
                  ),
                ),
                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

Future<String?> showLocationPicker(
  BuildContext context, {
  String? initialCity,
  bool allowAll = false,
}) {
  return showModalBottomSheet<String>(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    builder: (context) => _LocationPickerSheet(
      initialCity: initialCity,
      allowAll: allowAll,
    ),
  );
}

class _LocationPickerSheet extends StatefulWidget {
  final String? initialCity;
  final bool allowAll;

  const _LocationPickerSheet({
    this.initialCity,
    this.allowAll = false,
  });

  @override
  State<_LocationPickerSheet> createState() => _LocationPickerSheetState();
}

class _LocationPickerSheetState extends State<_LocationPickerSheet> {
  LocationData? _data;
  String? _selectedRegion;
  String? _selectedDistrict;
  LocationCity? _selectedCity;
  String _query = '';

  @override
  void initState() {
    super.initState();
    neoStore.locations.then((data) {
      if (!mounted) return;
      _data = data;
      _initSelection(data);
      setState(() {});
    });
  }

  void _initSelection(LocationData data) {
    if (_selectedRegion != null) return;

    final initial = widget.initialCity ?? '';
    final found = (initial.isNotEmpty && initial != '–í—Å–µ')
        ? data.findCity(initial)
        : null;

    _selectedRegion = found?.region ?? (data.regions.isNotEmpty
        ? data.regions.first
        : null);

    if (_selectedRegion == null) return;

    final districts = data.districtsFor(_selectedRegion!);
    _selectedDistrict =
        found?.district ?? (districts.isNotEmpty ? districts.first : null);

    if (_selectedDistrict == null) return;

    final cities = data.citiesFor(_selectedRegion!, _selectedDistrict!);
    _selectedCity = found?.city ?? (cities.isNotEmpty ? cities.first : null);
  }

  void _updateRegion(String? value) {
    if (value == null || value == _selectedRegion || _data == null) return;
    setState(() {
      _selectedRegion = value;
      final districts = _data!.districtsFor(value);
      _selectedDistrict = districts.isNotEmpty ? districts.first : null;
      final cities = (_selectedDistrict != null)
          ? _data!.citiesFor(value, _selectedDistrict!)
          : const [];
      _selectedCity = cities.isNotEmpty ? cities.first : null;
      _query = '';
    });
  }

  void _updateDistrict(String? value) {
    if (value == null || value == _selectedDistrict || _data == null) return;
    setState(() {
      _selectedDistrict = value;
      final cities = _data!.citiesFor(_selectedRegion!, value);
      _selectedCity = cities.isNotEmpty ? cities.first : null;
      _query = '';
    });
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      height: MediaQuery.of(context).size.height * 0.82,
      decoration: BoxDecoration(
        color: cs.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
      ),
      child: _data == null
          ? const Center(child: CircularProgressIndicator())
          : Column(
              children: [
                Padding(
                  padding: const EdgeInsets.fromLTRB(20, 16, 12, 8),
                  child: Row(
                    children: [
                      Text(
                        '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥',
                        style: Theme.of(context).textTheme.titleLarge,
                      ),
                      const Spacer(),
                      IconButton(
                        onPressed: () => Navigator.pop(context),
                        icon: const Icon(Icons.close_rounded),
                      ),
                    ],
                  ),
                ),
                if (widget.allowAll)
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: NeoButton(
                      text: '–í—Å–µ –≥–æ—Ä–æ–¥–∞',
                      onPressed: () => Navigator.pop(context, '–í—Å–µ'),
                      color: Colors.grey,
                      icon: Icons.public_rounded,
                      fullWidth: true,
                    ),
                  ),
                Padding(
                  padding: const EdgeInsets.fromLTRB(20, 16, 20, 8),
                  child: Column(
                    children: [
                      _InlineDropdown(
                        label: '–û–±–ª–∞—Å—Ç—å',
                        items: _data!.regions,
                        value: _selectedRegion,
                        onChanged: (value) => _updateRegion(value),
                      ),
                      const SizedBox(height: 16),
                      _InlineDropdown(
                        label: '–†–∞–π–æ–Ω',
                        items: _selectedRegion == null
                            ? const []
                            : _data!.districtsFor(_selectedRegion!),
                        value: _selectedDistrict,
                        onChanged: (value) => _updateDistrict(value),
                      ),
                      const SizedBox(height: 16),
                      TextField(
                        onChanged: (value) {
                          setState(() => _query = value.trim().toLowerCase());
                        },
                        decoration: InputDecoration(
                          hintText: '–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞',
                          prefixIcon: Icon(
                            Icons.search_rounded,
                            color: cs.onSurface.withAlpha(128),
                          ),
                          filled: true,
                          fillColor: cs.surfaceContainerHighest,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                Expanded(
                  child: _buildCityList(),
                ),
              ],
            ),
    );
  }

  Widget _buildCityList() {
    if (_data == null || _selectedRegion == null || _selectedDistrict == null) {
      return const SizedBox.shrink();
    }

    final cities = _data!.citiesFor(_selectedRegion!, _selectedDistrict!);
    final filtered = _query.isEmpty
        ? cities
        : cities
            .where((city) => city.name.toLowerCase().contains(_query))
            .toList();

    if (filtered.isEmpty) {
      return Center(
        child: Text(
          '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
          style: TextStyle(
            color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
          ),
        ),
      );
    }

    return ListView.builder(
      padding: const EdgeInsets.fromLTRB(20, 8, 20, 24),
      itemCount: filtered.length,
      itemBuilder: (context, index) {
        final city = filtered[index];
        final selected = _selectedCity?.name == city.name;
        return ListTile(
          onTap: () => Navigator.pop(context, city.name),
          contentPadding: const EdgeInsets.symmetric(horizontal: 12),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          tileColor: selected
              ? NeoThemes.currentColor.withAlpha(26)
              : Colors.transparent,
          title: Text(city.name),
          subtitle: city.type.isNotEmpty ? Text(city.type) : null,
          trailing:
              selected ? const Icon(Icons.check_rounded) : const SizedBox(),
        );
      },
    );
  }
}

class _InlineDropdown extends StatefulWidget {
  final String label;
  final List<String> items;
  final String? value;
  final ValueChanged<String> onChanged;

  const _InlineDropdown({
    required this.label,
    required this.items,
    required this.value,
    required this.onChanged,
  });

  @override
  State<_InlineDropdown> createState() => _InlineDropdownState();
}

class _InlineDropdownState extends State<_InlineDropdown> {
  final LayerLink _link = LayerLink();
  OverlayEntry? _entry;

  @override
  void dispose() {
    _removeEntry();
    super.dispose();
  }

  void _removeEntry() {
    _entry?.remove();
    _entry = null;
  }

  void _toggleMenu() {
    if (_entry != null) {
      _removeEntry();
      return;
    }

    if (widget.items.isEmpty) return;

    final overlay = Overlay.of(context);
    final renderBox = context.findRenderObject() as RenderBox;
    final size = renderBox.size;
    final offset = renderBox.localToGlobal(Offset.zero);
    final screenHeight = MediaQuery.of(context).size.height;
    final top = offset.dy + size.height + 6;
    final maxHeight = (screenHeight - top - 16).clamp(120, 320).toDouble();

    _entry = OverlayEntry(
      builder: (context) {
        return Stack(
          children: [
            Positioned.fill(
              child: GestureDetector(
                onTap: _removeEntry,
                behavior: HitTestBehavior.translucent,
                child: const SizedBox.expand(),
              ),
            ),
            CompositedTransformFollower(
              link: _link,
              showWhenUnlinked: false,
              offset: Offset(0, size.height + 6),
              child: Material(
                elevation: 8,
                color: Theme.of(context).colorScheme.surface,
                borderRadius: BorderRadius.circular(16),
                child: ConstrainedBox(
                  constraints: BoxConstraints(
                    maxHeight: maxHeight,
                    minWidth: size.width,
                  ),
                  child: ListView.separated(
                    padding:
                        const EdgeInsets.symmetric(vertical: 6, horizontal: 6),
                    shrinkWrap: true,
                    itemCount: widget.items.length,
                    separatorBuilder: (_, __) => const SizedBox(height: 4),
                    itemBuilder: (context, index) {
                      final item = widget.items[index];
                      final isSelected = item == widget.value;
                      return InkWell(
                        borderRadius: BorderRadius.circular(12),
                        onTap: () {
                          widget.onChanged(item);
                          _removeEntry();
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                              horizontal: 12, vertical: 10),
                          decoration: BoxDecoration(
                            color: isSelected
                                ? NeoThemes.currentColor.withAlpha(26)
                                : Colors.transparent,
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Row(
                            children: [
                              Expanded(
                                child: Text(
                                  item,
                                  style: TextStyle(
                                    fontWeight: isSelected
                                        ? FontWeight.w600
                                        : FontWeight.w500,
                                  ),
                                ),
                              ),
                              if (isSelected)
                                Icon(
                                  Icons.check_rounded,
                                  color: NeoThemes.currentColor,
                                  size: 18,
                                ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );

    overlay.insert(_entry!);
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final valueText = widget.value?.isNotEmpty == true
        ? widget.value!
        : '–í—ã–±–µ—Ä–∏—Ç–µ';

    return CompositedTransformTarget(
      link: _link,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            widget.label,
            style: Theme.of(context).textTheme.titleSmall,
          ),
          const SizedBox(height: 8),
          InkWell(
            onTap: _toggleMenu,
            borderRadius: BorderRadius.circular(16),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
              decoration: BoxDecoration(
                color: cs.surfaceContainerHighest,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                children: [
                  Expanded(
                    child: Text(
                      valueText,
                      style: TextStyle(
                        color: widget.value == null
                            ? cs.onSurface.withAlpha(128)
                            : cs.onSurface,
                      ),
                    ),
                  ),
                  Icon(
                    Icons.keyboard_arrow_down_rounded,
                    color: cs.onSurface.withAlpha(153),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        CREATE ITEM PAGE
=========================== */

class NeoCreateItemPage extends StatefulWidget {
  const NeoCreateItemPage({super.key});

  @override
  State<NeoCreateItemPage> createState() => _NeoCreateItemPageState();
}

class _NeoCreateItemPageState extends State<NeoCreateItemPage> {
  final _titleController = TextEditingController();
  final _descController = TextEditingController();
  final _cityController = TextEditingController();
  String _selectedCategory = '–¢–µ—Ö–Ω–∏–∫–∞';
  ItemType _selectedType = ItemType.exchange;
  bool _loading = false;

  final List<String> _selectedImages = [];
  int _mainImageIndex = 0;

  final List<String> categories = [
    '–¢–µ—Ö–Ω–∏–∫–∞',
    '–û–¥–µ–∂–¥–∞',
    '–î–æ–º',
    '–°–ø–æ—Ä—Ç',
    '–ö–Ω–∏–≥–∏',
    '–î—Ä—É–≥–æ–µ'
  ];

  final ImagePicker _picker = ImagePicker();

  Future<void> _pickCity() async {
    final city = await showLocationPicker(
      context,
      initialCity: _cityController.text,
    );
    if (city != null) {
      setState(() => _cityController.text = city);
    }
  }

  @override
  void dispose() {
    _titleController.dispose();
    _descController.dispose();
    _cityController.dispose();
    super.dispose();
  }

  Future<void> _pickImages() async {
    if (_selectedImages.length >= 5) {
      _showToast('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Ñ–æ—Ç–æ');
      return;
    }

    try {
      final List<XFile> pickedFiles = await _picker.pickMultiImage(
        maxWidth: 1200,
        maxHeight: 1200,
        imageQuality: 85,
      );

      if (pickedFiles.isNotEmpty) {
        final availableSlots = 5 - _selectedImages.length;
        final filesToAdd = pickedFiles.take(availableSlots).toList();

        setState(() {
          _selectedImages.addAll(filesToAdd.map((file) => file.path));
        });
      }
    } catch (e) {
      _showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–æ—Ç–æ: $e');
    }
  }

  void _removeImage(int index) {
    setState(() {
      _selectedImages.removeAt(index);
      if (_mainImageIndex >= _selectedImages.length) {
        _mainImageIndex =
            _selectedImages.isNotEmpty ? _selectedImages.length - 1 : 0;
      }
    });
  }

  void _setMainImage(int index) {
    setState(() {
      _mainImageIndex = index;
    });
  }

  bool _isRemotePath(String path) {
    return path.startsWith('http');
  }

  Widget _buildImageItem(int index) {
    return Container(
      width: 100,
      height: 100,
      margin: const EdgeInsets.only(right: 12),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        image: DecorationImage(
          image: FileImage(File(_selectedImages[index])),
          fit: BoxFit.cover,
        ),
      ),
      child: Stack(
        children: [
          if (index == _mainImageIndex)
            Positioned(
              top: 4,
              right: 4,
              child: Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: Colors.green.withAlpha(200),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Icon(
                  Icons.star_rounded,
                  color: Colors.white,
                  size: 16,
                ),
              ),
            ),
          Positioned(
            bottom: 4,
            left: 4,
            child: GestureDetector(
              onTap: () => _setMainImage(index),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: Colors.black.withAlpha(128),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  index == _mainImageIndex ? '–ì–ª–∞–≤–Ω–æ–µ' : '–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ),
          Positioned(
            top: 4,
            left: 4,
            child: GestureDetector(
              onTap: () => _removeImage(index),
              child: Container(
                padding: const EdgeInsets.all(2),
                decoration: BoxDecoration(
                  color: Colors.red.withAlpha(200),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.close_rounded,
                  color: Colors.white,
                  size: 14,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _handleCreate() async {
    if (_loading) return;
    if (_titleController.text.isEmpty ||
        _descController.text.isEmpty ||
        _cityController.text.isEmpty) {
      _showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    if (_selectedImages.isEmpty) {
      _showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ');
      return;
    }

    setState(() => _loading = true);

    try {
      final user = neoStore.user;
      if (user == null) throw Exception('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');

      final uploadedUrls = await neoStore.uploadItemImages(_selectedImages);
      if (uploadedUrls.isEmpty) {
        _showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
        return;
      }
      if (uploadedUrls.length < _selectedImages.length) {
        _showToast('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
      }

      final localPaths =
          _selectedImages.where((path) => !_isRemotePath(path)).toList();
      final mainIndex = _mainImageIndex < uploadedUrls.length
          ? _mainImageIndex
          : 0;

      final newItem = Item(
        id: 'i_${DateTime.now().millisecondsSinceEpoch}',
        title: _titleController.text,
        desc: _descController.text,
        city: _cityController.text,
        category: _selectedCategory,
        type: _selectedType,
        status: user.isModerator ? ItemStatus.approved : ItemStatus.pending,
        likes: 0,
        views: 0,
        ownerId: user.uid,
        ownerName: user.name,
        ownerEmail: user.email,
        createdAt: DateTime.now(),
        photoPaths: const [],
        photoUrls: uploadedUrls,
        localImagePaths: localPaths,
        mainImageIndex: mainIndex,
      );

      await neoStore.addItem(newItem);

      if (!mounted) return;

      _showToast(user.isModerator
          ? '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!'
          : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é');
      Navigator.pop(context);
    } catch (e) {
      _showToast('–û—à–∏–±–∫–∞: $e');
    } finally {
      setState(() => _loading = false);
    }
  }

  void _showToast(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        duration: const Duration(seconds: 2),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 12),
            Text(
              '–î–æ 5 —Ñ–æ—Ç–æ. –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç –≥–ª–∞–≤–Ω—ã–º.',
              style: TextStyle(
                color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 16),
            if (_selectedImages.isNotEmpty)
              SizedBox(
                height: 100,
                child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  itemCount: _selectedImages.length,
                  itemBuilder: (context, index) {
                    return _buildImageItem(index);
                  },
                ),
              ),
            if (_selectedImages.length < 5)
              Container(
                margin: const EdgeInsets.only(top: 16),
                child: DottedBorder(
                  borderType: BorderType.RRect,
                  radius: const Radius.circular(12),
                  dashPattern: const [8, 4],
                  color: NeoThemes.currentColor.withAlpha(128),
                  child: InkWell(
                    onTap: _pickImages,
                    borderRadius: BorderRadius.circular(12),
                    child: Container(
                      width: double.infinity,
                      height: 100,
                      decoration: BoxDecoration(
                        color: Theme.of(context)
                            .colorScheme
                            .surfaceContainer
                            .withAlpha(77),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.add_photo_alternate_rounded,
                            color: NeoThemes.currentColor,
                            size: 32,
                          ),
                          const SizedBox(height: 8),
                          Text(
                            '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ',
                            style: TextStyle(
                              color: NeoThemes.currentColor,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          Text(
                            '${_selectedImages.length}/5',
                            style: TextStyle(
                              color: NeoThemes.currentColor.withAlpha(128),
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            const SizedBox(height: 32),
            Text(
              '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 20),
            NeoInput(
              controller: _titleController,
              hint: '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è*',
              prefixIcon: Icons.title_rounded,
            ),
            const SizedBox(height: 16),
            NeoInput(
              controller: _descController,
              hint: '–û–ø–∏—Å–∞–Ω–∏–µ*',
              prefixIcon: Icons.description_rounded,
              maxLines: 4,
            ),
            const SizedBox(height: 16),
            NeoInput(
              controller: _cityController,
              hint: '–ì–æ—Ä–æ–¥*',
              prefixIcon: Icons.location_on_rounded,
              suffixIcon: Icons.keyboard_arrow_down_rounded,
              readOnly: true,
              onTap: _pickCity,
            ),
            const SizedBox(height: 24),
            Text(
              '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: categories.map((category) {
                return ChoiceChip(
                  label: Text(category),
                  selected: _selectedCategory == category,
                  onSelected: (selected) {
                    setState(() => _selectedCategory = category);
                  },
                );
              }).toList(),
            ),
            const SizedBox(height: 24),
            Text(
              '–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: _TypeChoice(
                    type: ItemType.exchange,
                    selected: _selectedType == ItemType.exchange,
                    onTap: () {
                      setState(() => _selectedType = ItemType.exchange);
                    },
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: _TypeChoice(
                    type: ItemType.gift,
                    selected: _selectedType == ItemType.gift,
                    onTap: () {
                      setState(() => _selectedType = ItemType.gift);
                    },
                  ),
                ),
              ],
            ),
            const SizedBox(height: 40),
            NeoButton(
              text: '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',
              onPressed: _handleCreate,
              loading: _loading,
              fullWidth: true,
              icon: Icons.publish_rounded,
            ),
            const SizedBox(height: 20),
            if (neoStore.user?.isModerator == false)
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.orange.withAlpha(26),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.orange.withAlpha(77)),
                ),
                child: const Row(
                  children: [
                    Icon(
                      Icons.info_rounded,
                      color: Colors.orange,
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        '–í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π',
                        style: TextStyle(
                          color: Colors.orange,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class _TypeChoice extends StatelessWidget {
  final ItemType type;
  final bool selected;
  final VoidCallback? onTap;

  const _TypeChoice({
    required this.type,
    required this.selected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: selected ? type.accent.withAlpha(26) : Colors.transparent,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: selected ? type.accent : Colors.grey.withAlpha(77),
            width: 1.5,
          ),
        ),
        child: Column(
          children: [
            Icon(
              type.icon,
              color: selected ? type.accent : Colors.grey,
              size: 32,
            ),
            const SizedBox(height: 8),
            Text(
              type.label,
              style: TextStyle(
                color: selected ? type.accent : Colors.grey,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/* ===========================
        MODERATION PAGE
=========================== */

class NeoModerationPage extends StatefulWidget {
  const NeoModerationPage({super.key});

  @override
  State<NeoModerationPage> createState() => _NeoModerationPageState();
}

class _NeoModerationPageState extends State<NeoModerationPage> {
  @override
  Widget build(BuildContext context) {
    final pendingItems = neoStore.getPendingItems();

    return Scaffold(
      appBar: AppBar(
        title: const Text('–ú–æ–¥–µ—Ä–∞—Ü–∏—è'),
      ),
      body: pendingItems.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.check_circle_rounded,
                    size: 60,
                    color: Colors.green.withAlpha(128),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    '–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
                    style: Theme.of(context).textTheme.titleMedium,
                  ),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.all(20),
              itemCount: pendingItems.length,
              itemBuilder: (context, index) {
                final item = pendingItems[index];
                return _ModerationItemCard(item: item);
              },
            ),
    );
  }
}

class _ModerationItemCard extends StatelessWidget {
  final Item item;

  const _ModerationItemCard({required this.item});

  Future<void> _showRejectDialog(BuildContext context) async {
    final controller = TextEditingController();
    final result = await showDialog<String?>(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: const Text('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è'),
          content: TextField(
            controller: controller,
            maxLines: 3,
            decoration: const InputDecoration(
              hintText: '–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context, null),
              child: const Text('–û—Ç–º–µ–Ω–∞'),
            ),
            TextButton(
              onPressed: () => Navigator.pop(context, controller.text.trim()),
              child: const Text('–û—Ç–∫–ª–æ–Ω–∏—Ç—å'),
            ),
          ],
        );
      },
    );

    if (result == null) return;
    await neoStore.moderateItem(item.id, ItemStatus.rejected,
        comment: result.isEmpty ? null : result);
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            height: 200,
            width: double.infinity,
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.vertical(
                top: Radius.circular(24),
              ),
            ),
            child: ClipRRect(
              borderRadius: const BorderRadius.vertical(
                top: Radius.circular(24),
              ),
              child: item.getImageWidget(context, fit: BoxFit.cover),
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  item.title,
                  style: Theme.of(context).textTheme.titleLarge,
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 8),
                Text(
                  item.desc,
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(179),
                    fontSize: 14,
                  ),
                  maxLines: 3,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Icon(
                      Icons.location_on_rounded,
                      size: 16,
                      color: cs.onSurface.withAlpha(128),
                    ),
                    const SizedBox(width: 4),
                    Text(
                      item.city,
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(128),
                        fontSize: 14,
                      ),
                    ),
                    const Spacer(),
                    Text(
                      item.ownerName,
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(179),
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
                Row(
                  children: [
                    Expanded(
                      child: NeoButton(
                        text: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
                        onPressed: () {
                          _showRejectDialog(context);
                        },
                        color: Colors.red,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: NeoButton(
                        text: '–û–¥–æ–±—Ä–∏—Ç—å',
                        onPressed: () {
                          neoStore.moderateItem(item.id, ItemStatus.approved);
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ'),
                            ),
                          );
                        },
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        NEO CHATS
=========================== */

class NotificationsPage extends StatelessWidget {
  const NotificationsPage({super.key});

  String _formatTime(DateTime time) {
    final local = time.toLocal();
    final day = local.day.toString().padLeft(2, '0');
    final month = local.month.toString().padLeft(2, '0');
    final hour = local.hour.toString().padLeft(2, '0');
    final minute = local.minute.toString().padLeft(2, '0');
    return '$day.$month ${local.year} $hour:$minute';
  }

  String _statusLabel(String status) {
    switch (status) {
      case 'sent':
        return '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
      case 'failed':
        return '–û—à–∏–±–∫–∞';
      default:
        return '–í –æ—á–µ—Ä–µ–¥–∏';
    }
  }

  Color _statusColor(String status, ColorScheme scheme) {
    switch (status) {
      case 'sent':
        return Colors.green;
      case 'failed':
        return Colors.red;
      default:
        return scheme.onSurface.withAlpha(128);
    }
  }

  Widget _buildAvatar(String userId, String fallbackName) {
    return FutureBuilder<String?>(
      future: neoStore.fetchUserProfileImageUrl(userId),
      builder: (context, snapshot) {
        final url = snapshot.data;
        if (url?.isNotEmpty == true) {
          return ClipRRect(
            borderRadius: BorderRadius.circular(20),
            child: CachedNetworkImage(
              imageUrl: url!,
              width: 40,
              height: 40,
              fit: BoxFit.cover,
              placeholder: (context, value) => Center(
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  color: NeoThemes.currentColor,
                ),
              ),
              errorWidget: (context, value, error) {
                return _buildFallbackAvatar(fallbackName);
              },
            ),
          );
        }
        return _buildFallbackAvatar(fallbackName);
      },
    );
  }

  Widget _buildFallbackAvatar(String name) {
    return CircleAvatar(
      backgroundColor: NeoThemes.currentColor.withAlpha(26),
      child: Text(
        name.isNotEmpty ? name.substring(0, 1) : '?',
        style: const TextStyle(
          color: Colors.white,
          fontWeight: FontWeight.w700,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: neoStore,
      builder: (context, _) {
        final notifications = neoStore.notifications;
        return Scaffold(
          appBar: AppBar(
            title: const Text('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'),
          ),
          body: notifications.isEmpty
              ? Center(
                  child: Text(
                    '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç',
                    style: TextStyle(
                      color: Theme.of(context)
                          .colorScheme
                          .onSurface
                          .withAlpha(128),
                    ),
                  ),
                )
              : ListView.separated(
                  padding: const EdgeInsets.all(16),
                  itemCount: notifications.length,
                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                  itemBuilder: (context, index) {
                    final notification = notifications[index];
                    final cs = Theme.of(context).colorScheme;
                    final statusText = _statusLabel(notification.status);
                    final statusColor = _statusColor(notification.status, cs);
                    final isModeration =
                        notification.action.startsWith('moderation');

                    return InkWell(
                      borderRadius: BorderRadius.circular(16),
                      onTap: () async {
                        await neoStore.markNotificationRead(notification.id);
                        if (notification.chatId.isNotEmpty) {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) =>
                                  ChatDetailPage(chatId: notification.chatId),
                            ),
                          );
                        } else if (notification.itemId.isNotEmpty) {
                          final item = neoStore.items
                              .firstWhere((e) => e.id == notification.itemId,
                                  orElse: () => Item(
                                        id: '',
                                        title: '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
                                        desc: '',
                                        city: '',
                                        category: '',
                                        type: ItemType.exchange,
                                        status: ItemStatus.pending,
                                        likes: 0,
                                        views: 0,
                                        ownerId: '',
                                        ownerName: '',
                                        ownerEmail: '',
                                        createdAt: DateTime.now(),
                                        photoPaths: const [],
                                        photoUrls: const [],
                                      ));
                          if (item.id.isEmpty) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'),
                              ),
                            );
                            return;
                          }
                          if (notification.action == 'moderation_rejected') {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) => NeoEditItemPage(
                                  item: item,
                                  readOnly: true,
                                  moderationComment: notification.comment,
                                ),
                              ),
                            );
                          } else {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) =>
                                    NeoItemDetailPage(
                                      itemId: item.id,
                                      initialItem: item,
                                    ),
                              ),
                            );
                          }
                        } else {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('–ß–∞—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω'),
                            ),
                          );
                        }
                      },
                      child: Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: cs.surfaceContainerHighest,
                          borderRadius: BorderRadius.circular(16),
                          border: notification.read
                              ? null
                              : Border.all(
                                  color: NeoThemes.currentColor.withAlpha(128),
                                ),
                        ),
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            isModeration
                                ? const CircleAvatar(
                                    backgroundColor: Colors.orange,
                                    child: Icon(Icons.gavel_rounded,
                                        color: Colors.white),
                                  )
                                : _buildAvatar(
                                    notification.fromUserId,
                                    notification.fromName,
                                  ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    notification.fromName,
                                    style: TextStyle(
                                      fontWeight: notification.read
                                          ? FontWeight.w500
                                          : FontWeight.w700,
                                      color: cs.onSurface,
                                    ),
                                  ),
                                  const SizedBox(height: 6),
                                  Text(
                                    notification.body.isNotEmpty
                                        ? notification.body
                                        : notification.title,
                                    maxLines: 2,
                                    overflow: TextOverflow.ellipsis,
                                    style: TextStyle(
                                      color: cs.onSurface.withAlpha(179),
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Row(
                                    children: [
                                      Text(
                                        _formatTime(notification.createdAt),
                                        style: TextStyle(
                                          color: cs.onSurface.withAlpha(128),
                                          fontSize: 12,
                                        ),
                                      ),
                                      const Spacer(),
                                      Text(
                                        statusText,
                                        style: TextStyle(
                                          color: statusColor,
                                          fontWeight: FontWeight.w600,
                                          fontSize: 12,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
        );
      },
    );
  }
}

class NeoChats extends StatelessWidget {
  const NeoChats({super.key});

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: neoStore,
      builder: (context, _) {
        final meId = neoStore.user?.uid;
        final chats = neoStore.chats;

        Item? findItem(String? id) {
          if (id == null) return null;
          for (final item in neoStore.items) {
            if (item.id == id) return item;
          }
          return null;
        }

        bool isWantToGive(ChatThread chat) {
          if (meId == null) return false;
          final item = findItem(chat.relatedItemId);
          return item != null && item.ownerId == meId;
        }

        final wantGiveChats =
            chats.where((chat) => isWantToGive(chat)).toList();
        final wantGetChats =
            chats.where((chat) => !isWantToGive(chat)).toList();
        final wantGiveUnread = wantGiveChats.fold<int>(
            0, (sum, chat) => sum + max(0, chat.unread));
        final wantGetUnread = wantGetChats.fold<int>(
            0, (sum, chat) => sum + max(0, chat.unread));

        Widget buildChatList(List<ChatThread> list) {
          if (list.isEmpty) {
            return Center(
              child: Text(
                '–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤',
                style: TextStyle(
                  color: Theme.of(context).colorScheme.onSurface.withAlpha(128),
                ),
              ),
            );
          }
          return ListView.builder(
            padding: const EdgeInsets.all(20),
            itemCount: list.length,
            itemBuilder: (context, index) {
              final chat = list[index];
              return Padding(
                padding: const EdgeInsets.only(bottom: 12),
                child: _NeoChatTile(chat: chat),
              );
            },
          );
        }

        return DefaultTabController(
          length: 2,
          child: Column(
            children: [
              Container(
                width: double.infinity,
                padding: const EdgeInsets.fromLTRB(20, 60, 20, 16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      Theme.of(context).colorScheme.surface.withAlpha(230),
                      Theme.of(context).colorScheme.surface.withAlpha(153),
                    ],
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(
                          '–°–æ–æ–±—â–µ–Ω–∏—è',
                          style: Theme.of(context).textTheme.displaySmall,
                        ),
                        const Spacer(),
                        Container(
                          padding: const EdgeInsets.symmetric(
                              horizontal: 12, vertical: 6),
                          decoration: BoxDecoration(
                            color: NeoThemes.currentColor.withAlpha(26),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(
                            '${neoStore.totalUnread} –Ω–æ–≤—ã—Ö',
                            style: TextStyle(
                              color: NeoThemes.currentColor,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    TabBar(
                      tabs: [
                        Tab(
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const Text('–•–æ—á—É –ø–æ–ª—É—á–∏—Ç—å'),
                              if (wantGetUnread > 0) ...[
                                const SizedBox(width: 6),
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 6, vertical: 2),
                                  decoration: BoxDecoration(
                                    color: Colors.red,
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Text(
                                    '$wantGetUnread',
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 10,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ),
                        Tab(
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const Text('–•–æ—á—É –æ—Ç–¥–∞—Ç—å'),
                              if (wantGiveUnread > 0) ...[
                                const SizedBox(width: 6),
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 6, vertical: 2),
                                  decoration: BoxDecoration(
                                    color: Colors.red,
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Text(
                                    '$wantGiveUnread',
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 10,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ),
                      ],
                      indicatorSize: TabBarIndicatorSize.tab,
                    ),
                  ],
                ),
              ),
              Expanded(
                child: TabBarView(
                  children: [
                    buildChatList(wantGetChats),
                    buildChatList(wantGiveChats),
                  ],
                ),
              ),
              const SizedBox(height: 80),
            ],
          ),
        );
      },
    );
  }
}

class _NeoChatTile extends StatefulWidget {
  final ChatThread chat;

  const _NeoChatTile({required this.chat});

  @override
  State<_NeoChatTile> createState() => __NeoChatTileState();
}

class __NeoChatTileState extends State<_NeoChatTile>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );
    _scale = Tween<double>(begin: 1.0, end: 1.02).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _handleHover(bool hover) {
    if (hover) {
      _controller.forward();
    } else {
      _controller.reverse();
    }
  }

  Widget _buildProfileImage() {
    return FutureBuilder<String?>(
      future: neoStore.fetchUserProfileImageUrl(widget.chat.peerId),
      builder: (context, snapshot) {
        final url = snapshot.data;
        if (url?.isNotEmpty == true) {
          return ClipRRect(
            borderRadius: BorderRadius.circular(16),
            child: CachedNetworkImage(
              imageUrl: url!,
              width: 48,
              height: 48,
              fit: BoxFit.cover,
              placeholder: (context, value) => Center(
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  color: NeoThemes.currentColor,
                ),
              ),
              errorWidget: (context, value, error) {
                return _buildDefaultPeerAvatar();
              },
            ),
          );
        }
        return _buildDefaultPeerAvatar();
      },
    );
  }

  Widget _buildDefaultPeerAvatar() {
    return Container(
      width: 48,
      height: 48,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            NeoThemes.currentColor.withAlpha(204),
            NeoThemes.currentNeon.withAlpha(153),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Center(
        child: Text(
          widget.chat.peerName.substring(0, 1),
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.w700,
            fontSize: 18,
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final lastMessage = widget.chat.last;
    final lastPreview = lastMessage.type == MessageType.image
        ? '–§–æ—Ç–æ'
        : (lastMessage.text.isNotEmpty ? lastMessage.text : '–°–æ–æ–±—â–µ–Ω–∏–µ');

    return MouseRegion(
      onEnter: (_) => _handleHover(true),
      onExit: (_) => _handleHover(false),
      child: GestureDetector(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => ChatDetailPage(chatId: widget.chat.id),
            ),
          );
        },
        child: AnimatedBuilder(
          animation: _controller,
          builder: (context, child) {
            return Transform.scale(
              scale: _scale.value,
              child: child,
            );
          },
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: NeoThemes.getCardDecoration(context),
            child: Row(
              children: [
                _buildProfileImage(),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Text(
                            widget.chat.peerName,
                            style: Theme.of(context).textTheme.titleMedium,
                          ),
                          const Spacer(),
                          Text(
                            '${lastMessage.at.hour.toString().padLeft(2, '0')}:${lastMessage.at.minute.toString().padLeft(2, '0')}',
                            style: TextStyle(
                              color: cs.onSurface.withAlpha(128),
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 4),
                      Text(
                        lastPreview,
                        style: TextStyle(
                          color: cs.onSurface.withAlpha(179),
                          fontSize: 14,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                const SizedBox(width: 12),
                if (widget.chat.unread > 0)
                  Container(
                    width: 20,
                    height: 20,
                    decoration: BoxDecoration(
                      color: NeoThemes.currentColor,
                      shape: BoxShape.circle,
                    ),
                    child: Center(
                      child: Text(
                        '${widget.chat.unread}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 10,
                          fontWeight: FontWeight.w700,
                        ),
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

/* ===========================
        NEO FAVORITES
=========================== */

class NeoFavorites extends StatelessWidget {
  const NeoFavorites({super.key});

  @override
  Widget build(BuildContext context) {
    final favoriteItems = neoStore.items
        .where((item) => neoStore.isFav(item.id))
        .where((item) => item.status == ItemStatus.approved)
        .toList();

    return CustomScrollView(
      physics: const BouncingScrollPhysics(),
      slivers: [
        SliverAppBar(
          expandedHeight: 140,
          floating: false,
          pinned: true,
          backgroundColor: Colors.transparent,
          surfaceTintColor: Colors.transparent,
          flexibleSpace: FlexibleSpaceBar(
            background: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    Theme.of(context).colorScheme.surface.withAlpha(230),
                    Theme.of(context).colorScheme.surface.withAlpha(153),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.fromLTRB(20, 60, 20, 20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
                      style: Theme.of(context).textTheme.displaySmall,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      '${favoriteItems.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                      style: TextStyle(
                        color: Theme.of(context)
                            .colorScheme
                            .onSurface
                            .withAlpha(153),
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
        SliverPadding(
          padding: const EdgeInsets.all(20),
          sliver: favoriteItems.isEmpty
              ? SliverToBoxAdapter(
                  child: Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.favorite_border_rounded,
                          size: 60,
                          color: Colors.grey.withAlpha(128),
                        ),
                        const SizedBox(height: 16),
                        Text(
                          '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                          style: Theme.of(context).textTheme.titleMedium,
                        ),
                      ],
                    ),
                  ),
                )
              : SliverGrid(
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 16,
                    mainAxisSpacing: 16,
                    childAspectRatio: 0.75,
                  ),
                  delegate: SliverChildBuilderDelegate(
                    (context, index) {
                      final item = favoriteItems[index];
                      return GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) =>
                                  NeoItemDetailPage(
                                    itemId: item.id,
                                    initialItem: item,
                                  ),
                            ),
                          );
                        },
                        child: _NeoFavoriteCard(item: item),
                      );
                    },
                    childCount: favoriteItems.length,
                  ),
                ),
        ),
        const SliverToBoxAdapter(
          child: SizedBox(height: 80),
        ),
      ],
    );
  }
}

class _NeoFavoriteCard extends StatefulWidget {
  final Item item;

  const _NeoFavoriteCard({required this.item});

  @override
  State<_NeoFavoriteCard> createState() => __NeoFavoriteCardState();
}

class __NeoFavoriteCardState extends State<_NeoFavoriteCard> {
  bool _favorited = true;

  @override
  void initState() {
    super.initState();
    _favorited = neoStore.isFav(widget.item.id);
  }

  void _toggleFavorite() {
    setState(() => _favorited = !_favorited);
    neoStore.toggleFav(widget.item.id);
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      decoration: NeoThemes.getCardDecoration(context),
      child: Stack(
        children: [
          // –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          Positioned.fill(
            child: ClipRRect(
              borderRadius: BorderRadius.circular(24),
              child: widget.item.getImageWidget(context, fit: BoxFit.cover),
            ),
          ),

          // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
          Positioned.fill(
            child: DecoratedBox(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(24),
                gradient: LinearGradient(
                  colors: [
                    Colors.transparent,
                    Colors.black.withAlpha(179),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  stops: const [0.4, 1.0],
                ),
              ),
            ),
          ),

          // –ò–∫–æ–Ω–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
          Positioned(
            top: 16,
            right: 16,
            child: GestureDetector(
              onTap: _toggleFavorite,
              child: Container(
                width: 36,
                height: 36,
                decoration: BoxDecoration(
                  color: Colors.black.withAlpha(180),
                  borderRadius: BorderRadius.circular(18),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withAlpha(100),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Center(
                  child: Icon(
                    _favorited ? Icons.favorite_rounded : Icons.favorite_border,
                    color: _favorited ? Colors.red : Colors.white,
                    size: 20,
                  ),
                ),
              ),
            ),
          ),

          // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –≤–Ω–∏–∑—É
          Positioned(
            bottom: 0,
            left: 0,
            right: 0,
            child: Container(
              decoration: BoxDecoration(
                borderRadius: const BorderRadius.only(
                  bottomLeft: Radius.circular(24),
                  bottomRight: Radius.circular(24),
                ),
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.transparent,
                    Colors.black.withAlpha(220),
                  ],
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    Text(
                      widget.item.title,
                      style: Theme.of(context).textTheme.titleMedium?.copyWith(
                            color: Colors.white,
                            fontSize: 14,
                          ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),

                    // –ì–æ—Ä–æ–¥
                    const SizedBox(height: 6),
                    Text(
                      widget.item.city,
                      style: TextStyle(
                        color: Colors.white.withAlpha(204),
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
/* ===========================
        NEO PROFILE
=========================== */

class NeoProfile extends StatefulWidget {
  const NeoProfile({super.key});

  @override
  State<NeoProfile> createState() => _NeoProfileState();
}

class _NeoProfileState extends State<NeoProfile> {
  final _nameController = TextEditingController();
  final _cityController = TextEditingController();
  bool _isEditing = false;
  final ImagePicker _picker = ImagePicker();

  final _loginEmailController = TextEditingController();
  final _loginPasswordController = TextEditingController();
  final _signupNameController = TextEditingController();
  final _signupEmailController = TextEditingController();
  final _signupPasswordController = TextEditingController();
  final _signupCityController = TextEditingController();
  bool _isLoginMode = true;
  bool _authLoading = false;
  String _authError = '';

  @override
  void initState() {
    super.initState();
    if (neoStore.user != null) {
      _updateControllers();
    }
  }

  @override
  void didUpdateWidget(NeoProfile oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (neoStore.user != null) {
      _updateControllers();
    }
  }

  void _updateControllers() {
    if (neoStore.user != null) {
      _nameController.text = neoStore.user!.name;
      _cityController.text = neoStore.user!.city;
    }
  }

  Widget _buildProfileImage() {
    if (neoStore.user?.profileImageUrl?.isNotEmpty == true) {
      return ClipRRect(
        borderRadius: BorderRadius.circular(50),
        child: CachedNetworkImage(
          imageUrl: neoStore.user!.profileImageUrl!,
          width: 100,
          height: 100,
          fit: BoxFit.cover,
          placeholder: (context, url) => Center(
            child: CircularProgressIndicator(
              strokeWidth: 2,
              color: NeoThemes.currentColor,
            ),
          ),
          errorWidget: (context, url, error) {
            return _buildDefaultAvatar();
          },
        ),
      );
    } else if (neoStore.user?.profileImagePath?.isNotEmpty == true) {
      return ClipRRect(
        borderRadius: BorderRadius.circular(50),
        child: Image.file(
          File(neoStore.user!.profileImagePath!),
          width: 100,
          height: 100,
          fit: BoxFit.cover,
          errorBuilder: (context, error, stackTrace) {
            return _buildDefaultAvatar();
          },
        ),
      );
    } else {
      return _buildDefaultAvatar();
    }
  }

  Widget _buildDefaultAvatar() {
    return Container(
      width: 100,
      height: 100,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            NeoThemes.currentColor,
            NeoThemes.currentNeon,
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        shape: BoxShape.circle,
        boxShadow: [
          BoxShadow(
            color: NeoThemes.currentColor.withAlpha(77),
            blurRadius: 20,
            spreadRadius: 5,
          ),
        ],
      ),
      child: const Center(
        child: Icon(
          Icons.person_rounded,
          size: 40,
          color: Colors.white,
        ),
      ),
    );
  }

  Future<void> _pickProfileImage() async {
    try {
      final XFile? image = await _picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 800,
        maxHeight: 800,
        imageQuality: 90,
      );

      if (image != null && neoStore.user != null) {
        await neoStore.updateProfile(profileImagePath: image.path);
        setState(() {});
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–æ—Ç–æ: $e'),
        ),
      );
    }
  }

  Future<void> _pickProfileCity() async {
    if (!_isEditing) return;
    final city = await showLocationPicker(
      context,
      initialCity: _cityController.text,
    );
    if (city != null) {
      setState(() => _cityController.text = city);
    }
  }

  Future<void> _pickSignupCity() async {
    final city = await showLocationPicker(
      context,
      initialCity: _signupCityController.text,
    );
    if (city != null) {
      setState(() => _signupCityController.text = city);
    }
  }

  void _saveProfile() async {
    if (_nameController.text.isEmpty || _cityController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'),
        ),
      );
      return;
    }

    await neoStore.updateProfile(
      name: _nameController.text,
      city: _cityController.text,
    );

    setState(() {
      _isEditing = false;
    });

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω'),
      ),
    );
  }

  Future<void> _handleAuth() async {
    if (_authLoading) return;

    setState(() {
      _authLoading = true;
      _authError = '';
    });

    try {
      if (_isLoginMode) {
        if (_loginEmailController.text.isEmpty ||
            _loginPasswordController.text.isEmpty) {
          throw Exception('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        }

        await neoStore.login(
          email: _loginEmailController.text,
          password: _loginPasswordController.text,
        );
      } else {
        if (_signupNameController.text.isEmpty ||
            _signupEmailController.text.isEmpty ||
            _signupPasswordController.text.isEmpty ||
            _signupCityController.text.isEmpty) {
          throw Exception('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        }

        await neoStore.signup(
          name: _signupNameController.text,
          email: _signupEmailController.text,
          password: _signupPasswordController.text,
          city: _signupCityController.text,
        );
      }

      _loginEmailController.clear();
      _loginPasswordController.clear();
      _signupNameController.clear();
      _signupEmailController.clear();
      _signupPasswordController.clear();
      _signupCityController.clear();

      setState(() {});

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            _isLoginMode
                ? '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!'
                : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!',
          ),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      setState(() {
        _authError = e.toString();

        if (e.toString().contains('wrong-password') ||
            e.toString().contains('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å')) {
          _authError = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.';
        } else if (e.toString().contains('user-not-found') ||
            e.toString().contains('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
          _authError = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.';
        } else if (e.toString().contains('invalid-credential') ||
            e.toString().contains('invalid-credentials')) {
          _authError = '–í–≤–µ–¥–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.';
        } else if (e.toString().contains('email-already-in-use')) {
          _authError = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
        } else if (e.toString().contains('network-request-failed') ||
            e.toString().contains('timeout') ||
            e.toString().contains('—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ')) {
          _authError = '–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
        } else if (e.toString().contains('invalid-email')) {
          _authError = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.';
        } else if (e.toString().contains('weak-password')) {
          _authError = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.';
        }
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('–û—à–∏–±–∫–∞: $_authError'),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      setState(() {
        _authLoading = false;
      });
    }
  }

  void _switchAuthMode() {
    setState(() {
      _isLoginMode = !_isLoginMode;
      _authError = '';
      _loginEmailController.clear();
      _loginPasswordController.clear();
      _signupNameController.clear();
      _signupEmailController.clear();
      _signupPasswordController.clear();
      _signupCityController.clear();
    });
  }

  void _showTermsDialog() {
    final cs = Theme.of(context).colorScheme;
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è'),
        content: SizedBox(
          width: double.maxFinite,
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildPolicySection(
                  '1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è',
                  '–ò—Å–ø–æ–ª—å–∑—É—è NeoObmin, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞.',
                  cs,
                ),
                const SizedBox(height: 12),
                _buildPolicySection(
                  '2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–∫–∫–∞—É–Ω—Ç',
                  '–í—ã –Ω–µ—Å–µ—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.',
                  cs,
                ),
                const SizedBox(height: 12),
                _buildPolicySection(
                  '3. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                  '–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã. –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é.',
                  cs,
                ),
                const SizedBox(height: 12),
                _buildPolicySection(
                  '4. –û–±–º–µ–Ω',
                  'NeoObmin –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–¥–µ–ª–∫–∞—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.',
                  cs,
                ),
              ],
            ),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('–ó–∞–∫—Ä—ã—Ç—å'),
          ),
        ],
      ),
    );
  }

  void _showPrivacyDialog() {
    final cs = Theme.of(context).colorScheme;
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏'),
        content: SizedBox(
          width: double.maxFinite,
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildPolicySection(
                  '1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö',
                  '–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –∏–º—è, email –∏ –≥–æ—Ä–æ–¥, –∞ —Ç–∞–∫–∂–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö.',
                  cs,
                ),
                const SizedBox(height: 12),
                _buildPolicySection(
                  '2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ',
                  '–î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.',
                  cs,
                ),
                const SizedBox(height: 12),
                _buildPolicySection(
                  '3. –ó–∞—â–∏—Ç–∞',
                  '–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö.',
                  cs,
                ),
              ],
            ),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('–ó–∞–∫—Ä—ã—Ç—å'),
          ),
        ],
      ),
    );
  }

  Widget _buildPolicySection(String title, String content, ColorScheme cs) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          title,
          style: Theme.of(context).textTheme.titleSmall,
        ),
        const SizedBox(height: 6),
        Text(
          content,
          style: TextStyle(
            color: cs.onSurface.withAlpha(153),
            fontSize: 12,
            height: 1.4,
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: neoStore,
      builder: (context, _) {
        final user = neoStore.user;
        final isLoggedIn = user != null;
        return Scaffold(
          body: CustomScrollView(
            physics: const BouncingScrollPhysics(),
            slivers: [
              SliverToBoxAdapter(
                child: Container(
                  padding: const EdgeInsets.fromLTRB(20, 60, 20, 20),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        NeoThemes.currentColor.withAlpha(77),
                        Theme.of(context).colorScheme.surface.withAlpha(153),
                      ],
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                    ),
                  ),
                  child: Column(
                    children: [
                      if (!isLoggedIn)
                        _buildAuthForm()
                      else
                        _buildProfileHeader(),
                    ],
                  ),
                ),
              ),
              if (isLoggedIn && !_isEditing) ...[
                _buildLoggedInContent(),
              ],
              const SliverToBoxAdapter(
                child: SizedBox(height: 120),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildAuthForm() {
    final cs = Theme.of(context).colorScheme;

    return Column(
      children: [
        Container(
          width: 100,
          height: 100,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                NeoThemes.currentColor,
                NeoThemes.currentNeon,
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: NeoThemes.currentColor.withAlpha(77),
                blurRadius: 20,
                spreadRadius: 5,
              ),
            ],
          ),
          child: const Center(
            child: Icon(
              Icons.person_rounded,
              size: 40,
              color: Colors.white,
            ),
          ),
        ),
        const SizedBox(height: 16),
        Text(
          _isLoginMode ? '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
          style: Theme.of(context).textTheme.displaySmall,
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 4),
        Text(
          _isLoginMode
              ? '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±–º–µ–Ω'
              : '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç',
          style: TextStyle(
            color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
            fontSize: 14,
          ),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 20),
        if (!_isLoginMode) ...[
          Container(
            margin: const EdgeInsets.only(bottom: 12),
            child: NeoInput(
              controller: _signupNameController,
              hint: '–ò–º—è',
              prefixIcon: Icons.person_rounded,
            ),
          ),
        ],
        Container(
          margin: const EdgeInsets.only(bottom: 12),
          child: NeoInput(
            controller:
                _isLoginMode ? _loginEmailController : _signupEmailController,
            hint: 'Email',
            prefixIcon: Icons.email_rounded,
            keyboardType: TextInputType.emailAddress,
          ),
        ),
        Container(
          margin: const EdgeInsets.only(bottom: 12),
          child: NeoInput(
            controller: _isLoginMode
                ? _loginPasswordController
                : _signupPasswordController,
            hint: '–ü–∞—Ä–æ–ª—å',
            prefixIcon: Icons.lock_rounded,
            obscure: true,
          ),
        ),
        if (!_isLoginMode) ...[
          Container(
            margin: const EdgeInsets.only(bottom: 20),
            child: NeoInput(
              controller: _signupCityController,
              hint: '–ì–æ—Ä–æ–¥',
              prefixIcon: Icons.location_on_rounded,
              suffixIcon: Icons.keyboard_arrow_down_rounded,
              readOnly: true,
              onTap: _pickSignupCity,
            ),
          ),
        ],
        if (_authError.isNotEmpty)
          Container(
            padding: const EdgeInsets.all(12),
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.red.withAlpha(30),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.red.withAlpha(77)),
            ),
            child: Row(
              children: [
                const Icon(Icons.error_outline_rounded,
                    size: 16, color: Colors.red),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    _authError,
                    style: const TextStyle(
                      color: Colors.red,
                      fontSize: 12,
                    ),
                  ),
                ),
              ],
            ),
          ),
        NeoButton(
          text: _isLoginMode
              ? (_authLoading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏')
              : (_authLoading ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'),
          onPressed: _handleAuth,
          loading: _authLoading,
          fullWidth: true,
          icon: _isLoginMode ? Icons.login_rounded : Icons.person_add_rounded,
        ),
        if (!_isLoginMode) ...[
          const SizedBox(height: 12),
          RichText(
            textAlign: TextAlign.center,
            text: TextSpan(
              style: TextStyle(
                color: cs.onSurface.withAlpha(153),
                fontSize: 12,
              ),
              children: [
                const TextSpan(
                  text:
                      '–ù–∞–∂–∏–º–∞—è "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–∞—à–µ–π ',
                ),
                TextSpan(
                  text: '–ü–æ–ª–∏—Ç–∏–∫–æ–π',
                  style: TextStyle(
                    color: NeoThemes.currentColor,
                    fontWeight: FontWeight.w600,
                  ),
                  recognizer: TapGestureRecognizer()
                    ..onTap = _showPrivacyDialog,
                ),
                const TextSpan(text: ' –∏ '),
                TextSpan(
                  text: '–£—Å–ª–æ–≤–∏—è–º–∏',
                  style: TextStyle(
                    color: NeoThemes.currentColor,
                    fontWeight: FontWeight.w600,
                  ),
                  recognizer: TapGestureRecognizer()..onTap = _showTermsDialog,
                ),
                const TextSpan(text: '.'),
              ],
            ),
          ),
        ],
        const SizedBox(height: 12),
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              _isLoginMode ? '–ï—â–µ –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?',
              style: TextStyle(
                color: cs.onSurface.withAlpha(153),
              ),
            ),
            const SizedBox(width: 4),
            NeoTextButton(
              text: _isLoginMode ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏',
              onPressed: _switchAuthMode,
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildProfileHeader() {
    final user = neoStore.user!;
    final cs = Theme.of(context).colorScheme;

    return Column(
      children: [
        GestureDetector(
          onTap: _isEditing ? _pickProfileImage : null,
          child: Stack(
            children: [
              _buildProfileImage(),
              if (_isEditing)
                Positioned.fill(
                  child: Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withAlpha(128),
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: const Center(
                      child: Icon(
                        Icons.camera_alt_rounded,
                        color: Colors.white,
                        size: 32,
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),
        const SizedBox(height: 16),
        if (_isEditing)
          Column(
            children: [
              Container(
                margin: const EdgeInsets.symmetric(horizontal: 20),
                child: NeoInput(
                  controller: _nameController,
                  hint: '–ò–º—è',
                  prefixIcon: Icons.person_rounded,
                ),
              ),
              const SizedBox(height: 12),
              Container(
                margin: const EdgeInsets.symmetric(horizontal: 20),
                child: NeoInput(
                  controller: _cityController,
                  hint: '–ì–æ—Ä–æ–¥',
                  prefixIcon: Icons.location_on_rounded,
                  suffixIcon: Icons.keyboard_arrow_down_rounded,
                  readOnly: true,
                  onTap: _pickProfileCity,
                ),
              ),
              const SizedBox(height: 16),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  NeoButton(
                    text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    onPressed: _saveProfile,
                    icon: Icons.save_rounded,
                  ),
                  const SizedBox(width: 12),
                  NeoButton(
                    text: '–û—Ç–º–µ–Ω–∞',
                    onPressed: () {
                      setState(() {
                        _isEditing = false;
                        _updateControllers();
                      });
                    },
                    color: Colors.grey,
                    icon: Icons.close_rounded,
                  ),
                ],
              ),
            ],
          )
        else
          Column(
            children: [
              Text(
                user.name,
                style: Theme.of(context).textTheme.displaySmall,
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 4),
              Text(
                user.email,
                style: TextStyle(
                  color: cs.onSurface.withAlpha(153),
                  fontSize: 14,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 12),
              Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(
                  color: user.isModerator
                      ? Colors.green.withAlpha(26)
                      : NeoThemes.currentColor.withAlpha(26),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: user.isModerator
                        ? Colors.green.withAlpha(77)
                        : NeoThemes.currentColor.withAlpha(77),
                  ),
                ),
                child: Text(
                  user.isAdmin
                      ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
                      : user.isModerator
                          ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä'
                          : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                  style: TextStyle(
                    color: user.isModerator
                        ? Colors.green
                        : NeoThemes.currentColor,
                    fontWeight: FontWeight.w600,
                    fontSize: 12,
                  ),
                ),
              ),
              const SizedBox(height: 12),
              NeoButton(
                text: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                onPressed: () {
                  setState(() => _isEditing = true);
                },
                fullWidth: true,
                icon: Icons.edit_rounded,
              ),
            ],
          ),
      ],
    );
  }

  Widget _buildLoggedInContent() {
    final user = neoStore.user!;

    return SliverList(
      delegate: SliverChildListDelegate([
        Container(
          padding: const EdgeInsets.all(20),
          margin: const EdgeInsets.symmetric(horizontal: 20),
          decoration: NeoThemes.getCardDecoration(context),
          child: Column(
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  _StatItem(
                    value: '${user.itemsPosted}',
                    label: '–û–±—ä—è–≤–ª–µ–Ω–∏—è',
                    icon: Icons.list_alt_rounded,
                  ),
                  _StatItem(
                    value: '${user.likes}',
                    label: '–õ–∞–π–∫–∏',
                    icon: Icons.favorite_rounded,
                  ),
                  _StatItem(
                    value: '${user.level}',
                    label: '–£—Ä–æ–≤–µ–Ω—å',
                    icon: Icons.star_rounded,
                  ),
                ],
              ),
              const SizedBox(height: 16),
              LinearProgressIndicator(
                value: user.itemsPosted / 10,
                backgroundColor: Colors.grey.withAlpha(26),
                color: NeoThemes.currentColor,
                minHeight: 8,
                borderRadius: BorderRadius.circular(4),
              ),
              const SizedBox(height: 8),
              Text(
                '–ü—Ä–æ–≥—Ä–µ—Å—Å: ${user.itemsPosted}/10 –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                style: TextStyle(
                  color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
                  fontSize: 12,
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 20),
        ..._buildProfileActions(),
      ]),
    );
  }

  List<Widget> _buildProfileActions() {
    final user = neoStore.user!;
    final pendingCount =
        user.isModerator ? neoStore.getPendingItems().length : 0;
    final actions = [
      _ProfileItem(
        icon: Icons.list_alt_rounded,
        title: '–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        subtitle: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const MyItemsPage(),
            ),
          );
        },
      ),
      _ProfileItem(
        icon: Icons.emoji_events_rounded,
        title: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
        subtitle: '–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const AchievementsPage(),
            ),
          );
        },
      ),
      _ProfileItem(
        icon: Icons.settings_rounded,
        title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        subtitle: '–¢–µ–º—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const NeoSettingsPage(),
            ),
          );
        },
      ),
      if (user.isModerator)
        _ProfileItem(
          icon: Icons.gavel_rounded,
          title: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è',
          subtitle: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
          badgeCount: pendingCount,
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => const NeoModerationPage(),
              ),
            );
          },
        ),
      _ProfileItem(
        icon: Icons.help_rounded,
        title: '–ü–æ–º–æ—â—å',
        subtitle: '–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const HelpPage(),
            ),
          );
        },
      ),
      _ProfileItem(
        icon: Icons.description_rounded,
        title: '–£—Å–ª–æ–≤–∏—è',
        subtitle: '–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const TermsPage(),
            ),
          );
        },
      ),
      _ProfileItem(
        icon: Icons.privacy_tip_rounded,
        title: '–ü–æ–ª–∏—Ç–∏–∫–∞',
        subtitle: '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å',
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const PrivacyPage(),
            ),
          );
        },
      ),
      _ProfileItem(
        icon: Icons.logout_rounded,
        title: '–í—ã–π—Ç–∏',
        subtitle: '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é',
        color: Colors.red,
        isLogout: true, // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
        onTap: () {}, // –ü—É—Å—Ç–æ–π –∫–æ–ª–±–µ–∫, —Ç–∞–∫ –∫–∞–∫ –ª–æ–≥–∏–∫–∞ –≤ _LogoutButton
      ),
    ];

    return actions;
  }
}

/* ===========================
        MY ITEMS PAGE
=========================== */

class MyItemsPage extends StatefulWidget {
  const MyItemsPage({super.key});

  @override
  State<MyItemsPage> createState() => _MyItemsPageState();
}

class _MyItemsPageState extends State<MyItemsPage> {
  @override
  Widget build(BuildContext context) {
    final myItems = neoStore.myItems();

    return Scaffold(
      appBar: AppBar(
        title: const Text('–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'),
      ),
      body: myItems.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.list_alt_rounded,
                    size: 60,
                    color: Colors.grey.withAlpha(128),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    '–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
                    style: Theme.of(context).textTheme.titleMedium,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',
                    style: TextStyle(
                      color: Theme.of(context)
                          .colorScheme
                          .onSurface
                          .withAlpha(128),
                    ),
                  ),
                  const SizedBox(height: 20),
                  NeoButton(
                    text: '–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',
                    onPressed: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => const NeoCreateItemPage(),
                        ),
                      );
                    },
                  ),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.all(20),
              itemCount: myItems.length,
              itemBuilder: (context, index) {
                final item = myItems[index];
                return Padding(
                  padding: const EdgeInsets.only(bottom: 16),
                  child: _MyItemCard(item: item),
                );
              },
            ),
    );
  }
}

class _MyItemCard extends StatelessWidget {
  final Item item;

  const _MyItemCard({required this.item});

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            height: 180,
            width: double.infinity,
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.vertical(
                top: Radius.circular(24),
              ),
            ),
            child: ClipRRect(
              borderRadius: const BorderRadius.vertical(
                top: Radius.circular(24),
              ),
              child: item.getImageWidget(context, fit: BoxFit.cover),
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        item.title,
                        style: Theme.of(context).textTheme.titleLarge,
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: item.status.color.withAlpha(26),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: item.status.color.withAlpha(77),
                        ),
                      ),
                      child: Text(
                        item.status.label,
                        style: TextStyle(
                          color: item.status.color,
                          fontWeight: FontWeight.w600,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  item.desc,
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(179),
                    fontSize: 14,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Icon(
                      Icons.location_on_rounded,
                      size: 16,
                      color: cs.onSurface.withAlpha(128),
                    ),
                    const SizedBox(width: 4),
                    Text(
                      item.city,
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(128),
                        fontSize: 14,
                      ),
                    ),
                    const Spacer(),
                    Icon(
                      Icons.remove_red_eye_rounded,
                      size: 16,
                      color: cs.onSurface.withAlpha(128),
                    ),
                    const SizedBox(width: 4),
                    Text(
                      '${item.views}',
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(128),
                        fontSize: 14,
                      ),
                    ),
                    const SizedBox(width: 16),
                    const Icon(
                      Icons.favorite_rounded,
                      size: 16,
                      color: Colors.red,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      '${item.likes}',
                      style: TextStyle(
                        color: cs.onSurface.withAlpha(128),
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
                Row(
                  children: [
                    Expanded(
                      child: NeoButton(
                        text: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => NeoEditItemPage(item: item),
                            ),
                          );
                        },
                        color: Colors.blue,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: NeoButton(
                        text: '–£–¥–∞–ª–∏—Ç—å',
                        onPressed: () {
                          showDialog(
                            context: context,
                            builder: (context) => AlertDialog(
                              title: const Text('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'),
                              content: const Text(
                                  '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'),
                              actions: [
                                TextButton(
                                  onPressed: () => Navigator.pop(context),
                                  child: const Text('–û—Ç–º–µ–Ω–∞'),
                                ),
                                TextButton(
                                  onPressed: () {
                                    neoStore.deleteItem(item.id);
                                    Navigator.pop(context);
                                    ScaffoldMessenger.of(context).showSnackBar(
                                      const SnackBar(
                                        content: Text('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'),
                                      ),
                                    );
                                  },
                                  child: const Text(
                                    '–£–¥–∞–ª–∏—Ç—å',
                                    style: TextStyle(color: Colors.red),
                                  ),
                                ),
                              ],
                            ),
                          );
                        },
                        color: Colors.red,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        ACHIEVEMENTS PAGE
=========================== */

class AchievementsPage extends StatelessWidget {
  const AchievementsPage({super.key});

  @override
  Widget build(BuildContext context) {
    final achievements = neoStore.getUserAchievements();
    final unlockedCount = neoStore.unlockedAchievementsCount;

    return Scaffold(
      appBar: AppBar(
        title: const Text('–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è'),
      ),
      body: CustomScrollView(
        physics: const BouncingScrollPhysics(),
        slivers: [
          SliverToBoxAdapter(
            child: Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    NeoThemes.currentColor.withAlpha(77),
                    Theme.of(context).colorScheme.surface.withAlpha(153),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                ),
              ),
              child: Column(
                children: [
                  Container(
                    width: 80,
                    height: 80,
                    decoration:
                        NeoThemes.getNeonDecoration(NeoThemes.currentColor),
                    child: Center(
                      child: Text(
                        '$unlockedCount',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 32,
                          fontWeight: FontWeight.w700,
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
                    style: Theme.of(context).textTheme.displaySmall,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    '$unlockedCount –∏–∑ ${achievements.length} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ',
                    style: TextStyle(
                      color: Theme.of(context)
                          .colorScheme
                          .onSurface
                          .withAlpha(153),
                      fontSize: 16,
                    ),
                  ),
                ],
              ),
            ),
          ),
          SliverPadding(
            padding: const EdgeInsets.all(20),
            sliver: SliverList(
              delegate: SliverChildBuilderDelegate(
                (context, index) {
                  final achievement = achievements[index];
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: _AchievementCard(achievement: achievement),
                  );
                },
                childCount: achievements.length,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _AchievementCard extends StatelessWidget {
  final Achievement achievement;

  const _AchievementCard({required this.achievement});

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final progress = achievement.progress.toDouble();
    final target = achievement.target.toDouble();
    final percentage = (progress / target).clamp(0.0, 1.0);

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: NeoThemes.getCardDecoration(context),
      child: Row(
        children: [
          Container(
            width: 60,
            height: 60,
            decoration: BoxDecoration(
              color: achievement.unlocked
                  ? achievement.color.withAlpha(26)
                  : Colors.grey.withAlpha(26),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: achievement.unlocked
                    ? achievement.color.withAlpha(77)
                    : Colors.grey.withAlpha(77),
              ),
            ),
            child: Center(
              child: Icon(
                achievement.icon,
                color: achievement.unlocked ? achievement.color : Colors.grey,
                size: 28,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  achievement.title,
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 4),
                Text(
                  achievement.description,
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(153),
                    fontSize: 12,
                  ),
                ),
                const SizedBox(height: 8),
                LinearProgressIndicator(
                  value: percentage,
                  backgroundColor: Colors.grey.withAlpha(26),
                  color: achievement.unlocked ? achievement.color : Colors.grey,
                  minHeight: 4,
                  borderRadius: BorderRadius.circular(2),
                ),
                const SizedBox(height: 4),
                Text(
                  '${achievement.progress}/${achievement.target}',
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(153),
                    fontSize: 10,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(width: 12),
          Icon(
            achievement.unlocked
                ? Icons.check_circle_rounded
                : Icons.lock_rounded,
            color: achievement.unlocked ? achievement.color : Colors.grey,
          ),
        ],
      ),
    );
  }
}

/* ===========================
        SETTINGS PAGE
=========================== */

class NeoSettingsPage extends StatefulWidget {
  const NeoSettingsPage({super.key});

  @override
  State<NeoSettingsPage> createState() => _NeoSettingsPageState();
}

class _NeoSettingsPageState extends State<NeoSettingsPage> {
  Future<void> _showFcmToken() async {
    try {
      await FirebaseMessaging.instance.requestPermission();
      final token = await FirebaseMessaging.instance.getToken();
      if (!mounted) return;

      if (token == null || token.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('FCM —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω')),
        );
        return;
      }

      await showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('FCM —Ç–æ–∫–µ–Ω'),
          content: SelectableText(token),
          actions: [
            TextButton(
              onPressed: () {
                Clipboard.setData(ClipboardData(text: token));
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')),
                );
              },
              child: const Text('–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'),
            ),
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('–ó–∞–∫—Ä—ã—Ç—å'),
            ),
          ],
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: $e')),
      );
    }
  }

  Future<void> _showOneSignalId() async {
    try {
      final subId = OneSignal.User.pushSubscription.id;
      if (!mounted) return;

      if (subId == null || subId.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('OneSignal ID –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω')),
        );
        return;
      }

      final content = 'OneSignal ID: $subId';

      await showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('OneSignal ID'),
          content: SelectableText(content),
          actions: [
            TextButton(
              onPressed: () {
                Clipboard.setData(ClipboardData(text: content));
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')),
                );
              },
              child: const Text('–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'),
            ),
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('–ó–∞–∫—Ä—ã—Ç—å'),
            ),
          ],
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è OneSignal ID: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Scaffold(
      appBar: AppBar(
        title: const Text('–ù–∞—Å—Ç—Ä–æ–π–∫–∏'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: NeoThemes.getCardDecoration(context),
              child: Column(
                children: [
                  _SettingsItem(
                    title: '–¢–µ–º–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',
                    subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–≤—É—é —Ç–µ–º—É',
                    trailing: Wrap(
                      spacing: 8,
                      children: NeoThemes.themeColors.map((color) {
                        final index = NeoThemes.themeColors.indexOf(color);
                        return GestureDetector(
                          onTap: () {
                            neoStore.changeTheme(index);
                          },
                          child: Container(
                            width: 32,
                            height: 32,
                            decoration: BoxDecoration(
                              color: color,
                              shape: BoxShape.circle,
                              border: Border.all(
                                color: neoStore.selectedThemeIndex == index
                                    ? Colors.white
                                    : Colors.transparent,
                                width: 3,
                              ),
                            ),
                          ),
                        );
                      }).toList(),
                    ),
                  ),
                  const Divider(),
                  _SettingsItem(
                    title: '–†–µ–∂–∏–º —Ç–µ–º—ã',
                    subtitle: '–°–≤–µ—Ç–ª–∞—è, —Ç–µ–º–Ω–∞—è –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è',
                    trailing: Wrap(
                      spacing: 8,
                      children: [
                        _ThemeModeButton(
                          mode: 0,
                          icon: Icons.light_mode_rounded,
                          label: '–°–≤–µ—Ç–ª–∞—è',
                          isSelected: neoStore.selectedThemeMode == 0,
                        ),
                        _ThemeModeButton(
                          mode: 1,
                          icon: Icons.dark_mode_rounded,
                          label: '–¢–µ–º–Ω–∞—è',
                          isSelected: neoStore.selectedThemeMode == 1,
                        ),
                        _ThemeModeButton(
                          mode: 2,
                          icon: Icons.settings_suggest_rounded,
                          label: '–°–∏—Å—Ç–µ–º–Ω–∞—è',
                          isSelected: neoStore.selectedThemeMode == 2,
                        ),
                      ],
                    ),
                  ),
                  if (neoStore.user?.isAdmin == true) ...[
                    const Divider(),
                    _SettingsItem(
                      title: 'FCM —Ç–æ–∫–µ–Ω',
                      subtitle: '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                      trailing: TextButton(
                        onPressed: _showFcmToken,
                        child: const Text('–ü–æ–∫–∞–∑–∞—Ç—å'),
                      ),
                    ),
                    _SettingsItem(
                      title: 'OneSignal ID',
                      subtitle: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                      trailing: TextButton(
                        onPressed: _showOneSignalId,
                        child: const Text('–ü–æ–∫–∞–∑–∞—Ç—å'),
                      ),
                    ),
                  ],
                ],
              ),
            ),
            const SizedBox(height: 24),
            Text(
              '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: NeoThemes.getCardDecoration(context),
              child: Column(
                children: [
                  _SettingsSwitch(
                    title: 'Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    subtitle: '–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö',
                    value: neoStore.sNotifs,
                    onChanged: (value) {
                      neoStore.setSettings(notifs: value);
                      setState(() {});
                    },
                  ),
                ],
              ),
            ),
            const SizedBox(height: 24),
            Text(
              '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: NeoThemes.getCardDecoration(context),
              child: Column(
                children: [
                  _SettingsSwitch(
                    title: '–ù–µ–æ–Ω-—ç—Ñ—Ñ–µ–∫—Ç—ã',
                    subtitle: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–æ–Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ',
                    value: neoStore.sUseNeon,
                    neonGlow: true,
                    onChanged: (value) {
                      neoStore.setSettings(neon: value);
                      setState(() {});
                    },
                  ),
                  const Divider(),
                  _SettingsSwitch(
                    title: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å',
                    subtitle:
                        '–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤–∞—à –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',
                    value: neoStore.sShowOnlineStatus,
                    onChanged: (value) {
                      neoStore.setSettings(showOnlineStatus: value);
                      setState(() {});
                    },
                  ),
                ],
              ),
            ),
            const SizedBox(height: 24),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.red.withAlpha(26),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: Colors.red.withAlpha(77)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    '–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞',
                    style: Theme.of(context).textTheme.titleMedium?.copyWith(
                          color: Colors.red,
                        ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    '–≠—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å',
                    style: TextStyle(
                      color: cs.onSurface.withAlpha(153),
                      fontSize: 12,
                    ),
                  ),
                  const SizedBox(height: 16),
                  NeoButton(
                    text: '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ',
                    onPressed: () {
                      showDialog(
                        context: context,
                        builder: (context) => AlertDialog(
                          title: const Text('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?'),
                          content: const Text(
                              '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã?'),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context),
                              child: const Text('–û—Ç–º–µ–Ω–∞'),
                            ),
                            TextButton(
                              onPressed: () {
                                neoStore.resetData();
                                Navigator.pop(context);
                                ScaffoldMessenger.of(context).showSnackBar(
                                  const SnackBar(
                                    content: Text('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã'),
                                  ),
                                );
                              },
                              child: const Text(
                                '–°–±—Ä–æ—Å–∏—Ç—å',
                                style: TextStyle(color: Colors.red),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                    color: Colors.red,
                    fullWidth: true,
                    icon: Icons.delete_forever_rounded,
                  ),
                ],
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class _SettingsItem extends StatelessWidget {
  final String title;
  final String subtitle;
  final Widget trailing;

  const _SettingsItem({
    required this.title,
    required this.subtitle,
    required this.trailing,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 4),
                Text(
                  subtitle,
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(153),
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(width: 16),
          trailing,
        ],
      ),
    );
  }
}

class _SettingsSwitch extends StatefulWidget {
  final String title;
  final String subtitle;
  final bool value;
  final ValueChanged<bool> onChanged;
  final bool neonGlow;

  const _SettingsSwitch({
    required this.title,
    required this.subtitle,
    required this.value,
    required this.onChanged,
    this.neonGlow = false,
  });

  @override
  State<_SettingsSwitch> createState() => __SettingsSwitchState();
}

class __SettingsSwitchState extends State<_SettingsSwitch> {
  bool _value = false;

  @override
  void initState() {
    super.initState();
    _value = widget.value;
  }

  @override
  void didUpdateWidget(_SettingsSwitch oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.value != _value) {
      setState(() {
        _value = widget.value;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.title,
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 4),
                Text(
                  widget.subtitle,
                  style: TextStyle(
                    color: cs.onSurface.withAlpha(153),
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(width: 16),
          AnimatedContainer(
            duration: const Duration(milliseconds: 200),
            padding: const EdgeInsets.all(4),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              boxShadow: widget.neonGlow && _value
                  ? [
                      BoxShadow(
                        color: NeoThemes.currentNeon.withAlpha(140),
                        blurRadius: 18,
                        spreadRadius: 2,
                      ),
                    ]
                  : null,
            ),
            child: Switch(
              value: _value,
              onChanged: (value) {
                setState(() {
                  _value = value;
                });
                widget.onChanged(value);
              },
              activeThumbColor: NeoThemes.currentColor,
              activeTrackColor: NeoThemes.currentColor.withAlpha(120),
            ),
          ),
        ],
      ),
    );
  }
}

class _ThemeModeButton extends StatelessWidget {
  final int mode;
  final IconData icon;
  final String label;
  final bool isSelected;

  const _ThemeModeButton({
    required this.mode,
    required this.icon,
    required this.label,
    required this.isSelected,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        neoStore.changeThemeMode(mode);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected
              ? NeoThemes.currentColor.withAlpha(26)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: isSelected
                ? NeoThemes.currentColor.withAlpha(77)
                : Colors.grey.withAlpha(77),
          ),
        ),
        child: Column(
          children: [
            Icon(
              icon,
              color: isSelected ? NeoThemes.currentColor : Colors.grey,
              size: 20,
            ),
            const SizedBox(height: 4),
            Text(
              label,
              style: TextStyle(
                color: isSelected ? NeoThemes.currentColor : Colors.grey,
                fontSize: 10,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/* ===========================
        HELP PAGE
=========================== */

class HelpPage extends StatelessWidget {
  const HelpPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('–ü–æ–º–æ—â—å'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
              style: Theme.of(context).textTheme.displaySmall,
            ),
            const SizedBox(height: 24),
            const _HelpItem(
              question: '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?',
              answer:
                  '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "+" –≤ —Ü–µ–Ω—Ç—Ä–µ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å".',
            ),
            const SizedBox(height: 16),
            const _HelpItem(
              question: '–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º?',
              answer:
                  '–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É". –≠—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç —á–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º.',
            ),
            const SizedBox(height: 16),
            const _HelpItem(
              question: '–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?',
              answer:
                  '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–µ—Ç–∞–ª–µ–π –æ–±—ä—è–≤–ª–µ–Ω–∏—è.',
            ),
            const SizedBox(height: 16),
            const _HelpItem(
              question: '–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å?',
              answer:
                  '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ—Ñ–∏–ª—å" –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å". –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è, –≥–æ—Ä–æ–¥ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø—Ä–æ—Ñ–∏–ª—è.',
            ),
            const SizedBox(height: 16),
            const _HelpItem(
              question: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è?',
              answer:
                  '–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 24 —á–∞—Å–æ–≤. –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è".',
            ),
            const SizedBox(height: 32),
            Text(
              '–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(20),
              decoration: NeoThemes.getCardDecoration(context),
              child: const Column(
                children: [
                  _ContactItem(
                    icon: Icons.email_rounded,
                    title: 'Email',
                    value: 'support@neoobmin.com',
                  ),
                  Divider(),
                  _ContactItem(
                    icon: Icons.phone_rounded,
                    title: '–¢–µ–ª–µ—Ñ–æ–Ω',
                    value: '+7 (999) 123-45-67',
                  ),
                  Divider(),
                  _ContactItem(
                    icon: Icons.language_rounded,
                    title: '–í–µ–±-—Å–∞–π—Ç',
                    value: 'www.neoobmin.com',
                  ),
                ],
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class _HelpItem extends StatelessWidget {
  final String question;
  final String answer;

  const _HelpItem({
    required this.question,
    required this.answer,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            question,
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 8),
          Text(
            answer,
            style: TextStyle(
              color: cs.onSurface.withAlpha(153),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }
}

class _ContactItem extends StatelessWidget {
  final IconData icon;
  final String title;
  final String value;

  const _ContactItem({
    required this.icon,
    required this.title,
    required this.value,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          Icon(
            icon,
            color: NeoThemes.currentColor,
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                const SizedBox(height: 4),
                Text(
                  value,
                  style: TextStyle(
                    color:
                        Theme.of(context).colorScheme.onSurface.withAlpha(153),
                    fontSize: 14,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        TERMS PAGE
=========================== */

class TermsPage extends StatelessWidget {
  const TermsPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è NeoObmin',
              style: Theme.of(context).textTheme.displaySmall,
            ),
            const SizedBox(height: 16),
            Text(
              '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 1 —è–Ω–≤–∞—Ä—è 2024',
              style: TextStyle(
                color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 24),
            const _TermSection(
              title: '1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è',
              content:
                  '1.1. –ù–∞—Å—Ç–æ—è—â–∏–µ –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–≥—É–ª–∏—Ä—É—é—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –≤–∞–º–∏ –∏ NeoObmin.\n\n'
                  '1.2. –ò—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ NeoObmin, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ –£—Å–ª–æ–≤–∏—è–º–∏.',
            ),
            const SizedBox(height: 16),
            const _TermSection(
              title: '2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–∫–∫–∞—É–Ω—Ç',
              content:
                  '2.1. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.\n\n'
                  '2.2. –í—ã –Ω–µ—Å–µ—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å —Å–≤–æ–∏—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n\n'
                  '2.3. –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤.',
            ),
            const SizedBox(height: 16),
            const _TermSection(
              title: '3. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π',
              content:
                  '3.1. –í—ã –º–æ–∂–µ—Ç–µ —Ä–∞–∑–º–µ—â–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö –¥–ª—è –æ–±–º–µ–Ω–∞ –∏–ª–∏ –¥–∞—Ä–µ–Ω–∏—è.\n\n'
                  '3.2. –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö.\n\n'
                  '3.3. –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é.',
            ),
            const SizedBox(height: 16),
            const _TermSection(
              title: '4. –û–±–º–µ–Ω —Ç–æ–≤–∞—Ä–∞–º–∏',
              content:
                  '4.1. NeoObmin —è–≤–ª—è–µ—Ç—Å—è –ª–∏—à—å –ø–ª–æ—â–∞–¥–∫–æ–π –¥–ª—è —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n'
                  '4.2. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —É—Å–ª–æ–≤–∏—è –æ–±–º–µ–Ω–∞ –Ω–µ—Å—É—Ç –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–¥–µ–ª–∫–∏.\n\n'
                  '4.3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Å–¥–µ–ª–∫–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö.',
            ),
            const SizedBox(height: 16),
            const _TermSection(
              title: '5. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',
              content:
                  '5.1. NeoObmin –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π.\n\n'
                  '5.2. NeoObmin –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–¥–µ–ª–∫–∞—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.\n\n'
                  '5.3. –í —Å–ª—É—á–∞–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.',
            ),
            const SizedBox(height: 16),
            const _TermSection(
              title: '6. –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π',
              content:
                  '6.1. –ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–µ –£—Å–ª–æ–≤–∏—è.\n\n'
                  '6.2. –ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–æ–≤—ã–º–∏ –£—Å–ª–æ–≤–∏—è–º–∏.',
            ),
            const SizedBox(height: 32),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: NeoThemes.currentColor.withAlpha(26),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: NeoThemes.currentColor.withAlpha(77)),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.info_rounded,
                    color: NeoThemes.currentColor,
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      '–ò—Å–ø–æ–ª—å–∑—É—è NeoObmin, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –∏ —Å–æ–≥–ª–∞—Å–Ω—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.',
                      style: TextStyle(
                        color: Theme.of(context).colorScheme.onSurface,
                        fontSize: 12,
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class _TermSection extends StatelessWidget {
  final String title;
  final String content;

  const _TermSection({
    required this.title,
    required this.content,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 8),
          Text(
            content,
            style: TextStyle(
              color: cs.onSurface.withAlpha(153),
              fontSize: 14,
              height: 1.5,
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        PRIVACY PAGE
=========================== */

class PrivacyPage extends StatelessWidget {
  const PrivacyPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ NeoObmin',
              style: Theme.of(context).textTheme.displaySmall,
            ),
            const SizedBox(height: 16),
            Text(
              '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 1 —è–Ω–≤–∞—Ä—è 2024',
              style: TextStyle(
                color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 24),
            const _PrivacySection(
              title: '1. –°–æ–±–∏—Ä–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              content:
                  '1.1. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º—ã —Å–æ–±–∏—Ä–∞–µ–º –≤–∞—à–µ –∏–º—è, email –∏ –≥–æ—Ä–æ–¥.\n\n'
                  '1.2. –ü—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –º—ã —Å–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö.\n\n'
                  '1.3. –ú—ã —Å–æ–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.',
            ),
            const SizedBox(height: 16),
            const _PrivacySection(
              title: '2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
              content:
                  '2.1. –í–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.\n\n'
                  '2.2. –í–∞—à email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.\n\n'
                  '2.3. –ú—ã –Ω–µ –ø—Ä–æ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.',
            ),
            const SizedBox(height: 16),
            const _PrivacySection(
              title: '3. –ó–∞—â–∏—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
              content:
                  '3.1. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.\n\n'
                  '3.2. –í–∞—à–∏ –ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.\n\n'
                  '3.3. –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏–º–µ—é—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏.',
            ),
            const SizedBox(height: 16),
            const _PrivacySection(
              title: '4. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
              content:
                  '4.1. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.\n\n'
                  '4.2. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤–∏–¥–Ω–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.\n\n'
                  '4.3. –í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.',
            ),
            const SizedBox(height: 16),
            const _PrivacySection(
              title: '5. –í–∞—à–∏ –ø—Ä–∞–≤–∞',
              content:
                  '5.1. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –¥–∞–Ω–Ω—ã—Ö.\n\n'
                  '5.2. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è.\n\n'
                  '5.3. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.',
            ),
            const SizedBox(height: 16),
            const _PrivacySection(
              title: '6. –ö–æ–Ω—Ç–∞–∫—Ç—ã',
              content:
                  '6.1. –ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –Ω–∞ privacy@neoobmin.com.\n\n'
                  '6.2. –ú—ã –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π.\n\n'
                  '6.3. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–ü–æ–º–æ—â—å" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.',
            ),
            const SizedBox(height: 32),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: NeoThemes.currentColor.withAlpha(26),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: NeoThemes.currentColor.withAlpha(77)),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.security_rounded,
                    color: NeoThemes.currentColor,
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      '–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –¥–æ–≤–µ—Ä–∏–µ –∏ –¥–µ–ª–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ–µ –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.',
                      style: TextStyle(
                        color: Theme.of(context).colorScheme.onSurface,
                        fontSize: 12,
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class _PrivacySection extends StatelessWidget {
  final String title;
  final String content;

  const _PrivacySection({
    required this.title,
    required this.content,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: NeoThemes.getCardDecoration(context),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 8),
          Text(
            content,
            style: TextStyle(
              color: cs.onSurface.withAlpha(153),
              fontSize: 14,
              height: 1.5,
            ),
          ),
        ],
      ),
    );
  }
}

/* ===========================
        UI COMPONENTS
=========================== */

class NeoButton extends StatelessWidget {
  final String text;
  final VoidCallback onPressed;
  final bool loading;
  final bool fullWidth;
  final IconData? icon;
  final Color? color;

  const NeoButton({
    super.key,
    required this.text,
    required this.onPressed,
    this.loading = false,
    this.fullWidth = false,
    this.icon,
    this.color,
  });

  @override
  Widget build(BuildContext context) {
    final btnColor = color ?? NeoThemes.currentColor;

    return Container(
      width: fullWidth ? double.infinity : null,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(14),
        boxShadow: [
          BoxShadow(
            color: btnColor.withAlpha(90),
            blurRadius: 14,
            offset: const Offset(0, 6),
          ),
        ],
      ),
      child: ElevatedButton(
        onPressed: loading ? null : onPressed,
        style: ElevatedButton.styleFrom(
          backgroundColor: btnColor,
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          elevation: 0,
          shadowColor: Colors.transparent,
          surfaceTintColor: Colors.transparent,
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            if (loading)
              const SizedBox(
                width: 20,
                height: 20,
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  color: Colors.white,
                ),
              )
            else if (icon != null)
              Icon(icon, size: 20),
            if ((loading || icon != null) && text.isNotEmpty)
              const SizedBox(width: 12),
            if (text.isNotEmpty)
              Text(
                text,
                style: const TextStyle(
                  fontWeight: FontWeight.w700,
                  fontSize: 15,
                  letterSpacing: 0.3,
                ),
              ),
          ],
        ),
      ),
    );
  }
}

class NeoTextButton extends StatelessWidget {
  final String text;
  final VoidCallback onPressed;
  final Color? color;

  const NeoTextButton({
    super.key,
    required this.text,
    required this.onPressed,
    this.color,
  });

  @override
  Widget build(BuildContext context) {
    final btnColor = color ?? NeoThemes.currentColor;

    return TextButton(
      onPressed: onPressed,
      style: TextButton.styleFrom(
        foregroundColor: btnColor,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10),
        ),
      ),
      child: Text(
        text,
        style: const TextStyle(
          fontWeight: FontWeight.w600,
        ),
      ),
    );
  }
}

class NeoInput extends StatelessWidget {
  final TextEditingController controller;
  final String hint;
  final IconData? prefixIcon;
  final IconData? suffixIcon;
  final bool obscure;
  final TextInputType? keyboardType;
  final int? maxLines;
  final bool enabled;
  final bool readOnly;
  final VoidCallback? onTap;

  const NeoInput({
    super.key,
    required this.controller,
    required this.hint,
    this.prefixIcon,
    this.suffixIcon,
    this.obscure = false,
    this.keyboardType,
    this.maxLines = 1,
    this.enabled = true,
    this.readOnly = false,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return TextField(
      controller: controller,
      obscureText: obscure,
      keyboardType: keyboardType,
      maxLines: maxLines,
      enabled: enabled,
      readOnly: readOnly,
      onTap: onTap,
      decoration: InputDecoration(
        hintText: hint,
        prefixIcon: prefixIcon != null
            ? Icon(
                prefixIcon,
                color: cs.onSurface.withAlpha(128),
              )
            : null,
        suffixIcon: suffixIcon != null
            ? Icon(
                suffixIcon,
                color: cs.onSurface.withAlpha(128),
              )
            : null,
        filled: true,
        fillColor: cs.surfaceContainerHighest,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(
            color: NeoThemes.currentColor.withAlpha(128),
            width: 2,
          ),
        ),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 18, vertical: 14),
      ),
    );
  }
}
/* ===========================
        EDIT ITEM PAGE
=========================== */

class NeoEditItemPage extends StatefulWidget {
  final Item item;
  final bool readOnly;
  final String? moderationComment;

  const NeoEditItemPage({
    super.key,
    required this.item,
    this.readOnly = false,
    this.moderationComment,
  });

  @override
  State<NeoEditItemPage> createState() => _NeoEditItemPageState();
}

class _NeoEditItemPageState extends State<NeoEditItemPage> {
  final _titleController = TextEditingController();
  final _descController = TextEditingController();
  final _cityController = TextEditingController();
  String _selectedCategory = '–¢–µ—Ö–Ω–∏–∫–∞';
  ItemType _selectedType = ItemType.exchange;
  bool _loading = false;

  final List<String> _selectedImages = [];
  int _mainImageIndex = 0;

  final List<String> categories = [
    '–¢–µ—Ö–Ω–∏–∫–∞',
    '–û–¥–µ–∂–¥–∞',
    '–î–æ–º',
    '–°–ø–æ—Ä—Ç',
    '–ö–Ω–∏–≥–∏',
    '–î—Ä—É–≥–æ–µ'
  ];

  final ImagePicker _picker = ImagePicker();

  Future<void> _pickCity() async {
    if (widget.readOnly) return;
    final city = await showLocationPicker(
      context,
      initialCity: _cityController.text,
    );
    if (city != null) {
      setState(() => _cityController.text = city);
    }
  }

  @override
  void initState() {
    super.initState();
    final item = widget.item;
    _titleController.text = item.title;
    _descController.text = item.desc;
    _cityController.text = item.city;
    _selectedCategory = item.category;
    _selectedType = item.type;
    _selectedImages.addAll(item.photoUrls);
    for (final path in item.localImagePaths) {
      if (!_selectedImages.contains(path)) {
        _selectedImages.add(path);
      }
    }
    _mainImageIndex = item.mainImageIndex;
  }

  @override
  void dispose() {
    _titleController.dispose();
    _descController.dispose();
    _cityController.dispose();
    super.dispose();
  }

  Future<void> _pickImages() async {
    if (_selectedImages.length >= 5) {
      _showToast('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Ñ–æ—Ç–æ');
      return;
    }

    try {
      final List<XFile> pickedFiles = await _picker.pickMultiImage(
        maxWidth: 1200,
        maxHeight: 1200,
        imageQuality: 85,
      );

      if (pickedFiles.isNotEmpty) {
        final availableSlots = 5 - _selectedImages.length;
        final filesToAdd = pickedFiles.take(availableSlots).toList();

        setState(() {
          _selectedImages.addAll(filesToAdd.map((file) => file.path));
        });
      }
    } catch (e) {
      _showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–æ—Ç–æ: $e');
    }
  }

  void _removeImage(int index) {
    setState(() {
      _selectedImages.removeAt(index);
      if (_mainImageIndex >= _selectedImages.length) {
        _mainImageIndex =
            _selectedImages.isNotEmpty ? _selectedImages.length - 1 : 0;
      }
    });
  }

  void _setMainImage(int index) {
    setState(() {
      _mainImageIndex = index;
    });
  }

  bool _isRemotePath(String path) {
    return path.startsWith('http');
  }

  ImageProvider _imageProvider(String path) {
    if (_isRemotePath(path)) {
      return NetworkImage(path);
    }
    return FileImage(File(path));
  }

  Widget _buildImageItem(int index) {
    return Container(
      width: 100,
      height: 100,
      margin: const EdgeInsets.only(right: 12),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        image: DecorationImage(
          image: _imageProvider(_selectedImages[index]),
          fit: BoxFit.cover,
        ),
      ),
      child: Stack(
        children: [
          if (index == _mainImageIndex)
            Positioned(
              top: 4,
              right: 4,
              child: Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: Colors.green.withAlpha(200),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Icon(
                  Icons.star_rounded,
                  color: Colors.white,
                  size: 16,
                ),
              ),
            ),
          Positioned(
            bottom: 4,
            left: 4,
            child: GestureDetector(
              onTap: () => _setMainImage(index),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: Colors.black.withAlpha(128),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  index == _mainImageIndex ? '–ì–ª–∞–≤–Ω–æ–µ' : '–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ),
          Positioned(
            top: 4,
            left: 4,
            child: GestureDetector(
              onTap: () => _removeImage(index),
              child: Container(
                padding: const EdgeInsets.all(2),
                decoration: BoxDecoration(
                  color: Colors.red.withAlpha(200),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.close_rounded,
                  color: Colors.white,
                  size: 14,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _handleUpdate() async {
    if (widget.readOnly) return;
    if (_titleController.text.isEmpty ||
        _descController.text.isEmpty ||
        _cityController.text.isEmpty) {
      _showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    if (_selectedImages.isEmpty) {
      _showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ');
      return;
    }

    setState(() => _loading = true);

    try {
      final user = neoStore.user;
      if (user == null) throw Exception('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');

      final uploadedUrls = await neoStore.uploadItemImages(_selectedImages);
      if (uploadedUrls.isEmpty) {
        _showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
        return;
      }
      if (uploadedUrls.length < _selectedImages.length) {
        _showToast('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
      }

      final localPaths =
          _selectedImages.where((path) => !_isRemotePath(path)).toList();
      final mainIndex = _mainImageIndex < uploadedUrls.length
          ? _mainImageIndex
          : 0;

      final updatedItem = widget.item.copyWith(
        title: _titleController.text,
        desc: _descController.text,
        city: _cityController.text,
        category: _selectedCategory,
        type: _selectedType,
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é
        status: ItemStatus.pending,
        photoUrls: uploadedUrls,
        localImagePaths: localPaths,
        mainImageIndex: mainIndex,
        updatedAt: DateTime.now(),
      );

      await neoStore.updateItem(updatedItem);

      if (!mounted) return;

      _showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é');
      Navigator.pop(context);
    } catch (e) {
      _showToast('–û—à–∏–±–∫–∞: $e');
    } finally {
      setState(() => _loading = false);
    }
  }

  void _showToast(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        duration: const Duration(seconds: 2),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final comment = widget.moderationComment ?? widget.item.moderationComment;

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.readOnly
            ? '–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è'
            : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            if (comment?.isNotEmpty == true)
              Container(
                padding: const EdgeInsets.all(16),
                margin: const EdgeInsets.only(bottom: 16),
                decoration: BoxDecoration(
                  color: Colors.red.withAlpha(26),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.red.withAlpha(77)),
                ),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Icon(Icons.error_outline_rounded, color: Colors.red),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        comment!,
                        style: const TextStyle(
                          color: Colors.red,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            Text(
              '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 12),
            Text(
              '–î–æ 5 —Ñ–æ—Ç–æ. –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç –≥–ª–∞–≤–Ω—ã–º.',
              style: TextStyle(
                color: Theme.of(context).colorScheme.onSurface.withAlpha(153),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 16),
            if (_selectedImages.isNotEmpty)
              SizedBox(
                height: 100,
                child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  itemCount: _selectedImages.length,
                  itemBuilder: (context, index) {
                    return _buildImageItem(index);
                  },
                ),
              ),
            if (_selectedImages.length < 5)
              Container(
                margin: const EdgeInsets.only(top: 16),
                child: DottedBorder(
                  borderType: BorderType.RRect,
                  radius: const Radius.circular(12),
                  dashPattern: const [8, 4],
                  color: NeoThemes.currentColor.withAlpha(128),
                  child: InkWell(
                    onTap: _pickImages,
                    borderRadius: BorderRadius.circular(12),
                    child: Container(
                      width: double.infinity,
                      height: 100,
                      decoration: BoxDecoration(
                        color: Theme.of(context)
                            .colorScheme
                            .surfaceContainer
                            .withAlpha(77),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.add_photo_alternate_rounded,
                            color: NeoThemes.currentColor,
                            size: 32,
                          ),
                          const SizedBox(height: 8),
                          Text(
                            '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ',
                            style: TextStyle(
                              color: NeoThemes.currentColor,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          Text(
                            '${_selectedImages.length}/5',
                            style: TextStyle(
                              color: NeoThemes.currentColor.withAlpha(128),
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            const SizedBox(height: 32),
            Text(
              '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 20),
            NeoInput(
              controller: _titleController,
              hint: '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è*',
              prefixIcon: Icons.title_rounded,
              enabled: !widget.readOnly,
            ),
            const SizedBox(height: 16),
            NeoInput(
              controller: _descController,
              hint: '–û–ø–∏—Å–∞–Ω–∏–µ*',
              prefixIcon: Icons.description_rounded,
              maxLines: 4,
              enabled: !widget.readOnly,
            ),
            const SizedBox(height: 16),
            NeoInput(
              controller: _cityController,
              hint: '–ì–æ—Ä–æ–¥*',
              prefixIcon: Icons.location_on_rounded,
              suffixIcon: Icons.keyboard_arrow_down_rounded,
              enabled: !widget.readOnly,
              readOnly: true,
              onTap: widget.readOnly ? null : _pickCity,
            ),
            const SizedBox(height: 24),
            Text(
              '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: categories.map((category) {
                return ChoiceChip(
                  label: Text(category),
                  selected: _selectedCategory == category,
                  onSelected: widget.readOnly
                      ? null
                      : (selected) {
                          setState(() => _selectedCategory = category);
                        },
                );
              }).toList(),
            ),
            const SizedBox(height: 24),
            Text(
              '–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: _TypeChoice(
                    type: ItemType.exchange,
                    selected: _selectedType == ItemType.exchange,
                    onTap: widget.readOnly
                        ? null
                        : () {
                            setState(() => _selectedType = ItemType.exchange);
                          },
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: _TypeChoice(
                    type: ItemType.gift,
                    selected: _selectedType == ItemType.gift,
                    onTap: widget.readOnly
                        ? null
                        : () {
                            setState(() => _selectedType = ItemType.gift);
                          },
                  ),
                ),
              ],
            ),
            if (!widget.readOnly) ...[
              const SizedBox(height: 24),
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.orange.withAlpha(26),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.orange.withAlpha(77)),
                ),
                child: const Row(
                  children: [
                    Icon(
                      Icons.info_rounded,
                      color: Colors.orange,
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        '–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é',
                        style: TextStyle(
                          color: Colors.orange,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 40),
              NeoButton(
                text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è',
                onPressed: _handleUpdate,
                loading: _loading,
                fullWidth: true,
                icon: Icons.save_rounded,
              ),
              const SizedBox(height: 20),
            ],
          ],
        ),
      ),
    );
  }
}

class _StatItem extends StatelessWidget {
  final String value;
  final String label;
  final IconData icon;

  const _StatItem({
    required this.value,
    required this.label,
    required this.icon,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return Column(
      children: [
        Container(
          width: 48,
          height: 48,
          decoration: BoxDecoration(
            color: NeoThemes.currentColor.withAlpha(26),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: NeoThemes.currentColor.withAlpha(77),
            ),
          ),
          child: Center(
            child: Icon(
              icon,
              color: NeoThemes.currentColor,
              size: 24,
            ),
          ),
        ),
        const SizedBox(height: 8),
        Text(
          value,
          style: Theme.of(context).textTheme.titleLarge,
        ),
        const SizedBox(height: 4),
        Text(
          label,
          style: TextStyle(
            color: cs.onSurface.withAlpha(128),
            fontSize: 12,
          ),
        ),
      ],
    );
  }
}

class _ProfileItem extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final VoidCallback onTap;
  final Color? color;
  final bool isLogout; // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
  final int badgeCount;

  const _ProfileItem({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.onTap,
    this.color,
    this.isLogout = false, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
    this.badgeCount = 0,
  });

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    final itemColor = color ?? NeoThemes.currentColor;

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
      child: isLogout
          ? _LogoutButton(
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ã—Ö–æ–¥–∞
              icon: icon,
              title: title,
              subtitle: subtitle,
              color: itemColor,
            )
          : _RegularProfileItem(
              // –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—É–Ω–∫—Ç–æ–≤
              icon: icon,
              title: title,
              subtitle: subtitle,
              onTap: onTap,
              color: itemColor,
              cs: cs,
              badgeCount: badgeCount,
            ),
    );
  }
}

// –û–±—ã—á–Ω—ã–π –ø—É–Ω–∫—Ç –ø—Ä–æ—Ñ–∏–ª—è
class _RegularProfileItem extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final VoidCallback onTap;
  final Color color;
  final ColorScheme cs;
  final int badgeCount;

  const _RegularProfileItem({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.onTap,
    required this.color,
    required this.cs,
    required this.badgeCount,
  });

  @override
  Widget build(BuildContext context) {
    return ListTile(
      onTap: onTap,
      leading: Container(
        width: 48,
        height: 48,
        decoration: BoxDecoration(
          color: color.withAlpha(26),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: color.withAlpha(77),
          ),
        ),
        child: Center(
          child: Icon(
            icon,
            color: color,
            size: 24,
          ),
        ),
      ),
      title: Text(
        title,
        style: Theme.of(context).textTheme.titleMedium,
      ),
      subtitle: Text(
        subtitle,
        style: TextStyle(
          color: cs.onSurface.withAlpha(153),
          fontSize: 12,
        ),
      ),
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (badgeCount > 0)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: Colors.red,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Text(
                '$badgeCount',
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 11,
                  fontWeight: FontWeight.w700,
                ),
              ),
            ),
          const SizedBox(width: 8),
          Icon(
            Icons.chevron_right_rounded,
            color: cs.onSurface.withAlpha(77),
          ),
        ],
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      tileColor: cs.surfaceContainerHighest,
    );
  }
}

// –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
class _LogoutButton extends StatefulWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final Color color;

  const _LogoutButton({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.color,
  });

  @override
  State<_LogoutButton> createState() => __LogoutButtonState();
}

class __LogoutButtonState extends State<_LogoutButton> {
  bool _isLoggingOut = false;

  Future<void> _logout() async {
    if (_isLoggingOut) return;

    setState(() => _isLoggingOut = true);

    try {
      await neoStore.logout();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤—ã—Ö–æ–¥–µ
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞'),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: $e'),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 2),
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoggingOut = false);
      }
    }
  }

  void _showLogoutDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞'),
        content: const Text('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('–û—Ç–º–µ–Ω–∞'),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
              _logout(); // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—ã—Ö–æ–¥
            },
            child: const Text(
              '–í—ã–π—Ç–∏',
              style: TextStyle(color: Colors.red),
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return ListTile(
      onTap: _showLogoutDialog,
      leading: Container(
        width: 48,
        height: 48,
        decoration: BoxDecoration(
          color: widget.color.withAlpha(26),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.color.withAlpha(77),
          ),
        ),
        child: Center(
          child: _isLoggingOut
              ? SizedBox(
                  width: 20,
                  height: 20,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    color: widget.color,
                  ),
                )
              : Icon(
                  widget.icon,
                  color: widget.color,
                  size: 24,
                ),
        ),
      ),
      title: Text(
        widget.title,
        style: Theme.of(context).textTheme.titleMedium,
      ),
      subtitle: Text(
        widget.subtitle,
        style: TextStyle(
          color: cs.onSurface.withAlpha(153),
          fontSize: 12,
        ),
      ),
      trailing: _isLoggingOut
          ? SizedBox(
              width: 20,
              height: 20,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                color: widget.color,
              ),
            )
          : Icon(
              Icons.exit_to_app_rounded,
              color: widget.color,
            ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      tileColor: cs.surfaceContainerHighest,
    );
  }
}
